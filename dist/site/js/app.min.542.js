var requirejs,require,define;!function(e){function t(e,t){return y.call(e,t)}function i(e,t){var i,s,a,r,n,o,l,c,h,d,u,p=t&&t.split("/"),m=f.map,g=m&&m["*"]||{};if(e){for(n=(e=e.split("/")).length-1,f.nodeIdCompat&&b.test(e[n])&&(e[n]=e[n].replace(b,"")),"."===e[0].charAt(0)&&p&&(e=p.slice(0,p.length-1).concat(e)),h=0;h<e.length;h++)if("."===(u=e[h]))e.splice(h,1),h-=1;else if(".."===u){if(0===h||1===h&&".."===e[2]||".."===e[h-1])continue;h>0&&(e.splice(h-1,2),h-=2)}e=e.join("/")}if((p||g)&&m){for(h=(i=e.split("/")).length;h>0;h-=1){if(s=i.slice(0,h).join("/"),p)for(d=p.length;d>0;d-=1)if((a=m[p.slice(0,d).join("/")])&&(a=a[s])){r=a,o=h;break}if(r)break;!l&&g&&g[s]&&(l=g[s],c=h)}!r&&l&&(r=l,o=c),r&&(i.splice(0,o,r),e=i.join("/"))}return e}function s(t,i){return function(){var s=w.call(arguments,0);return"string"!=typeof s[0]&&1===s.length&&s.push(null),d.apply(e,s.concat([t,i]))}}function a(e){return function(t){return i(t,e)}}function r(e){return function(t){m[e]=t}}function n(i){if(t(g,i)){var s=g[i];delete g[i],v[i]=!0,h.apply(e,s)}if(!t(m,i)&&!t(v,i))throw new Error("No "+i);return m[i]}function o(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function l(e){return e?o(e):[]}function c(e){return function(){return f&&f.config&&f.config[e]||{}}}var h,d,u,p,m={},g={},f={},v={},y=Object.prototype.hasOwnProperty,w=[].slice,b=/\.js$/;u=function(e,t){var s,r=o(e),l=r[0],c=t[1];return e=r[1],l&&(s=n(l=i(l,c))),l?e=s&&s.normalize?s.normalize(e,a(c)):i(e,c):(l=(r=o(e=i(e,c)))[0],e=r[1],l&&(s=n(l))),{f:l?l+"!"+e:e,n:e,pr:l,p:s}},p={require:function(e){return s(e)},exports:function(e){var t=m[e];return void 0!==t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:c(e)}}},h=function(i,a,o,c){var h,d,f,y,w,b,S,T=[],C=typeof o;if(c=c||i,b=l(c),"undefined"===C||"function"===C){for(a=!a.length&&o.length?["require","exports","module"]:a,w=0;w<a.length;w+=1)if(y=u(a[w],b),"require"===(d=y.f))T[w]=p.require(i);else if("exports"===d)T[w]=p.exports(i),S=!0;else if("module"===d)h=T[w]=p.module(i);else if(t(m,d)||t(g,d)||t(v,d))T[w]=n(d);else{if(!y.p)throw new Error(i+" missing "+d);y.p.load(y.n,s(c,!0),r(d),{}),T[w]=m[d]}f=o?o.apply(m[i],T):void 0,i&&(h&&h.exports!==e&&h.exports!==m[i]?m[i]=h.exports:f===e&&S||(m[i]=f))}else i&&(m[i]=o)},requirejs=require=d=function(t,i,s,a,r){if("string"==typeof t)return p[t]?p[t](i):n(u(t,l(i)).f);if(!t.splice){if((f=t).deps&&d(f.deps,f.callback),!i)return;i.splice?(t=i,i=s,s=null):t=e}return i=i||function(){},"function"==typeof s&&(s=a,a=r),a?h(e,t,i,s):setTimeout(function(){h(e,t,i,s)},4),d},d.config=function(e){return d(e)},requirejs._defined=m,(define=function(e,i,s){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");i.splice||(s=i,i=[]),t(m,e)||t(g,e)||(g[e]=[e,i,s])}).amd={jQuery:!0}}(),define("../../../../node_modules/almond/almond",function(){}),define("registry",["require"],function(e){"use strict";var t=[];return{get:function(e){return t[e]||void 0},set:function(e,i){t[e]=i}}}),define("global/views/navigation",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.View.extend({el:"#nav",events:{"click .log-out":"logOut"},initialize:function(){var e=t.get("pubSub");this.listenTo(e,"app:navigate",this.setActiveTab),this.listenTo(this.model,"change:requests",this.showFriendRequests),this.listenTo(this.model,"change:teamApplications",this.showTeamApplications),this.model.get("tag")&&this.$("#navTeam a").attr("href","/team/"+this.model.get("tag")),this.showFriendRequests(),this.showNewNews(),this.showTeamApplications()},setActiveTab:function(e){"navNews"=="nav"+e.charAt(0).toUpperCase()+e.slice(1)&&this.model.set({_visitedBlog:!0})},logOut:function(e){e.preventDefault(),t.get("player").logout(),document.location.href="/"},showFriendRequests:function(){this.model.get("requests")>0?this.$("#navFriends .navigation-jewel").html(this.model.get("requests")).show():this.$("#navFriends .navigation-jewel").hide()},showNewNews:function(){NTGLOBALS("LOGGED_IN")&&this.model.get("lastLogin")<NTGLOBALS("RECENT_NEWS")&&!this.model.get("_visitedBlog")?this.$("#navNews .navigation-jewel").show():this.$("#navNews .navigation-jewel").hide()},showTeamApplications:function(){this.model.get("teamApplications")>0?this.$("#navTeam .navigation-jewel").html(this.model.get("teamApplications")).show():this.$("#navTeam .navigation-jewel").hide()}})}),define("templates",["require"],function(e){"use strict";return function(e,t){return window.NTJST[e+"_"+t]?window.NTJST[e+"_"+t]:(console.error("Unable to find template: "+e+"_"+t),function(){return"Unable to find template: "+e+"_"+t})}}),define("shared/classes/typing",["require"],function(e){"use strict";return{speed:function(e,t){return e=e||0,0==(t=t||0)?0:Math.round(e/5/(t/60))},accuracy:function(e,t,i){if(e=e||0,t=t||0,i=parseInt(i,10)||0,0==e)return 0;var s=parseFloat((100-t/e*100).toFixed(i));return s>=100?100:s}}}),define("global/models/car",["require"],function(e){"use strict";var t=Backbone.Model.extend({idAttribute:"carID",defaults:{carID:9,name:"Rental Car",price:0,unlockLevel:999,status:"owned"},imageSrc:function(e,i){return t.imageSrc(e,this.id,i)}},{imageSrc:function(e,t,i){return(i=10*Math.floor(i/10))&&i>0&&i<356?"/cars/painted/"+t+"_"+e+"_1_"+i+".png":"/cars/"+t+"_"+e+"_1.png"},imageTag:function(e,i,s){return'<img src="'+t.imageSrc(e,i,s)+'"  />'},imageBackgroundCSS:function(e,i,s){return"background-image: url('"+t.imageSrc(e,i,s)+"'); "}});return t}),define("global/views/scoreboard_table",["require","templates","shared/classes/typing","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("shared/classes/typing"),s=e("global/models/car"),a=e("registry"),r=[{field:"played",title:"Most Active",header:"Races"},{field:"speed",title:"Fastest Racer (500+ races)",header:"Avg Speed"},{field:"longestSession",title:"Longest Session",header:"Session Races"},{field:"money",title:"Most Money",header:"Dollars Saved"},{field:"moneySpent",title:"Biggest Spender",header:"Dollars Spent"},{field:"nitrosUsed",title:"Nitros Used",header:"Nitros"},{field:"oldest",title:"Oldest Active Player",header:"Member Since"}];return Backbone.View.extend({hoverOffset:354,hover:null,tagName:"table",className:"scoreboard-table",events:{"click .row":"handleRowClick","mouseenter .row":"showPlayerPopup","mouseleave .row":"hidePlayerPopup"},initialize:function(e){void 0===this.template&&(this.template=t("global","scoreboard_table"),this.hofTemplate=t("global","scoreboard_hof")),this.headers=e.headers||!1,this.hover=e.hover,this.noTop3=e.noTop3,this.listenTo(this.model,"reset",this.render)},render:function(){var e="hof"==this.model.board?this.hofTemplate:this.template;return this.$el.html(e({hofData:r,board:this.model.board,time:this.model.time,Typing:i,noTop3:this.noTop3,grouping:this.model.grouping,countries:NTGLOBALS("COUNTRIES"),rows:this.model.toJSON(),headers:this.headers,player:a.get("player").toJSON(),formatHof:this.formatHof,carSrc:s.imageSrc})),this},handleRowClick:function(e){var t=$(e.currentTarget).data("id");if(!t)return!1;"teams"==this.model.grouping?location.href="/team/"+this.model.findWhere({teamID:t}).get("tag"):"racer"==this.model.grouping&&(location.href="/racer/"+this.model.findWhere({userID:t}).get("username"))},showPlayerPopup:function(e){if(e.preventDefault(),"teams"!=this.model.grouping){var t,i=$(e.currentTarget).data("id");i&&(t=this.model.findWhere({userID:i}),this.hover&&this.hover.show(e.currentTarget,t,this.hoverOffset))}},hidePlayerPopup:function(e){return this.hover&&this.hover.hide(e),!1},formatHof:function(e){switch(e.valueType){case"number":return e.value.addCommas();case"dollars":return"$"+e.value.addCommas();case"percentage":return e.value+"%";case"date":return moment(1e3*e.value).format("MMM D, YYYY");case"speed":return e.value+" wpm";default:return e.value}}})}),define("scoreboard/collections/data",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.Collection.extend({board:"points",grouping:"racer",time:"season",seasonID:0,rankingsModel:null,cache:{},rankingsCache:{},initialize:function(){this.player=t.get("player"),this.rankingsModel=new Backbone.Model,this.time=this.player.get("_scoreboardTime")||this.time,this.board=this.player.get("_scoreboardBoard")||this.board,this.grouping=this.player.get("_scoreboardGrouping")||this.grouping,this.updateRankings({})},updateRankings:function(e){if(e.scores){var t;t="racer"==this.grouping?_.find(e.scores,function(e){return e.userID==this.player.id},this):_.find(e.scores,function(e){return e.teamID==this.player.get("teamID")},this),this.rankingsCache[e.board+e.time+e.grouping+e.seasonID]={board:e.board,time:e.time,grouping:e.grouping,seasonID:e.seasonID,yourRank:t?"points"==this.board?t.rank:e.scores.indexOf(t)+1:0,yourScore:t?t[this.board]:0,totalRanks:e.totalRanks},this.rankingsModel.set(this.rankingsCache[this.board+this.time+this.grouping+this.seasonID])}},parse:function(e){if(e.success)return this.updateRankings(e.data),this.cache[this.board+this.time+this.grouping+this.seasonID]=e.data.scores,e.data.scores;this.rankingsModel.set({error:e.data.message})},setOptions:function(e,t,i,s){return this.board=e||this.board,this.time=t||this.time,this.grouping=i||this.grouping,this.seasonID=s||0,this.player.set({_scoreboardBoard:e,_scoreboardTime:t,_scoreboardGrouping:i}),this},fetch:function(){if(this.cache[this.board+this.time+this.grouping+this.seasonID])this.rankingsModel.set(this.rankingsCache[this.board+this.time+this.grouping+this.seasonID]),this.reset(this.cache[this.board+this.time+this.grouping+this.seasonID]);else{this.trigger("request");var e=this.board,t=this.time,i=this.grouping,s=this.seasonID,a={board:this.board,time:this.time,grouping:this.grouping,seasonID:this.seasonID};$.ajax({url:"/api/scoreboard",data:a,success:function(a){a.data.board=e,a.data.time=t,a.data.grouping=i,a.data.seasonID=s,this.reset(this.parse(a))}.bind(this),error:function(){this.reset([])}.bind(this)})}}})}),define("shared/classes/model_backends/localstorage",["require"],function(e){"use strict";var t=[],i=function(e){this.table=e};return i.prototype.setModel=function(e){t.push(e),this.model=e},i.prototype.getData=function(){return void 0===window.localStorage[rot47(this.table)]?null:JSON.parse(rot47(window.localStorage[rot47(this.table)]))},i.prototype.setData=function(e){window.localStorage[rot47(this.table)]=rot47(JSON.stringify(e))},i.prototype.change=function(){this.setData(this.model.toJSON())},i.prototype.add=i.prototype.change,i.prototype.remove=i.prototype.change,i.prototype.reset=i.prototype.change,i.prototype.sort=i.prototype.change,i.clear=function(){t.forEach(function(e){e.off()}),t=[],localStorage.clear()},i}),define("global/models/player",["require","shared/classes/model_backends/localstorage","shared/classes/typing","registry"],function(e){"use strict";var t=e("shared/classes/model_backends/localstorage"),i=(e("shared/classes/typing"),e("registry"));return Backbone.Model.extend({idAttribute:"userID",defaults:{username:"",gender:"",contact:0,valid_email:0,displayName:"Guest Racer",title:"Accountless One",money:0,blogComments:0,totalComments:0,moneySpent:0,level:0,playTime:0,highestSpeed:0,avgSpeed:0,placed1:0,placed2:0,placed3:0,racesPlayed:0,experience:0,carID:9,carHueAngle:0,nitros:0,nitrosUsed:0,nitrosPurchased:0,achievementPoints:0,country:"",sessionPages:0,visits:"",sessionRaces:0,shares:0,speed:0,practices:0,referrals:0,profileFields:0,consecWins:0,consecDaysRaced:0,seasonField1:0,seasonField2:0,seasonField3:0,membership:"basic",lastLogin:0,wampusWins:0,requests:0,totalCars:0,soldCars:0,friendLimit:200,teamID:0,tag:"",tagColor:"",raceSounds:"none",lookingForTeam:0,paintJobs:0,profileViews:0,allowFriendRequests:1,teamApplications:0,longestSession:0,mysteryBoxes:0,memberDays:0,rewardCountdown:0,teamRole:"member"},initialize:function(){this.on("change:avgSpeed",function(){$.cookie(rot47("avgspeed"),this.get("avgSpeed"),{path:"/",domain:this.getCookieDomain()})}.bind(this))},setupGuest:function(){var e=$.cookie("ntuserguest");e||(e="g"+Math.random(),$.cookie("ntuserguest",e,{path:"/",domain:this.getCookieDomain()})),this.defaults.userID=e,this.defaults.avgSpeed=this.get("avgSpeed"),this.set(this.defaults)},isGuest:function(){return String(this.id).match(/^g/)},loginWithData:function(e){e.cars.length>0&&_.isArray(e.cars[0])&&(e.cars=e.cars.map(function(e){return{carID:e[0],status:e[1],hueAngle:e[2]}})),e.achievements.length>0&&_.isArray(e.achievements[0])&&(e.achievements=e.achievements.map(function(e){return{achievementID:e[0],completedStamp:e[1]}})),e.friends.length>0&&_.isNumber(e.friends[0])&&(e.friends=e.friends.map(function(e){return{userID:e}}));var s=i.get("playerCars");s.reset(e.cars,{silent:!0}),s.setBackend(new t("playerCars"),"model"),delete e.cars;var a=i.get("playerGarage");a.reset(_.map(e.garage,function(e){return{carID:e}}),{silent:!0}),a.setBackend(new t("playerGarage"),"model"),delete e.garage;var r=i.get("playerFriends");r.reset(e.friends,{silent:!0}),r.setBackend(new t("playerFriends"),"model"),delete e.friends;var n=i.get("playerAchievements");n.reset(e.achievements,{silent:!0}),n.setBackend(new t("playerAchievements"),"model"),delete e.achievements,e.rewardCountdown=Date.getUnixTime()+e.rewardCountdown,this.clear({silent:!0}),this.set(e,{silent:!0}),this.setBackend(new t("player"),"model"),this.setCachingCookie(e.membership)},setCachingCookie:function(e){var t=$.cookie("ntuserrem");if("gold"==e){var i=t.split("<");i[2]=2,t=i.join("<")}$.cookie("ntuserrem",t,{expires:1/24*2,path:"/",domain:this.getCookieDomain()}),$.cookie("PHPNTSESSION",$.cookie("PHPNTSESSION"),{expires:1/24*2,path:"/",domain:this.getCookieDomain()}),$.cookie($.cookie("PHPNTSESSION"),$.cookie($.cookie("PHPNTSESSION")),{expires:1/24*2,path:"/",domain:this.getCookieDomain()}),$.removeCookie("ntuserguest",{path:"/",domain:this.getCookieDomain()})},logout:function(e){e=e||{};var s=i.get("realtime");s&&s.end();var a=this.getCookieDomain();$.removeCookie("ntuserguest",{path:"/",domain:a}),$.removeCookie(rot47("avgspeed"),{path:"/",domain:a}),this.removeSessionCookies(),t.clear()},removeSessionCookies:function(){var e=this.getCookieDomain();$.removeCookie("ntuserrem",{path:"/",domain:e}),$.removeCookie($.cookie("PHPNTSESSION"),{path:"/",domain:e}),$.removeCookie("PHPNTSESSION",{path:"/",domain:e})},applyToTeam:function(e){return $.post("/api/teams/"+e+"/apply").done(function(){i.get("realtime").applyToTeam(e)}.bind(this))},inviteToTeam:function(e){return this.get("teamID")&&"officer"==this.get("teamRole")?$.post("/api/players/"+e+"/team-invite").done(function(t){t.success&&i.get("realtime").inviteToTeam(e,this.get("teamID"))}.bind(this)):$.Deferred().resolve()},addCar:function(e){var t={},s=i.get("playerCars"),a=s.get(e);t.carID=e,t.carHueAngle=0,this.set(t),a?a.set({status:"owned",hueAngle:0}):s.add({carID:e})},useCar:function(e,t){if(this.set({carID:e,carHueAngle:t}),!this.get("profileView"))return $.post("/api/cars/"+e+"/use")},requestFriend:function(e){return $.post("/api/friends/"+e+"/request").done(function(){i.get("realtime").requestFriend(e)})},report:function(e){return $.post("/api/players/"+e+"/report")},setSoundPrefs:function(e){if(this.set({raceSounds:e}),NTGLOBALS("LOGGED_IN"))return $.post("/api/settings/sounds/",{value:e})},getReward:function(){return $.get("/api/rewards/daily")},getPendingCashGifts:function(){return $.get("/api/items/cash-gifts")},getCookieDomain:function(){var e=location.hostname.split(".");return location.hostname.match(/nitrotype/)?"."+e[e.length-2]+"."+e[e.length-1]:location.hostname}})}),define("global/views/player_hover",["require","global/models/player","global/models/car","templates","registry"],function(e){"use strict";var t=e("global/models/player"),i=e("global/models/car"),s=e("templates"),a=e("registry");return Backbone.View.extend({className:"racer-hover",events:{mouseleave:"hide"},_initialize:function(){void 0===this.template&&(this.template=s("global","player_hover")),this.player=a.get("player"),this.model=new t,this.top3=a.get("top3Players"),this.listenTo(this.model,"change",this.render),$("body").append(this.el),this.inited=!0},render:function(){var e=this.model;this.model.id==this.player.id&&(e=this.player),this.$el.html(this.template({data:e.toJSON(),carImage:i.imageTag,formatDate:this.formatDate,cars:a.get("cars"),top3:this.top3,countries:NTGLOBALS("COUNTRIES")}))},show:function(e,t,i,s){this.inited||this._initialize(),e=$(e),this.model.clear({silent:!0}),this.model.set(t.toJSON());var a=237;s&&(this.model.set({robot:!0}),a=135),this.$el.css({top:e.offset().top+e.height()/2-a,left:e.offset().left+i}).show()},hide:function(e){$(e.relatedTarget).closest(this.el).length||this.$el.hide()},formatDate:function(e){return e?moment(new Date(1e3*e)).format("MMM D, YYYY"):"N/A"}})}),define("index/views/mini_scoreboard",["require","registry","global/views/scoreboard_table","scoreboard/collections/data","global/views/player_hover","templates"],function(e){"use strict";var t=e("registry"),i=e("global/views/scoreboard_table"),s=e("scoreboard/collections/data"),a=e("global/views/player_hover"),r=e("templates");return Backbone.View.extend({boards:{},text:{season:"Top Racers This Season",weekly:"Top Racers in the Last 7 Days",monthly:"Top Racers in the Last 30 Days",daily:"Top Racers in the Last 24 Hours"},times:["weekly"],timeIndex:-1,initialize:function(){void 0===this.template&&(this.template=r("index","mini_scoreboard")),this.playerHover=new a,this.player=t.get("player");var e;_.each(this.times,function(t){NTGLOBALS("SCOREBOARD_TOP3")[t]&&((e=new s(NTGLOBALS("SCOREBOARD_TOP3")[t])).time=t,e.board="points",e.grouping="racer",this.boards[t]=new i({model:e,hover:this.playerHover,headers:!0,noTop3:!0}))}.bind(this)),this.render()},render:function(){this.$el.html(this.template({times:this.times,text:this.text})),_.each(this.times,function(e){NTGLOBALS("SCOREBOARD_TOP3")[e]&&this.$(".time-"+e+" .scoreboard-table").append(this.boards[e].render().el)}.bind(this))},changeBoard:function(){this.$(".boards").velocity({bottom:-332},1e3,"easeIn",function(){}),setTimeout(this.changeBoard.bind(this),6e3)}})}),define("index/index",["require","index/views/mini_scoreboard"],function(e){"use strict";var t=e("index/views/mini_scoreboard");return Backbone.View.extend({el:"#app",initialize:function(){this.miniScoreboard=new t,this.render()},render:function(){this.$(".scoreboard-scroll-container").html(this.miniScoreboard.el)}})}),define("relogin/index",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.View.extend({el:"#app",initialize:function(){var e,i=t.get("player");if(e=location.hash?JSON.parse(decodeURIComponent(location.hash.replace("#",""))):$.getQueryParams(),window.detectAdb&&(e.adb=window.detectAdb()),e.tz=jstz.determine().name(),e.type)$.get("/api/login/"+e.type,e).done(function(e){if(e.success)i.loginWithData(e.data),e.data.new?window.location.href="/race":window.location.href="/garage";else{var t="Unable to log in";e.data&&(t=e.data.username?e.data.username:e.data.message),this.showMessage("Unable to log in","There was an error: "+t),console.log(e)}}.bind(this));else{if(!e.autologin)return void(location.href="/");$.post("/api/auth/autologin",{id:e.id}).done(function(e){e.success?(i.loginWithData(e.data),location.href="/garage"):alert("Failed to log in !")})}},loginMessage:function(){this.showMessage("Your session has expired",'Please <a href="#" class="login-link" style="text-decoration: underline">log back in</a>.')},showMessage:function(e,t){this.$(".section-header").velocity("fadeOut",function(){$(this).html(e).velocity("fadeIn")}),this.$(".content-box p").velocity("fadeOut",function(){$(this).html(t).velocity("fadeIn")})}})}),define("join/index",["require","templates","registry"],function(e){"use strict";var t=e("templates");e("registry");return Backbone.View.extend({el:".lookup",initialize:function(e){void 0===this.template&&(this.template=t("join","index")),NTGLOBALS("LOGGED_IN")?this.showMessage("You are already logged in.  This link is for creating new accounts."):$.post("/api/referrals/"+e.username).done(function(e){e.success?this.render(e.data.displayName):this.showMessage("Invalid referral link.  Unable to find a player with that username.")}.bind(this))},render:function(e){this.$el.velocity("fadeOut",function(){this.$el.html(this.template({displayName:e})).velocity("fadeIn")}.bind(this))},showMessage:function(e){this.$el.html("<p>"+e+"</p>")}})}),define("global/collections/invites",["require","global/models/player"],function(e){"use strict";var t=e("global/models/player");return Backbone.Collection.extend({model:t,comparator:function(e,t){return e.get("reward")&&!t.get("reward")?-1:t.get("reward")&&!e.get("reward")?1:e.get("createdStamp")>t.get("createdStamp")?-1:1},fetch:function(){this.trigger("request");var e=this;this.request=$.get("/api/referrals").done(function(t){e.request=null,t.success?e.reset(t.data):e.reset()})}})}),define("global/views/modal",["require"],function(e){"use strict";return Backbone.View.extend({options:{},className:"popup-base",events:{"click .close-button":"hide"},initialize:function(e){e=e||{},this.options=e,$("body div.wrap").append(this.el),this.$el.html('<div class="popup-overlay"></div>')},show:function(e){return this.showOptions=e||{},this.$el.velocity("fadeIn"),setTimeout(function(){this.$("input:eq(0)").focus()}.bind(this),0),!1},hide:function(){return this.$el.velocity("fadeOut",function(){this.showOptions&&this.showOptions.destroy&&this.remove()}.bind(this)),this.trigger("close"),!1},showError:function(e){this.$(".message").html(e)},isPending:function(){return this.pendingButton&&this.pendingButton.hasClass("pending")},startPendingMode:function(e){this.pendingButton=$(e),this.pendingButton.addClass("pending").prop("disabled",!0)},endPendingMode:function(){this.pendingButton&&this.pendingButton.removeClass("pending").prop("disabled",!1)}})}),define("global/views/invites",["require","templates","global/collections/invites","global/views/modal","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("global/collections/invites"),s=e("global/views/modal"),a=e("global/models/car"),r=e("registry");return s.extend({_initialize:function(){void 0===this.template&&(this.template=t("global","invites")),this.player=r.get("player"),this.model=new i,this.listenTo(this.model,"reset",this.render),this.inited=!0},render:function(){return this.$el.append(this.template({invites:this.model.toJSON(),username:this.player.get("username"),carPath:a.imageSrc})),this},show:function(){return this.inited||this._initialize(),0===this.model.length&&this.model.fetch(),s.prototype.show.apply(this,arguments)}})}),define("shared/classes/form_model",["require"],function(e){"use strict";return Backbone.Model.extend({url:"",initialize:function(){$.validator.addMethod("alphanum",function(e){return/^[a-zA-Z0-9]+$/.test(e)},"Can only contain letters and numbers")},validationRules:{},validationMessages:{},save:function(){var e="function"==typeof this.url?this.url():this.url;if(!e)throw new Error("You must specify a url for your FormModels");return $.post(e,this.toJSON())}})}),define("garage/models/survey_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/settings/survey",defaults:{field:"",value:""},validationRules:{value:{required:!0}},validationMessages:{}})}),define("shared/classes/form_validation",["require"],function(e){"use strict";var t=function(e,t,i,s,a,r){this.form=e,this.button=t,this.model=i,a&&(s=s.bind(a),r&&(r=r.bind(a))),this.successCallback=s||$.noop,this.errorCallback=r,this.setup()};return t.prototype.setup=function(){this.form.validate({submitHandler:_.bind(this.submitHandler,this),rules:this.model.validationRules||{},messages:this.model.validationMessages||{}});var e=this;this.button.click(function(t){t.preventDefault(),e.form.submit()})},t.prototype.submitHandler=function(){var e=this;if(!this.submitted){this.disableForm();var t={};_.each(this.form.serializeArray(),function(e){t[e.name]=e.value}),this.model.set(t),setTimeout(function(){e.model.save().done(function(t){if(t.success)e.successCallback(t.data,e.model,e.form);else{if(t.data){try{e.form.validate().showErrors(t.data)}catch(i){e.errorCallback?e.errorCallback(t.data,e.model,e.form):t.data&&t.data.message?alert("An error occurred!\n\nMessage: "+t.data.message+"\n\nIf this continues, please try logging out and back in, and if that does not fix it please contact support!"):window.onerror("validation.showErrors",location.href,0,0,{stack:JSON.stringify(t)})}var i=Object.keys(t.data)[0];e.form.find("[name="+i+"]").focus()}else alert("There was an error communicating with the server");e.enableForm()}})},300)}},t.prototype.disableForm=function(){this.submitted=!0,this.button.addClass("pending")},t.prototype.enableForm=function(){this.button.removeClass("pending"),this.submitted=!1},t}),define("garage/views/under_ad",["require","templates","global/views/invites","garage/models/survey_form","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("global/views/invites"),s=e("garage/models/survey_form"),a=e("shared/classes/form_validation");e("registry");return Backbone.View.extend({events:{"click .invite-link":"handleInviteClick"},initialize:function(e){void 0===this.template&&(this.template=t("garage","under_ad"))},render:function(){var e=!1;return this.model.get("profileView")||!NTGLOBALS("LOGGED_IN")||this.model.get("gender")&&this.model.get("country")||1!=Math.floor(3*Math.random())||(e=this.model.get("country")?"gender":"country"),this.$el.html(this.template({player:this.model.toJSON(),countries:NTGLOBALS("COUNTRIES"),showSurvey:e})),e&&new a(this.$("form[name=survey]"),this.$("form[name=survey] .button"),new s,this.surveyCallback,this),this},handleInviteClick:function(){return this.invites||(this.invites=new i),this.invites.show(),!1},surveyCallback:function(e,t){var i={};i[t.get("field")]=t.get("value"),this.model.set(i),this.$("form[name=survey]").velocity("fadeOut",function(){$(this).replaceWith("<p>Your profile has been updated!</p>").show()})}})}),define("analytics",["require"],function(e){"use strict";return{trackEvent:function(e,t,i,s){ga("send","event",e,t,i,s)},trackPage:function(e){ga("send","pageview",e)},customDimension:function(e,t){ga("set","dimension"+e,t)},customMetric:function(e,t){ga("set","metric"+e,t)},trackSale:function(e,t){ga("require","ecommerce"),ga("ecommerce:addTransaction",{id:e.transaction_id,affiliation:e.store,revenue:e.total,shipping:0,tax:0}),t&&t.forEach(function(t){ga("ecommerce:addItem",{id:e.transaction_id,name:t.product,sku:t.sku,category:t.category,price:t.price,quantity:t.quantity||1})}),ga("ecommerce:send")}}}),define("garage/models/sell_nitros",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/sell-nitros"},defaults:{password:"",quantity:10},validationRules:{password:{required:!0}}})}),define("garage/views/sell_nitros",["require","templates","analytics","global/views/modal","garage/models/sell_nitros","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/views/modal"),a=e("garage/models/sell_nitros"),r=e("shared/classes/form_validation"),n=e("registry");return s.extend({initialize:function(e){s.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .arrows a":"updateQuantity"})),this.formModel=new a,"standard"!=n.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),void 0===this.template&&(this.template=t("garage","sell_nitros")),this.player=e.player,this.render()},render:function(){return this.$el.append(this.template({player:this.player.toJSON(),quantity:this.formModel.get("quantity"),unitPrice:NTGLOBALS("NITRO_SALES_PRICE"),price:NTGLOBALS("NITRO_SALES_PRICE")*this.formModel.get("quantity")})),new r(this.$("form"),this.$(".sell-button"),this.formModel,this.sell,this,this.sellError),this},sellError:function(e){this.showError(e.message)},sell:function(e){n.get("player").set(e),i.trackEvent("Dealership","Sell Nitro",null,this.formModel.get("quantity")),this.hide()},updateQuantity:function(e){var t=10*Math.round((this.formModel.get("quantity")+($(e.currentTarget).is(".up")?10:-10))/10);return this.formModel.set({quantity:Math.max(10,Math.min(this.player.get("nitros"),t))}),this.$(".quantity-value").html("-"+this.formModel.get("quantity").addCommas()),this.$(".price-value").html("$"+(NTGLOBALS("NITRO_SALES_PRICE")*this.formModel.get("quantity")).addCommas()),!1}})}),define("garage/models/send_cash",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({initialize:function(){$.validator.addMethod("notEnoughCash",function(e){return e<=this.get("playersCash")*(1+this.get("feePercent"))}.bind(this),"You do not have enough cash!")},url:function(){return"/api/friends/"+this.get("recipient")+"/sendcash"},defaults:{amount:0,password:""},validationRules:{amount:{required:!0,number:!0,min:1e5,notEnoughCash:!0},password:{required:!0}},validationMessages:{amount:{min:"You can not send less than $100,000",notEnoughCash:"You do not have enough money!"}}})}),define("shared/classes/sound",["require","registry"],function(e){"use strict";var t,i=0,s=0,a="/dist/site/misc/sounds/",r=e("registry"),n=function(){if(!t){var e=new Audio,i=e.canPlayType("audio/ogg")?"ogg":null,s=e.canPlayType("audio/mp4")?"mp4":null;t=i||s||"mp3"}},o={sounds:{},play:function(e){"string"==typeof e&&(e={id:e}),e.loop=e.loop||!1,e.volume=e.volume||1,e.delay=e.delay||0,this.sounds[e.id]&&(this.sounds[e.id].volume=e.volume,this.sounds[e.id].loop=e.loop,e.muted&&this.mute(e.id),setTimeout(function(){this.sounds[e.id].play()}.bind(this),e.delay))},stop:function(e,t){t=t||!1;var i=this.sounds[e];i&&(t?createjs.Tween.get(i).to({volume:0},t).call(function(){this.stop(e)}.bind(this)):i.pause&&i.pause())},mute:function(e){this.sounds[e]&&(this.sounds[e].muted=!0)},unmute:function(e){this.sounds[e]&&(this.sounds[e].muted=!1)},preload:function(e,r,o){n(),t="mp3","blank"!=e&&i++,o=o||e;var l=function(){++s==i&&this.trigger("complete")}.bind(this);$.ajax(a+r+"/"+t+"/"+o+"."+t).done(function(){this.sounds[e]=new Audio(a+r+"/"+t+"/"+o+"."+t),"blank"!=o&&(s++,this.trigger("progress"),l())}.bind(this)).fail(function(e){"blank"!=o&&(this.trigger("error",e,o),l())}.bind(this))}},l={sounds:{},sources:{},gameSounds:null,inited:!1,initialize:function(){n();try{this.gameSounds=new WebAudiox.GameSounds}catch(e){return void(this.disabled=!0)}this.inited=!0,r.get("isMobile")&&(this.preload("blank","global"),$("body").one("touchstart",function(){this.play("blank")}.bind(this)))},play:function(e){if("string"==typeof e&&(e={id:e}),e.loop=e.loop||!1,e.volume=e.volume||1,e.delay=e.delay||0,this.sounds[e.id]){var t=function(){try{var t=this.sounds[e.id].play({loop:e.loop,volume:e.volume});t.defaultVolume=e.volume,this.sources[e.id]||(this.sources[e.id]=[]),this.sources[e.id].push(t),e.muted&&this.mute(e.id)}catch(e){console.error(e)}}.bind(this);e.delay?setTimeout(t,e.delay):t()}},stop:function(e,t){t=t||!1;var i=this.sources[e];if(i)try{i.forEach(function(e){t?createjs.Tween.get(e.gainNode.gain).to({value:0},t).call(function(){e.stop()}.bind(this)):e.stop()})}catch(e){console.error(e)}},mute:function(e){if(this.sources[e])try{this.sources[e].forEach(function(e){e.gainNode.gain.value=0})}catch(e){console.error(e)}},unmute:function(e){if(this.sources[e])try{this.sources[e].forEach(function(e){e.gainNode.gain.value=e.defaultVolume})}catch(e){console.error(e)}},preload:function(e,r,n){if(this.inited||this.initialize(),!this.disabled){"blank"!=e&&i++,n=n||e;var o=function(){++s==i&&this.trigger("complete")}.bind(this);try{this.gameSounds.createClip().load(a+r+"/"+t+"/"+n+"."+t,function(t){this.sounds[e]=t,"blank"!=n&&(s++,this.trigger("progress"),o())}.bind(this),function(e){"blank"!=n&&(this.trigger("error",e,n),o())}.bind(this))}catch(e){console.error(e)}}}};return window.AudioContext?_.extend(l,Backbone.Events):_.extend(o,Backbone.Events)}),define("garage/views/send_cash",["require","templates","analytics","global/views/modal","garage/models/send_cash","shared/classes/form_validation","shared/classes/sound","registry"],function(e){"use strict";var t=e("templates"),i=(e("analytics"),e("global/views/modal")),s=e("garage/models/send_cash"),a=e("shared/classes/form_validation"),r=e("shared/classes/sound"),n=e("registry");return i.extend({initialize:function(e){i.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=t("garage","send_cash")),this.events["change input[name=amount]"]="updateTransactionFee",this.delegateEvents(this.events),this.player=n.get("player"),this.recipient=e.recipient,this.model=new s,this.model.validationRules.amount.min=NTGLOBALS("CASH_SENDING").minimum,this.model.validationMessages.amount.min="You can not send less than $"+NTGLOBALS("CASH_SENDING").minimum.addCommas(),"standard"!=n.get("player").get("accountType")&&(this.model.validationRules.password.required=!1),this.model.set({playersCash:this.player.get("money"),recipient:this.recipient.id,feePercent:"basic"==this.player.get("membership")?NTGLOBALS("CASH_SENDING").feePercent:0}),this.render()},render:function(){return this.$el.append(this.template({recipient:this.recipient.toJSON(),player:this.player.toJSON(),minAmount:NTGLOBALS("CASH_SENDING").minimum,feePercent:NTGLOBALS("CASH_SENDING").feePercent})),new a(this.$("form"),this.$(".purchase-button"),this.model,this.send,this),this.updateTransactionFee(),this},send:function(e){r.play({id:"purchase",volume:.5}),n.get("realtime").sendCash(this.recipient.id,this.model.get("amount")),n.get("player").set(e),this.hide()},updateTransactionFee:function(){var e=parseInt(this.$("input[name=amount]").val(),10);!isNaN(e)&&e>0&&this.$(".transaction-fee").html(Math.round(e+e*this.model.get("feePercent")).addCommas())}})}),define("shared/classes/levels",["require"],function(e){"use strict";return{experienceForLevel:function(e){var t=NTGLOBALS("LEVEL_BASE_POINTS"),i=NTGLOBALS("LEVEL_MULTIPLE");return e=parseInt(e,10)-1,Math.floor(t*i*Math.pow(e,2)+t*e)},levelForExperience:function(e){var t=NTGLOBALS("LEVEL_BASE_POINTS"),i=NTGLOBALS("LEVEL_MULTIPLE");return e=parseInt(e,10),Math.floor((Math.sqrt(4*t*i*e+Math.pow(t,2))-t)/(2*t*i))+1}}}),define("global/views/experience_bar",["require","shared/classes/levels"],function(e){"use strict";var t=e("shared/classes/levels");return Backbone.View.extend({width:280,level:1,experience:0,initialize:function(e){this.options=e,this.width=parseInt(this.options.width,10)||this.width,this.level=parseInt(this.options.level,10),this.experience=parseInt(this.options.experience,10),this.render()},render:function(){if(this.options.loggedOut)$(this.el).css("background-size","0% 100%").html('You must <a class="login login-link" href="#">log in</a> or <a class="register register-link" href="#">sign up</a> to level up');else{var e=t.experienceForLevel(this.level),i=t.experienceForLevel(this.level+1),s=i-e,a=Math.round((this.experience-e)/s*100),r=i-this.experience;$(this.el).html('<span class="numbers">'+r.addCommas()+"</span> more exp to next level").css("background-size",a+"% 100%")}},animateTo:function(e,i){var s,a,r,n,o,l,c,h=t.levelForExperience(e),d=h-this.level,u=0,p=[],m="linear",g=this.$(".numbers");if(i=i||2e3,!(e<=this.experience)){if(d>0)for(;u<d;)this.level+u<h&&p.push(t.experienceForLevel(this.level+u+1)),u++;p.push(e),s=parseInt(i/p.length,10),u=0,(a=function(){0!==p.length&&(r=p.shift(),u>0?(this.$el.css("background-size","0% auto"),c=0):(g.countdown(t.experienceForLevel(h+1)-e,{formatter:Number.addCommas}),c=this.$el.css("background-size").split(" ")[0].replace("%","")),p.length>0?(m="linear",o=100):(m="swing",n=t.experienceForLevel(this.level+u+1)-1-t.experienceForLevel(this.level+u),l=e-t.experienceForLevel(this.level+u),o=Math.round(l/n*100)),$({exp:c}).animate({exp:o},{step:function(e){this.$el.css({"background-size":e+"% 100%"})}.bind(this),easing:m,duration:s,complete:a.bind(this)}),u++)}.bind(this))()}}})}),define("global/views/tooltip",["require"],function(e){"use strict";return Backbone.View.extend({className:"tooltip-hover",initialize:function(){this.$el.hide(),$("body").append(this.el)},show:function(e){var t=$(e.currentTarget);this.$el.html(t.data("tip")).css({left:t.offset().left-this.$el.outerWidth()/2+t.width()/2,top:t.offset().top-this.$el.outerHeight()-15}).velocity("fadeIn",200)},hide:function(){return this.$el.hide(),!1}})}),define("global/views/report_user",["require","global/views/tooltip","templates"],function(e){"use strict";var t=e("global/views/tooltip"),i=e("templates");return t.extend({className:"tooltip-hover tooltip-report",events:{"click .report":"report","click .cancel":"hide"},initialize:function(e){void 0===this.template&&(this.template=i("global","report_user")),this.player=e.player,t.prototype.initialize.apply(this),this.render()},render:function(){this.$el.html(this.template({}))},show:function(e,i){return!$(e.currentTarget).hasClass("done")&&(this.userID=i,this.target=e.target,t.prototype.show.apply(this,arguments))},report:function(){return this.hide(),this.player.report(this.userID),$(this.target).velocity("fadeOut",function(){$(this).html("Reported. Thanks!").addClass("done").velocity("fadeIn")}),!1}})}),define("garage/views/rewards",["require","global/views/modal","registry","global/models/car","shared/classes/levels","templates"],function(e){"use strict";var t=e("global/views/modal"),i=e("registry"),s=e("global/models/car"),a=e("shared/classes/levels"),r=e("templates");return t.extend({events:{"click .close-button":"close"},initialize:function(e){void 0===this.template&&(this.template=r("garage","rewards")),t.prototype.initialize.apply(this,arguments),this.render()},show:function(){t.prototype.show.apply(this,arguments);var e=i.get("player");e.getReward().done(function(t){t.success?(this.showCloseButtons(),t.data.reward?(this.showReward(t.data.type,t.data.value),this.reward=t.data):(e.set({rewardCountdown:Date.getUnixTime()+t.data.next}),this.showNotReady(t.data.next))):(alert("There was an error fetching your reward.  Please refresh the page and try again"),this.hide())}.bind(this))},render:function(){this.$el.append(this.template({}))},showCloseButtons:function(){this.$(".close-button").velocity("fadeIn",{display:"block"})},close:function(){if(this.reward){var e=i.get("player");e.set({mysteryBoxes:e.get("mysteryBoxes")+1,rewardCountdown:Date.getUnixTime()+this.reward.next}),this.reward.reward&&("money"==this.reward.type?e.inc({money:this.reward.value}):"nitros"==this.reward.type?e.inc({nitros:this.reward.value}):"experience"==this.reward.type?(e.inc({experience:this.reward.value}),e.set({level:a.levelForExperience(e.get("experience"))})):"car"==this.reward.type&&e.addCar(this.reward.value))}return this.hide(),!1},showReward:function(e,t){var i="";"money"==e?i="$"+Number(t).addCommas():"nitros"==e?i=t+" nitros":"experience"==e?i=Number(t).addCommas()+" XP":"car"==e&&(i="a new car");var a=this.$(".reward-image").addClass(e).css({transform:"scale(0.0)"});"car"==e&&a.css({backgroundImage:"url("+s.imageSrc("large",t)+")"}),this.$(".reward-value").html(i),this.$(".wait").hide(),this.$(".reward-info").velocity("fadeIn",function(){a.velocity({scale:[1,0],rotateZ:[1080,0]},{duration:1e3}).velocity({top:"-=10"},{duration:1500,easing:"easeInOutQuad",loop:5})})},showNotReady:function(e){this.$(".countdown-timer").html(Number(e).countdownSeconds()),this.$(".wait").hide(),this.$(".not-ready").velocity("fadeIn",{display:"block"})}})}),define("garage/views/player_info",["require","templates","analytics","global/models/car","garage/views/sell_nitros","garage/views/send_cash","global/views/experience_bar","global/views/report_user","garage/views/rewards","registry","shared/classes/sound"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/models/car"),a=e("garage/views/sell_nitros"),r=e("garage/views/send_cash"),n=e("global/views/experience_bar"),o=e("global/views/report_user"),l=e("garage/views/rewards"),c=e("registry"),h=e("shared/classes/sound");return Backbone.View.extend({events:{"click .sell-nitros-button":"showSellNitros","click .add-friend":"addFriend","click .invite-to-team":"inviteToTeam","click .report-player a":"showReportPlayer","click .claim-button":"claimReward","click .send-cash":"sendCash"},initialize:function(e){void 0===this.template&&(this.template=t("garage","player_info")),this.friends=e.friends,this.reportUser=new o({player:this.model}),this.listenTo(this.model,"change:carID",this.changeCar),this.listenTo(this.model,"change:money",this.changeMoney),this.listenTo(this.model,"change:nitros",this.changeNitros),this.listenTo(this.model,"change:experience",this.changeExperience),this.listenTo(this.model,"change:level",this.changeLevel),h.preload("swoosh","global"),h.preload("purchase","global")},render:function(){var e=this.model.toJSON(),t=c.get("cars");return this.$el.html(this.template({player:e,friends:this.friends,car:t.get(parseInt(this.model.get("carID"),10)).toJSON(),carImage:s.imageTag,top3:c.get("top3Players"),viewer:c.get("player").toJSON(),self:c.get("player").get("userID")==e.userID,maxFriends:c.get("player").get("friendLimit")<=c.get("playerFriends").totalFriends(),loggedIn:NTGLOBALS("LOGGED_IN"),countries:NTGLOBALS("COUNTRIES"),rewardCountdown:this.rewardCountdown()})),!e.profileView&&NTGLOBALS("LOGGED_IN")&&this.updateRewardCountdown(),this.model.get("profileView")||(this.experienceBar=new n({width:280,el:this.$(".experience-bar"),level:this.model.get("level"),experience:this.model.get("experience"),loggedOut:!this.model.get("profileView")&&!NTGLOBALS("LOGGED_IN")})),this},claimReward:function(){return this.$(".countdown-claim").velocity("fadeOut"),(new l).show(),!1},updateRewardCountdown:function(){this.rewardCountdownEle||(this.rewardCountdownEle=this.$(".reward-countdown"));var e=this.rewardCountdown();e<=0?(this.$(".countdown-timer").fastHide(),this.$(".countdown-claim").fastShow()):(this.rewardCountdownEle.html(e.countdownSeconds()),setTimeout(this.updateRewardCountdown.bind(this),1e3))},rewardCountdown:function(){return this.model.get("rewardCountdown")-Date.getUnixTime()},changeMoney:function(){this.$(".player-money .numbers").countdown(this.model.get("money"),{formatter:Number.addCommas}),h.play({id:"purchase",volume:.5})},changeNitros:function(){this.$(".player-nitros").countdown(this.model.get("nitros"),{formatter:Number.addCommas})},changeExperience:function(){this.$(".player-experience").countdown(this.model.get("experience"),{formatter:Number.addCommas}),this.experienceBar.animateTo(this.model.get("experience"))},changeLevel:function(){this.$(".player-level").countdown(this.model.get("level"))},changeCar:function(){var e=$(window).width();this.$(".player-car-name").html(c.get("cars").get(this.model.get("carID")).get("name"));var t=this;this.$(".player-car").finish().css({left:280}).velocity({left:-1*e/2},250,"easeInExpo",function(){$(this).html(s.imageTag("large",t.model.get("carID"),t.model.get("carHueAngle"))).css("left",e/2+135).velocity({left:280},250,"easeOutExpo")}),h.play({id:"swoosh",volume:.5})},showSellNitros:function(e){return new a({player:this.model}).show({destroy:!0}),!1},sendCash:function(){return c.get("player").get("level")<NTGLOBALS("CASH_SENDING").minLevel&&!c.get("player").get("admin")&&!c.get("player").get("moderator")?(alert("You must be at least level "+NTGLOBALS("CASH_SENDING").minLevel+" to send cash to friends."),!1):(new r({recipient:this.model}).show({destroy:!0}),!1)},addFriend:function(){var e=this.$(".add-friend");return!(e.hasClass("button-pending")||!e.hasClass("button-green"))&&(i.trackEvent("Friends","Request","racer profile"),c.get("player").requestFriend(this.model.id),e.addClass("button-pending").removeClass("button-green").text("Sent").attr("disabled","disabled"),!1)},inviteToTeam:function(){var e=this.$(".invite-to-team");return!e.hasClass("button-pending")&&(e.addClass("button-pending"),i.trackEvent("Team","Invite","racer profile"),c.get("player").inviteToTeam(this.model.id).always(function(){e.removeClass("button-green").text("Sent").attr("disabled","disabled")}.bind(this)),!1)},showReportPlayer:function(e){return this.reportUser.show(e,this.model.id),!1}})}),define("global/collections/cars",["require","global/models/car"],function(e){"use strict";var t=e("global/models/car");return Backbone.Collection.extend({model:t,comparator:function(e){return("00000"+e.get("level")).slice(-5)+"-"+e.get("name")}})}),define("garage/collections/garage",["require"],function(e){"use strict";return Backbone.Collection.extend({})}),define("stats/collections/stats",["require"],function(e){"use strict";return Backbone.Collection.extend({url:"/api/stats/summary",model:Backbone.Model.extend({idAttribute:"board"})})}),define("global/views/chart",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({options:{scaleGridLineColor:"rgba(110,115,121,0.3)",scaleShowLabels:!1,pointDotRadius:5,pointDotStrokeWidth:2,pointHitDetectionRadius:0,datasetStrokeWidth:7,bezierCurve:!1,showTooltips:!0,tooltipFillColor:"#2d8acd",tooltipFontColor:"#ffffff",showLabels:!1},dataset:{labels:[],data:[]},initialize:function(e){void 0===this.template&&(this.template=t("global","chart")),e.width=e.width||this.width||548,e.height=e.height||this.height||100,e.type=(e.type||this.type||"line").ucFirst(),this.setOptions(e)},setData:function(e,t){(t=t||{}).data=e,this.dataset=t},setOptions:function(e){_.extend(this.options,e)},render:function(){if(this.$el.html(this.template({options:this.options,data:this.dataset.data})),this.dataset.data.length>0){var e=this.$("canvas")[0],t=e.getContext("2d"),i=_.pluck(this.dataset.data,"label");2==window.devicePixelRatio&&(e.width=this.options.width,e.height=this.options.height,e.style.width=this.options.width/2+"px",e.style.height=this.options.height/2+"px",t.scale(2,2)),new Chart(t)[this.options.type]({labels:i,datasets:[this.dataset]},this.options)}}})}),define("stats/views/racelog_graph",["require","global/views/chart","shared/classes/typing"],function(e){"use strict";var t=e("global/views/chart"),i=e("shared/classes/typing");return t.extend({placeColors:["fee78b","cecece","9b671c","2d8acd"],getPointColor:function(e){return"#"+(this.placeColors[e-1]||this.placeColors[this.placeColors.length-1])},getPlaceText:function(e){return e+e.ordinal()},initialize:function(e){(e=e||{}).tooltipTemplate=function(e){var t=this.dataset.data[e.index];return t.value+" WPM   "+this.getPlaceText(t.place)+" Place   "+i.accuracy(t.typed,t.errs,2)+"% Acc"}.bind(this),t.prototype.initialize.call(this,e)},setData:function(e){var i={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};e=_.map(e,function(e){return e.label="",e.pointColor=this.getPointColor(e.place),e},this),t.prototype.setData.call(this,e,i)}})}),define("stats/views/daily_graph",["require","global/views/chart"],function(e){"use strict";var t=e("global/views/chart");return t.extend({initialize:function(e){(e=e||{}).tooltipTemplate=function(e){var t=this.dataset.data[e.index];return t.date+"   "+t.races+" Race"+(1==t.races?"":"s")+"   Avg "+t.value+" WPM"}.bind(this),t.prototype.initialize.call(this,e)},setData:function(e){var i={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};e=_.map(e,function(e){var t=moment(new Date(1e3*e.stamp));return e.date=t.format("MMM D, YYYY"),e.pointColor="#2d8acd",e.label="",e},this),t.prototype.setData.call(this,e,i)}})}),define("stats/views/monthly_graph",["require","global/views/chart"],function(e){"use strict";var t=e("global/views/chart");return t.extend({initialize:function(e){(e=e||{}).tooltipTemplate=function(e){var t=this.dataset.data[e.index];return t.date+"   "+t.races+" Race"+(1==t.races?"":"s")+"   Avg "+t.value+" WPM"}.bind(this),t.prototype.initialize.call(this,e)},setData:function(e){var i={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};e=_.map(e,function(e){var t=moment(new Date(e.year,e.month-1,1));return e.date=t.format("MMM, YYYY"),e.pointColor="#2d8acd",e.label="",e},this),t.prototype.setData.call(this,e,i)}})}),define("stats/views/problemkeys_graph",["require","global/views/chart"],function(e){"use strict";var t=e("global/views/chart");return t.extend({initialize:function(e){(e=e||{}).type="bar",e.tooltipTemplate="<%=label%> was typed incorrectly <%=value%>% of the time",t.prototype.initialize.call(this,e)},setData:function(e){var i={fillColor:"rgba(45,138,205,0.5)",strokeColor:"#2d8acd"};t.prototype.setData.call(this,e,i)}})}),define("global/views/stats",["require","registry","templates","stats/collections/stats","stats/views/racelog_graph","stats/views/daily_graph","stats/views/monthly_graph","stats/views/problemkeys_graph","shared/classes/typing"],function(e){"use strict";var t=e("registry"),i=e("templates"),s=e("stats/collections/stats"),a=e("stats/views/racelog_graph"),r=e("stats/views/daily_graph"),n=e("stats/views/monthly_graph"),o=e("stats/views/problemkeys_graph"),l=e("shared/classes/typing");return Backbone.View.extend({events:{"click .graph-options a":"handleSwitchGraph"},graphType:"racelog",cachedData:{},initialize:function(e){void 0===this.template&&(this.template=i("global","stats"),this.statsTemplate=i("global","stats_summary")),this.player=t.get("player"),this.username=e.username,this.racingStats=new s(this.model.get("racingStats")),this.model.get("raceLogs")&&(this.cachedData.racelog=this.model.get("raceLogs")),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),dateFormat:this.dateFormat,typing:l,username:this.username,loggedIn:NTGLOBALS("LOGGED_IN")})),this.showStats(),this.showGraph()},dateFormat:function(e){return e?moment(new Date(1e3*e)).format("MMM D, YYYY"):"Not a Member"},handleSwitchGraph:function(e){return!$(e.target).hasClass("active")&&(this.graphType=$(e.target).data("id"),this.$(".graph-options a").removeClass("active"),$(e.target).addClass("active"),"problemkeys"==this.graphType?this.$(".racer-logs-link").velocity("fadeOut"):this.$(".racer-logs-link").html($(e.target).html()+" History &raquo;").attr("href","/racelog/"+this.graphType).velocity("fadeIn"),this.showGraph(),!1)},renderStats:function(){this.$("#stats-summary").html(this.statsTemplate({stats:_.indexBy(this.racingStats.toJSON(),function(e){return e.board}),typing:l}))},showStats:function(){!NTGLOBALS("LOGGED_IN")||this.model.get("profileView")||Date.now()-this.player.get("_racingStatsStamp")<6e5?this.renderStats():this.racingStats.fetch().done(function(){this.player.set({racingStats:this.racingStats.toJSON(),_racingStatsStamp:Date.now()}),this.renderStats()}.bind(this))},showGraph:function(){if(NTGLOBALS("LOGGED_IN")||this.model.get("profileView")){var e,t=140;this.graph&&this.graph.remove(),"problemkeys"==this.graphType?(e=o,t=90):e="racelog"==this.graphType?a:"lastdays"==this.graphType?r:n,this.graph=new e({width:548,height:t}),this.$(".race-chart").append(this.graph.el),this.cachedData[this.graphType]?(this.graph.setData(this.cachedData[this.graphType]),this.graph.render()):$.get("/api/stats/graphs/"+this.graphType).done(function(e){e.success?(this.cachedData[this.graphType]=e.data,"racelog"==this.graphType&&this.model.set({raceLogs:e.data}),this.graph.setData(e.data),this.graph.render()):alert("Unable to access graph data: "+e.data.message)}.bind(this))}}})}),define("achievements/models/achievement",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.Model.extend({idAttribute:"achievementID",defaults:{active:0,desc:"",gid:0,hidden:0,name:"",points:0,reward:"",newCarThumbs:null,rewardDesc:"",ruleGroup:"",rules:"",completedStamp:0},prettyCompletedStamp:function(){return $.timeago(1e3*this.get("completedStamp"))},icon:function(){return JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT))[this.get("rules")[0].field].icon},progress:function(){var e,i,s,a,r,n=[],o=this.get("rules"),l=JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT)),c=t.get("player");return _.each(o,function(t,o){if(l[t.field]&&"carID"!=t.field){switch(a=c.get(t.field),r=t.value,o>0&&("gt"==t.comparison||"gte"==t.comparison)&&a>=r&&(a=Math.min(a,r)),e=l[t.field].prefix||"",i=l[t.field].suffix||"",s=l[t.field].format||null){case"minutes":a=Math.round(a/60),r=Math.round(r/60);break;case"speed":i="wpm"}l=l[t.field].text,a="eq"==t.comparison?a:Number(a).addCommas(),n.push(e+a+i+("gt"==t.comparison||"gte"==t.comparison?" / "+e+Number(r).addCommas()+i:"")+" "+l)}}),n.length>0?n[0]:""},progressPercent:function(){var e=this.get("rules"),i=t.get("player");if("gt"!=e[0].comparison&&"gte"!=e[0].comparison)return 0;var s=i.get(e[0].field),a=e[0].value;return Math.round(s/a*100)},checkIfComplete:function(e){var t,i,s,a=this.get("rules"),r=0;if(!this.get("active"))return!1;for(i=0,t=a.length,0;i<t;i++)switch(s=parseInt(e[a[i].field]||0,10),a[i].comparison){case"eq":r+=s==parseInt(a[i].value,10)||e[a[i].field]===a[i].value?1:0;break;case"ne":r+=s!=parseInt(a[i].value,10)?1:0;break;case"gt":r+=s>parseInt(a[i].value,10)?1:0;break;case"gte":r+=s>=parseInt(a[i].value,10)?1:0;break;case"lt":r+=s<parseInt(a[i].value,10)?1:0;break;case"lte":r+=s<=parseInt(a[i].value,10)?1:0;break;default:"undefined"!=typeof console&&console.log("Unknown comparison in achievement: "+this.id+", comp: "+a[i].comparison);continue}return r==t}})}),define("achievements/collections/achievements",["require","achievements/models/achievement","analytics","registry"],function(e){"use strict";var t=e("achievements/models/achievement"),i=e("analytics"),s=e("registry"),a=Backbone.Collection.extend({model:t,comparator:function(e){return this.sortOrder?e.get(this.sortOrder):e.get("ruleGroup")+"-"+("00000"+e.get("points")).slice(-5)+"-"+e.get("name")},filterByGroupId:function(e){return this.filter(function(t){return t.get("gid")==e&&(1==t.get("active")||t.get("completedStamp")>0)&&(0===t.get("hidden")||t.get("completedStamp")>0)})},setCompleted:function(e){e.each(function(e){this.get(e.id).set({completedStamp:e.get("completedStamp")})},this)},getRecentlyCompleted:function(e){e=e||3;var t=new a;return t.sortOrder="createdStamp",t.add(_.chain(this.toJSON()).filter(function(e){return e.completedStamp>0}).sortBy(function(e){return-1*e.completedStamp}).first(e).value()),t}},{check:function(){if(NTGLOBALS("LOGGED_IN")&&!this.paused){var e,t,a=s.get("player").toJSON(),r=s.get("playerAchievements"),n=s.get("achievements"),o=[],l=s.get("player");n.each(function(e){r.get(e.id)||e.checkIfComplete(a)&&o.push(e.id)},this),o.length&&$.post("/api/achievements/check/",{ids:o}).done(function(a){a.success&&(a=a.data,_.size(a.achieved)>0&&_.each(a.achieved,function(a,o){e=n.get(o),t=e.get("reward"),r.add({achievementID:e.id,completedStamp:a}),"car"==t.type&&s.get("playerCars").add({carID:t.value}),"title"==t.type&&l.set({title:t.value}),i.trackEvent("Achievements","Achieved",e.get("name"))}.bind(this)),l.set(a.user))})}},pause:function(e){this.paused=e,this.paused||this.check()}});return a}),define("garage/views/gold_gift",["require","templates","global/views/modal","registry"],function(e){"use strict";var t=e("templates"),i=e("global/views/modal"),s=e("registry");return i.extend({_initialize:function(){void 0===this.template&&(this.template=t("garage","gold_gift")),this.player=s.get("player"),this.inited=!0},render:function(){return this.$el.append(this.template({from:this.player.get("goldgift")})),this.player.unset("goldgift"),this},show:function(){return this.inited||this._initialize(),this.render(),i.prototype.show.apply(this,arguments)}})}),define("garage/views/cash_gift",["require","templates","global/views/modal","registry"],function(e){"use strict";var t=e("templates"),i=e("global/views/modal"),s=e("registry");return i.extend({_initialize:function(e){void 0===this.template&&(this.template=t("garage","cash_gift")),this.player=s.get("player"),this.inited=!0},render:function(){return this.$el.append(this.template({data:this.options.data})),this},show:function(){return this.inited||this._initialize(),this.render(),i.prototype.show.apply(this,arguments)},hide:function(){return this.player.inc({money:this.options.data.amount}),i.prototype.hide.apply(this,arguments)}})}),define("garage/models/garage_spot",["require"],function(e){"use strict";return Backbone.Model.extend({defaults:{spot_id:null,car_id:null},idAttribute:"spot_id"})}),define("garage/collections/garage_spots",["require","garage/models/garage_spot","global/collections/cars","registry"],function(e){"use strict";var t=e("garage/models/garage_spot"),i=e("global/collections/cars"),s=e("registry");return Backbone.Collection.extend({model:t,comparator:"spot_id",setPlayer:function(e,t,i){var a=_.where(i.toJSON(),{status:"owned"});this.playerGarage=t,t=t.pluck("carID"),this.allCars=s.get("cars"),this.setCars(t,a,e)},setCars:function(e,t,s){t=new i(t);var a;for(a=e.length-1;a>=0&&(null===e[a]||""===e[a]);a--)e.pop();e=_.map(e,function(e){return Number(e)||null});var r;_.each(e,function(i,s){i&&(r=parseInt(i,10),t.get(r)||(e[s]=null))}),t.each(function(t){var i=t.toJSON();if(-1==e.indexOf(parseInt(i.carID,10))){var s=e.indexOf(null);-1==s?e.push(i.carID):e[s]=i.carID}});var n={};_.each(e,function(t,i){n[t]?e[i]=null:n[t]=!0});var o=e.length%30,l=e.length+(30-o);a=e.length;var c=!1;if(0===o?_.each(e,function(e){null!==e&&""!==e||(c=!1)}):c=!0,c)for(a;a<l;a++)e.push(null);this.playerGarage.reset(_.map(e,function(e){return{carID:e}}));var h,d=[],u=null;_.each(e,function(e,i){h=null,u=null,e&&(h=this.allCars.get(e).get("name"),u=t.get(e).get("hueAngle")),d[i]={spot_id:i,car_id:e,name:h,hue_angle:u,active:e==s.get("carID")}}.bind(this)),this.reset(d,{silent:!0})},saveCars:function(){var e=this.toJSON(),t=[];return _.each(e,function(e){t.push(e.car_id)}),$.post("/api/cars-arrange",{garage:t}),t},swapCars:function(e,t,i,s){var a=this.findWhere({spot_id:parseInt(e,10)}),r=this.findWhere({spot_id:parseInt(i,10)});t=t?parseInt(t,10):null,s=s?parseInt(s,10):null;var n=a.toJSON(),o=r.toJSON();a.set({car_id:s,name:o.name,hue_angle:o.hue_angle,active:o.active},{silent:!0}),r.set({car_id:t,name:n.name,hue_angle:n.hue_angle,active:n.active},{silent:!0}),this.trigger("change")},setActiveCar:function(e){e=parseInt(e,10);var t=this.findWhere({active:!0});t&&t.set({active:!1},{silent:!0});var i=this.get(e);i&&i.set({active:!0},{silent:!0})}})}),define("garage/views/spots",["require","templates","global/models/car"],function(e){"use strict";var t=e("templates"),i=e("global/models/car");return Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=t("garage","spots")),this.listenTo(this.collection,"change",this.render)},render:function(){var e={spots:this.collection.toJSON(),carStyle:i.imageBackgroundCSS};return this.$el.html(this.template(e)),this}})}),define("garage/models/sell_car",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/cars/"+this.get("carID")+"/sell"},defaults:{password:""},validationRules:{password:{required:!0}}})}),define("garage/views/sell_car",["require","templates","analytics","registry","global/views/modal","garage/models/sell_car","shared/classes/form_validation","global/models/car"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("registry"),a=e("global/views/modal"),r=e("garage/models/sell_car"),n=e("shared/classes/form_validation"),o=e("global/models/car");return a.extend({initialize:function(e){a.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=t("garage","sell_car")),this.formModel=new r,"standard"!=s.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.formModel.set({carID:this.model.id}),this.hueAngle=e.hueAngle,this.player=e.player,this.render()},render:function(){var e=this.player.toJSON(),t=this.model.toJSON();return this.$el.append(this.template({data:t,hueAngle:this.hueAngle,player:e,sellPrice:Math.round(.6*t.price),discountText:"",carSrc:o.imageSrc})),new n(this.$("form"),this.$(".sell-button"),this.formModel,this.sell,this,this.sellError),this},sellError:function(e){this.showError(e.message)},sell:function(e){s.get("playerCars").get(this.model.id).set({status:"sold",hueAngle:0}),s.get("player").set(e),i.trackEvent("Dealership","Sell Car",this.model.get("name"),.6*this.model.get("price")),this.hide()}})}),define("garage/views/car_picker",["require","templates","garage/collections/garage_spots","garage/views/spots","garage/views/sell_car","registry"],function(e){"use strict";var t=e("templates"),i=e("garage/collections/garage_spots"),s=e("garage/views/spots"),a=e("garage/views/sell_car"),r=e("registry");return Backbone.View.extend({$activeCar:null,$draggingCar:null,draggingCarOffset:null,hoveredCarId:null,editMode:!1,canChangeEditMode:!0,events:{"click #editMode":"toggleEditMode","mouseover .spot":"mouseOver","mouseout .spot":"mouseOut","mousedown .spot":"mouseDown",mouseup:"mouseUp","click .spot":"selectCar","click .sell-button":"showSellCar"},initialize:function(e){void 0===this.template&&(this.template=t("garage","car_picker")),this.playerGarage=e.playerGarage,this.playerCars=e.playerCars,this.listenTo(this.playerCars,"change",this.playerCarsChanged),this.listenTo(this.playerCars,"add",this.playerCarsChanged),this.collection=new i,this.collection.setPlayer(this.model,this.playerGarage,this.playerCars);var s=this;$(document).mousemove(function(e){s.$draggingCar&&s.$draggingCar.css({left:Math.round(e.pageX-s.draggingCarOffset.left),top:Math.round(e.pageY-s.draggingCarOffset.top)})})},render:function(){this.$el.html(this.template({player:this.model.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN")}));var e=new s({collection:this.collection});return this.$(".car-picker").html(e.render().el),this},playerCarsChanged:function(){this.collection.setPlayer(this.model,this.playerGarage,this.playerCars),this.render()},mouseOver:function(e){this.editMode&&(this.activeSpotId=$(e.currentTarget).data("id"))},mouseOut:function(e){this.editMode&&(this.activeSpotId=null)},mouseDown:function(e){e.preventDefault(),this.editMode&&$(e.currentTarget).find(".car").data("id")&&(this.$activeCar=$(e.currentTarget),this.$draggingCar=this.$activeCar.find(".car").clone(!1),this.$draggingCar.addClass("dragging"),this.$draggingCar.appendTo(this.$el.find(".car-picker")),this.draggingCarOffset=this.$draggingCar.offset(),this.draggingCarOffset.left+=Math.round(this.$draggingCar.find(".image").height()/2),this.draggingCarOffset.top+=Math.round(this.$draggingCar.find(".image").width()/2),this.$draggingCar.css({left:this.$activeCar.offset().left-this.$el.find(".car-picker").offset().left,top:this.$activeCar.offset().top-this.$el.find(".car-picker").offset().top}),this.$activeCar.addClass("moving"),this.$el.find(".car-picker").addClass("drag"))},mouseUp:function(e){if(this.editMode&&this.$activeCar){if(null!==this.activeSpotId){var t=this.activeSpotId,i=this.$activeCar.data("id"),s=this.$el.find('.spot[data-id="'+i+'"]').find(".car").data("id")||null,a=this.$el.find('.spot[data-id="'+t+'"]').find(".car").data("id")||null;this.collection.swapCars(i,s,t,a)}this.$activeCar.removeClass("moving"),this.$activeCar=null,this.$draggingCar&&(this.$draggingCar.remove(),this.$draggingCar=null,this.draggingCarOffset=null),this.$el.find(".car-picker").removeClass("drag")}},toggleEditMode:function(e){if(e.preventDefault(),this.canChangeEditMode)if(this.editMode=!this.editMode,this.editMode)$(e.currentTarget).text("Save Cars"),this.$(".owned-cars").addClass("edit-mode"),this.$("#editFade").velocity("fadeIn",500);else{$(e.currentTarget).text("Re-arrange Cars"),this.$(".owned-cars").removeClass("edit-mode"),this.$("#editFade").velocity("fadeOut",500);var t=this.collection.saveCars();this.playerGarage.reset(_.map(t,function(e){return{carID:e}}))}},selectCar:function(e){if(!this.editMode){var t=parseInt($(e.currentTarget).find(".car").data("id"),10),i=parseInt($(e.currentTarget).find(".car").data("angle"),10)||0;if($(e.currentTarget).hasClass("empty")||this.model.get("carID")==t)return;this.$el.find(".spot.active").removeClass("active"),$(e.currentTarget).addClass("active"),this.model.useCar(t,i);var s=parseInt($(e.currentTarget).data("id"),10);this.collection.setActiveCar(s)}},showSellCar:function(e){var t=this.model,i=r.get("cars").get($(e.target).parents(".car").data("id")),s=r.get("playerCars").get(i.id).get("hueAngle");return new a({player:t,model:i,hueAngle:s}).show({destroy:!0}),!1}})}),define("garage/index",["require","garage/views/under_ad","garage/views/player_info","registry","global/models/player","global/collections/cars","garage/collections/garage","global/views/stats","achievements/collections/achievements","garage/views/gold_gift","garage/views/cash_gift","garage/views/car_picker"],function(e){"use strict";var t=e("garage/views/under_ad"),i=e("garage/views/player_info"),s=e("registry"),a=e("global/models/player"),r=e("global/collections/cars"),n=e("garage/collections/garage"),o=e("global/views/stats"),l=e("achievements/collections/achievements"),c=e("garage/views/gold_gift"),h=e("garage/views/cash_gift"),d=e("garage/views/car_picker");return Backbone.View.extend({el:"#app",initialize:function(e){(e=e||{}).username?(this.model=new a(NTGLOBALS("RACER_INFO")),this.playerCars=new r(NTGLOBALS("RACER_INFO").cars.map(function(e){return{carID:e[0],status:e[1],hueAngle:e[2]}})),this.playerGarage=new n(_.map(NTGLOBALS("RACER_INFO").garage,function(e){return{carID:e}}))):(this.model=s.get("player"),this.playerCars=s.get("playerCars"),this.playerGarage=s.get("playerGarage"),this.model.get("goldgift")&&(this.goldGift=new c),this.model.get("cashgift")?this.model.getPendingCashGifts().done(function(e){e.data.length&&(this.model.set({pendingCashGifts:e.data}),this.showCashGifts()),this.model.set({cashgift:null})}.bind(this)):this.model.get("pendingCashGifts")&&this.showCashGifts()),this.playerFriends=s.get("playerFriends"),this.playerInfo=new i({model:this.model,friends:this.playerFriends}),this.playerCars.length>0&&(this.carPicker=new d({model:this.model,playerCars:this.playerCars,playerGarage:this.playerGarage})),e.username?this.statsView=new o({model:this.model,username:e.username}):this.underAd=new t({model:this.model}),this.render()},render:function(){this.$el.find("#profileView").append(this.playerInfo.render().el),this.carPicker&&this.$(".owned-cars").append(this.carPicker.render().el),this.underAd&&this.$(".under-ad").append(this.underAd.render().el),this.statsView&&this.$(".stats-view").append(this.statsView.el),this.goldGift&&this.goldGift.show(),"#die"==location.hash&&this.monkey()},showCashGifts:function(){var e=this.model.get("pendingCashGifts");if(!e||0===e.length)return this.model.set({pendingCashGifts:null}),void l.pause(!1);l.pause(!0);var t=e.pop();this.model.set({pendingCashGifts:e});var i=new h({data:t});i.show(),i.on("close",this.showCashGifts.bind(this))}})}),define("dealership/models/paint_car",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/cars/"+this.get("carID")+"/paint"},defaults:{angle:0,password:""},validationRules:{password:{required:!0}}})});var Pixastic=function(){function e(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)}function t(e,t,s){var a=new Array;null==t&&(t=document),null==s&&(s="*");var r=t.getElementsByTagName(s),n=r.length,o=new RegExp("(^|\\s)"+e+"(\\s|$)");for(i=0,j=0;i<n;i++)o.test(r[i].className)&&(a[j]=r[i],j++);return a}function s(e,t){if(Pixastic.debug)try{switch(t){case"warn":console.warn("Pixastic:",e);break;case"error":console.error("Pixastic:",e);break;default:console.log("Pixastic:",e)}}catch(e){}}"undefined"!=typeof pixastic_parseonload&&pixastic_parseonload&&function(t){var i=!1,s=function(){i||(i=!0,t())};document.write('<script defer src="//:" id="__onload_ie_pixastic__"><\/script>');var a=document.getElementById("__onload_ie_pixastic__");a.onreadystatechange=function(){"complete"==a.readyState&&(a.parentNode.removeChild(a),s())},document.addEventListener&&document.addEventListener("DOMContentLoaded",s,!1),e(window,"load",s)}(function(){for(var e=t("pixastic",null,"img"),i=t("pixastic",null,"canvas"),s=e.concat(i),a=0;a<s.length;a++)!function(){for(var e=s[a],t=[],i=e.className.split(" "),r=0;r<i.length;r++){var n=i[r];if("pixastic-"==n.substring(0,9)){var o=n.substring(9);""!=o&&t.push(o)}}if(t.length)if("img"==e.tagName.toLowerCase()){var l=new Image;if(l.src=e.src,l.complete)for(var c=0;c<t.length;c++){var h=Pixastic.applyAction(e,e,t[c],null);h&&(e=h)}else l.onload=function(){for(var i=0;i<t.length;i++){var s=Pixastic.applyAction(e,e,t[i],null);s&&(e=s)}}}else setTimeout(function(){for(var i=0;i<t.length;i++){var s=Pixastic.applyAction(e,e,t[i],null);s&&(e=s)}},1)}()});var a=function(){var e=document.createElement("canvas"),t=!1;try{t=!("function"!=typeof e.getContext||!e.getContext("2d"))}catch(e){}return function(){return t}}(),r=function(){var e,t=document.createElement("canvas"),i=!1;try{"function"==typeof t.getContext&&(e=t.getContext("2d"))&&(i="function"==typeof e.getImageData)}catch(e){}return function(){return i}}(),n=function(){var e=!1,t=document.createElement("canvas");if(a()&&r()){t.width=t.height=1;var i=t.getContext("2d");i.fillStyle="rgb(255,0,0)",i.fillRect(0,0,1,1);var s=document.createElement("canvas");s.width=s.height=1;var n=s.getContext("2d");n.fillStyle="rgb(0,0,255)",n.fillRect(0,0,1,1),i.globalAlpha=.5,i.drawImage(s,0,0);var o=i.getImageData(0,0,1,1).data;e=255!=o[2]}return function(){return e}}();return{parseOnLoad:!1,debug:!1,applyAction:function(e,t,i,a){a=a||{};var r="canvas"==e.tagName.toLowerCase();if(r&&Pixastic.Client.isIE())return Pixastic.debug&&s("Tried to process a canvas element but browser is IE."),!1;var n,o,l=!1;Pixastic.Client.hasCanvas()&&(l=!!a.resultCanvas,o=(n=a.resultCanvas||document.createElement("canvas")).getContext("2d"));var c=e.offsetWidth,h=e.offsetHeight;if(r&&(c=e.width,h=e.height),0==c||0==h){if(null!=e.parentNode)return void(Pixastic.debug&&s("Image has 0 width and/or height."));var d=e.style.position,u=e.style.left;e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),c=e.offsetWidth,h=e.offsetHeight,document.body.removeChild(e),e.style.position=d,e.style.left=u}if(i.indexOf("(")>-1){var p=i;i=p.substr(0,p.indexOf("("));var m=p.match(/\((.*?)\)/);if(m[1]){m=m[1].split(";");for(var g=0;g<m.length;g++)if(thisArg=m[g].split("="),2==thisArg.length)if("rect"==thisArg[0]){var f=thisArg[1].split(",");a[thisArg[0]]={left:parseInt(f[0],10)||0,top:parseInt(f[1],10)||0,width:parseInt(f[2],10)||0,height:parseInt(f[3],10)||0}}else a[thisArg[0]]=thisArg[1]}}a.rect?(a.rect.left=Math.round(a.rect.left),a.rect.top=Math.round(a.rect.top),a.rect.width=Math.round(a.rect.width),a.rect.height=Math.round(a.rect.height)):a.rect={left:0,top:0,width:c,height:h};var v=!1;if(Pixastic.Actions[i]&&"function"==typeof Pixastic.Actions[i].process&&(v=!0),!v)return Pixastic.debug&&s('Invalid action "'+i+'". Maybe file not included?'),!1;if(!Pixastic.Actions[i].checkSupport())return Pixastic.debug&&s('Action "'+i+'" not supported by this browser.'),!1;Pixastic.Client.hasCanvas()?(n!==e&&(n.width=c,n.height=h),l||(n.style.width=c+"px",n.style.height=h+"px"),o.drawImage(t,0,0,c,h),e.__pixastic_org_image?(n.__pixastic_org_image=e.__pixastic_org_image,n.__pixastic_org_width=e.__pixastic_org_width,n.__pixastic_org_height=e.__pixastic_org_height):(n.__pixastic_org_image=e,n.__pixastic_org_width=c,n.__pixastic_org_height=h)):Pixastic.Client.isIE()&&void 0===e.__pixastic_org_style&&(e.__pixastic_org_style=e.style.cssText);var y={image:e,canvas:n,width:c,height:h,useData:!0,options:a};return!!Pixastic.Actions[i].process(y)&&(Pixastic.Client.hasCanvas()?(y.useData&&Pixastic.Client.hasCanvasImageData()&&(n.getContext("2d").putImageData(y.canvasData,a.rect.left,a.rect.top),n.getContext("2d").fillRect(0,0,0,0)),a.leaveDOM||(n.title=e.title,n.imgsrc=e.imgsrc,r||(n.alt=e.alt),r||(n.imgsrc=e.src),n.className=e.className,n.style.cssText=e.style.cssText,n.name=e.name,n.tabIndex=e.tabIndex,n.id=e.id,e.parentNode&&e.parentNode.replaceChild&&e.parentNode.replaceChild(n,e)),a.resultCanvas=n,n):e)},prepareData:function(e,t){var i=e.canvas.getContext("2d"),s=e.options.rect,a=i.getImageData(s.left,s.top,s.width,s.height),r=a.data;return t||(e.canvasData=a),r},process:function(e,t,i,s){if("img"==e.tagName.toLowerCase()){var a=new Image;if(a.src=e.src,a.complete){r=Pixastic.applyAction(e,a,t,i);return s&&s(r),r}a.onload=function(){var r=Pixastic.applyAction(e,a,t,i);s&&s(r)}}if("canvas"==e.tagName.toLowerCase()){var r=Pixastic.applyAction(e,e,t,i);return s&&s(r),r}},revert:function(e){if(Pixastic.Client.hasCanvas()){if("canvas"==e.tagName.toLowerCase()&&e.__pixastic_org_image)return e.width=e.__pixastic_org_width,e.height=e.__pixastic_org_height,e.getContext("2d").drawImage(e.__pixastic_org_image,0,0),e.parentNode&&e.parentNode.replaceChild&&e.parentNode.replaceChild(e.__pixastic_org_image,e),e}else Pixastic.Client.isIE()&&void 0!==e.__pixastic_org_style&&(e.style.cssText=e.__pixastic_org_style)},Client:{hasCanvas:a,hasCanvasImageData:r,hasGlobalAlpha:n,isIE:function(){return!!document.all&&!!window.attachEvent&&!window.opera}},Actions:{}}}();"undefined"!=typeof jQuery&&jQuery&&jQuery.fn&&(jQuery.fn.pixastic=function(e,t){var i=[];return this.each(function(){if("img"!=this.tagName.toLowerCase()||this.complete){var s=Pixastic.process(this,e,t);s&&i.push(s)}}),i.length>0?jQuery(i):this}),Pixastic.Actions.hsl={process:function(e){var t=parseInt(e.options.hue,10)||0,i=(parseInt(e.options.saturation,10)||0)/100,s=(parseInt(e.options.lightness,10)||0)/100;if(i<0)a=1+i;else var a=1+2*i;var r=6*(t=t%360/360),n=255*s,o=1+s,l=1-s;if(Pixastic.Client.hasCanvasImageData()){for(var c=Pixastic.prepareData(e),h=e.options.rect,d=h.width*h.height,u=4*d,p=u+1,m=u+2;d--;){var g=c[u-=4],f=c[p=u+1],v=c[m=u+2];if(0!=t||0!=i){var y=g;f>y&&(y=f),v>y&&(y=v);var w=g;f<w&&(w=f),v<w&&(w=v);var b=y-w,S=(w+y)/510;if(S>0&&b>0){if(S<=.5){(T=b/(y+w)*a)>1&&(T=1);C=S*(1+T)}else{var T=b/(510-y-w)*a;T>1&&(T=1);var C=S+T-S*T}if(g==y)if(f==w)_=5+(y-v)/b+r;else _=1-(y-f)/b+r;else if(f==y)if(v==w)_=1+(y-g)/b+r;else _=3-(y-v)/b+r;else if(g==w)_=3+(y-f)/b+r;else var _=5-(y-g)/b+r;_<0&&(_+=6),_>=6&&(_-=6);var k=S+S-C,x=_>>0;0==x?(g=255*C,f=255*(k+(C-k)*(_-x)),v=255*k):1==x?(g=255*(C-(C-k)*(_-x)),f=255*C,v=255*k):2==x?(g=255*k,f=255*C,v=255*(k+(C-k)*(_-x))):3==x?(g=255*k,f=255*(C-(C-k)*(_-x)),v=255*C):4==x?(g=255*(k+(C-k)*(_-x)),f=255*k,v=255*C):5==x&&(g=255*C,f=255*k,v=255*(C-(C-k)*(_-x)))}}s<0?(g*=o,f*=o,v*=o):s>0&&(g=g*l+n,f=f*l+n,v=v*l+n),c[u]=g<0?0:g>255?255:g,c[p]=f<0?0:f>255?255:f,c[m]=v<0?0:v>255?255:v}return!0}},checkSupport:function(){return Pixastic.Client.hasCanvasImageData()}},define("shared/classes/pixastic",function(){}),define("dealership/views/paint_car",["require","templates","analytics","global/views/modal","registry","dealership/models/paint_car","shared/classes/form_validation","global/models/car","shared/classes/pixastic"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/views/modal"),a=e("registry"),r=e("dealership/models/paint_car"),n=e("shared/classes/form_validation"),o=e("global/models/car");return e("shared/classes/pixastic"),s.extend({initialize:function(e){s.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{})),void 0===this.template&&(this.template=t("dealership","paint_car")),this.player=e.player,this.model=a.get("cars").get(this.player.get("carID")),this.formModel=new r,this.formModel.set({carID:this.model.id}),"standard"!=a.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.render(),this.$("input[type=range]").on("input change",this.sliderUpdate.bind(this)),this.car=this.$(".carImage"),this.carSourceImage=new Image,this.carSourceImage.src=o.imageSrc("large",this.player.get("carID")),this.updateHue(this.player.get("carHueAngle"))},render:function(){var e=this.model.toJSON();return e.price=Math.round(e.price*NTGLOBALS("PAINT_PRICE")),this.$el.append(this.template({data:e,player:this.player.toJSON(),carSrc:o.imageSrc})),new n(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},sliderUpdate:function(e){var t=$(e.target).val();return this.updateHue(t),!1},updateHue:function(e){Pixastic.process(this.carSourceImage,"hsl",{hue:e},function(e){this.car.html(e)}.bind(this)),this.formModel.set({angle:e})},purchaseError:function(e){this.showError(e.message)},purchase:function(e){var t=a.get("playerCars");e.carHueAngle=this.formModel.get("angle"),a.get("player").set(e),t.get(this.model.id).set({hueAngle:e.carHueAngle}),i.trackEvent("Dealership","Paint Car",this.model.get("name")),i.trackEvent("Dealership","Spend Money",null,this.model.get("price")*NTGLOBALS("PAINT_PRICE")),this.hide()}})}),define("dealership/models/buy_nitros",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/buy-nitros"},defaults:{password:"",quantity:10},validationRules:{password:{required:!0}}})}),define("dealership/views/buy_nitros",["require","templates","analytics","global/views/modal","dealership/models/buy_nitros","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/views/modal"),a=e("dealership/models/buy_nitros"),r=e("shared/classes/form_validation"),n=e("registry");return s.extend({initialize:function(e){s.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .arrows a":"updateQuantity"})),this.formModel=new a,"standard"!=n.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),void 0===this.template&&(this.template=t("dealership","buy_nitros")),this.player=e.player,this.render()},render:function(){return this.$el.append(this.template({player:this.player.toJSON(),quantity:this.formModel.get("quantity"),unitPrice:NTGLOBALS("NITRO_PRICE"),price:NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity")})),new r(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},purchaseError:function(e){this.showError(e.message)},purchase:function(e){i.trackEvent("Dealership","Purchase Nitro",null,this.formModel.get("quantity")),i.trackEvent("Dealership","Spend Money",null,parseInt(NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity"),10)),this.hide(),n.get("player").set(e)},updateQuantity:function(e){return this.formModel.set({quantity:Math.max(10,this.formModel.get("quantity")+($(e.currentTarget).is(".up")?10:-10))}),this.$(".quantity-value").html("+"+this.formModel.get("quantity").addCommas()),this.$(".price-value").html("$"+(NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity")).addCommas()),!1}})}),define("dealership/views/player_info",["require","templates","registry","dealership/views/paint_car","dealership/views/buy_nitros","global/models/car","shared/classes/sound"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("dealership/views/paint_car"),a=e("dealership/views/buy_nitros"),r=e("global/models/car"),n=e("shared/classes/sound");return Backbone.View.extend({events:{"click .paint-car":"showPaintCarView","click .buy-nitros":"showBuyNitrosView"},initialize:function(e){void 0===this.template&&(this.template=t("dealership","player_info")),this.player=e.player,this.listenTo(this.player,"change:carID change:carHueAngle",this.changeCar),this.listenTo(this.player,"change:money",this.changeMoney),this.listenTo(this.player,"change:nitros",this.changeNitros),n.preload("swoosh","global"),n.preload("purchase","global"),this.render()},render:function(){var e=i.get("playerCars");this.$el.html(this.template({player:this.player.toJSON(),carImage:r.imageTag,cars:i.get("cars"),loggedIn:NTGLOBALS("LOGGED_IN"),allowPaint:e.length>0}))},changeCar:function(){this.$(".player-car-name").html(i.get("cars").get(this.player.get("carID")).get("name"));var e=this;this.$(".player-car").finish().css({left:0}).velocity({left:-1*$(window).width()/2},250,function(){$(this).html(r.imageTag("large",e.player.get("carID"),e.player.get("carHueAngle"))).css("left",$(window).width()/2+135).velocity({left:0},250,"easeOutExpo")}),n.play({id:"swoosh",volume:.5})},changeMoney:function(){this.$(".player-money .numbers").countdown(this.player.get("money"),{formatter:Number.addCommas}),n.play({id:"purchase",volume:.5})},changeNitros:function(){this.$(".player-nitros").countdown(this.player.get("nitros").addCommas(),{formatter:Number.addCommas})},showPaintCarView:function(){return new s({player:this.player}).show({destroy:!0}),!1},showBuyNitrosView:function(){return new a({player:this.player}).show({destroy:!0}),!1}})}),define("dealership/collections/groups",["require"],function(e){"use strict";return Backbone.Collection.extend({comparator:"minLevel"})}),define("dealership/models/buy_car",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/cars/"+this.get("carID")+"/buy"},defaults:{password:""},validationRules:{password:{required:!0}}})}),define("dealership/views/buy_car",["require","templates","analytics","global/views/modal","dealership/models/buy_car","shared/classes/form_validation","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/views/modal"),a=e("dealership/models/buy_car"),r=e("shared/classes/form_validation"),n=e("global/models/car"),o=e("registry");return s.extend({initialize:function(e){s.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{})),void 0===this.template&&(this.template=t("dealership","buy_car")),this.player=e.player,this.formModel=new a,this.formModel.set({carID:this.model.id}),"standard"!=o.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.render()},render:function(){var e=this.player.toJSON(),t=this.model.toJSON();return this.$el.append(this.template({data:t,player:e,carSrc:n.imageSrc})),new r(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},purchaseError:function(e){this.showError(e.message)},purchase:function(e){var t=o.get("player");t.set(e),t.addCar(this.formModel.get("carID")),i.trackEvent("Dealership","Purchase Car",this.model.get("name")),i.trackEvent("Dealership","Spend Money",null,this.model.get("price")),this.hide()}})}),define("dealership/views/catalog",["require","templates","dealership/collections/groups","registry","dealership/views/buy_car"],function(e){"use strict";var t=e("templates"),i=e("dealership/collections/groups"),s=e("registry"),a=e("dealership/views/buy_car");return Backbone.View.extend({events:{"click .buy-car":"showBuyCarView"},initialize:function(e){void 0===this.template&&(this.template=t("dealership","catalog")),this.player=e.player,this.model=s.get("cars"),this.groups=new i(NTGLOBALS("CAR_GROUPS")),NTGLOBALS("SPECIAL_EVENT")&&(this.groups.forEach(function(e){e.set({excludeCars:NTGLOBALS("SPECIAL_EVENT_CARS")})}),this.groups.unshift({minLevel:0,filterCars:NTGLOBALS("SPECIAL_EVENT_CARS"),subText:"Use "+NTGLOBALS("SPECIAL_EVENT").ucFirst()+" event cars to earn extra cash, experience, and achievements!",name:NTGLOBALS("SPECIAL_EVENT").ucFirst()+" Event Cars"})),this.owned=s.get("playerCars"),this.listenTo(this.owned,"add change",this.buyCar),this.render()},render:function(){var e=this.owned,t=_.chain(this.model.toJSON()).filter(function(t){return!(e.get(t.id)&&"owned"==e.get(t.id).get("status")||!e.get(t.id)&&!t.purchasable)}).sortBy("price").groupBy(function(e){return e.unlockLevel}).value();this.$el.html(this.template({allCars:_.flatten(_.values(t)),cars:t,player:this.player.toJSON(),groups:this.groups.toJSON(),carPath:this.model.model.imageSrc}))},buyCar:function(e){this.$("div[data-id="+e.id+"]").velocity("fadeOut",function(){$(this).remove()})},showBuyCarView:function(e){if($(e.currentTarget).hasClass("button-locked"))return!1;var t=this.model.get($(e.target).parents(".car").data("id"));return new a({player:this.player,model:t}).show({destroy:!0}),!1}})}),define("dealership/index",["require","registry","dealership/views/player_info","dealership/views/catalog"],function(e){"use strict";var t=e("registry"),i=e("dealership/views/player_info"),s=e("dealership/views/catalog");return Backbone.View.extend({el:"#app",initialize:function(){this.player=t.get("player"),this.playerInfo=new i({player:this.player}),this.catalogView=new s({player:this.player}),this.render()},render:function(){this.$(".player-info").append(this.playerInfo.el),this.$(".car-list").append(this.catalogView.el)}})}),define("friends/views/friends",["require","templates","analytics","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/models/car"),a=e("registry");return Backbone.View.extend({events:{"click tr":"handleRowClick"},initialize:function(e){this.statusMap=NTGLOBALS("PAGE_LABELS"),this.parent=e.parent,this.player=a.get("player"),void 0===this.template&&(this.template=t("friends","friends")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,data:this.model.toJSON(),carImage:s.imageTag,friends:a.get("playerFriends"),loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friendLimit:this.player.get("friendLimit"),totalFriends:a.get("playerFriends").totalFriends(),totalTeammates:a.get("playerFriends").totalTeammates(),countries:NTGLOBALS("COUNTRIES"),status:this.formatOnlineStatus.bind(this)})),this.hideSpinner()},formatOnlineStatus:function(e){var t=this.statusMap[e];return t||"Browsing"},removeRow:function(e){var t=this;this.$("#row-"+e.id).velocity("fadeOut",function(){t.render()})},show:function(e){this.model.fetch(e),this.$el.show()},hide:function(){this.model.cancel(),this.$el.hide()},showSpinner:function(){this.$(".my-friends").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".my-friends").fastShow(),this.$(".spinner").fastHide()},handleRowClick:function(e){e.preventDefault();var t=$(e.target);return t.is(".remove-friend")?this.confirmDelete(e):t.is(".cancel")?this.cancelDelete(e):t.is(".delete")?this.deleteFriend(e):!t.is(".remove-popup")&&void(location.href="/racer/"+this.model.get($(e.currentTarget).data("id")).get("username"))},confirmDelete:function(e){i.trackEvent("Friends","Delete"),$(e.currentTarget).find(".remove-popup").fastShow()},cancelDelete:function(e){$(e.currentTarget).find(".remove-popup").fastHide()},deleteFriend:function(e){var t=$(e.currentTarget).data("id");this.model.get(t)&&this.model.delete(t)}})}),define("friends/views/requests",["require","templates","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("global/models/car"),s=e("registry");return Backbone.View.extend({events:{"click .refresh":"refresh","click .approve-all":"handleApproveAll","click .deny-all":"handleDenyAll","click tr":"handleRowClick"},initialize:function(e){this.parent=e.parent,this.player=s.get("player"),void 0===this.template&&(this.template=t("friends","requests")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,totalRecords:this.model.totalRecords,data:this.model.toJSON(),carImage:i.imageTag,loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friendLimit:this.player.get("friendLimit"),totalFriends:s.get("playerFriends").totalFriends(),countries:NTGLOBALS("COUNTRIES")})),this.hideSpinner()},removeRow:function(e){var t=this;this.$("#row-"+e.id).velocity("fadeOut",function(){t.render()})},refresh:function(){return this.model.fetch(1e3),!1},show:function(e){this.model.fetch(e),this.$el.fastShow()},hide:function(){this.model.cancel(),this.$el.hide()},showSpinner:function(){this.$(".friend-requests").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friend-requests").fastShow(),this.$(".spinner").fastHide()},handleApproveAll:function(){var e=this;return this.model.approveAll().done(function(t){t.success?e.parent.switchTabs("friends"):alert("There was an error: "+t.message)}),!1},handleDenyAll:function(){var e=this;return this.model.denyAll().done(function(t){t.success?e.parent.switchTabs("friends"):alert("There was an error: "+t.message)}),!1},getRowId:function(e){return $(e.currentTarget).data("id")},handleRowClick:function(e){if($(e.target).is(".approve")){if($(e.currentTarget).data("clicked"))return!1;$(e.currentTarget).data("clicked",!0),this.model.approve(this.getRowId(e))}else if($(e.target).is(".deny")){if($(e.currentTarget).data("clicked"))return!1;$(e.currentTarget).data("clicked",!0),this.model.deny(this.getRowId(e))}else $(e.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(e.currentTarget).data("id")).get("username"));return!1}})}),define("friends/views/search_results",["require","templates","analytics","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("global/models/car"),a=e("registry");return Backbone.View.extend({searchTerm:"",events:{"click tr":"handleRowClick"},initialize:function(){this.player=a.get("player"),void 0===this.template&&(this.template=t("friends","search_results")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,data:this.model.toJSON(),carImage:s.imageTag,loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friends:a.get("playerFriends"),friendLimit:this.player.get("friendLimit"),totalFriends:a.get("playerFriends").totalFriends(),countries:NTGLOBALS("COUNTRIES")})),this.hideSpinner()},handleRowClick:function(e){if($(e.target).is(".add-friend")){var t=$(e.currentTarget).data("id");this.model.requestFriend(t),i.trackEvent("Friends","Request","friends page"),$(e.target).removeClass("button-green add-friend").addClass("button-pending").html("Request Sent")}else{if($(e.target).is(".button-friends"))return!1;$(e.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(e.currentTarget).data("id")).get("username"))}return!1},search:function(e,t){this.searchTerm=e,e.length<3?this.model.reset():(i.trackEvent("Friends","Search"),this.model.search(e,t))},show:function(){this.$el.fastShow()},hide:function(){this.model.cancel(),this.$el.fastHide()},showSpinner:function(){this.$(".friend-search").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friend-search").fastShow(),this.$(".spinner").fastHide()}})}),define("friends/collections/friends",["require","global/models/player","registry"],function(e){"use strict";var t=e("global/models/player"),i=e("registry");return Backbone.Collection.extend({prevTotalFriends:0,model:t,initialize:function(){},comparator:function(e){return(e.get("lastActivity")?"1-":"2-"+e.get("friendType"))+e.get("displayName")+e.get("username")},delete:function(e){this.remove(e),$.post("/api/friends/"+e+"/delete").done(function(e){e.success||alert("There was an error: "+e.message)})},cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},fetch:function(e){if(!NTGLOBALS("LOGGED_IN"))return this.reset();if(this.trigger("request"),this.cancel(),e)this.request=setTimeout(_.bind(this.fetch,this),e);else{var t="/api/friends";this.onlineOnly&&(t+="?online=1"),this.request=$.get(t).done(function(e){if(this.request=null,e.success){var t=[];e.data.fields&&e.data.values?t=$.objectArray(e.data.fields,e.data.values):_.isArray(e.data)&&(t=e.data),i.get("playerFriends").reset(t),this.reset(t)}else this.reset()}.bind(this))}},totalFriends:function(){return this.where({friendType:"friend"}).length},totalTeammates:function(){return this.where({friendType:"teammate"}).length}})}),define("friends/collections/requests",["require","global/models/player","registry"],function(e){"use strict";var t=e("global/models/player"),i=e("registry");return Backbone.Collection.extend({model:t,totalRecords:0,initialize:function(){this.on("reset",this.updatePlayer,this),this.on("remove",this.updatePlayer,this)},updatePlayer:function(){i.get("player").set({requests:this.totalRecords})},approve:function(e){this.totalRecords--,this.remove(e);i.get("player");return $.post("/api/friend-requests/"+e+"/accept").done(function(){i.get("realtime").acceptFriends([e])})},deny:function(e){return this.totalRecords--,this.remove(e),$.post("/api/friend-requests/"+e+"/deny")},approveAll:function(){return this.trigger("request"),$.post("/api/friend-requests/accept-all").done(function(e){e.success&&(i.get("realtime").acceptFriends(this.pluck("id")),this.totalRecords-=e.data.count,this.reset())}.bind(this))},denyAll:function(){return this.trigger("request"),$.post("/api/friend-requests/deny-all").done(function(e){e.success&&(this.totalRecords=0,this.reset())}.bind(this))},cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},fetch:function(e){if(!NTGLOBALS("LOGGED_IN"))return this.reset();if(this.cancel(),this.trigger("request"),e)this.request=setTimeout(_.bind(this.fetch,this),e);else{var t=this;this.request=$.get("/api/friend-requests").done(function(e){t.request=null,e.success?e.data.ignore?t.reset():(t.totalRecords=e.data.totalRecords,t.reset(e.data.requests)):t.reset()})}}})}),define("friends/collections/search_results",["require","global/models/player","registry"],function(e){"use strict";var t=e("global/models/player"),i=e("registry");return Backbone.Collection.extend({prevTerm:"",model:t,cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},search:function(e,t){if(e!=this.prevTerm)if(this.cancel(),this.trigger("request"),t)this.request=setTimeout(_.bind(this.search,this,e),t);else{this.prevTerm=e;var i=this;this.request=$.post("/api/players-search",{term:e}).done(function(e){i.request=null,e.success?i.reset(e.data):i.reset()})}},requestFriend:function(e){return i.get("player").requestFriend(e)}})}),define("friends/index",["require","friends/views/friends","friends/views/requests","friends/views/search_results","global/views/invites","friends/collections/friends","friends/collections/requests","friends/collections/search_results","registry"],function(e){"use strict";var t=e("friends/views/friends"),i=e("friends/views/requests"),s=e("friends/views/search_results"),a=e("global/views/invites"),r=e("friends/collections/friends"),n=e("friends/collections/requests"),o=e("friends/collections/search_results"),l=e("registry");return Backbone.View.extend({el:"#app",contentEl:null,activeTab:"friends",events:{"click .tabs li":"handleTabClick","click .search-button":"handleSearchClick","click .invite-link":"handleInviteClick","submit form":"handleSearchSubmit"},initialize:function(){this.player=l.get("player"),this.playerFriends=l.get("playerFriends"),this.listenTo(this.playerFriends,"add",this.updateTabs),this.listenTo(this.playerFriends,"remove",this.updateTabs),this.listenTo(this.player,"change:requests",this.updateTabs),this.player.get("requests")>0&&(this.activeTab="requests");var e=new r,c=new n,h=new o;this.friendsView=new t({model:e,parent:this}),this.requestsView=new i({model:c,parent:this}),this.searchResultsView=new s({model:h,parent:this}),this.invites=new a,this.render(),this.updateTabs(),this.switchTabs(this.activeTab,0)},render:function(){this.contentEl=this.$(".friends-content"),this.contentEl.append([this.friendsView.el,this.requestsView.el,this.searchResultsView.el])},updateTabs:function(){this.$("#tab-friends a").html("My Friends ("+this.playerFriends.length+")"),this.$("#tab-requests a").html("Requests ("+this.player.get("requests")+")")},switchTabs:function(e,t){this.activeTab=e,this.$(".tabs li").removeClass("active"),this.$("#tab-"+e).addClass("active"),this.friendsView.hide(),this.requestsView.hide(),this.searchResultsView.hide(),this[this.activeTab+"View"].show(t)},handleTabClick:function(e){return this.switchTabs(e.currentTarget.id.split("-")[1],1e3),!1},handleSearchClick:function(e){e.preventDefault(),this.$("form").submit()},handleSearchSubmit:function(e){e.preventDefault(),this.switchTabs("searchResults"),this.searchResultsView.search(this.$("form input").val(),1e3)},handleInviteClick:function(){return this.invites.show(),!1}})}),define("bugs/models/form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/settings/bugs",defaults:{},validationRules:{description:{required:!0},page:{required:!0},action:{required:!0}},validationMessages:{}})}),define("bugs/index",["require","registry","shared/classes/form_validation","bugs/models/form"],function(e){"use strict";e("registry");var t=e("shared/classes/form_validation"),i=e("bugs/models/form");return Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){new t(this.$("form[name=bugs-form]"),this.$("form[name=bugs-form] .button"),new i,this.callback,this)},callback:function(e,t,i){i.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Thanks for helping to improve Nitro Type!</p>").velocity("fadeIn")})}})}),define("scoreboard/views/navigation",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({grouping:null,board:null,time:null,events:{"click .tabs a":"handleTabClick","click .tab-filters a":"handleTimeClick"},initialize:function(){void 0===this.template&&(this.template=t("scoreboard","navigation")),this.grouping=this.model.grouping,this.board=this.model.board,this.time=this.model.time,this.render()},render:function(){this.$el.html(this.template({board:this.board,time:this.time,grouping:this.grouping})),this.switchTabs()},handleTabClick:function(e){e.preventDefault();var t=e.currentTarget.id.split("-");this.grouping=t[1],this.board=t[2],"speed"==this.board&&"season"==this.time&&(this.time="monthly"),this.model.setOptions(this.board,this.time,this.grouping).fetch(),this.switchTabs()},handleTimeClick:function(e){e.preventDefault(),this.time=e.currentTarget.id.split("-")[1],"speed"==this.board&&"season"==this.time&&(this.time="monthly"),this.model.setOptions(this.board,this.time,this.grouping).fetch(),this.switchTabs()},switchTabs:function(){"speed"==this.board?(this.$(".tab-filters li").fastShow(!0),this.$("#time-season").parent().fastHide(),this.$("#time-daily").parent().fastHide()):"hof"==this.board?this.$(".tab-filters li").fastHide():(this.$("#time-season").parent().fastShow(!0),this.$(".tab-filters li").fastShow(!0),this.$("#time-daily").parent().fastShow(!0)),this.$(".tabs li,.tab-filters li").removeClass("active"),this.$("#tab-"+this.grouping+"-"+this.board).parent().addClass("active"),this.$("#time-"+this.time).parent().addClass("active")}})}),define("scoreboard/views/ranking",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({events:{"click .js-see-rewards":"seeRewards","change select[name=seasonID]":"changeSeason"},minRequirements:{racer:{daily:6,weekly:15,monthly:30,season:20},teams:{daily:50,weekly:150,monthly:300,season:200}},initialize:function(e){this.seasons=e.seasons,this.currentSeason=e.currentSeason,void 0===this.template&&(this.template=t("scoreboard","ranking")),this.listenTo(this.model,"reset",this.render)},render:function(){var e=this.model.rankingsModel.toJSON();switch(e.board){case"speed":e.scoreDesc="WPM";break;case"played":e.scoreDesc="races";break;case"points":e.scoreDesc="points"}e.grouping&&(e.minReqs=this.minRequirements[e.grouping][e.time]),this.$el.html(this.template({data:e,seasons:this.seasons.toJSON(),season:this.currentSeason?this.currentSeason.toJSON():{}}))},changeSeason:function(e){this.trigger("change-season",$(e.currentTarget).val())},seeRewards:function(e){$(e.currentTarget).addClass("is-open"),$(".seasons-rewardsLink").fastHide()}})}),define("global/models/season",["require"],function(e){"use strict";return Backbone.Model.extend({idAttribute:"seasonID",defaults:{name:""}})}),define("global/collections/seasons",["require","global/models/season"],function(e){"use strict";var t=e("global/models/season");return Backbone.Collection.extend({model:t,comparator:"startStamp"})}),define("scoreboard/index",["require","scoreboard/views/navigation","scoreboard/views/ranking","global/views/player_hover","global/views/scoreboard_table","scoreboard/collections/data","global/collections/seasons","global/models/season","registry"],function(e){"use strict";var t=e("scoreboard/views/navigation"),i=e("scoreboard/views/ranking"),s=e("global/views/player_hover"),a=e("global/views/scoreboard_table"),r=e("scoreboard/collections/data"),n=e("global/collections/seasons"),o=e("global/models/season"),l=e("registry");return Backbone.View.extend({el:"#app",initialize:function(){this.player=l.get("player"),this.dataColl=new r,this.listenTo(this.dataColl,"request",this.showLoader),this.listenTo(this.dataColl,"reset",this.hideLoader),this.seasons=new n(NTGLOBALS("SEASONS").map(function(e){return e.rewards=JSON.parse(e.rewards),e})),this.currentSeason=new o(this.getCurrentSeason().toJSON()),this.playerHover=new s,this.navigation=new t({model:this.dataColl}),this.ranking=new i({model:this.dataColl,seasons:this.seasons,currentSeason:this.currentSeason}),this.listenTo(this.ranking,"change-season",this.changeSeason),this.table=new a({model:this.dataColl,hover:this.playerHover,headers:!0}),this.render(),this.dataColl.fetch()},render:function(){this.$(".navigation").append(this.navigation.el),this.showLoader(),this.$(".scoreboard-content").append(this.ranking.el).append(this.table.el)},getCurrentSeason:function(e){return e>0?this.seasons.get(e):NTGLOBALS("CURRENT_SEASON")?this.seasons.get(NTGLOBALS("CURRENT_SEASON").seasonID):this.seasons.find({started:0})},changeSeason:function(e){this.currentSeason.set(this.getCurrentSeason(e).toJSON()),this.dataColl.setOptions(null,null,null,e),this.dataColl.fetch()},showLoader:function(){this.$(".scoreboard-content").hide(),this.$(".loading-box").show()},hideLoader:function(){this.$(".loading-box").hide(),this.$(".scoreboard-content").show()}})}),define("news/index",["require"],function(e){"use strict";return Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){}})}),define("news/models/comment",["require"],function(e){"use strict";return Backbone.Model.extend({idAttribute:"blogCommentID",delete:function(){return $.post("/api/news-comments/"+this.id+"/delete")},approve:function(){return $.post("/api/news-comments/"+this.id+"/approve")},deleteAndModerate:function(e){var t={};return e&&(t.ban=1),$.post("/api/news-comments/"+this.id+"/delete-and-moderate",t)},edit:function(){}})}),define("news/collections/comments",["require","news/models/comment","registry"],function(e){"use strict";var t=e("news/models/comment"),i=e("registry");return Backbone.Collection.extend({model:t,initialize:function(){this.isModerator=i.get("player").get("moderator")},comparator:function(e,t){if(this.isModerator){if(!e.get("approved")&&t.get("approved"))return 1;if(e.get("approved")&&!t.get("approved"))return-1}return e.get("createdStamp")>t.get("createdStamp")?1:-1},getOffset:function(e){return e==this.length?0:e-this.length},fetchUnapproved:function(e){$.get("/api/news/"+e+"/unapproved").done(function(e){e.success&&e.data&&e.data.length&&this.add(e.data)}.bind(this))}})}),define("news/models/comment_edit_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/news-comments/"+this.get("blogCommentID")+"/edit"},defaults:{comment:null},validationRules:{comment:{maxlength:2e3}},validationMessages:{}})}),define("news/views/comment_edit_box",["require","templates","analytics","news/models/comment_edit_form","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("news/models/comment_edit_form"),a=e("shared/classes/form_validation"),r=e("registry");return Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=t("news","comment_edit_box")),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),allowComments:NTGLOBALS("ALLOW_COMMENTS"),player:r.get("player").toJSON()})),new a(this.$("form"),this.$(".button"),new s,this.postComment,this)},postComment:function(){i.trackEvent("Blog","CommentEdit"),this.$el.velocity("slideUp",function(){this.$el.html("Your comment edit has been submitted for moderation and will appear shortly.").velocity("fadeIn")}.bind(this))}})}),define("news/views/comments",["require","templates","global/views/report_user","registry","global/models/car","news/views/comment_edit_box","shared/classes/pixastic"],function(e){"use strict";var t=e("templates"),i=e("global/views/report_user"),s=e("registry"),a=e("global/models/car"),r=e("news/views/comment_edit_box");return e("shared/classes/pixastic"),Backbone.View.extend({events:{"click .delete-post":"deletePost","click .moderate-post":"moderatePost","click .approve-post":"approvePost","click .reply-to":"replyToPost","click .report-user a":"reportPost","click .edit-post":"editPost"},initialize:function(e){this.commentCount=e.commentCount,this.player=s.get("player"),void 0===this.template&&(this.template=t("news","comments")),this.model.isModerator&&this.model.fetchUnapproved(e.id),this.listenTo(this.model,"add",this.render),this.reportUser=new i({player:this.player}),this.listenTo(this.reportUser,"reported",this.playerReported),this.render()},render:function(){this.$el.html(this.template({loggedIn:NTGLOBALS("LOGGED_IN"),countries:NTGLOBALS("COUNTRIES"),CarModel:a,friends:s.get("playerFriends"),allowComments:NTGLOBALS("ALLOW_COMMENTS"),comments:this.model.toJSON(),offset:this.model.getOffset(NTGLOBALS("COMMENT_COUNT")),player:s.get("player"),view:this,top3:s.get("top3Players")}))},formatComment:function(e){return e.replace(/(@\S+)\s+|(@\S+)$/gm,function(e){return'<span class="reply">'+e+"</span>"}).replace(/\n/gm,"<br />\n")},formatDate:function(e){var t=moment(new Date(1e3*e));return t.format("YYYY-MM-DD")==t.format("YYYY-MM-DD")?t.format("h:mma"):t.format("M/D/YY h:mma")},getModelByEvent:function(e){return this.model.get(this.getCommentByEvent(e).data("id"))},getCommentByEvent:function(e){return this.$(e.currentTarget).parents("div.comment")},deletePost:function(e){return this.getModelByEvent(e).delete().done(function(t){t.success?this.getCommentByEvent(e).velocity("fadeOut"):alert("ERROR: "+t.data.message)}.bind(this)),!1},moderatePost:function(e){var t=this.getModelByEvent(e),i=!1;return $(e.currentTarget).hasClass("ban")&&(i=!0),t.deleteAndModerate(i).done(function(t){t.success?this.getCommentByEvent(e).velocity("fadeOut"):alert("ERROR: "+t.data.message)}.bind(this)),!1},approvePost:function(e){return this.getModelByEvent(e).approve().done(function(t){t.success?this.getCommentByEvent(e).velocity("fadeOut"):alert("ERROR: "+t.data.message)}.bind(this)),!1},replyToPost:function(e){var t=this.getModelByEvent(e),i="";this.player.get("lastComment")>(new Date).getTime()/1e3-900&&$("#comment-message").highlight(),t.get("teamID")&&(i="["+t.get("tag")+"]"),i+=t.get("displayName")?t.get("displayName"):t.get("username"),$("textarea[name=comment]").focus().val($("textarea[name=comment]").val()+"@"+i)},reportPost:function(e){return this.reportUser.show(e,this.getModelByEvent(e).id),!1},playerReported:function(){this.$(".report-player").velocity("fadeOut",function(){$(this).html("Reported. Thanks!").velocity("fadeIn")})},editPost:function(e){var t=this.getModelByEvent(e);return new r({model:t,el:this.getCommentByEvent(e).find(".comment-text")}),$(e.target).hide(),!1}})}),define("news/models/comment_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return"/api/news/"+this.get("newsId")+"/comment"},defaults:{comment:null},validationRules:{comment:{required:!0,maxlength:2e3}},validationMessages:{}})}),define("news/views/comment_box",["require","templates","analytics","news/models/comment_form","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("news/models/comment_form"),a=e("shared/classes/form_validation"),r=e("registry");return Backbone.View.extend({initialize:function(e){this.newsId=e.id,void 0===this.template&&(this.template=t("news","comment_box")),this.render()},render:function(){this.$el.html(this.template({newsId:this.newsId,allowComments:NTGLOBALS("ALLOW_COMMENTS"),player:r.get("player").toJSON(),loggedIn:NTGLOBALS("LOGGED_IN")})),new a(this.$("form"),this.$(".button"),new s,this.postComment,this)},postComment:function(){i.trackEvent("Blog","Comment"),this.$el.velocity("slideUp",function(){this.$el.html("Thanks for joining the conversation!  Your post will display shortly.").velocity("fadeIn"),r.get("player").set({lastComment:(new Date).getTime()/1e3}),r.get("player").inc({totalComments:1})}.bind(this))}})}),define("news/read",["require","news/collections/comments","news/views/comments","news/views/comment_box","registry"],function(e){"use strict";var t=e("news/collections/comments"),i=e("news/views/comments"),s=e("news/views/comment_box"),a=e("registry");return Backbone.View.extend({el:"#app",initialize:function(e){this.player=a.get("player");var r=e.newsId,n=new t(NTGLOBALS("COMMENTS"));this.comments=new i({model:n,id:r}),this.commentBox=new s({id:r}),this.render()},render:function(){this.$(".num-comments .num").html(NTGLOBALS("COMMENT_COUNT")),this.player.get("level")<20&&this.$(".add-comment").hide(),this.$(".comments").append(this.comments.el),this.$(".leave-comment").append(this.commentBox.el)}})}),define("stats/index",["require","registry","global/views/stats"],function(e){"use strict";var t=e("registry"),i=e("global/views/stats");return Backbone.View.extend({el:"#app",initialize:function(){this.stats=new i({model:t.get("player")}),this.render()},render:function(){this.$el.prepend(this.stats.el);var e=$("#midAd");e.length&&this.$("#midAdPosition").append(e)}})}),define("racelog/collections/data",["require"],function(e){"use strict";return Backbone.Collection.extend({currentPage:0,pageSize:30,totalRecords:0,fetch:function(e,t,i){return t=t||0,i=i||30,this.currentPage=t,this.pageSize=i,$.get("/api/stats/data/"+e+"?page="+t+"&limit="+i).done(function(e){e.success&&(this.totalRecords=e.data.totalRecords,this.reset(e.data.logs))}.bind(this))}})}),define("race/models/racer",["require","registry","shared/classes/typing","shared/classes/levels"],function(e){"use strict";var t=e("registry"),i=e("shared/classes/typing"),s=e("shared/classes/levels");return Backbone.Model.extend({idAttribute:"userID",defaults:{completeStamp:0,joinStamp:0,disqualified:!1,guest:!1,robot:!1,position:0,typed:0,errors:0,seconds:0,skipped:0,nitrosAvailable:0,nitros:0,nitrosUsed:0,profile:null,rewards:null},save:function(e){if(this.race=e,!NTGLOBALS("LOGGED_IN"))return this.saveGuest();var a=this.toJSON(),r=t.get("player"),n=e.racers.getPlace(this.id),o=(a.completeStamp-a.startStamp)/1e3;this.logProblemKeys();var l={money:a.rewards.money,experience:a.rewards.experience,level:s.levelForExperience(r.get("experience")+a.rewards.experience)>r.get("level")?1:0,nitros:a.rewards.nitros-a.nitrosUsed,placed1:1===n?1:0,placed2:2===n?1:0,placed3:3===n?1:0,racesPlayed:1,playTime:Math.ceil(o),nitrosUsed:a.nitrosUsed,wampusWins:a.rewards.bonuses.wampus?1:0};a.rewards.session?l.sessionRaces=1:r.set({sessionRaces:1}),"holiday"==NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(t.get("player").get("carID"))?(l.seasonField1=1,l.seasonField2=1,l.seasonField3=a.nitrosUsed):"summer"==NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(t.get("player").get("carID"))?(l.seasonField1=1,l.seasonField2=1,l.seasonField3=a.nitrosUsed):"halloween"==NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(t.get("player").get("carID"))&&(l.seasonField1=1),l.consecWins=1===n?1:-1*r.get("consecWins"),r.inc(l);var c=[];r.get("lastRaces")&&(c=r.get("lastRaces").split("|").map(function(e){var t=e.split(",");return{typed:parseInt(t[0],10),seconds:parseInt(t[1],10),errors:parseInt(t[2],10)}})),c.push({typed:a.typed-a.skipped,seconds:Math.round(o),errors:a.errors});var h=(c=c.slice(-10)).reduce(function(e,t){return{typed:e.typed+t.typed,seconds:e.seconds+t.seconds,errors:e.errors+t.errors}},{typed:0,seconds:0,errors:0}),d=i.speed(h.typed,h.seconds),u=i.accuracy(h.typed,h.errors,2),p=c.map(function(e){return e.typed+","+e.seconds+","+e.errors}).join("|"),m=Math.ceil(Date.now()/1e3),g=parseInt(r.get("tzOffset")||0,10),f=parseInt(r.get("lastConsecRace"),10),v=parseInt(r.get("consecDaysRaced"),10),y=m-m%86400-g,w=f-f%86400-g;y-w==86400?v++:y-w>86400&&(v=1),r.set({avgSpeed:d,avgAccuracy:u,lastRaces:p,newHighSpeed:i.speed(a.typed-a.skipped,o)>r.get("highestSpeed")?1:0,highestSpeed:Math.max(r.get("highestSpeed"),i.speed(a.typed-a.skipped,o)),longestSession:Math.max(r.get("sessionRaces"),r.get("longestSession")),lastConsecRace:m,consecDaysRaced:v,raceLogs:null,lastDq:null,DQs:0})},saveQualifying:function(e,s){var a=t.get("player"),r=i.speed(this.get("typed"),(this.get("completeStamp")-this.get("startStamp"))/1e3);return NTGLOBALS("LOGGED_IN")?$.post("/api/race/save-qualifying",{speed:r,carID:s.carID}).done(function(e){e.success&&(a.addCar(s.carID),a.set({carID:s.carID,avgSpeed:r}),a.inc({money:1e4}))}):(a.set({avgSpeed:r}),$.Deferred().resolve({success:!0}))},saveGuest:function(){var e=t.get("player"),s=this.toJSON(),a=i.speed(s.typed-s.skipped,(s.completeStamp-s.startStamp)/1e3);e.set({avgSpeed:a})},logProblemKeys:function(){var e=this.toJSON(),s={ak:JSON.stringify(this.get("allKeys")),ek:JSON.stringify(this.get("errorKeys"))};$("#"+rot47("3@EA")+rot47("2?6=")).length>0&&(s.hx="3@EA2?6=");var a=t.get("player");s.level=a.get("level"),s.std=this.race.std,this.race.isTriggered&&(s.trg=this.race.isTriggered),s.speed=i.speed(e.typed,(e.completeStamp-e.startStamp)/1e3),s.acc=i.accuracy(e.typed,e.errors,2),s.co=document.co,(s.std<=50||this.race.isTriggered)&&$.post("/api/race/problem-keys",s)},savePractice:function(){if(NTGLOBALS("LOGGED_IN")){var e=t.get("player"),i=this.toJSON();$.post("/api/race/log-practice",{secs:Math.ceil((i.completeStamp-i.startStamp)/1e3),errors:i.errors,typed:i.typed}).done(function(){e.inc({practices:1})})}},getAccuracy:function(){return i.accuracy(this.get("typed"),this.get("errors"),2)}})}),define("race/collections/racers",["require","race/models/racer"],function(e){"use strict";var t=e("race/models/racer");return Backbone.Collection.extend({comparator:function(e,t){return e.attributes.disqualified&&!t.attributes.disqualified?1:t.attributes.disqualified&&!e.attributes.disqualified?-1:e.attributes.completeStamp&&!t.attributes.completeStamp?-1:t.attributes.completeStamp&&!e.attributes.completeStamp?1:e.attributes.completeStamp&&t.attributes.completeStamp?e.attributes.completeStamp<t.attributes.completeStamp?-1:1:e.attributes.position==t.attributes.position?0:e.attributes.position>t.attributes.position?-1:1},model:t,getPlace:function(e){return this.sort(),this.indexOf(this.get(e))+1}})}),define("race/models/race",["require","race/collections/racers","registry"],function(e){"use strict";var t=e("race/collections/racers"),i=e("registry");return Backbone.Model.extend({idAttribute:"raceID",defaults:{track:"",music:"",completeStamp:0,startStamp:0,status:"",countdown:0,lessonID:0,lesson:"",nitros:0,lastCallStamp:0,callSpeed:250},self:null,racers:null,logs:[],log:function(e,t){var i;try{i=-1==this.realtime.transport.transports.indexOf("websocket")?"polling":"websocket"}catch(e){}this.logs.push({event:e,stamp:Date.now(),transport:i,data:t})},initialize:function(){this.racers=new t,this.realtime=i.get("realtime"),this.realtime.on("end",this.connectionEnd.bind(this)),this.realtime.on("reconnect failed",this.connectionEnd.bind(this)),this.realtime.on("reconnect",function(){this.reconnect()}.bind(this))},join:function(e,t){t=t||{},this.raceJoinOptions=t,this.self=e,t.fake?this.fakeRace():(this.listenTo(this.self,"change",this.trackChanges),this.sendUpdates(),t.update=3417,this.log("send:join",t),this.realtime.raceJoin(t).on("data",this.receiveUpdates.bind(this)))},beginFriendRace:function(){this.set({startFriendRace:!0}),this.log("send:beginFriendRace"),this.realtime.raceBeginFriendRace()},raceChanges:{},trackChanges:function(e){this.self.changed.nitrosUsed&&(this.raceChanges.n=e.changed.nitrosUsed),this.self.changed.typed&&(this.raceChanges.t=e.changed.typed),this.self.changed.errors&&(this.raceChanges.e=e.changed.errors),this.self.changed.skipped&&(this.raceChanges.s=e.changed.skipped),this.raceChanges.n>0&&this.sendUpdates()},sendUpdates:function(){if(Object.keys(this.raceChanges).length>0&&(this.log("send:update",this.raceChanges),this.realtime.raceUpdate(this.raceChanges),this.raceChanges={}),this.get("startStamp")>0&&(Date.now()-this.get("startStamp"))/1e3>20&&this.self.getAccuracy()>0&&this.self.getAccuracy()<50)this.trigger("error",{type:"accuracy",accuracy:this.self.getAccuracy()});else if(!this.self.get("completeStamp")){setTimeout(this.sendUpdates.bind(this),500)}},receiveUpdates:function(e){if("race"==e.stream){this.log("receive:"+e.msg,e.payload);var t=performance.now();switch(this.set({callSpeed:t-this.get("lastCallStamp"),lastCallStamp:t}),e.msg){case"error":this.error(e.payload);break;case"setup":this.setUp(e.payload);break;case"joined":this.addRacer(e.payload);break;case"left":e.payload==this.self.id?this.disqualifyRacer():this.removeRacer(e.payload);break;case"disqualified":this.disqualifyRacer();break;case"status":this.changeStatus(e.payload);break;case"update":this.racerUpdates(e.payload)}}},setUp:function(e){this.set(e),e.racers&&e.racers.forEach(function(e){this.addRacer(e)}.bind(this))},changeStatus:function(e){var t=["l","lesson","","join","reverse","split"];e[t[0]]&&(e[t[1]]=rot47(e[t[0]])[t[5]](t[2])[t[4]]()[t[3]](t[2]),delete e[t[0]]),"racing"==e.status?this.racers.each(function(t){t.set({startStamp:e.startStamp})}):"countdown"==e.status&&this.beginCountdown(),this.set(e)},beginCountdown:function(){this.countdownStart=performance.now(),this.countdownTimer()},countdownTimer:function(){if(0!==this.get("countdown")){if("racing"!=this.get("status")){var e=performance.now();return e-this.countdownStart>=1e3&&(this.countdownStart+=e-this.countdownStart,this.inc({countdown:-1})),requestAnimFrame(this.countdownTimer.bind(this))}this.set({countdown:0})}},addRacer:function(e){e.nitros=e.nitrosAvailable,this.racers.add(e)},removeRacer:function(e){this.racers.remove(e)},disqualifyRacer:function(){this.self.set({disqualified:!0}),console.warn("You have been disqualified")},error:function(e){this.trigger("error",e)},racerUpdates:function(e){e.racers.forEach(this.updateRacer.bind(this)),this.set({lastUpdate:this.get("startStamp")+e.secs,racerChanges:e.racers,seconds:e.secs/1e3}),this.racers.sort()},updateRacer:function(e){e.id=e.u,e.t&&(e.typed=e.t,e.position=e.t/this.attributes.lesson.length),e.n&&(e.nitrosUsed=e.n),e.d&&(e.disqualified=e.d),e.c&&(e.completeStamp=e.c),e.e&&(e.errors=e.e),e.s&&(e.skipped=e.s),e.r&&(e.rewards=e.r);var t=this.racers.get(e.u);t&&(t.set(e),e.u==this.self.id&&(e.c||e.r)&&this.self.set(this.racers.get(e.u).toJSON()))},reconnect:function(){!this.get("id")||this.self.get("disqualified")||this.self.get("completeStamp")||this.self.get("rewards")||this.self.get("error")||(console.log("Reconnect occurred"),this.realtime.raceReJoin(this.raceJoinOptions))},connectionEnd:function(e){this.trigger("error",{type:"closed",message:e&&e.message||null,stack:e&&e.stack||null})},disconnectError:function(){}})}),define("global/views/race_results",["require","templates","shared/classes/typing","global/models/car","registry","global/views/experience_bar","global/models/player","shared/classes/levels"],function(e){"use strict";var t=e("templates"),i=e("shared/classes/typing"),s=e("global/models/car"),a=e("registry"),r=e("global/views/experience_bar"),n=e("global/models/player"),o=e("shared/classes/levels");return Backbone.View.extend({events:{"click .close-button":"hide","click .racer":"clickRow","click .button-race":"raceAgain","mouseenter .racer":"showPlayerPopup","mouseleave .racer":"hidePlayerPopup"},initialize:function(e){void 0===this.template&&(this.template=t("global","race_results"),this.templateRacers=t("global","race_results_racers")),this.replay=e.replay,this.practice=e.practice,this.player=a.get("player"),this.racers=e.model.racers,this.hover=e.hover,this.replay||$(document).bind("keypress.rerace",this.handleEnterKey.bind(this)),this.render(),this.listenTo(this.model,"change",this.renderRacers)},render:function(){var e=this.racers.get(this.player.id).toJSON();e.place=this.racers.getPlace(this.player.id),e.rewards||(e.rewards={bonuses:{}}),2!=this.model.get("version")&&(e.rewards={},e.rewards.bonuses={place:e.money},e.rewards.experience=e.exp,e.rewards.nitros=e.nitros,e.rewards.money=e.money,this.racers.where({robot:"wampus"}).length&&e.place<this.racers.getPlace(this.racers.where({robot:"wampus"})[0].id)&&(e.rewards.bonuses.wampus=5e4,e.rewards.bonuses.place-=e.rewards.bonuses.wampus));var t=4;e.rewards.bonuses.wampus&&t++,e.rewards.bonuses.goldWords&&t++,e.rewards.bonuses.test&&t++,(NTGLOBALS("SPECIAL_EVENT")&&!this.replay||e.rewards.bonuses.event)&&t++,this.$el.hide().html(this.template({replay:this.replay,practice:this.practice,race:this.model.toJSON(),racer:e,racers:this.racers.toJSON(),player:this.player.toJSON(),speed:i.speed,accuracy:i.accuracy,rewardRows:t})),this.replay||(this.experienceBar=new r({width:445,el:this.$(".experience-bar"),level:o.levelForExperience(this.player.get("experience")-e.rewards.experience),experience:this.player.get("experience")-e.rewards.experience,loggedOut:!NTGLOBALS("LOGGED_IN")})),this.racersEle=this.$(".racers"),this.renderRacers(),$("body").append(this.el)},renderRacers:function(){this.racersEle.html(this.templateRacers({racers:this.racers.toJSON(),player:this.player.toJSON(),seconds:this.model.get("seconds"),top3:a.get("top3Players"),friends:a.get("playerFriends"),speed:i.speed,accuracy:i.accuracy,carTag:s.imageTag,countries:NTGLOBALS("COUNTRIES")}))},animateRewards:function(){this.replay||this.practice||(this.$(".current-cash .amount").countdown(this.player.get("money"),{formatter:function(e){return"$"+e.addCommas()}}),this.experienceBar.animateTo(this.player.get("experience")))},show:function(e,t){e&&this.$(".popup").css({top:Math.max(20,e-575)}),t?this.$el.velocity("fadeIn",this.animateRewards.bind(this)):(this.$el.show(),this.animateRewards())},hide:function(){return this.$el.hide(),this.trigger("hide"),!1},clickRow:function(e){var t=$(e.currentTarget);return t.hasClass("wampus")?(location.href="/racer/wampus",!1):!t.hasClass("guest")&&!t.hasClass("robot")&&(location.href="/racer/"+this.racers.get(t.data("id")).get("profile").username,!1)},showPlayerPopup:function(e){if(!this.hover)return!1;var t,i=$(e.currentTarget).data("id"),s=this.racers.findWhere({userID:i});if(!s)return!1;var a=s.get("profile");return a.userID=s.id,t=new n(a),this.hover.show(e.currentTarget,t,300,s.get("robot")),!1},hidePlayerPopup:function(e){return this.hover&&this.hover.hide(e),!1},handleEnterKey:function(e){if(!$(e.target).is("input"))return 13==e.which?($(document).unbind("keypress.rerace"),this.raceAgain()):void 0},raceAgain:function(){return location.reload(),!1}})}),define("racelog/views/table",["require","shared/classes/typing","race/models/race","global/models/player","global/views/race_results","templates"],function(e){"use strict";var t=e("shared/classes/typing"),i=e("race/models/race"),s=e("global/models/player"),a=e("global/views/race_results"),r=e("templates");return Backbone.View.extend({type:"racelog",events:{"click tbody tr":"clickRow"},initialize:function(e){void 0===this.template&&(this.template=r("racelog","table")),this.type=e.type||this.type,this.listenTo(this.model,"reset",this.render),this.render()},dateFormat:function(e,t){var i=moment(new Date(1e3*e));return"racelog"==t?i.format("MM/DD/YY hh:mma"):"lastdays"==t?i.format("MM/DD/YY"):"bymonth"==t?i.format("MMM/YY"):void 0},placeFormat:function(e,t,i){return"racelog"==i?e+e.ordinal():(e/t*10/10).toFixed(2)+" / 5"},monthFormat:function(e,t){return moment(new Date(t,e-1,1)).format("MMM, YYYY")},secondsFormat:function(e){var t;return e>60?(t=Math.floor(e/60))+" min"+(1==t?"":"s"):e+" secs"},render:function(){this.$el.html(this.template({data:this.model.toJSON(),type:this.type,pageSize:this.model.pageSize,totalRecords:this.model.totalRecords,currentPage:this.model.currentPage,dateFormat:this.dateFormat,placeFormat:this.placeFormat,secondsFormat:this.secondsFormat,monthFormat:this.monthFormat,speed:t.speed,accuracy:t.accuracy}))},clickRow:function(e){if("racelog"!=this.type)return!1;var t=$(e.currentTarget).data("id");return t!=this.lastRace&&(this.lastRace=t,this.fetchSavedRace(t).done(function(t){this.resultsView&&this.resultsView.remove(),this.resultsView=new a({destroy:!0,replay:!0,model:t}),this.resultsView.on("hide",function(){this.resultsView.remove(),this.lastRace=null},this),this.resultsView.show(e.pageY)}.bind(this)).fail(function(e){alert(e)}),!1)},fetchSavedRace:function(e){var t=$.Deferred();return $.get("/api/race/"+e).done(function(e){if(e.success){var a=new i(_.pick(e.data,["status","completeStamp","startStamp","lessonID","version"]));a.racers.reset(_.map(e.data.racers,function(e){return e.guest||e.robot||(e.userID=Number(e.userID)),e.seconds=(e.completeStamp-e.startStamp)/1e3,e.profile.wampus&&(e.robot="wampus"),e.profile=new s(e.profile).toJSON(),e})),e.data.rewards&&_.each(e.data.rewards,function(e){a.racers.get(e.userID).set(_.omit(e,["userID"]))}),t.resolve(a)}else t.reject("Unable to fetch race "+e.data.message)}),t}})}),define("racelog/views/pager",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({pages:1,pageSize:30,currentPage:0,events:{"click a":"handleClick"},initialize:function(e){void 0===this.template&&(this.template=t("racelog","pager")),this.pageSize=e.pageSize||this.pageSize,this.listenTo(this.model,"reset",this.setPages),this.render()},render:function(){this.$el.html(this.template({pages:this.pages}))},setPages:function(){var e=Math.ceil(this.model.totalRecords/this.pageSize);e!=this.pages&&(this.pages=e,this.render())},handleClick:function(e){var t=$(e.target).data("index");return t!=this.currentPage&&("next"==t&&(t=this.currentPage+1),!(t+1>this.pages)&&(this.currentPage=t,this.$("a").removeClass("active"),this.$("a[data-index="+this.currentPage+"]").addClass("active"),this.trigger("change",this.currentPage),!1))}})}),define("racelog/index",["require","registry","racelog/collections/data","racelog/views/table","racelog/views/pager","stats/views/racelog_graph","shared/classes/typing","stats/views/daily_graph","stats/views/monthly_graph"],function(e){"use strict";var t=e("registry"),i=e("racelog/collections/data"),s=e("racelog/views/table"),a=e("racelog/views/pager"),r=e("stats/views/racelog_graph"),n=e("shared/classes/typing"),o=e("stats/views/daily_graph"),l=e("stats/views/monthly_graph");return Backbone.View.extend({el:"#app",daysBack:30,pageSize:30,type:"racelog",initialize:function(e){this.type=e.type||this.type,this.player=t.get("player"),"gold"==this.player.get("membership")&&(this.daysBack=90),this.model=new i,this.listenTo(this.model,"reset",this.changePage),this.pagerView=new a({model:this.model,pageSize:this.pageSize}),this.listenTo(this.pagerView,"change",this.fetchPage),"racelog"==this.type?this.graphView=new r({width:735,height:198}):"lastdays"==this.type?this.graphView=new o({width:735,height:198}):this.graphView=new l({width:735,height:198}),this.tableView=new s({model:this.model,type:this.type}),this.render(),this.fetchPage(0)},render:function(){var e="";switch(this.type){case"bymonth":e="Monthly Stats";break;case"lastdays":e="Daily Stats (Last "+this.daysBack+" Days)";break;case"racelog":e="Race Logs (Last "+this.daysBack+" Days)"}this.$(".section-header").html(e),this.$(".export").attr("href","/api/stats/data/"+this.type+"?export=1"),this.$(".pages").append(this.pagerView.el),this.$(".graph").append(this.graphView.el),this.$(".table").append(this.tableView.el)},changePage:function(){var e=_.map(this.model.toJSON(),function(e){var t;return"bymonth"==this.type?(t=moment(new Date(e.year,e.month-1,1)),e.label=t.format("MMM, YYYY"),e.place=(e.placed/e.races*10/10).toFixed(2)+"/5"):"racelog"==this.type?(t=moment(new Date(1e3*e.stamp)),e.label=t.format("MMM D, YYYY"),e.place=e.placed):"lastdays"==this.type&&(t=moment(new Date(1e3*e.stamp)),e.label=t.format("MM/DD/YY"),e.place=(e.placed/e.races*10/10).toFixed(2)+"/5"),e.money=e.reward.money,e.value=n.speed(e.typed,e.secs),e}.bind(this)).reverse();this.graphView.setData(e),this.graphView.render()},fetchPage:function(e){this.model.fetch(this.type,e,this.pageSize).done(function(e){e.success||alert("There was an error fetching your data: "+e.data.message)})}})}),define("race/models/practice_race",["require","race/collections/racers","registry"],function(e){"use strict";var t=e("race/collections/racers"),i=e("registry");return Backbone.Model.extend({idAttribute:"raceID",defaults:{track:"",music:"",completeStamp:0,startStamp:0,status:"",countdown:0,lessonID:0,nitros:0,practice:!0},self:null,racers:null,initialize:function(){this.racers=new t},join:function(e){this.self=e,this.listenTo(this.self,"change:typed",this.racerUpdates),this.listenTo(this.self,"change:errors",this.racerUpdates),this.sendUpdates(),$.get("/api/race/practice-lesson").done(function(e){e.success?(this.begin(),this.countdown(e.data.lesson,3)):alert("There was an error fetching a practice lesson")}.bind(this))},begin:function(){var e=i.get("player");this.setUp({status:"open",racers:[{userID:e.id,profile:e.toJSON()}]})},countdown:function(e,t){this.changeStatus({status:"countdown",lesson:e}),this.updateCountdown(t);var i=setInterval(function(){var e=this.get("countdown");this.updateCountdown(e-1),0===this.get("countdown")&&(clearInterval(i),this.changeStatus({status:"racing"}))}.bind(this),1e3)},setUp:function(e){this.set(e),e.racers&&e.racers.forEach(function(e){this.addRacer(e)}.bind(this))},changeStatus:function(e){if("racing"==e.status){var t=Date.now();e.startStamp=t,this.racers.each(function(e){e.set({startStamp:t})}),this.raceUpdate()}this.set(e)},updateCountdown:function(e){this.set({countdown:e})},addRacer:function(e){this.racers.add(e)},raceUpdate:function(){this.racers.at(0).set({update:Date.now()}),this.racers.at(0).get("completeStamp")||setTimeout(this.raceUpdate.bind(this),500)},raceChanges:{},racerUpdates:function(e){var t=e.changed;t.typed&&(this.raceChanges.typed=t.typed),t.errors&&(this.raceChanges.errors=t.errors)},sendUpdates:function(){this.get("lesson")&&(this.raceChanges.typed||this.raceChanges.errors)&&(this.raceChanges.typed&&(this.raceChanges.position=this.raceChanges.typed/this.get("lesson").length),1==this.raceChanges.position&&(this.raceChanges.completeStamp=Date.now(),this.raceChanges.rewards=!0,this.set({completeStamp:this.raceChanges.completeStamp})),this.raceChanges.id=this.self.id);var e=Date.now(),t={lastUpdate:e,seconds:(e-this.get("startStamp"))/1e3,lastCallStamp:e,callSpeed:e-this.get("lastCallStamp")};this.get("startStamp")||(t.seconds=0),Object.keys(this.raceChanges).length>0&&(this.racers.at(0).set(this.raceChanges),this.self.set(this.racers.at(0).toJSON()),t.racerChanges=[this.raceChanges]),this.set(t),this.raceChanges={},this.get("completeStamp")||setTimeout(this.sendUpdates.bind(this),1e3)}})}),define("race/models/qualifying_race",["require","race/models/practice_race","registry"],function(e){"use strict";var t=e("race/models/practice_race");e("registry");return t.extend({lesson:"By typing this text you are setting your qualifying typing speed.",join:function(e){this.self=e,this.listenTo(this.self,"change:typed",this.racerUpdates),this.listenTo(this.self,"change:errors",this.racerUpdates),this.sendUpdates(),this.begin()},beginCountdown:function(){this.countdown(this.lesson,4)}})}),define("race/views/invite",["require","global/views/modal","analytics","registry","global/models/car","friends/collections/friends","templates"],function(e){"use strict";var t=e("global/views/modal"),i=(e("analytics"),e("registry")),s=e("global/models/car"),a=e("friends/collections/friends"),r=e("templates");return t.extend({_initialize:function(){void 0===this.template&&(this.template=r("race","invite")),this.player=i.get("player"),this.delegateEvents(_.extend(this.events,{"click .tabs li":"clickTab","click .friend":"clickFriend","click .send-invites":"sendInvites"})),this.model=new a,this.model.onlineOnly=!0,this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"request",this.showSpinner),this.render(),this.model.fetch(0),this.inited=!0},render:function(){this.$el.append(this.template({data:this.model.toJSON(),player:this.player.toJSON(),carTag:s.imageTag})),this.hideSpinner()},showSpinner:function(){this.$(".friends").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friends").fastShow(),this.$(".spinner").fastHide()},show:function(){return this.inited||this._initialize(),t.prototype.show.apply(this,arguments)},clickFriend:function(e){return $(e.currentTarget).toggleClass("active"),!1},clickTab:function(e){var t=$(e.currentTarget);if(t.hasClass("active"))return!1;var i=$(e.currentTarget).hasClass("others")?"others":"online";return this.$(".tabs li").removeClass("active"),t.addClass("active"),"others"==i?(this.$(".online-friends").fastHide(),this.$(".invite-others").velocity("fadeIn")):(this.$(".invite-others").fastHide(),this.$(".online-friends").velocity("fadeIn")),!1},sendInvites:function(e){var t=this.$(".friend.active"),s=_.map(t,function(e){return $(e).data("id")});return!!s.length&&(i.get("realtime").raceInvites(s),t.addClass("sending"),$(e.currentTarget).fastHide(),this.$(".invites-sent").fastShow(),setTimeout(function(){this.hide(),t.removeClass("sending active"),$(e.currentTarget).fastShow(),this.$(".invites-sent").fastHide()}.bind(this),3e3),!1)}})}),define("global/views/filtered_select",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({className:"response-container",selectOptions:{},filter:"",text:"",events:{"click .selected-response":"toggleOptions","keyup .search-input":"keyInput","click li":"clickOption"},initialize:function(e){this.options=e,this.template=t("global","filtered_select"),this.selectOptions=e.selectOptions,this.select=$(e.select),this.render()},render:function(){this.$el.append(this.template()),this.selectedEle=this.$(".selected-response"),this.optionsEle=this.$(".response-scroll"),this.filterEle=this.$(".search-input"),this.renderOptions()},renderOptions:function(){var e="",t=this.filter.replace(/[\-\[\]\/\{}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");Object.keys(this.selectOptions).forEach(function(i){e+='<p class="response-group">'+i+"</p><ul>",this.selectOptions[i].forEach(function(i){i.match(new RegExp(t,"i"))&&(e+="<li>"+i+"</li>")}.bind(this)),e+="</ul>"}.bind(this)),this.optionsEle.html(e)},resetFilter:function(){this.filter="",this.clearSelection(),this.renderOptions(),this.filterEle.val(""),this.optionsEle.scrollTop(0)},clearSelection:function(){this.$("li.active").removeClass("active"),this.selectedEle.html("&nbsp;"),this.text=""},clickOption:function(e){this.selectText($(e.currentTarget))},getText:function(){return this.text},selectText:function(e){var t=$(e).html();this.text=t,this.$("li.active").removeClass("active"),e.addClass("active"),this.hideOptions(),this.selectedEle.html(t)},toggleOptions:function(){this.$el.hasClass("open")?this.hideOptions():this.showOptions()},showOptions:function(){this.filters&&this.resetFilter(),this.filterEle.focus(),this.$el.addClass("open")},hideOptions:function(){this.$el.removeClass("open")},keyInput:function(e){if(13==e.which){var t=this.optionsEle.find("li.active");if(0===t.length){var i=this.optionsEle.find("li");1===i.length&&(t=i)}if(t){if(this.text=t.html(),!this.text)return;this.trigger("enter"),this.hideOptions(),this.resetFilter()}return!1}return 27==e.which?(""===this.filter&&this.hideOptions(),this.resetFilter(),this.clearSelection(),!1):38==e.which?(this.moveActive(-1),!1):40==e.which?(this.moveActive(1),!1):(this.filter!=e.currentTarget.value&&(this.filter=e.currentTarget.value,this.renderOptions()),!1)},moveActive:function(e){for(var t,i=this.optionsEle.find("li"),s=0;s<i.length;s++)if("active"==(t=i[s]).className)return void(i[s+e]&&(i[s+e].className="active",this.selectedEle.html(i[s+e].innerHTML),i[s+e].scrollIntoView(!1),t.className=""));i.length&&(i[0].className="active")}})}),define("shared/classes/drags",["require"],function(e){$.fn.drags=function(e){if(""===(e=$.extend({handle:"",cursor:"move"},e)).handle)t=this;else var t=this.find(e.handle);if("function"==typeof e.stop)i=e.stop;else var i=$.noop;return t.css("cursor",e.cursor).on("mousedown",function(t){if(""===e.handle)i=$(this).addClass("draggable");else var i=$(this).addClass("active-handle").parent().addClass("draggable");var s=i.css("z-index"),a=i.outerHeight(),r=i.outerWidth(),n=i.offset().top+a-t.pageY,o=i.offset().left+r-t.pageX;i.parents().on("mousemove",function(e){$(".draggable").offset({top:e.pageY+n-a,left:e.pageX+o-r}).on("mouseup",function(){$(this).removeClass("draggable").css("z-index",s)})}),t.preventDefault()}).on("mouseup",function(t){""===e.handle?$(this).removeClass("draggable"):$(this).removeClass("active-handle").parent().removeClass("draggable");var s=$(this).offset();i({top:s.top,left:s.left})})}}),define("race/views/chat",["require","registry","templates","global/views/filtered_select","shared/classes/drags"],function(e){"use strict";var t=e("registry"),i=e("templates"),s=e("global/views/filtered_select");return e("shared/classes/drags"),Backbone.View.extend({className:"race-chat",events:{"click .send":"send","click .collapse-toggle":"toggleCollapse"},initialize:function(e){this.options=e,this.template=i("race","chat"),this.chatTemplate=i("race","chat_row"),this.player=t.get("player"),this.realtime=t.get("realtime"),this.realtime.on("data",this.receiveData.bind(this)),this.race=e.race,this.listenTo(this.race,"change:status",this.raceStatusChange),this.chats=new Backbone.Collection,this.listenTo(this.chats,"add",this.renderNewChat),this.racers=e.race.racers,this.listenTo(this.racers,"add",this.updateRacers),this.listenTo(this.racers,"remove",this.updateRacers),this.chatOptions=_.flatten(_.values(NTGLOBALS("CHAT_TEXTS"))),this.select=new s({selectOptions:NTGLOBALS("CHAT_TEXTS")}),this.select.on("enter",this.send.bind(this));var a=this.player.get("_chatPos");a&&this.$el.css(a),this.render()},raceStatusChange:function(e,t){"open"==t?this.joinRoom():"countdown"==t&&this.hide()},render:function(){this.$el.fastHide().html(this.template()),this.$(".chat-texts").replaceWith(this.select.el),this.messagesEle=this.$(".messages"),this.racersSelect=this.$(".racers"),this.updateRacers(),this.$el.drags({handle:".handle",stop:function(e){this.player.set({_chatPos:e})}.bind(this)})},renderNewChat:function(e){(e=e.toJSON()).userID==this.player.id?e.fromClass="you":e.fromClass="other";var t=$(this.chatTemplate(e));this.messagesEle.append(t),this.messagesEle[0].scrollTop=this.messagesEle[0].scrollHeight},show:function(){this.shown||(this.shown=!0,this.$el.velocity("fadeIn"))},hide:function(){this.$el.fastHide()},updateRacers:function(){var e,t,i,s='<option value="">Everyone</option>';this.racers.forEach(function(a){a.id!=this.player.id&&(e=a.get("profile"),i=e.tag?"["+e.tag+"]":"",t=e.displayName?e.displayName:e.username,s+="<option>"+i+t+"</option>")}.bind(this)),this.racersSelect.html(s),this.racers.length>1&&!this.race.get("startFriendRace")&&this.show()},send:function(){var e=this.select.getText();if(this.select.hideOptions(),this.select.resetFilter(),this.select.clearSelection(),e){var t=this.racersSelect.val();this.racersSelect[0].selectedIndex=0;var i=this.player.get("tag"),s=this.player.get("displayName")||this.player.get("username");i&&(s="["+i+"]"+s),this.realtime.chat({room:this.race.get("id"),userID:this.player.id,to:t,from:s,msg:e})}},joinRoom:function(){this.realtime.chat({room:this.race.get("id"),join:!0})},receiveData:function(e){"chat"==e.stream&&e.chats.forEach(function(e){if(-1!==this.chatOptions.indexOf(e.msg)){if(this.racers.get(e.userID)){var t=this.racers.get(e.userID).get("profile"),i=t.tag,s=t.displayName||t.username;i&&(s="["+i+"]"+s),e.from=s}this.chats.add(e)}}.bind(this))},toggleCollapse:function(){return this.$el.toggleClass("collapsed"),!1}})}),define("race/views/top/background",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=PIXI.Sprite.fromFrame("race_top.png")};return t.prototype={tick:function(e){}},t}),define("race/views/top/sound_buttons",["require","registry"],function(e){"use strict";var t=e("registry"),i=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.player=t.get("player");var i=this.player.get("raceSounds");"none"==i?(this.fx="off",this.music="off"):"only_music"==i?(this.fx="off",this.music="on"):"only_fx"==i?(this.fx="on",this.music="off"):(this.fx="on",this.music="on"),this.textures={music_on:PIXI.Texture.fromFrame("sound_music_on.png"),music_off:PIXI.Texture.fromFrame("sound_music_off.png"),fx_on:PIXI.Texture.fromFrame("sound_fx_on.png"),fx_off:PIXI.Texture.fromFrame("sound_fx_off.png")},this.el=new PIXI.DisplayObjectContainer,this.fxButton=new PIXI.Sprite(this.textures["fx_"+this.fx]),this.fxButton.position.x=8,this.fxButton.position.y=32,$("#sound-fx-toggle").click(this.toggleFx.bind(this)),this.musicButton=new PIXI.Sprite(this.textures["music_"+this.music]),this.musicButton.position.x=8,this.musicButton.position.y=53,$("#sound-music-toggle").click(this.toggleMusic.bind(this)),this.el.addChild(this.fxButton),this.el.addChild(this.musicButton)};return i.prototype={toggleFx:function(){this.fx="on"==this.fx?"off":"on",this.fxButton.setTexture(this.textures["fx_"+this.fx]),this.updateSoundPrefs()},toggleMusic:function(){this.music="on"==this.music?"off":"on",this.musicButton.setTexture(this.textures["music_"+this.music]),this.updateSoundPrefs()},updateSoundPrefs:function(){$("#sound-tooltip").remove();var e;e="on"==this.music&&"on"==this.fx?"all":"on"==this.music&&"off"==this.fx?"only_music":"off"==this.music&&"on"==this.fx?"only_fx":"none",this.player.setSoundPrefs(e)}},i}),define("race/views/top/lead_car",["require","global/models/car"],function(e){"use strict";var t=e("global/models/car"),i=function(e){this.game=e.game,this.model=e.model,this.leader=null,this.model.racers.on("sort",this.update.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=640,this.el.position.y=14;var t=new PIXI.Text("Lead Car",{font:"14px 'Droid Serif'",fill:"#f8ce5e"});t.position.x=14,t.position.y=15,this.el.addChild(t),this.teamNameText=new PIXI.Text(" ",{font:"14px 'Droid Serif'"}),this.teamNameText.position.x=14,this.teamNameText.position.y=33,this.el.addChild(this.teamNameText),this.displayNameText=new PIXI.Text(" ",{font:"14px 'Droid Serif'",fill:"#cecece"}),this.displayNameText.position.x=14,this.displayNameText.position.y=33,this.el.addChild(this.displayNameText),this.leadCar=PIXI.Sprite.fromFrame("car_loading.png"),this.leadCar.position.y=12,this.leadCar.position.x=226,this.leadCar.anchor.x=1,this.el.addChild(this.leadCar)};return i.prototype={tick:function(e){},update:function(){if(!("racing"!=this.model.get("status")||this.model.get("seconds")<1)){var e=this.model.racers.at(0);if(e!==this.leader){var i=e.get("profile");this.updateCar(t.imageSrc("small",i.carID,i.carHueAngle)),i.tag?(this.teamNameText.visible=!0,this.teamNameText.setText("["+i.tag+"]"),this.teamNameText.setStyle({fill:"#"+i.tagColor,font:"14px 'Droid Serif'"}),this.displayNameText.position.x=14+this.teamNameText.width):(this.displayNameText.position.x=14,this.teamNameText.visible=!1),this.displayNameText.setText(i.displayName||i.username),this.leader=e}}},updateCar:function(e){this.leadCar.setTexture(PIXI.Texture.fromImage(e))}},i}),define("race/views/top/mini_track",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.el=new PIXI.DisplayObjectContainer,this.el.x=179,this.el.y=17,this.cars={},this.carPositions=[],this.model.racers.on("add",this.addRacer.bind(this)),this.model.racers.on("remove",this.removeRacer.bind(this)),this.model.on("change:racerChanges",this.update.bind(this)),this.model.racers.forEach(function(e){this.addRacer(e)}.bind(this))};return t.prototype={tick:function(e){var t=this;Object.keys(this.cars).forEach(function(e){var i=t.cars[e];i.position.x=Math.round(i.tempX)})},addRacer:function(e){for(var t=e.id==this.racer.id,i=0;i<this.carPositions.length&&this.carPositions[i];i++);this.carPositions[i]=e;var s;(s=t?PIXI.Sprite.fromFrame("mini_car_self.png"):PIXI.Sprite.fromFrame("mini_car_other.png")).tempX=0,s.position.y=11*i,this.el.addChild(s),this.cars[e.id]=s},removeRacer:function(e){this.el.removeChild(this.cars[e.id]),delete this.cars[e.id],delete this.carPositions[this.carPositions.indexOf(e)]},update:function(){var e;this.model.get("racerChanges").forEach(function(t){t.position&&(e=426*t.position,createjs.Tween.get(this.cars[t.id],{override:!0}).to({tempX:e},this.model.get("callSpeed")+10))},this)}},t}),define("race/views/top",["require","race/views/top/background","race/views/top/sound_buttons","race/views/top/lead_car","race/views/top/mini_track","registry"],function(e){"use strict";var t=e("race/views/top/background"),i=e("race/views/top/sound_buttons"),s=e("race/views/top/lead_car"),a=e("race/views/top/mini_track");e("registry");return Backbone.View.extend({initialize:function(e){this.options=e,this.loader=e.loader,this.stage=e.stage,this.renderer=e.renderer,this.supportSound=!0,this.started=!1,this.racer=e.racer,this.deltaCounter=0,this.loader.on("complete",function(){this.start(),this.started=!0}.bind(this))},start:function(){this.background=new t({game:this}),this.stage.addChild(this.background.el),this.supportSound&&(this.soundButtons=new i({game:this}),this.stage.addChild(this.soundButtons.el)),this.leadCar=new s({game:this,model:this.model}),this.stage.addChild(this.leadCar.el),this.miniTrack=new a({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.miniTrack.el),this.updateStage()},tick:function(e){this.started&&this.miniTrack.tick(e)},updateStage:function(){this.renderer.render(this.stage)}})}),define("race/views/track/background",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.velocity=0,this.allowVelocityChanges=!1,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var t,i=0;i<12;i++)(t=PIXI.Sprite.fromFrame("base.png")).position.x=i*t.width,this.el.addChild(t);for(i=0;i<2;i++)(t=PIXI.Sprite.fromFrame("top.png")).position.x=i*t.width,this.el.addChild(t),(t=PIXI.Sprite.fromFrame("skids.png")).position.x=i*t.width,this.el.addChild(t);this.el.cacheAsBitmap=!0,this.tileW=this.el.getBounds().width/2};return t.prototype={tick:function(e){this.el.position.x=Math.round((this.el.position.x-e.delta*this.velocity)%this.tileW)},begin:function(){createjs.Tween.get(this).to({velocity:1},3e3,createjs.Ease.linear).call(function(){this.allowVelocityChanges=!0}.bind(this))},updateVelocity:function(e){this.allowVelocityChanges&&(e=Math.max(Math.min(e,2),.5),createjs.Tween.get(this).to({velocity:1*e},1e3,createjs.Ease.linear))}},t}),define("race/views/track/animation",["require"],function(e){"use strict";var t={nitro:{frames:10,speed:.4},hearts:{frames:4,speed:.3},smoke:{frames:20,speed:.4},stars:{frames:10,speed:.3},type:{frames:12,speed:.3},lightning:{frames:24,speed:.2},bits:{frames:19,speed:.4},fire:{frames:16,speed:.5}},i=function(e){this.game=e.game;var i,s=t[e.type],a=[];if(s){for(var r=0;r<s.frames;r++)i=PIXI.Texture.fromFrame(e.type+"/texture"+String(r+1).pad(4,"0","STR_PAD_LEFT")+".png"),a.push(i);this.el=new PIXI.MovieClip(a),this.el.animationSpeed=s.speed}};return i.prototype={play:function(e){this.el.loop=e,this.el.gotoAndPlay(0)}},i}),define("race/views/track/flag",["require"],function(e){"use strict";var t=function(e){this.game=e.game;try{this.el=PIXI.Sprite.fromFrame("flags/"+e.country.toLowerCase()+".png")}catch(e){this.el=PIXI.Sprite.fromFrame("flags/unknown.png")}};return t.prototype={tick:function(e){}},t}),define("race/views/track/gender",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=PIXI.Sprite.fromFrame(e.gender+".png"),e.gender||(this.el.visible=!1)};return t.prototype={tick:function(e){}},t}),define("race/views/track/car",["require","race/views/track/animation","race/views/track/flag","race/views/track/gender","global/models/car","registry"],function(e){"use strict";var t=e("race/views/track/animation"),i=e("race/views/track/flag"),s=e("race/views/track/gender"),a=e("global/models/car"),r=e("registry"),n=980,o=function(e){this.options=e,this.game=e.game,this.model=e.model,this.race=e.race,this.practiceMode=this.race.get("practice"),this.animations={},this.progress=0,this.disqualified=!1,this.finished=!1,this.wpm=0,this.initialized=!1,this.x=0,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=90+46*e.position+this.game.topOffset,this.hideOffTrack(),n=this.game.renderer.width+30;var t=this.model.get("profile");this.carSrc=a.imageSrc("small",t.carID);var i=$("<img>").attr("src",this.carSrc).load(function(){try{if(t.carHueAngle>0)return void Pixastic.process(i[0],"hsl",{hue:t.carHueAngle},function(e){this.initialize(new PIXI.Sprite(new PIXI.Texture(new PIXI.BaseTexture(e),new PIXI.Rectangle(0,0,e.width,e.height))))}.bind(this))}catch(e){console.warn("Failed to color car. Falling back to no paint"),console.error(e)}var e=PIXI.Sprite.fromImage(this.carSrc);e.width=i[0].width,e.height=i[0].height,this.initialize(e)}.bind(this)).error(function(){console.error("Car image failed to load: ",this.carSrc),this.carSrc=a.imageSrc("small",9,0),this.initialize(PIXI.Sprite.fromImage(this.carSrc))}.bind(this))};return o.prototype={tick:function(){this.el.position.x=Math.round(this.x)},calculateX:function(e){if(!(this.progress>=1||this.finished||this.disqualified)){var t=0,i=0,s=(n-345)/20+5;this.practiceMode?i=(n-345)*e:e>=.8&&(i=(100*e-80)*s),t=this.options.self?i:100*(this.progress-e)*s+i,t=Math.round(t),createjs.Tween.get(this,{override:!0}).to({x:t},this.race.get("callSpeed")+100)}},initialize:function(e){if(!this.initialized){this.initialized=!0;var t=this.model.get("profile");this.car=e,this.car.position.x=345,this.car.anchor.x=1,this.tag=new PIXI.DisplayObjectContainer,this.tag.position.x=2;var a=PIXI.Sprite.fromImage((this.options.self?"self_tag":"competitor_tag")+".png");a.position.y=2;var n=t.country;"NT"==t.tag&&(n="ftw");var o=new i({game:this.game,country:n});o.el.position.x=8,o.el.position.y=7;var l,c=o.el.width+12;t.gender&&((l=new s({game:this.game,gender:t.gender})).el.position.x=c,l.el.position.y=6,c+=l.el.width+4);var h;r.get("playerFriends").get(this.model.id)&&((h=PIXI.Sprite.fromImage("friend.png")).position.x=c,h.position.y=6,c+=h.width+3);var d;"gold"==t.membership&&((d=PIXI.Sprite.fromImage("gold_icon.png")).position.x=c,d.position.y=6,c+=d.width+2);var u;r.get("top3Players").get(this.model.id)&&((u=PIXI.Sprite.fromImage("scoreboard_champion.png")).position.x=c,u.position.y=4);var p="";t.tag&&(p="["+t.tag+"]");var m=new PIXI.Text(p+(t.displayName||t.username),{font:'10px "Droid Serif"',fill:"#FFFFFF"});if(m.position.x=7,m.position.y=22,m.width>120){var g=new PIXI.Graphics;g.beginFill(16777215).drawRect(0,0,120,40),m.mask=g}this.tag.addChild(a),this.tag.addChild(m),this.tag.addChild(o.el),l&&this.tag.addChild(l.el),h&&this.tag.addChild(h),d&&this.tag.addChild(d),u&&this.tag.addChild(u),this.tag.cacheAsBitmap=!0,this.el.addChild(this.car),this.el.addChild(this.tag),t.animation&&this.addAnimation(t.animation,"behind",!0),this.addAnimation("nitro"),this.enterTrack(this.options.animateIn)}},disqualify:function(){this.disqualified=!0,this.el.x>-345&&createjs.Tween.get(this,{override:!0}).to({x:-345},2*(this.el.x+345),createjs.Ease.linear)},hideOffTrack:function(){createjs.Tween.removeTweens(this),this.x=-345},enterTrack:function(e){e?createjs.Tween.get(this,{override:!0}).to({x:0},1e3,createjs.Ease.sineOut):this.x=0},enterFinish:function(e,t){this.finished=!0;var i=this.game.renderer.width-345;e?(this.hideOffTrack(),createjs.Tween.get(this,{override:!0}).wait(t).to({x:i},1500+t,createjs.Ease.sineOut)):(createjs.Tween.removeTweens(this),this.x=i)},finishRace:function(){this.finished=!0,createjs.Tween.get(this,{override:!0}).to({x:this.game.renderer.width+100},500,createjs.Ease.linear)},addAnimation:function(e,i,s){i=i||"behind";var a=new t({game:this.game,type:e});this.model.get("profile");this.animations[e]=a,"behind"==i&&(a.el.position.x=345-this.car.width-a.el.width,a.el.position.y=Math.round(20-a.el.height/2)),this.el.addChild(a.el),s&&a.play(!0)},fireNitro:function(){this.animations.nitro&&this.animations.nitro.play(!1)}},o}),define("race/views/track/tree",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.isCanvas=!(this.game.renderer instanceof PIXI.WebGLRenderer),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=412,this.el.position.y=60+this.game.topOffset;var t=PIXI.Sprite.fromFrame("tree_lights.png");this.el.addChild(t),this.lights={},this.lights.green=[PIXI.Sprite.fromFrame("green_light_glow.png"),PIXI.Sprite.fromFrame("green_light_glow.png")],this.lights.yellow=[PIXI.Sprite.fromFrame("yellow_light_glow.png"),PIXI.Sprite.fromFrame("yellow_light_glow.png")],this.lights.red=[PIXI.Sprite.fromFrame("red_light_glow.png"),PIXI.Sprite.fromFrame("red_light_glow.png")],this.lights.green[0].position.x=-5,this.lights.green[1].position.x=92,this.lights.yellow[0].position.x=-5,this.lights.yellow[1].position.x=92,this.lights.red[0].position.x=-5,this.lights.red[1].position.x=92,this.el.addChild(this.lights.green[0]),this.el.addChild(this.lights.green[1]),this.el.addChild(this.lights.yellow[0]),this.el.addChild(this.lights.yellow[1]),this.el.addChild(this.lights.red[0]),this.el.addChild(this.lights.red[1]),this.wait=PIXI.Sprite.fromFrame("tree_wait.png"),this.wait.position.x=155,this.wait.position.y=3,this.wait.visible=!0,this.el.addChild(this.wait),this.ready=PIXI.Sprite.fromFrame("tree_ready.png"),this.ready.position.x=155,this.ready.position.y=52,this.ready.visible=!1,this.el.addChild(this.ready),this.type=PIXI.Sprite.fromFrame("tree_type.png"),this.type.position.x=155,this.type.position.y=200,this.type.visible=!1,this.el.addChild(this.type),this.showFrame(4)};return t.prototype={tick:function(e){},getLightMask:function(e){var t=new PIXI.Graphics;return t.beginFill(0).drawCircle(this.el.position.x+29,this.el.position.y+29+48*e,23),t.beginFill(0).drawCircle(this.el.position.x+125,this.el.position.y+29+48*e,23),t},showFrame:function(e){switch(this.lights.green[0].visible=!1,this.lights.green[1].visible=!1,this.lights.yellow[0].visible=!1,this.lights.yellow[1].visible=!1,this.lights.red[0].visible=!1,this.lights.red[1].visible=!1,this.ready.visible=!1,this.wait.visible=!1,e){case 3:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=48*(4-e)-3,this.lights.yellow[1].position.y=48*(4-e)-3,this.ready.visible=!0;break;case 2:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=48*(4-e)-3,this.lights.yellow[1].position.y=48*(4-e)-3,this.ready.position.y=103,this.ready.visible=!0;break;case 1:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=48*(4-e)-3,this.lights.yellow[1].position.y=48*(4-e)-3,this.ready.visible=!0,this.ready.position.y=150;break;case 0:this.lights.green[0].visible=!0,this.lights.green[1].visible=!0,this.lights.green[0].position.y=48*(4-e)-2,this.lights.green[1].position.y=48*(4-e)-2,this.type.visible=!0,createjs.Tween.get(this.el).wait(1e3).to({alpha:0},1e3).call(function(){this.el.visible=!1}.bind(this));break;default:this.lights.red[0].position.y=-3,this.lights.red[1].position.y=-3,this.lights.red[0].visible=!0,this.lights.red[1].visible=!0,this.wait.visible=!0}}},t}),define("race/views/track/starting_line",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var t,i=0;i<8;i++)(t=PIXI.Sprite.fromFrame("base.png")).position.x=i*t.width,this.el.addChild(t);for(i=0;i<4;i++)(t=PIXI.Sprite.fromFrame("bleachers.png")).position.x=i*t.width,this.el.addChild(t);var s=PIXI.Sprite.fromFrame("start.png");s.position.x=240,s.position.y=42,this.el.addChild(s),this.el.cacheAsBitmap=!0};return t.prototype={tick:function(e,t){this.el.visible&&(this.el.position.x=Math.round(this.el.position.x-e.delta*t),this.el.position.x<=-this.el.getBounds().width&&(this.el.visible=!1))}},t}),define("race/views/track/finish_line",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var t,i=new PIXI.DisplayObjectContainer,s=0;s<6;s++)(t=PIXI.Sprite.fromFrame("base.png")).position.x=s*t.width,i.addChild(t);for(s=0;s<3;s++)(t=PIXI.Sprite.fromFrame("bleachers.png")).position.x=s*t.width,i.addChild(t);for(t=PIXI.Sprite.fromFrame("skids.png"),i.addChild(t),(t=PIXI.Sprite.fromFrame("finish.png")).position.x=0,t.position.y=88,i.addChild(t),i.cacheAsBitmap=!0,this.el.addChild(i),this.flashes=[],s=0;s<8;s++)this.flashes.push(PIXI.Sprite.fromFrame("flash.png")),this.flashes[s].shown=Math.round(100*Math.random()),this.flashes[s].y=this.randomFlashY(),this.flashes[s].x=this.randomFlashX(),this.el.addChild(this.flashes[s]);this.el.visible=!1};return t.prototype={tick:function(e){this.flashes.forEach(function(t){t.shown>100&&(t.shown=0,t.y=this.randomFlashY(),t.x=this.randomFlashX(),t.visible=!t.visible),t.shown+=e.delta},this)},show:function(){this.el.visible=!0},randomFlashX:function(){return Math.round(Math.random()*(this.game.renderer.width-60))+20},randomFlashY:function(){return Math.round(35*Math.random())+8}},t}),define("race/views/track/flash",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.Graphics,this.el.beginFill(16777215).drawRect(0,0,this.game.renderer.width,320),this.el.position.y=this.game.topOffset,this.el.visible=!1};return t.prototype={tick:function(e){},show:function(){this.el.visible=!0,createjs.Tween.get(this.el,{override:!0}).wait(100).to({alpha:0},400,createjs.Ease.linear)}},t}),define("race/views/track",["require","race/views/track/background","race/views/track/car","race/views/track/tree","race/views/track/starting_line","race/views/track/finish_line","race/views/track/flash","shared/classes/typing","shared/classes/sound","registry"],function(e){"use strict";var t=e("race/views/track/background"),i=e("race/views/track/car"),s=e("race/views/track/tree"),a=e("race/views/track/starting_line"),r=e("race/views/track/finish_line"),n=e("race/views/track/flash"),o=e("shared/classes/typing"),l=e("shared/classes/sound"),c=e("registry");return Backbone.View.extend({stage:null,renderer:null,loader:null,sounds:{},cars:{},carPositions:[],focalRacer:null,lastUpdateStamp:null,status:"",disqualified:!1,finished:!1,fps:0,initialize:function(e){this.options=e,this.loader=e.loader,this.carLoader=e.carLoader,this.racer=e.racer,this.stage=e.stage,this.renderer=e.renderer,this.topOffset=e.topOffset||0,this.player=c.get("player"),this.listenTo(this.player,"change:raceSounds",this.stopMultipleSounds),this.listenTo(this.racer,"change:disqualified",this.disqualify),this.listenTo(this.racer,"change:nitrosUsed",this.firePlayerNitro),this.listenTo(this.racer,"change:errors",this.playErrorSound),this.listenTo(this.racer,"change:typingComplete",this.finish),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.model,"change:countdown",this.countdown),this.listenTo(this.model,"change:racerChanges",this.update),this.listenTo(this.model.racers,"add",this.addRacer),this.listenTo(this.model.racers,"remove",this.removeRacer),this.loader.on("complete",function(){this.stage.removeChild(this.loaderText),this.stage.removeChild(this.loaderPercent),this.createElements(),this.updateStage()},this)},render:function(){},createElements:function(){this.background=new t({game:this,track:this.model.get("track")}),this.tree=new s({game:this}),this.startingLine=new a({game:this,track:this.model.get("track")}),this.finishLine=new r({game:this,track:this.model.get("track")}),this.carContainer=new PIXI.DisplayObjectContainer,this.flash=new n({game:this})},start:function(){this.stage.addChild(this.background.el),this.stage.addChild(this.startingLine.el),this.stage.addChild(this.tree.el),this.stage.addChild(this.finishLine.el),this.stage.addChild(this.carContainer),this.stage.addChild(this.flash.el),this.model.racers.forEach(function(e){this.addRacer(e)},this),this.options.showFPS&&(this.fps="~",this.fpsText=new PIXI.Text("FPS: "+this.fps,{font:"24px Arial",fill:"white"}),this.fpsText.position.y=this.topOffset,this.stage.addChild(this.fpsText),setInterval(this.updateFPS.bind(this),1e3)),this.playSound({id:"cheering",loop:!0,volume:.1})},updateFPS:function(){this.fpsText.setText("FPS: "+Math.round(this.fps))},update:function(){!this.finished&&this.focalRacer&&this.focalRacer.get("completeStamp")&&this.finish();var e,t,i=[];if(this.model.get("racerChanges").forEach(function(s){(e=this.model.racers.get(s.id))&&(t=this.cars[e.id],s.disqualified&&t.disqualify(),!s.position||t.finished||t.disqualified||this.finished||(t.progress=s.position),s.nitrosUsed&&this.focalRacer&&e.id!=this.focalRacer.id&&(t.fireNitro(),this.playSound({id:"nitro",volume:.6,oneOff:!0})),s.completeStamp&&(this.finished?i.push(e):t.finishRace()))},this),this.focalRacer&&this.focalRacer.get("profile").avgSpeed>0){var s=o.speed(this.focalRacer.get("typed"),this.model.get("seconds"))/this.focalRacer.get("profile").avgSpeed;this.background.updateVelocity(s)}var a=i.reduce(function(e,t){return Math.min(e,t.get("completeStamp"))},this.model.get("lastUpdate")),r=0;if(i.forEach(function(e){r=e.get("completeStamp")-a,this.cars[e.id].enterFinish(!0,r),this.playSound({id:"car_stopping",volume:.5,oneOff:!0,delay:r})}.bind(this)),!this.finished&&this.focalRacer){var n=this.focalRacer.get("position");this.model.racers.forEach(function(e){this.cars[e.id].calculateX(n)}.bind(this))}},firePlayerNitro:function(){this.focalRacer.get("completeStamp")||(this.cars[this.focalRacer.id].fireNitro(),this.playSound({id:"nitro",oneOff:!0,volume:.6}))},playErrorSound:function(){var e=Math.floor(4*Math.random())+1;this.playSound({id:"error"+e,oneOff:!0,volume:.6})},statusChange:function(){this.status=this.model.get("status"),"open"==this.status?this.start():"racing"==this.status&&(this.playSound({id:"countdown_go",volume:.5}),this.playSound({id:"acceleration",volume:.2}),this.playSound({id:"music",volume:.6,loop:!0,delay:1e3}),this.background.begin())},countdown:function(){var e=this.model.get("countdown");this.tree.showFrame(e),2!=e&&1!=e||this.playSound({id:"countdown_"+e,volume:.5})},finish:function(){this.finished||(this.finished=!0,this.finishLine.show(),this.flash.show(),this.background.el.visible=!1,this.startingLine.el.visible=!1,this.model.racers.forEach(function(e){e.get("completeStamp")?this.cars[e.id].finished&&this.cars[e.id].enterFinish(!1):this.cars[e.id].hideOffTrack()},this),this.stopSound("music"),this.stopSound("cheering"),this.playSound({id:"finish_crowd",volume:.5}))},disqualify:function(){this.playSound({id:"disqualified",volume:.5}),this.stopSound("cheering",2e3),this.stopSound("music",1e3),this.disqualified=!0},addRacer:function(e){var t=e.id==this.racer.id;t&&(this.focalRacer=e);for(var s=0;s<this.carPositions.length&&this.carPositions[s];s++);this.carPositions[s]=e;var a=new i({game:this,model:e,race:this.model,self:t,position:s,animateIn:!!this.focalRacer});this.carContainer.addChild(a.el),this.cars[e.id]=a;var r=c.get("cars").get(e.get("profile").carID).get("enterSound");this.focalRacer&&this.playSound({id:"entry_"+r,oneOff:!0,volume:.2})},removeRacer:function(e){this.carContainer.removeChild(this.cars[e.id].el),delete this.cars[e.id],delete this.carPositions[this.carPositions.indexOf(e)]},tick:function(e){this.fps=e.fps;var t=this;Object.keys(this.cars).forEach(function(e){t.cars[e].tick()}),this.disqualified||(this.finished?this.finishLine.tick(e):"racing"==this.status&&(this.background.tick(e),this.startingLine.tick(e,this.background.velocity)))},playSound:function(e){var t=this.player.get("raceSounds"),i=!0,s=!0;"none"==t?(i=!1,s=!1):"only_music"==t?(i=!1,s=!0):"only_fx"==t&&(i=!0,s=!1),"music"!=e.id||s||(e.muted=!0),"music"==e.id||i||(e.muted=!0),l.play(e)},stopSound:function(e,t){l.stop(e,t)},stopMultipleSounds:function(){var e=this.player.get("raceSounds"),t=!0,i=!0;"none"==e?(t=!1,i=!1):"only_music"==e?(t=!1,i=!0):"only_fx"==e&&(t=!0,i=!1),i?l.unmute("music"):l.mute("music"),Object.keys(l.sounds).forEach(function(e){"music"!=e&&(t?l.unmute(e):l.mute(e))}.bind(this))},updateStage:function(){this.renderer.render(this.stage)}})}),define("race/classes/keyboard_input",["require","registry"],function(e){"use strict";function t(e){var t=i(e),s=i(e.map(function(e){var i=e-t;return i*i}));return Math.sqrt(s)}function i(e){return e.reduce(function(e,t){return e+t},0)/e.length}var s=e("registry"),a=[],r=0;return Backbone.View.extend({racer:null,typed:0,acceptInput:!1,letters:[],content:"",lastKeyWasError:!1,isTriggered:0,allKeys:{},errorKeys:{},initialize:function(e){this.options=e,this.racer=e.racer,this.isMobile=s.get("isMobile"),this.isMobile?(this.mobileFocusAlert=$("#mobile-focus-alert").fastShow(),this.raceInput=$("#race-input").focus(this.mobileInputFocused.bind(this)).blur(this.mobileInputBlurred.bind(this))):$("#race-input").remove(),$("body").keypress(this.handleKeyPress.bind(this)).keydown(this.handleKeyDown.bind(this)),this.listenTo(this.model,"change:lesson",this.setLesson),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.racer,"change:disqualified",function(){this.acceptInput=!1},this),this.contentEl=this.$(".lesson-content")},stop:function(){this.mobileFocusAlert&&this.mobileFocusAlert.remove(),this.raceInput&&this.raceInput.unbind().blur().remove()},mobileInputFocused:function(){this.mobileFocusAlert.fastHide()},mobileInputBlurred:function(){this.raceInput.focus()},setLesson:function(e,t){this.content=t,this.letters=t.split("")},statusChange:function(e,t){this.acceptInput="racing"==t},fakeInput:function(){var e=function(){this.handleKeyPress({which:this.letters[this.typed].charCodeAt(0),target:{}}),this.acceptInput&&setTimeout(e,150)}.bind(this);e()},getKeyStd:function(){return t(a)},prevKeyPress:null,handleKeyPress:function(e){if(this.prevKeyPress&&this.prevKeyPress.timeStamp===e.timeStamp)return!1;if(this.prevKeyPress=e,e.isTrigger&&this.isTriggered++,r?(a.push(Date.now()-r),r=Date.now()):r=Date.now(),("INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName)&&"race-input"!=e.target.id)return!0;if(!this.acceptInput)return 32!=e.which;if(13==e.which)return Math.min(this.model.get("nitros"),this.racer.get("nitros"))-this.racer.get("nitrosUsed")>0&&this.skipWord(),!1;var t=String.fromCharCode(e.which),i=this.letters[this.typed];return!e.shiftKey&&t.match(/[a-zA-Z]/)&&(t==t.toUpperCase()?this.showCapsLockWarning():this.hideCapsLockWarning()),t==i?this.typedCorrectLetter(t):this.typedIncorrectLetter(i),!(!this.isMobile||32==e.which)},prevKeyDown:null,handleKeyDown:function(e){return(!this.prevKeyDown||this.prevKeyDown.timeStamp!==e.timeStamp)&&(this.prevKeyDown=e,32==e.which?this.handleKeyPress(e):("INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName)&&"race-input"!=e.target.id||9!=e.which&&(!this.acceptInput||(9===e.which||8===e.which||20===e.which||13==e.which||32==e.which?(20==e.which&&this.showCapsLockWarning(),(8==e.which||13==e.which)&&this.handleKeyPress(e)):void 0)))},skipWord:function(){var e,t;-1==(e=this.content.indexOf(" ",this.typed+1))?e=this.content.length:e++,t=this.content.substring(this.typed,e).length,this.racer.inc({skipped:t,nitrosUsed:1}),this.typedCorrectLetter(null,t)},typedCorrectLetter:function(e,t){t=t||1,this.typed+=t,this.racer.set({typed:this.typed}),e&&" "!=e&&(this.allKeys[e]=this.allKeys[e]?this.allKeys[e]+1:1),this.typed>=this.content.length&&(this.acceptInput=!1,this.racer.set({allKeys:this.allKeys,errorKeys:this.errorKeys,typingComplete:!0})),this.lastKeyWasError=!1},typedIncorrectLetter:function(e){this.trigger("error-typed"),this.lastKeyWasError||(this.errorKeys[e]=this.errorKeys[e]?this.errorKeys[e]+1:1,this.racer.inc({errors:1}),this.lastKeyWasError=!0)},showCapsLockWarning:function(){this.isMobile||this.racer.set({capslock:!0})},hideCapsLockWarning:function(){this.racer.set({capslock:!1})}})}),define("race/classes/asset_loader",["require","registry","shared/classes/sound"],function(e){"use strict";var t=e("registry"),i=e("shared/classes/sound"),s={basePath:"/dist/site/images/track",tracks:["desert","beach","arctic","forest","grass"],music:["8bit","city_nights","desert","dirty_bit","road_warrior","standard"],sounds:["acceleration","car_stopping","cheering","disqualified","error1","error2","error3","error4","finish_crowd","nitro","countdown_1","countdown_2","countdown_go","entry_muscle","entry_sport"]},a=[s.basePath+"/textures.8.png",s.basePath+"/textures.8.json",s.basePath+"/animations.png",s.basePath+"/animations.json",s.basePath+"/fonts/LCD2.fnt"],r=function(e){this.options=e||{};var r=0,n=function(){2==++r&&this.trigger("complete")}.bind(this);"holiday"==NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(t.get("player").get("carID"))?(s.tracks=["holiday"],s.music=["christmas1","christmas2","christmas3","christmas4"]):"summer"==NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(t.get("player").get("carID"))&&(s.tracks=["beach"],s.music=["summer1","summer2","summer3"]),this.options.track||(this.options.track=s.tracks[Math.floor(Math.random()*s.tracks.length)]),this.options.music||(this.options.music=s.music[Math.floor(Math.random()*s.music.length)]),a.push(s.basePath+"/tracks/"+this.options.track+"/textures.json"),this.loader=new PIXI.AssetLoader(a),this.loader.on("onComplete",n),i.on("complete",n)};return _.extend(r.prototype,Backbone.Events),r.prototype.load=function(){var e=this.loader.assetURLs.length,t=0,a=function(){++t==e?this.loader.load():this.trigger("progress",{progress:t/e})}.bind(this);e=e+s.sounds.length+1,i.preload("music","music",this.options.music),s.sounds.forEach(function(e){i.preload(e,"track")}.bind(this)),i.on("progress",a),i.on("error",a),this.loader.assetURLs.forEach(function(e){$.get(e,{ignoreCSRF:!0}).done(a).error(function(t){this.trigger("error",t,e)}.bind(this))}.bind(this))},r}),define("race/views/dashboard/background",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=PIXI.Sprite.fromFrame("dashboard_bg.png"),this.el.position.y=this.game.topOffset};return t.prototype={tick:function(e){}},t}),define("race/views/dashboard/panel",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=PIXI.Sprite.fromFrame("dashboard.png"),this.el.position.x=32,this.el.position.y=2+this.game.topOffset};return t.prototype={tick:function(e){}},t}),define("race/views/dashboard/accuracy",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.x=147,this.el.position.y=53+this.game.topOffset,this.text=new PIXI.BitmapText("100",{font:"24px LCD2"}),this.text.position.x=0,this.text.position.y=0,this.el.addChild(this.text);var t=new PIXI.Text("%",{font:"12px Arial",fill:"#5fbf55",stroke:"#393939",strokeThickness:2});t.position.x=48,t.position.y=14,t.cacheAsBitmap=!0,this.el.addChild(t)};return t.prototype={update:function(e){this.lastAccuracy!=e&&(this.text.setText(String(e).pad(3," ","STR_PAD_LEFT")),this.lastAccuracy=e)}},t}),define("race/views/dashboard/speed",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.BitmapText("  0",{font:"24px LCD2"}),this.el.position.x=128,this.el.position.y=104+this.game.topOffset};return t.prototype={update:function(e){e!=this.lastSpeed&&(this.el.setText(String(e).pad(3," ","STR_PAD_LEFT")),this.lastSpeed=e)}},t}),define("race/views/dashboard/position",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.x=762,this.el.position.y=14+this.game.topOffset,this.textYou=new PIXI.BitmapText("0",{font:"24px LCD2"}),this.textYou.position.x=11,this.textYou.position.y=5,this.el.addChild(this.textYou),this.slash=new PIXI.BitmapText("/",{font:"24px LCD2"}),this.slash.position.x=22,this.slash.position.y=16,this.el.addChild(this.slash),this.textTotal=new PIXI.BitmapText("1",{font:"24px LCD2"}),this.textTotal.position.x=33,this.textTotal.position.y=26,this.el.addChild(this.textTotal)};return t.prototype={update:function(e,t){e==this.lastYou&&t==this.lastTotal||(this.textYou.setText(String(e)),this.textTotal.setText(String(t)),this.lastYou=e,this.lastTotal=t)}},t}),define("race/views/dashboard/time",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.BitmapText("0:00",{font:"24px LCD2"}),this.el.position.x=803,this.el.position.y=104+this.game.topOffset};return t.prototype={update:function(e){e=Math.floor(e),isNaN(e)&&(e=0);var t=Math.floor(e/60);e-=60*t,this.el.setText(t+":"+String(e).pad(2,"0","STR_PAD_LEFT"))}},t}),define("race/views/dashboard/nitros",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.el=new PIXI.DisplayObjectContainer,this.lockedNitro=PIXI.Sprite.fromFrame("nitro_locked.png"),this.el.addChild(this.lockedNitro),this.emptyNitro=PIXI.Sprite.fromFrame("nitro_empty.png"),this.el.addChild(this.emptyNitro),this.fullNitro=PIXI.Sprite.fromFrame("nitro_full.png");var t=new PIXI.Graphics;t.beginFill(0).moveTo(0,0).lineTo(this.emptyNitro.width,0).lineTo(this.emptyNitro.width+40,this.emptyNitro.height).lineTo(0,this.emptyNitro.height),this.fullNitro.mask=t,this.el.addChild(t),this.el.addChild(this.fullNitro),e.full||(this.fullNitro.mask.position.x=-this.emptyNitro.width-20)};t.prototype.use=function(){if(!this.used){this.used=!0;var e=this.emptyNitro.width;createjs.Tween.get(this.fullNitro.mask.position,{override:!0}).to({x:-e-20},300)}},t.prototype.lock=function(){this.emptyNitro.visible=!1,this.lockedNitro.visible=!0},t.prototype.unlock=function(){this.emptyNitro.visible=!0,this.lockedNitro.visible=!1},t.prototype.fill=function(){this.used=!1,createjs.Tween.get(this.fullNitro.mask.position,{override:!0}).to({x:0},300)};var i=function(e){this.game=e.game,this.nitrosEles=[],this.nitros=Math.min(3,e.nitros),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=860,this.el.position.y=4+this.game.topOffset;for(var i,s=0;s<3;s++)(i=new t({game:this.game})).el.position.y=50*s,this.nitrosEles[s]=i,this.el.addChild(i.el)};return i.prototype={tick:function(e){},useNitro:function(){this.nitros&&(this.nitrosEles[this.nitros-1].use(),this.nitros--)},fill:function(e,t){for(var i=Math.min(e,t,3),s=0;s<3;s++)i>s?this.nitrosEles[s].fill():e<=s?this.nitrosEles[s].lock():this.nitrosEles[s].unlock();this.nitros=i}},i}),define("race/views/dashboard/speedo",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.avgSpeed=e.avgSpeed||50,this.speed=0,this.el=PIXI.Sprite.fromFrame("needle.png"),this.el.position.x=95,this.el.position.y=81+this.game.topOffset,this.el.anchor.x=.5,this.el.anchor.y=1,this.el.rotation=Math.radians(-140)};return t.prototype={update:function(e){if(e!=this.speed){this.speed=e;var t=Math.max(0,Math.min(e/this.avgSpeed,1)),i=Math.radians(202*t-160);createjs.Tween.get(this.el,{override:!0}).to({rotation:i},1e3)}}},t}),define("race/views/dashboard/lesson_multi",["require","registry"],function(e){"use strict";var t=e("registry"),i=0,s=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.player=t.get("player"),this.text="",this.model.on("change:lesson",function(){this.updateText(this.model.get("lesson"))}.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=241,this.el.position.y=24+this.game.topOffset;var i=new PIXI.Graphics;i.beginFill(0).drawRect(this.el.position.x,this.el.position.y,500,119),this.el.mask=i,this.innerContainer=new PIXI.DisplayObjectContainer,this.el.addChild(this.innerContainer),this.cursor=new PIXI.Graphics,this.cursor.position.x=5,this.cursor.beginFill(11332256).drawRect(0,0,14,28),this.innerContainer.addChild(this.cursor),this.errorCursor=new PIXI.Graphics,this.errorCursor.position.x=this.cursor.position.x,this.errorCursor.beginFill(15379104).drawRect(0,0,14,28),this.errorCursor.visible=!1,this.innerContainer.addChild(this.errorCursor),this.setVisibility(),this.updateText("Please wait. Typing content will appear before the race begins",!0),this.player.on("change:_raceLineType",this.setVisibility,this),this.racer.on("change:typed",this.typed,this),this.racer.on("change:errors",this.error,this)};return s.prototype={setVisibility:function(){"single"==this.player.get("_raceLineType")?this.el.visible=!1:(this.el.visible=!0,this.game.updateStage())},lastPosition:0,typed:function(){var e=this.racer.get("typed");for(this.lastPosition;this.lastPosition<e;this.lastPosition++)this.progress(this.lastPosition+1)},progress:function(e){this.cursor.x+=14,this.cursor.visible=!0,this.errorCursor.visible=!1,"\n"==this.text[e-1]&&(this.cursor.position.y+=28,this.cursor.position.x=5,this.advanceLine()),this.text[e]||(this.cursor.visible=!1),this.errorCursor.position.x=this.cursor.x,this.errorCursor.position.y=this.cursor.y,this.el.visible&&this.game.updateStage()},error:function(){this.cursor.visible=!1,this.errorCursor.visible=!0},advanceLine:function(){createjs.Tween.get(this.innerContainer.position).to({y:this.innerContainer.position.y-28},500)},updateText:function(e,t){function s(e,t){var i=new PIXI.Text(e,{font:'18px "Droid Serif"',fill:t});return i.anchor.x=.5,i}t=t||!1,this.letters&&(this.letters.cacheAsBitmap=!1,this.innerContainer.removeChild(this.letters)),this.letters=new PIXI.DisplayObjectContainer,this.text=e.wordwrap(34).split("\n").map(function(e){return e.trim()}).join("\n");var a,r=0,n=0,o=t?"#7b7b7b":"#2e2e2e";this.text.split("").forEach(function(e){(a=s(e,o)).position.x=r+7+5,a.width%2&&(a.position.x+=.5),a.position.y=n+4,this.letters.addChild(a),r+=14,"\n"==e&&(n+=28,r=0,i++)}.bind(this));var l=PIXI.Sprite.fromFrame("finish_flag.png");l.position.x=r+3+5,l.position.y=n+8,this.letters.addChild(l),this.letters.cacheAsBitmap=!0,this.innerContainer.addChild(this.letters)}},s}),define("race/views/dashboard/lesson_single",["require","registry"],function(e){"use strict";var t=e("registry"),i=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.player=t.get("player"),this.text="",this.extraLetters=[],this.model.on("change:lesson",function(){this.updateText(this.model.get("lesson"))}.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=241,this.el.position.y=50+this.game.topOffset,this.lettersWindow=new PIXI.DisplayObjectContainer;var i=new PIXI.Graphics;i.beginFill(0).drawRect(this.el.position.x,this.el.position.y,504,50),this.game.stage.addChild(i),this.lettersWindow.mask=i,this.setVisibility(),this.cursor=new PIXI.Graphics,this.cursor.position.x=5,this.cursor.beginFill(11332256).drawRect(0,0,28,54),this.el.addChild(this.cursor),this.errorCursor=new PIXI.Graphics,this.errorCursor.position.x=this.cursor.position.x,this.errorCursor.beginFill(15379104).drawRect(0,0,28,54),this.errorCursor.visible=!1,this.el.addChild(this.errorCursor),this.el.addChild(this.lettersWindow),this.updateText("Please wait. Typing content will appear before the race begins",!0),this.player.on("change:_raceLineType",this.setVisibility,this),this.racer.on("change:typed",this.typed,this),this.racer.on("change:errors",this.error,this)};return i.prototype={setVisibility:function(){"single"==this.player.get("_raceLineType")?(this.el.visible=!0,this.game.updateStage()):this.el.visible=!1},lastPosition:0,typed:function(){var e=this.racer.get("typed");for(this.lastPosition;this.lastPosition<e;this.lastPosition++)this.progress(this.lastPosition+1)},progress:function(e){if(this.cursor.visible=!0,this.errorCursor.visible=!1,this.letters.position.x-=28,this.text[e]||(this.cursor.visible=!1),e%40==0){this.letters.cacheAsBitmap=!1;var t=e/40-1;this.lines[t].visible=!1,this.lines[t+2]&&(this.lines[t+2].position.x=this.lines[t+1].position.x,this.lines[t+2].visible=!0),this.lines[t+1]&&(this.lines[t+1].position.x=0),this.letters.position.x=0,this.letters.cacheAsBitmap=!0}this.el.visible&&this.game.updateStage()},error:function(){this.cursor.visible=!1,this.errorCursor.visible=!0},updateText:function(e,t){function i(e,t){var i=new PIXI.Text(e,{font:'32px "Droid Serif"',fill:t});return i.anchor.x=.5,i}t=t||!1,this.letters&&(this.letters.cacheAsBitmap=!1,this.lettersWindow.removeChild(this.letters)),this.lines=[],this.letters=new PIXI.DisplayObjectContainer,this.letters.position.y=5,this.text=e;var s,a,r=0,n=0,o=!0,l=t?"#7b7b7b":"#2e2e2e",c=0;this.text.split("").forEach(function(e){c%40==0&&(r=0,c%80==0&&(n=0,c>0&&(o=!1)),(s=new PIXI.DisplayObjectContainer).visible=o,s.position.x=n,s.position.y=8,this.letters.addChild(s),this.lines.push(s)),c++,(a=i(e,l)).position.x=r+14+5,a.width%2&&(a.position.x+=.5),s.addChild(a),r+=28,n+=28}.bind(this));var h=PIXI.Sprite.fromFrame("finish_flag.png");h.position.x=r+3+5,h.position.y=20,s.addChild(h),this.letters.cacheAsBitmap=!0,this.lettersWindow.addChild(this.letters)}},i}),define("race/views/dashboard/lesson_switch",["require","registry"],function(e){"use strict";var t=e("registry"),i=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.player=t.get("player"),this.lineType=this.player.get("_raceLineType")||"multi",this.textures={multi:PIXI.Texture.fromFrame("line_toggle_multi.png"),single:PIXI.Texture.fromFrame("line_toggle_single.png")},this.el=new PIXI.Sprite(this.textures[this.lineType]),this.el.position.x=432,this.el.position.y=144+this.game.topOffset,$("#line-type-toggle").click(this.toggleLineType.bind(this))};return i.prototype={toggleLineType:function(){this.lineType="multi"==this.lineType?"single":"multi",this.player.set({_raceLineType:this.lineType}),this.el.setTexture(this.textures[this.lineType])}},i}),define("race/views/dashboard/capslock_warning",["require"],function(e){"use strict";var t=function(e){this.game=e.game,this.model=e.model,this.racer=e.racer,this.el=PIXI.Sprite.fromFrame("caps_lock.png"),this.el.position.y=77+this.game.topOffset,this.el.position.x=367,this.el.visible=!1,this.racer.on("change:capslock",this.toggle,this)};return t.prototype={toggle:function(){this.racer.get("capslock")?this.el.visible=!0:this.el.visible=!1}},t}),define("race/views/dashboard",["require","race/views/dashboard/background","race/views/dashboard/panel","race/views/dashboard/accuracy","race/views/dashboard/speed","race/views/dashboard/position","race/views/dashboard/time","race/views/dashboard/nitros","race/views/dashboard/speedo","race/views/dashboard/lesson_multi","race/views/dashboard/lesson_single","race/views/dashboard/lesson_switch","race/views/dashboard/capslock_warning","shared/classes/typing"],function(e){"use strict";var t=e("race/views/dashboard/background"),i=e("race/views/dashboard/panel"),s=e("race/views/dashboard/accuracy"),a=e("race/views/dashboard/speed"),r=e("race/views/dashboard/position"),n=e("race/views/dashboard/time"),o=e("race/views/dashboard/nitros"),l=e("race/views/dashboard/speedo"),c=e("race/views/dashboard/lesson_multi"),h=e("race/views/dashboard/lesson_single"),d=e("race/views/dashboard/lesson_switch"),u=e("race/views/dashboard/capslock_warning"),p=e("shared/classes/typing");return Backbone.View.extend({accuracyEle:null,speedEle:null,positionEle:null,timeEle:null,nitrosEle:null,speedoEle:null,lessonEle:null,deltaCounter:0,initialize:function(e){this.options=e,this.loader=e.loader,this.racer=e.racer,this.stage=e.stage,this.renderer=e.renderer,this.topOffset=e.topOffset||0,this.listenTo(this.racer,"change:nitrosUsed",this.useNitro),this.listenTo(this.model.racers,"add",this.update),this.listenTo(this.model.racers,"remove",this.update),this.listenTo(this.racer,"change",this.update),this.listenTo(this.model,"change:nitros",this.fillNitros),this.listenTo(this.racer,"change:nitros",this.fillNitros),this.listenTo(this.model,"change:seconds",this.update),this.loader.on("complete",function(){this.start()}.bind(this)),this.render()},start:function(){this.background=new t({game:this}),this.stage.addChild(this.background.el),this.nitrosEle=new o({game:this,nitros:0}),this.stage.addChild(this.nitrosEle.el),this.panel=new i({game:this}),this.stage.addChild(this.panel.el),this.accuracyEle=new s({game:this}),this.stage.addChild(this.accuracyEle.el),this.speedEle=new a({game:this}),this.stage.addChild(this.speedEle.el),this.positionEle=new r({game:this}),this.stage.addChild(this.positionEle.el),this.timeEle=new n({game:this}),this.stage.addChild(this.timeEle.el),this.speedoEle=new l({game:this,avgSpeed:this.racer.get("profile").avgSpeed}),this.stage.addChild(this.speedoEle.el),this.lessonMultiEle=new c({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.lessonMultiEle.el),this.lessonSingleEle=new h({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.lessonSingleEle.el),this.lessonSwitchEle=new d({game:this,model:this.model}),this.stage.addChild(this.lessonSwitchEle.el),this.capslockWarningEle=new u({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.capslockWarningEle.el),this.updateStage()},updateStage:function(){this.renderer.render(this.stage)},tick:function(e){},fillNitros:function(){this.nitrosEle.fill(this.model.get("nitros"),this.racer.get("nitros"))},useNitro:function(){this.nitrosEle.useNitro()},update:function(){var e=0,t=this.model.racers.get(this.racer.id);if(t){this.model.get("startStamp")&&(e=t.get("completeStamp")?(t.get("completeStamp")-this.model.get("startStamp"))/1e3:this.model.get("seconds"));var i=p.accuracy(t.get("typed")-t.get("skipped"),t.get("errors"));this.accuracyEle.update(i);var s=p.speed(t.get("typed")-t.get("skipped"),e);this.speedEle.update(s),"racing"==this.model.get("status")?this.positionEle.update(this.model.racers.getPlace(t.id),this.model.racers.length):this.positionEle.update(0,this.model.racers.length),this.timeEle.update(e),this.speedoEle.update(s)}},prettyTime:function(e){e=Math.ceil(e),isNaN(e)&&(e=0);var t=Math.floor(e/60);return e-=60*t,t+":"+String(e).pad(2,"0","STR_PAD_LEFT")}})}),define("race/views/qualifying",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({events:{"click a.button":"clickBegin"},initialize:function(){void 0===this.template&&(this.template=t("race","qualifying")),this.$el.fastHide(),this.render()},render:function(){this.setElement(this.template())},show:function(){this.$el.velocity("fadeIn")},clickBegin:function(){return this.remove(),this.trigger("close"),!1}})}),define("race/views/qualifying_complete",["require","shared/classes/typing","registry","templates"],function(e){"use strict";var t=e("shared/classes/typing"),i=(e("registry"),e("templates"));return Backbone.View.extend({events:{"click .car-choices .choice":"selectCar","click .button":"close"},initialize:function(e){void 0===this.template&&(NTGLOBALS("LOGGED_IN")?this.template=i("race","qualifying_complete"):this.template=i("race","qualifying_complete_guest")),this.speed=t.speed(e.racer.get("typed"),(e.racer.get("completeStamp")-e.racer.get("startStamp"))/1e3),this.render()},render:function(){this.$el.append(this.template({speed:this.speed}))},selectCar:function(e){return this.$(".choice.active").removeClass("active"),$(e.currentTarget).addClass("active"),!1},show:function(){this.$el.velocity("fadeIn")},close:function(e){if(!NTGLOBALS("LOGGED_IN"))return!0;var t=this.$(".choice.active").data("carid"),i=$(e.currentTarget).hasClass("button-race")?"race":"garage";return this.undelegateEvents(),$(e.currentTarget).addClass("pending"),this.trigger("close",{carID:t,goto:i}),!1}})}),define("race/views/settings",["require","templates","registry","global/views/modal"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("global/views/modal");return s.extend({initialize:function(e){s.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .renderer":"changeRenderer"})),this.player=i.get("player"),void 0===this.template&&(this.template=t("race","settings")),this.render()},render:function(){var e,t=this.player.get("avgFPS");return e=t>=50?"great":t>=35?"good":t>=25?"fair":t>=20?"low":"poor",this.$el.append(this.template({avgFPS:t,fpsGrade:e,renderer:$.cookie("ntTrackRenderer"),hasWebGL:window.supportsWebGL()})),this},changeRenderer:function(e){var t=$(e.currentTarget).val();$.cookie("ntTrackRenderer")!=t&&this.$(".render-change").fastShow(),$.cookie("ntTrackRenderer",t,{path:"/",expires:365})}})}),define("global/views/window",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({className:"popup-base",events:{"click .close":"hide","click .alt-button":"clickAltButton","click .main-button":"clickMainButton"},initialize:function(e){this.$el.html('<div class="popup-overlay"></div>'),this.options=e},_initialize:function(){void 0===this.template&&(this.template=t("global","window")),this.render(),this.inited=!0},render:function(){this.$el.append(this.template({options:this.options})),$("body div.wrap").append(this.el)},show:function(){return this.inited||this._initialize(),this.$el.velocity("fadeIn"),!1},hide:function(){return this.$el.hide(),!1},clickMainButton:function(){return this.handleButtonClick(this.options.mainButtonHandler),!1},clickAltButton:function(){return this.handleButtonClick(this.options.altButtonHandler),!1},handleButtonClick:function(e){"string"==typeof e?"close"==e?this.hide():location.href=e:"function"==typeof e&&e(),this.hide()}})}),define("race/views/loader",["require","templates"],function(e){"use strict";var t=e("templates");return Backbone.View.extend({verbs:["Installing","Loading","Upgrading","Maintaining"],nouns:["Mufflers","Steering Wheels","Nitros","Achievements","Transmissions","Fish Heads","Ergonomic Keyboards","Wireless Mice (and Rats)","Corndogs","Coffee","Alternator","Sunroofs","Belts","Fans","Performance Chips","Struts","Knuckle"],header:"",message:"",initialize:function(e){void 0===this.template&&(this.template=t("race","loader")),_.extend(this,e),this.render()},render:function(){this.update()},update:function(e,t){this.header=e||this.header,this.message=t||this.message,this.$el.html(this.template({header:this.header,message:this.message}))},randomMessage:function(e){var t="Please wait... "+this.verbs[Math.floor(Math.random()*this.verbs.length)]+" "+this.nouns[Math.floor(Math.random()*this.nouns.length)];e&&(t+=e),this.update(null,t)}})}),define("race/index",["require","registry","analytics","race/models/race","race/models/practice_race","race/models/qualifying_race","race/models/racer","race/views/invite","race/views/chat","race/views/top","race/views/track","race/classes/keyboard_input","race/classes/asset_loader","race/views/dashboard","race/views/qualifying","race/views/qualifying_complete","global/views/race_results","race/views/settings","global/views/window","race/views/loader","global/views/player_hover"],function(e){"use strict";var t=e("registry"),i=e("analytics"),s=e("race/models/race"),a=e("race/models/practice_race"),r=e("race/models/qualifying_race"),n=e("race/models/racer"),o=e("race/views/invite"),l=e("race/views/chat"),c=e("race/views/top"),h=e("race/views/track"),d=e("race/classes/keyboard_input"),u=e("race/classes/asset_loader"),p=e("race/views/dashboard"),m=e("race/views/qualifying"),g=e("race/views/qualifying_complete"),f=e("global/views/race_results"),v=e("race/views/settings"),y=e("global/views/window"),w=e("race/views/loader"),b=e("global/views/player_hover"),S=(console,function(){document.body?(document.co=1,document.body.__defineGetter__&&(document.body.__defineGetter__("id",function(){document.co=2}),2==document.co||setTimeout(S,1e3))):setTimeout(S,1e3)});return"production"==NTGLOBALS("ENV")&&S(),Backbone.View.extend({el:"#app",events:{"click .friends-controls .invite":"inviteFriends","click .friends-controls .start-race":"beginFriendRace","click #settings-button":"openSettings"},initialize:function(e){this.options=e,this.options.debugging=!1,window.onbeforeunload=this.leavingRaceError.bind(this),$.cookie("ntTrackRenderer")||$.cookie("ntTrackRenderer","canvas",{path:"/",expires:365}),this.player=t.get("player"),this.racer=new n({profile:this.player.toJSON()}),this.options.avgSpeed=this.player.get("avgSpeed"),this.options.forceEarlyPlace=this.player.get("forceEarlyPlace"),this.listenTo(this.racer,"change:rewards",this.racerComplete),this.listenTo(this.racer,"change:disqualified",this.racerDisqualified),this.options.avgSpeed||(this.options.track="grass",this.options.music="desert"),this.loader=new u(this.options),t.get("isMobile")&&!this.player.get("_raceLineType")&&this.player.set({_raceLineType:"single"}),this.options.practice?(this.race=new a,this.racer.get("profile").nitros=0):this.options.avgSpeed||this.options.trackLeader||0!==this.player.get("racesPlayed")?(this.race=new s({version:2}),this.options.trackLeader):(this.race=new r,this.qualifying=new m({noOverlay:!0}),this.qualifying.on("close",function(){$("body").focus(),this.race.beginCountdown()}.bind(this))),this.player.get("DQs")>=5&&this.player.get("lastDq")>Date.getUnixTime()-180?this.raceError({type:"too many dqs"}):(this.listenTo(this.race,"change:status",this.statusChange),this.listenTo(this.race,"error",this.raceError),this.loaderView=new w({header:"Loading Race Files",message:"Please wait..."}),this.options.trackLeader&&(this.chat=new l({race:this.race})),this.race.racers.on("add",function(e){if(e.id==t.get("player").id){var i=e.toJSON();i.joinPosition=this.race.racers.length,this.racer.set(i)}}.bind(this)),this.render(),this.cacheElements(),this.scrollToPosition(),this.loader.once("complete",function(){var e=0;this.player.get("raceRenderDelay")&&(e=1e3*this.player.get("raceRenderDelay")),setTimeout(this.showTrack.bind(this),e)},this),this.loader.once("error",function(e,t){this.raceError({type:"assets",asset:t})},this),setTimeout(function(){this.loader.on("progress",function(e){this.loaderView.update("",Math.floor(100*e.progress)+"% complete")},this)}.bind(this),1e3),this.loader.load())},showTrack:function(){this.loaderView.remove(),this.options.avgSpeed&&0===this.player.get("racesPlayed")&&this.$(".first-race-tip").velocity("fadeIn"),this.input=new d({model:this.race,racer:this.racer}),t.get("isMobile")?$("#race-input").one("touchstart",this.joinRace.bind(this)):this.joinRace()},joinRace:function(){this.qualifying&&this.qualifying.show(),this.race.join(this.racer,this.options)},cachedEles:{},cacheElements:function(){this.cachedEles["settings-tooltip"]=this.$("#settings-tooltip"),this.cachedEles["sound-tooltip"]=this.$("#sound-tooltip"),this.cachedEles["race-tip"]=this.$(".race-tip"),this.cachedEles["friends-race"]=this.$(".friends-race"),this.cachedEles["friends-controls"]=this.$(".friends-controls")},statusChange:function(e,t){"countdown"==t&&(this.cachedEles["settings-tooltip"].fastHide(),this.cachedEles["sound-tooltip"].fastHide(),this.cachedEles["race-tip"].fastHide(),this.cachedEles["friends-race"].fastHide(),this.cachedEles["friends-controls"].fastHide()),"expired"==t&&(i.trackEvent("Race","Expired"),this.expireRace())},inviteFriends:function(){if("open"==this.race.get("status"))return this.invite||(this.invite=new o),this.invite.show(),!1},beginFriendRace:function(e){if("open"==this.race.get("status"))return this.cachedEles["friends-controls"].fastHide(),this.race.beginFriendRace(),!1},render:function(){var e=$("#race-track")[0];if(this.stage=new PIXI.Stage(0,!1),this.stage.interactive=!1,"webgl"==$.cookie("ntTrackRenderer")?this.renderer=PIXI.autoDetectRenderer(e.width,e.height,{view:e,transparent:!1}):this.renderer=new PIXI.CanvasRenderer(e.width,e.height,{view:e,transparent:!1}),this.$("#track-loader").append(this.loaderView.el),this.top=new c({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer}),this.track=new h({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:80}),this.dashboard=new p({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:400}),createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",this.tick.bind(this)),this.updateFPS(),this.qualifying&&this.$(".page-race").append(this.qualifying.el),!this.options.fake&&this.options.trackLeader)this.chat&&this.$el.append(this.chat.el),this.options.trackLeader==t.get("player").get("username")?this.$(".friends-controls").fastShow():this.$(".friends-race").fastShow();else if(!this.options.practice){var i=NTGLOBALS("TIPS"),s=this.$(".race-tip"),a=s.html();s.html(a+i[Math.floor(Math.random()*i.length)]).fastShow()}},frames:0,lastStamp:0,incTime:0,tick:function(e){var t=performance.now();this.lastStamp||(this.lastStamp=t);var i={delta:t-this.lastStamp,fps:this.fps};this.lastStamp=t,this.incTime+=i.delta,this.frames++,this.top.tick(i),this.track.tick(i);try{this.renderer.render(this.stage)}catch(e){window.onerror("Render Loop: "+e.message,e.fileName,e.lineNumber,e.columnNumber,e)}},lastFPSStamp:0,fpsCache:[],fps:0,zeroFpsCount:0,updateFPS:function(){var e=performance.now();this.lastFPSStamp&&(this.fps=this.frames/(e-this.lastFPSStamp)*1e3,this.fpsCache.push(this.fps),0===Math.round(this.fps)&&this.zeroFpsCount++,this.frames=0),this.lastFPSStamp=e,setTimeout(this.updateFPS.bind(this),1e3)},saveFPS:function(){if(this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(this.racer.get("disqualified")||this.racer.get("error"))&&$.post("/api/settings/fpscache",{raceID:this.race.get("id"),fps:this.fpsCache,position:this.racer.get("joinPosition"),renderer:$.cookie("ntTrackRenderer"),perfTestFps:"WebGL: "+this.player.get("_webglFPS")+", Canvas: "+this.player.get("_canvasFPS"),dq:this.racer.get("disqualified")?1:0,error:this.racer.get("error"),errorStack:this.racer.get("errorStack"),webglSupport:window.supportsWebGL()?1:0,errorMessage:this.racer.get("errorMessage"),socket:t.get("realtime").socket.transport.ws?"websocket":"polling",forceEarlyPlace:this.player.get("forceEarlyPlace")?1:0,racerRenderDelay:this.player.get("raceRenderDelay")}),this.fpsCache.length>10){var e=this.fpsCache.slice(4,-1),i=e.reduce(function(e,t){return e+t},0)/e.length;if((this.zeroFpsCount>3||this.player.get("avgFPS")>40&&i<20)&&(this.zeroFpsCount>3&&this.cachedEles["settings-tooltip"].html("Performance Issues Detected<br />View Performance Settings"),this.cachedEles["settings-tooltip"].velocity("fadeIn")),this.player.set({avgFPS:i}),"basic"==this.player.get("membership")){(e=this.fpsCache.slice(1,9).sort()).pop();var s=e.reduce(function(e,t){return e+t},0)/e.length,a=Math.floor(this.fpsCache.length/2),r=(e=this.fpsCache.slice(a,a+5)).reduce(function(e,t){return e+t},0)/e.length;s<=15&&r>=2*s&&this.player.set({forceEarlyPlace:!0}),this.player.get("raceRenderDelay")?this.player.inc({raceRenderDelay:-1}):s<=15&&r>=4*s&&this.player.set({raceRenderDelay:10})}}},scrollToPosition:function(){var e=("gold"==this.player.get("membership")?780:880)-$(window).height();if(!(e<0)){"gold"!=this.player.get("membership")&&e<200&&(e+=200-e),window.pageTopPadding&&(e+=window.pageTopPadding);try{$(window).scrollTop(e)}catch(e){}}},racerComplete:function(){this.saveFPS(),this.options.fake||(this.input.stop(),this.options.practice?(this.racer.savePractice(),this.showRaceResults()):this.player.get("avgSpeed")||this.options.trackLeader||0!==this.player.get("racesPlayed")?this.racer.get("rewards")&&(this.race.std=this.input.getKeyStd(),this.race.isTriggered=this.input.isTriggered,this.racer.save(this.race),this.showRaceResults()):this.showQualifyingComplete())},showRaceResults:function(){var e=new b,t=("gold"==this.player.get("membership")?780:880)+(window.pageTopPadding||0);setTimeout(function(){new f({model:this.race,practice:this.options.practice,hover:e}).show(t,!0)}.bind(this),this.options.practice?0:2e3)},showQualifyingComplete:function(){var e=new g({racer:this.racer});NTGLOBALS("LOGGED_IN")?e.on("close",function(e){this.racer.saveQualifying(this.race,e).done(function(t){t.success?location.href="/"+e.goto:alert("Uh oh.. There was a problem saving your qualifying score.  Please try again or contact support! "+t.error)})}.bind(this)):this.racer.saveQualifying(this.race),setTimeout(function(){this.$(".page-race").append(e.el),e.show()}.bind(this),2e3)},racerDisqualified:function(){i.trackEvent("Race","Disqualification"),this.input.stop(),this.race.logs.push({event:"disqualified window",stamp:Date.now()}),this.player.inc({DQs:1}),this.player.set({lastDq:Date.getUnixTime()}),this.saveFPS();var e="Uh oh! You have been disqualified due to inactivity.";this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(e+='</p><div class="dq-error" id="dq-error"><p>Was this disqualification an error? If so, please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">'),new y({hideCloseButton:!1,title:"Disqualified",body:e,mainButtonText:"Race Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}}).show(),this.options.debugging&&NTGLOBALS("LOGGED_IN")&&$("#dq-error-send").click(function(e){e.target.disabled=!0,$.post("/api/race/log-dq",{id:this.race.get("id"),type:"disqualification",logs:this.race.logs,msg:$("#dq-report").val()}),$("#dq-error").velocity("slideUp",function(){$("#dq-after-error").html("<p>Thanks for helping us improve Nitro Type!</p>")})}.bind(this))},expireRace:function(){this.input.stop(),this.race.logs.push({event:"expired window",stamp:Date.now()}),this.saveFPS();new y({hideCloseButton:!1,title:"Race Expired",body:"Uh oh! The race has expired due to inactivity. Please start another race to continue.",mainButtonText:"Race Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}}).show()},openSettings:function(){return new v({racer:this.racer}).show(),!1},leavingRaceError:function(e){if(!(this.racer.get("completeStamp")||this.racer.get("error")||this.racer.get("disqualified")||this.options.practice)){var t=null;return"racing"==this.race.get("status")||"countdown"==this.race.get("status")?(t="The race is currently active! Are you sure you want to leave?",e.returnValue=t,t):void 0}},raceError:function(e){if(!("expired"==this.race.get("status")||this.racer.get("completeStamp")||this.racer.get("disqualified")||this.racer.get("error"))){i.trackEvent("Race","Error",e.type),this.racer.set({error:e.type,errorMessage:e.message,errorStack:e.stack}),"connection"!=e.type&&"closed"!=e.type||this.saveFPS(),this.input&&this.input.stop();var t="Communications Error",s="There was an error communicating with the race server.<br /><br />Most common reasons:<ul><li>Your Internet connection is slow, unreliable, or unexpectedly stopped.</li><li>Your Internet connection is behind a firewall or proxy that is causing problems.</li></ul>";if("in race"==(e=e||{}).type)t="Currently in a Race",s="You are currently engaged in an active race. You must wait a moment until you are disqualified from that race before you can continue. Be sure to complete your next race to avoid this warning!";else if("too many dqs"==e.type)t="Too Many Disqualifications",s="You have disqualified 5 times in a row. You will need to wait a few minutes before you can race again.";else if("no guest friend races"==e.type)t="You Are Not Logged In",s='<p style="text-align: center;">To race with friends you must first log in.<br /><a href="#" class="log-in login-link">Log In</a><br /><br /><br /> Don\'t have an account?  Nitro Type is free!<br /><a href="#" class="register-in register-link">Sign Up</a><br />';else if("cannot rejoin"==e.type)t="Connection Lost";else if("accuracy"==e.type)t="Accuracy Too Low",s="Oops, your accuracy is only "+e.accuracy+"%, which is too low to qualify in a race!";else if("no userid"==e.type)t="Invalid Session",s="It is possible you have been logged out of your session.  Please log out and back in to continue.";else if("cookies required"==e.type)t="Cookies Required",s='It appears that your browser has "cookies" disabled. You must enable cookie support to play Nitro Type.';else if("invalid session"==e.type)t="Invalid Session",s="Something appears to be wrong with your session. Please log out and back in.";else if("race is full"==e.type)t="Race Is Full",s="The race you are attempting to join is already full. Most likely you were invited to a race with a friend, but unfortunately there are already 5 racers playing.";else if("assets"==e.type)t="Problem Loading Game Files",s="A required game file failed to load.<br /><br />File that could not load: "+e.asset+"  <br /><br />Please try again.<br /><br />If this continues, please contact Nitro Type support!";else{if("banned"==e.type||"warned"==e.type)return this.player.logout(),void(location.href="/");"connection"==e.type?(s='There was an error communicating with the race server.<br /><br />Message: "'+e.message+'"',this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(s+='</p><div class="dq-error" id="dq-error"><p>Uh oh, we don\'t like this! Please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">')):"closed"==e.type&&(s="There was an error communicating with the race server.<br /><br />Message: Connection Closed",this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(s+='</p><div class="dq-error" id="dq-error"><p>Uh oh, we don\'t like this! Please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">'))}new y({hideCloseButton:!0,title:t,body:s,mainButtonText:"Try Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}}).show(),this.options.debugging&&NTGLOBALS("LOGGED_IN")&&("connection"==e.type||"closed"==e.type)&&(this.race.logs.push({event:"error window",stamp:Date.now(),data:{type:e.type,message:e.message}}),$("#dq-error-send").click(function(t){t.target.disabled=!0,$.post("/api/race/log-dq",{id:this.race.get("id"),type:e.message,logs:this.race.logs,msg:$("#dq-report").val()}),$("#dq-error").velocity("slideUp",function(){$("#dq-after-error").html("<p>Thanks for helping us improve Nitro Type!</p>")})}.bind(this)))}}})}),define("race/models/performance_test_race",["require","race/models/practice_race"],function(e){"use strict";return e("race/models/practice_race").extend({join:function(){this.begin(),this.countdown("some text",1),this.set({status:"racing"})}})}),define("race/performance_test",["require","registry","race/models/performance_test_race","race/models/racer","race/views/top","race/views/track","race/classes/asset_loader","race/views/dashboard","race/views/loader","global/views/window"],function(e){"use strict";var t=e("registry"),i=e("race/models/performance_test_race"),s=e("race/models/racer"),a=e("race/views/top"),r=e("race/views/track"),n=e("race/classes/asset_loader"),o=e("race/views/dashboard"),l=e("race/views/loader"),c=e("global/views/window");return Backbone.View.extend({el:"#app",initialize:function(e){this.options=e||{},window.supportsWebGL()?(this.player=t.get("player"),this.racer=new s({profile:this.player.toJSON()}),this.player.get("_webglFPS")?this.options.renderer="webgl":this.options.renderer="canvas",this.options.track="grass",this.options.music="desert",this.loader=new n(this.options),this.loaderView=new l({header:"Loading Race Files",message:"Please wait..."}),this.race=new i,this.listenTo(this.race,"change:status",this.statusChange),this.render(),this.scrollToPosition(),this.loader.once("complete",function(){this.joinRace()}.bind(this)),this.loader.once("error",function(e,t){this.raceError({type:"assets",asset:t})},this),setTimeout(function(){this.loader.on("progress",function(e){this.loaderView.update("",Math.floor(100*e.progress)+"% complete")},this)}.bind(this),1e3),this.loader.load()):location.href="/"},joinRace:function(){this.qualifying&&this.qualifying.show(),this.race.join(this.racer,this.options),this.testSeconds=0,this.loaderView.$el.addClass("test-loader"),this.loaderView.verbs=["Polishing","Wrenching","Bolting","Soldering","Welding"],this.loaderView.update("Testing "+("canvas"==this.options.renderer?"Canvas":"WebGL")+" Performance"),this.updateFeedback()},updateFeedback:function(){this.loaderView.randomMessage(" ("+Math.round(this.testSeconds/5*100)+"%)"),this.testSeconds>=5?this.testComplete():(this.testSeconds++,setTimeout(this.updateFeedback.bind(this),1e3))},testComplete:function(){var e,t=this.fpsCache.slice(1,-1),i=_.reduce(t,function(e,t){return e+t},0)/(0===t.length?1:t.length),s={};if(s["_"+this.options.renderer+"FPS"]=i,this.player.set(s),this.player.get("_canvasFPS")>55||this.player.get("_canvasFPS")&&this.player.get("_webglFPS")){this.loaderView.update("Test Complete","Prepare To Race!");var a=this.player.get("_canvasFPS")||0,r=this.player.get("_webglFPS")||0;e=(r-=5)>a?"webgl":"canvas",$.cookie("ntTrackRenderer",e,{path:"/",expires:365}),setTimeout(function(){location.href="/race"+(location.hash?"/"+location.hash.replace("#",""):"")},1e3)}else location.reload()},render:function(){var e=$("#race-track")[0];e.style.position="absolute",e.style.top="-1000px",this.stage=new PIXI.Stage(0),"webgl"==this.options.renderer?this.renderer=new PIXI.WebGLRenderer(e.width,e.height,{view:e,transparent:!1}):this.renderer=new PIXI.CanvasRenderer(e.width,e.height,{view:e,transparent:!1}),this.$("#track-loader").append(this.loaderView.el),this.top=new a({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer}),this.track=new r({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:80}),this.track.playSound=function(){},this.dashboard=new o({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:400}),this.tick(),this.updateFPS()},frames:0,lastStamp:0,incTime:0,tick:function(){var e=performance.now();this.lastStamp||(this.lastStamp=e);var t={delta:e-this.lastStamp,fps:this.fps};this.lastStamp=e,this.incTime+=t.delta,this.frames++,createjs.Tween.tick(t.delta),this.top.tick(t),this.track.tick(t),this.renderer.render(this.stage),requestAnimFrame(this.tick.bind(this))},lastFPSStamp:0,fpsCache:[],fps:0,updateFPS:function(){var e=performance.now();this.lastFPSStamp&&(this.fps=this.frames/(e-this.lastFPSStamp)*1e3,this.fpsCache.push(this.fps),this.frames=0),this.lastFPSStamp=e,setTimeout(this.updateFPS.bind(this),1e3)},scrollToPosition:function(){var e=("gold"==this.player.get("membership")?780:880)-$(window).height();if(!(e<0)){"gold"!=this.player.get("membership")&&e<200&&(e+=200-e),window.pageTopPadding&&(e+=window.pageTopPadding);try{$(window).scrollTop(e)}catch(e){}}},raceError:function(e){var t,i;t="Problem Loading Game Files",i="A required game file failed to load.<br /><br />File that could not load: "+(e=e||{}).asset+"  <br /><br />Please try again.<br /><br />If this continues, please contact Nitro Type support!",new c({hideCloseButton:!0,title:t,body:i,mainButtonText:"Try Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}}).show()}})}),define("support/models/login_problems_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/support/account-help",defaults:{},validationRules:{firstname:{required:!0},lastname:{required:!0},email:{required:!0,email:!0},alt_email:{email:!0},other:{required:!0}},validationMessages:{firstname:{required:"Please enter your first name"},lastname:{required:"Please enter your last name"},email:{required:"Please enter your email",email:"Please enter a valid email"},other:{required:"Please provide as much detail as possible about your account, or we will not be able to help you"}}})}),define("support/models/contact_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/contact",defaults:{name:null,email:null,body:null},validationRules:{name:{required:!0},email:{required:!0,email:!0},body:{required:!0,minlength:75}},validationMessages:{name:{required:"Please enter your name"},email:{required:"Please enter your email",email:"Please enter a valid email"},body:{required:"Please enter a descriptive message",minlength:"Your message looks a little short. Please provide more information."}}})}),define("support/index",["require","templates","registry","support/models/login_problems_form","support/models/contact_form","shared/classes/form_validation"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("support/models/login_problems_form"),a=e("support/models/contact_form"),r=e("shared/classes/form_validation");return Backbone.View.extend({el:"#app",events:{"click .js-accordion":"seeQuestion","click .js-show-form":"render","focus input,select,textarea":"executeCaptcha"},initialize:function(){this.player=i.get("player"),NTGLOBALS("LOGGED_IN")?(this.model=new a,this.template=t("support","support_form"),this.buttonTemplate=t("support","support_button"),this.renderButton()):(this.model=new s,this.template=t("support","login_problems_form"),this.render())},render:function(){return this.$(".js-support-content").html(this.template({data:this.player.toJSON()})),new r(this.$("form"),this.$("form .button"),this.model,this.successCallback,this),!1},renderButton:function(){this.$(".js-support-button").html(this.buttonTemplate({data:this.player.toJSON()}))},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".success").velocity("slideDown")},seeQuestion:function(e){$(e.currentTarget).toggleClass("is-open")},executeCaptcha:function(){if(loggedIn()||this.model.get("captchaKey"))return!1;"object"==typeof grecaptcha?(window.registerRecaptchaCallback(this.setCaptchaKey.bind(this)),grecaptcha.execute()):this.setCaptchaKey("ignore")},setCaptchaKey:function(e){this.model.set({captchaKey:e}),this.$("input[name=captchaKey]").val(e)}})}),define("refund/models/contact_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/contact/refund",defaults:{name:null,email:null,body:null},validationRules:{name:{required:!0},ccLast4:{required:!0,number:!0},postalCode:{number:!0},amount:{number:!0,required:!0},email:{required:!0,email:!0},date:{required:!0},body:{required:!1}},validationMessages:{name:{required:"Please enter your name"},email:{required:"Please enter your email",email:"Please enter a valid email"}}})}),define("refund/index",["require","refund/models/contact_form","shared/classes/form_validation"],function(e){"use strict";var t=e("refund/models/contact_form"),i=e("shared/classes/form_validation");return Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){var e=new t;new i(this.$("form"),this.$("form .button"),e,this.successCallback,this)},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".success").velocity("slideDown")}})}),define("profile/models/profile",["require"],function(e){"use strict";return Backbone.Model.extend({initialize:function(){$.get("/api/settings").done(function(e){e.success?this.set(e.data):alert("There was an error fetching your profile data")}.bind(this))},verifyEmail:function(){$.post("/api/settings/verify-email")}})}),define("profile/models/profile_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({initialize:function(){$.validator.addMethod("displayName",function(e,t){return!e.match(/<|\>|\"|\'|@|\s+/i)},"Can not contain @, &lt;, &gt;, or quote symbols, or spaces")},url:"/api/settings/profile",defaults:{displayName:"",title:1,gender:"",country:""},validationRules:{displayName:{maxlength:20,minlength:4,displayName:!0}},validationMessages:{}})}),define("profile/models/account_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/settings/account",defaults:{firstname:"",lastname:"",email:"",birthYear:"",contact:0,password:""},validationRules:{password:{required:!0}},validationMessages:{}})}),define("profile/models/social_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/settings/social",defaults:{offlineMode:0,allowFriendRequests:1,lookingForTeam:"no"},validationRules:{},validationMessages:{}})}),define("profile/models/password_form",["require","shared/classes/form_model","registry"],function(e){"use strict";var t=e("shared/classes/form_model"),i=e("registry");return t.extend({initialize:function(){$.validator.addMethod("notMatchUsername",function(e){return e!=i.get("player").get("username")},"Can not match username"),$.validator.addMethod("notMatchPassword",function(e){return e!=this.findByName("password").val()},"Same as password")},url:"/api/settings/password",defaults:{password:"",newPassword:"",newPassword2:""},validationRules:{password:{required:!0},newPassword:{minlength:4,notMatchUsername:!0,notMatchPassword:!0},newPassword2:{minlength:4,equalTo:"input[name=newPassword]"}},validationMessages:{newPassword:{notMatchUsername:"Password can not be the same as your username",notMatchPassword:"That is the same as your Current Password"},newPassword2:{equalTo:"Passwords do not match"}}})}),define("profile/index",["require","templates","registry","profile/models/profile","shared/classes/form_validation","profile/models/profile_form","profile/models/account_form","profile/models/social_form","profile/models/password_form","global/views/window"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("profile/models/profile"),a=e("shared/classes/form_validation"),r=e("profile/models/profile_form"),n=e("profile/models/account_form"),o=e("profile/models/social_form"),l=e("profile/models/password_form"),c=e("global/views/window");return Backbone.View.extend({el:".profile-sections",events:{"click .js-verify-email":"verifyEmail"},initialize:function(){void 0===this.template&&(this.template=t("profile","index")),NTGLOBALS("LOGGED_IN")?(this.player=i.get("player"),this.model=new s,this.listenTo(this.model,"change",function(e){var t=e.toJSON();delete t.titles,this.player.set(t)}.bind(this)),this.listenTo(this.model,"change",this.render)):location.href="/"},render:function(){this.$el.html(this.template({player:this.player.toJSON(),data:this.model.toJSON(),countries:NTGLOBALS("COUNTRIES")})),new a(this.$("form[name=profile]"),this.$("form[name=profile] .button"),new r,this.profileCallback,this),new a(this.$("form[name=account]"),this.$("form[name=account] .js-submit"),new n,this.accountCallback,this),new a(this.$("form[name=social]"),this.$("form[name=social] .button"),new o,this.socialCallback,this),"standard"==this.player.get("accountType")&&new a(this.$("form[name=password]"),this.$("form[name=password] .button"),new l,this.passwordCallback,this)},profileCallback:function(e,t,i){(e=t.toJSON()).title=this.model.get("titles")[e.title],this.player.set(e),i.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your racer profile has been updated</p>").velocity("fadeIn")})},accountCallback:function(e,t,i){this.player.set(e),i.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your account info has been updated</p>").velocity("fadeIn")})},socialCallback:function(e,t,i){this.player.set({offline:parseInt(t.get("offlineMode"),10),allowFriendRequests:parseInt(t.get("allowFriendRequests"),10),lookingForTeam:"yes"==t.get("lookingForTeam")?1:0}),i.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your social settings have been updated</p>").velocity("fadeIn")})},passwordCallback:function(e,t,i){i.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your password has been updated</p>").velocity("fadeIn")})},verifyEmail:function(e){return this.model.verifyEmail(this.player.get("email")),$(e.currentTarget).remove(),new c({hideCloseButton:!1,title:"Verify Your Email",body:t("profile","verify_email")({email:this.player.get("email")}),mainButtonText:"Ok"}).show(),!1}})}),define("newpass/models/form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/lostpass-change",defaults:{password:"",password2:""},validationRules:{password:{required:!0,minlength:4},password2:{required:!0,minlength:4,equalTo:"input[name=password]"}},validationMessages:{password2:{equalTo:"Passwords do not match"}}})}),define("newpass/index",["require","shared/classes/form_validation","newpass/models/form"],function(e){"use strict";var t=e("shared/classes/form_validation"),i=e("newpass/models/form");return Backbone.View.extend({el:"#app",events:{"keypress input":"submitOnEnter"},initialize:function(){var e=location.hash.replace("#","").split(":");e[0]&&e[1]||(location.href="/"),this.$("form input[name=hash]").val(e[1]),this.$("form input[name=userID]").val(e[0]),new t(this.$("form"),this.$("form .button"),new i,this.callback,this)},callback:function(e,t,i){i.velocity("slideUp",function(){this.$(".content-box").append('<p>Your password has been updated.  You can <a href="#" class="login-link">Log In</a> now</p>').velocity("fadeIn")}.bind(this))},submitOnEnter:function(e){if(13===e.keyCode)return $(e.currentTarget).blur(),this.$("form").submit(),!1}})}),define("validate/models/form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/auth/validate-email"})}),define("validate/index",["require","shared/classes/form_validation","validate/models/form","registry"],function(e){"use strict";var t=e("shared/classes/form_validation"),i=e("validate/models/form"),s=e("registry");return Backbone.View.extend({el:"#app",initialize:function(){var e=location.hash.replace("#","").split(":"),s=e[0],a=e[1];if(s&&a||(s=$.getQueryParam("u"),a=$.getQueryParam("h")),s&&a){this.$("form input[name=hash]").val(a),this.$("form input[name=userID]").val(s);var r=$("<button>");new t(this.$("form"),r,new i,this.callback,this,this.callback),r.click()}else location.href="/"},callback:function(e,t,i){i.velocity("slideUp",function(){var t=e.valid_email?"Your email has been validated. You can now continue playing Nitro Type!":"Unable to validate email address.  It is possible your email changed recently.";this.$(".content-box").append("<p>"+t+"</p>").velocity("fadeIn");var i=s.get("player");NTGLOBALS("LOGGED_IN")&&e.userID==i.id&&i.set({valid_email:e.valid_email})}.bind(this))}})}),define("team/models/team",["require"],function(e){"use strict";return Backbone.Model.extend({idAttribute:"teamID",defaults:{name:"",tag:"",tagColor:"",members:0,createdStamp:0,username:"",displayName:"",userID:"",enrollment:"open",lastModified:0,minSpeed:0,minLevel:0,otherRequirements:""},leave:function(e){return $.post("/api/teams/leave").done(function(t){t.success&&e.set({teamID:0,tag:"",tagColor:"",totalTeammates:0,teamRole:"member"})})}},{getTeamByTag:function(e){return $.get("/api/teams/"+e)}})}),define("team/collections/teams",["require","team/models/team"],function(e){"use strict";var t=e("team/models/team");return Backbone.Collection.extend({model:t,searchAndInvites:function(e){e.page||this.trigger("request");var t=this;return $.post("/api/teams/search",e).done(function(i){i.success&&(e.page>0?t.add(i.data.teams):t.reset(i.data.teams),i.data.teams.length<e.pageSize&&t.trigger("end"))})},ignoreInvitation:function(e){return $.post("/api/teams/"+e+"/ignore-invite")},acceptInvitation:function(e){return $.post("/api/teams/"+e+"/accept-invite")}})}),define("team/views/index_invites",["require","templates","registry"],function(e){"use strict";var t=e("templates"),i=e("registry");return Backbone.View.extend({events:{"click tbody tr":"handleRowClick"},initialize:function(){this.template=t("team","index_invites"),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=i.get("player"),this.render()},render:function(){this._rendered?this.$el.html(this.template({data:this.model.toJSON(),waiting:!1})):(this.$el.html(this.template({waiting:!0})),this._rendered=!0)},removeRow:function(e){this.$("#row-"+e.id).velocity("fadeOut",function(){this.render()}.bind(this))},getRowId:function(e){return $(e.currentTarget).data("id")},handleRowClick:function(e){var t=this.model.get(this.getRowId(e));return $(e.target).is(".join")?this.model.acceptInvitation(t.id).done(function(e){e.success?(this.player.set({tag:t.get("tag"),tagColor:t.get("tagColor"),teamID:t.get("teamID")}),alert("You are now a member of "+t.get("tag")+"!"),location.href="/team/"+t.get("tag")):alert(e.data.message)}.bind(this)):$(e.target).is(".ignore")?(this.model.ignoreInvitation(t.id),this.model.remove(t)):$(e.currentTarget).is("tr")&&(location.href="/team/"+this.model.get(this.getRowId(e)).get("tag")),!1}})}),define("team/index",["require","team/collections/teams","profile/models/social_form","team/views/index_invites","templates","registry"],function(e){"use strict";var t=e("team/collections/teams"),i=e("profile/models/social_form"),s=e("team/views/index_invites"),a=e("templates"),r=e("registry");return Backbone.View.extend({el:"#app",events:{"click .team-preview":"handleTeamClick","change .lft-select":"changeLookingForTeam"},initialize:function(){void 0===this.template&&(this.template=a("team","index")),this.player=r.get("player"),this.model=new t,this.listenTo(this.model,"reset",this.render),this.player.get("lookingForTeam")&&(this.invites=new t,this.invitesView=new s({model:this.invites})),this.render(),this.model.searchAndInvites({minLevel:this.player.get("level"),minSpeed:this.player.get("avgSpeed"),invites:this.player.get("lookingForTeam")}).done(function(e){this.player.get("lookingForTeam")&&this.invites.reset(e.data.invites)}.bind(this)),this.player.set({teamApplications:0})},render:function(){var e=$(this.template({waiting:!this.rendered,player:this.player.toJSON(),teams:this.model.toJSON(),info:NTGLOBALS("TEAM_INFO"),loggedIn:NTGLOBALS("LOGGED_IN")}));this.invitesView&&this.rendered&&e.find("#teamInvites").html(this.invitesView.el),this.$el.html(e),this.rendered=!0},handleTeamClick:function(e){location.href="/team/"+this.model.get($(e.currentTarget).data("id")).get("tag")},changeLookingForTeam:function(e){var t=$(e.target).val(),s=new i;s.clear(),s.set({lookingForTeam:t}),this.player.set({lookingForTeam:"yes"==t?1:0}),s.save()}})}),define("team/search",["require","team/collections/teams","templates","analytics","registry"],function(e){"use strict";var t=e("team/collections/teams"),i=e("templates"),s=e("analytics"),a=e("registry");return Backbone.View.extend({page:0,pageSize:8,order:"level",minLevel:0,minSpeed:0,el:"#app",events:{"click .search":"newSearch","click .team-preview":"handleTeamClick","click .show-more a":"showMore"},initialize:function(){void 0===this.template&&(this.template=i("team","search"),this.resultsTemplate=i("team","search_results")),this.player=a.get("player"),this.model=new t,this.listenTo(this.model,"reset",this.renderResults),this.listenTo(this.model,"add",this.addResults),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"end",this.removeShowMore),this.render(),this.newSearch()},render:function(){this.$el.html(this.template({level:Math.min(10*Math.floor(this.player.get("level")/10),200),speed:Math.min(10*Math.floor(this.player.get("avgSpeed")/10),200)}))},newSearch:function(){return this.page=0,this.minSpeed=this.$("select[name=minSpeed]").val(),this.minLevel=this.$("select[name=minLevel]").val(),this.order=this.$("select[name=order]").val(),this.search(),!1},search:function(){s.trackEvent("Team","Search"),this.model.searchAndInvites({minLevel:this.minLevel,minSpeed:this.minSpeed,page:this.page,pageSize:this.pageSize,order:this.order})},renderResults:function(){this.hideSpinner(),this.$(".show-more").show(),this.$(".results").html(this.resultsTemplate({teams:this.model.toJSON()}))},addResults:function(e){var t=$(this.resultsTemplate({teams:[e.toJSON()]})).hide();this.$(".results").append(t),t.velocity("fadeIn")},showSpinner:function(){this.$(".spinner").show(),this.$(".team-list").hide()},hideSpinner:function(){this.$(".spinner").hide(),this.$(".team-list").show()},removeShowMore:function(){this.$(".show-more").hide()},handleTeamClick:function(e){location.href="/team/"+this.model.get($(e.currentTarget).data("id")).get("tag")},showMore:function(){return this.page+=1,this.search(),!1}})}),define("team/models/create_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:function(){return this.get("teamID")?"/api/teams/update":"/api/teams/create"},defaults:{tag:null,name:null,tagColor:null,minLevel:0,minSpeed:0,otherRequirements:null,password:""},validationRules:{tag:{required:!0,maxlength:4,minlength:2,alphanum:!0},name:{required:!0,maxlength:20},minLevel:{maxlength:3,number:!0},minSpeed:{maxlength:3,number:!0},otherRequirements:{maxlength:150},password:{required:!0}},validationMessages:{}})}),define("team/edit",["require","templates","registry","team/models/team","team/models/create_form","shared/classes/form_validation"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("team/models/team"),a=e("team/models/create_form"),r=e("shared/classes/form_validation");return Backbone.View.extend({el:"#app",events:{"click .tag-colors a":"changeColor","keyup input[name=tag]":"updatePreview","keyup input[name=name]":"updatePreview"},initialize:function(){void 0===this.template&&(this.template=t("team","create")),this.player=i.get("player"),s.getTeamByTag(this.player.get("tag")).done(function(e){if(e.success){if(e.data.info.userID!=this.player.id)return void(location.href="/team/"+e.data.info.tag);this.model=new s(e.data.info),this.render(),this.$(".spinner").hide(),this.$(".create-contents").show()}else alert("There was an error fetching your team information."),location.href="/team"}.bind(this))},render:function(){this.$el.html(this.template({team:this.model.toJSON(),player:this.player.toJSON(),teamInfo:NTGLOBALS("TEAM_INFO"),colors:NTGLOBALS("TEAM_COLORS")})),this.$(".spinner").show(),this.$(".create-contents").hide(),new r(this.$("form"),this.$(".create"),new a,this.editTeam,this)},updatePreview:function(){var e=this.$("input[name=tag]").val()||"TAG",t=this.$("input[name=name]").val()||"Your Team Name";this.$(".tag-preview").html("["+e.toUpperCase()+"]"),this.$(".name-preview").html(t)},changeColor:function(e){var t=$(e.currentTarget),i=t.data("color");return this.$("input[name=tagColor]").val(i),this.$(".tag-colors a").removeClass("active"),t.addClass("active"),this.$(".tag-color").css("color","#"+i),!1},editTeam:function(e,t){this.player.set({tag:t.get("tag").toUpperCase(),teamName:t.get("name"),tagColor:t.get("tagColor")}),location.href="/team/"+t.get("tag").toUpperCase()}})}),define("team/create",["require","templates","analytics","registry","team/models/create_form","shared/classes/form_validation"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("registry"),a=e("team/models/create_form"),r=e("shared/classes/form_validation");return Backbone.View.extend({el:"#app",events:{"click .tag-colors a":"changeColor","keyup input[name=tag]":"updatePreview","keyup input[name=name]":"updatePreview"},initialize:function(){void 0===this.template&&(this.template=t("team","create")),this.formModel=new a,"standard"!=s.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.player=s.get("player"),this.render()},render:function(){this.$el.html(this.template({team:{},player:this.player.toJSON(),teamInfo:NTGLOBALS("TEAM_INFO"),colors:NTGLOBALS("TEAM_COLORS")})),new r(this.$("form"),this.$(".create"),this.formModel,this.createTeam,this)},updatePreview:function(){var e=this.$("input[name=tag]").val()||"TAG",t=this.$("input[name=name]").val()||"Your Team Name";this.$(".tag-preview").html("["+e.toUpperCase()+"]"),this.$(".name-preview").html(t)},changeColor:function(e){var t=$(e.currentTarget),i=t.data("color");return this.$("input[name=tagColor]").val(i),this.$(".tag-colors a").removeClass("active"),t.addClass("active"),this.$(".tag-color").css("color","#"+i),!1},createTeam:function(e,t){i.trackEvent("Team","Create"),this.player.set({teamID:e.teamID,tag:t.get("tag").toUpperCase(),teamName:t.get("name"),tagColor:t.get("tagColor"),teamRole:"officer"}),location.href="/team/"+t.get("tag").toUpperCase()}})}),define("team/models/disband_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/teams/delete",defaults:{password:null},validationRules:{password:{required:!0}},validationMessages:{}})}),define("team/views/view_profile",["require","templates","analytics","team/models/disband_form","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("team/models/disband_form"),a=e("shared/classes/form_validation"),r=e("registry");return Backbone.View.extend({events:{"click .actions a":"handleClick"},initialize:function(){void 0===this.template&&(this.template=t("team","view_profile")),this.formModel=new s,"standard"!=r.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.player=r.get("player"),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),playerUserID:this.player.id,playerLevel:this.player.get("level"),playerSpeed:this.player.get("avgSpeed"),playerTeamID:this.player.get("teamID"),teamInfo:NTGLOBALS("TEAM_INFO"),dateFormat:this.dateFormat})),new a(this.$(".disband-confirm form"),this.$(".disband"),this.formModel,this.disbandTeam,this)},dateFormat:function(e){return moment(new Date(1e3*e)).format("MMM D, YYYY")},handleClick:function(e){var t=$(e.target);if(t.is(".leave-team"))this.showConfirm(e);else if(t.is(".cancel"))this.cancelConfirm(e);else if(t.is(".leave"))this.model.leave(this.player).done(function(e){e.success?location.href="/team":alert("There was an error: "+e.message)});else if(t.is(".disband-team"))this.showConfirm(e);else{if(!t.is(".join-button"))return!0;this.joinTeam(e)}return!1},disbandTeam:function(){i.trackEvent("Team","Disband"),this.player.set({teamID:0,tag:"",tagColor:"",totalTeammates:0,teamRole:"member"}),location.href="/team"},showConfirm:function(e){$(e.currentTarget).parent().find(".confirm").velocity("fadeIn")},cancelConfirm:function(e){$(e.currentTarget).parents(".confirm").velocity("fadeOut")},joinTeam:function(e){var t=$(e.currentTarget),s=t.parent();t.addClass("pending").prop("disabled",!0),this.player.applyToTeam(this.model.id).done(function(e){t.hide(),e.success?(i.trackEvent("Team","Join"),s.html("You will be notified if you are accepted, and will be joined to the first team that accepts you."),this.$(".num-views").fastHide()):s.html(e.data.message)}.bind(this))}})}),define("team/views/view_pending",["require","templates","global/models/car","registry","shared/classes/typing"],function(e){"use strict";var t=e("templates"),i=e("global/models/car"),s=e("registry"),a=e("shared/classes/typing");return Backbone.View.extend({events:{"click .approve-all":"handleApproveAll","click .deny-all":"handleDenyAll","click tbody tr":"handleRowClick"},initialize:function(e){void 0===this.template&&(this.template=t("team","view_pending")),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=s.get("player"),this.team=e.team,this.model.fetch()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),team:this.team.toJSON(),carImage:i.imageTag,countries:NTGLOBALS("COUNTRIES"),typing:a,dateFormat:this.dateFormat,playerUserID:this.player.id}));var e=this.$(".social-table")[0];e&&Sortable.initTable(e)},removeRow:function(e){var t=this;this.$("#row-"+e.id).velocity("fadeOut",function(){t.render()})},dateFormat:function(e){return moment(new Date(1e3*e)).format("MMM D, YYYY")},handleApproveAll:function(){return this.model.approveAll().done(function(e){e.success||alert("There was an error: "+e.message)}),!1},handleDenyAll:function(){return this.model.denyAll().done(function(e){e.success||alert("There was an error: "+e.message)}),!1},getRowId:function(e){return $(e.currentTarget).data("id")},handleRowClick:function(e){return $(e.target).is(".approve")?this.model.approve(this.getRowId(e)).done(function(e){!e.success&&e.data&&e.data.message&&alert(e.data.message)}):$(e.target).is(".deny")?this.model.deny(this.getRowId(e)):$(e.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(e.currentTarget).data("id")).get("username")),!1}})}),define("team/views/view_stats",["require","templates","shared/classes/typing"],function(e){"use strict";var t=e("templates"),i=e("shared/classes/typing");return Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=t("team","view_stats")),this.render()},render:function(){this.$el.html(this.template({data:_.indexBy(this.model.toJSON(),function(e){return e.board}),typing:i}))}})}),define("team/models/status_update",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/teams/status",defaults:{status:""},validationRules:{status:{required:!0,maxlength:110}}})}),define("team/views/team_status_modal",["require","templates","analytics","global/views/modal","team/models/status_update","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=(e("analytics"),e("global/views/modal")),s=e("team/models/status_update"),a=e("shared/classes/form_validation"),r=e("registry");return i.extend({initialize:function(e){i.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=t("team","team_status_modal")),this.model=new s,this.render()},render:function(){return this.$el.append(this.template({})),new a(this.$("form"),this.$(".button-update"),this.model,this.update,this),this},update:function(e,t,i){r.get("realtime").teamMotd(r.get("player").get("teamID")),r.get("player").set("teamStatusDate",e.changed_at),setTimeout(function(){location.reload()},1)}})}),define("team/views/view_members",["require","templates","global/models/car","registry","shared/classes/typing","team/views/team_status_modal"],function(e){"use strict";var t=e("templates"),i=e("global/models/car"),s=e("registry"),a=e("shared/classes/typing"),r=e("team/views/team_status_modal");return Backbone.View.extend({events:{"click tbody tr":"handleRowClick","click .js-member-toggle":"toggleMemberTables","click .update-status":"openUpdateStatusModal"},initialize:function(e){void 0===this.template&&(this.template=t("team","view_members")),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=s.get("player"),this.team=e.team,this.seasonModel=e.seasonModel,this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),season:this.seasonModel.toJSON(),team:this.team.toJSON(),carImage:i.imageTag,countries:NTGLOBALS("COUNTRIES"),typing:a,canPromote:this.model.where({role:"officer"}).length<NTGLOBALS("TEAM_INFO").maxOfficers,dateFormat:this.dateFormat,player:this.player.toJSON(),timeToNextStatusUpdate:this.getTimeUntilNextStatusUpdate()})),Sortable.initTable(this.$(".js-member-table")[0]),Sortable.initTable(this.$(".js-season-table")[0])},removeRow:function(e){this.$("#row-"+e.id).velocity("fadeOut",function(){$(this).remove()})},dateFormat:function(e){return moment(new Date(1e3*e)).format("MMM D, YYYY")},getTimeUntilNextStatusUpdate:function(){var e=this.model.findWhere({userID:this.player.id});if(e){var t=e.get("teamStatusDate");if(t&&t>0){var i=Date.getUnixTime()-t;if(i<43200)return Number(43200-i).countdownSeconds()}}return null},handleRowClick:function(e){e.preventDefault();var t=$(e.target);return t.is(".remove-friend")||t.parent().is(".remove-friend")?this.toggleOptions(e):t.is(".delete")?this.deleteMember(e):t.is(".promote")?this.promoteMember(e):t.is(".demote")?this.demoteMember(e):!t.is(".remove-popup")&&void(location.href="/racer/"+this.model.get($(e.currentTarget).data("id")).get("username"))},toggleOptions:function(e){$(e.currentTarget).find(".remove-popup").toggle()},deleteMember:function(e){return confirm("Remove Member from Team\n\nAre you sure?")&&this.model.delete($(e.currentTarget).data("id")),!1},promoteMember:function(e){return this.model.promote($(e.currentTarget).data("id")),!1},demoteMember:function(e){return this.model.demote($(e.currentTarget).data("id")),!1},toggleMemberTables:function(e){var t=$(e.currentTarget).data("id");return this.$(".js-member-toggle").removeClass("is-active"),$(e.currentTarget).addClass("is-active"),this.$(".js-members").fastHide(),this.$(".js-"+t).fastShow(),!1},openUpdateStatusModal:function(e){return(new r).show({destroy:!0}),!1}})}),define("team/models/motd",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({idAttribute:"teamMotdID",url:"/api/teams/motd",defaults:{message:""},validationRules:{message:{required:!0,maxlength:400}}})}),define("team/views/new_motd",["require","templates","analytics","global/views/modal","team/models/motd","shared/classes/form_validation","registry"],function(e){"use strict";var t=e("templates"),i=(e("analytics"),e("global/views/modal")),s=e("team/models/motd"),a=e("shared/classes/form_validation"),r=e("registry");return i.extend({initialize:function(e){i.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=t("team","new_motd")),this.model=new s,this.render()},render:function(){return this.$el.append(this.template({})),new a(this.$("form"),this.$(".button-update"),this.model,this.update,this),this},update:function(){r.get("realtime").teamMotd(r.get("player").get("teamID")),setTimeout(function(){location.reload()},0)}})}),define("team/views/view_motd",["require","templates","registry","team/views/new_motd"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("team/views/new_motd");return Backbone.View.extend({events:{"click .view-older":"viewAll","click .new-motd":"newMotd"},initialize:function(e){void 0===this.template&&(this.template=t("team","view_motd")),this.player=i.get("player"),this.team=e.team,this.render()},render:function(){this.$el.append(this.template({data:this.model.toJSON(),team:this.team.toJSON(),player:this.player.toJSON(),formatText:this.formatText}))},formatText:function(e){return e.replace(/(@\S+)\s+/gm,function(e){return'<span class="racer">'+e+"</span>"})},viewAll:function(){return this.$(".messages").addClass("view-all"),!1},newMotd:function(){return(new s).show({destroy:!0}),!1}})}),define("team/collections/motds",["require","team/models/motd"],function(e){"use strict";var t=e("team/models/motd");return Backbone.Collection.extend({model:t})}),define("team/collections/members",["require","global/models/player"],function(e){"use strict";var t=e("global/models/player");return Backbone.Collection.extend({model:t,delete:function(e){$.post("/api/team-members/"+e+"/remove").done(function(t){t.success?this.remove(e):alert("There was an error: "+t.message)}.bind(this))},demote:function(e){$.post("/api/team-members/"+e+"/demote").done(function(e){e.success?location.reload():alert("There was an error: "+e.message)})},promote:function(e){$.post("/api/team-members/"+e+"/promote").done(function(e){e.success?location.reload():alert("There was an error: "+e.message)})}})}),define("team/collections/stats",["require"],function(e){"use strict";return Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"board"})})}),define("team/collections/pending",["require","registry","global/models/player"],function(e){"use strict";var t=e("registry"),i=e("global/models/player");return Backbone.Collection.extend({model:i,initialize:function(){this.on("reset",this.updatePlayer,this),this.on("remove",this.updatePlayer,this)},updatePlayer:function(){t.get("player").set({teamApplications:this.length})},fetch:function(){var e=this;return $.get("/api/teams/applications").done(function(t){t.success&&e.reset(t.data)})},approve:function(e){return $.post("/api/team-requests/"+e+"/accept").done(function(i){i.success&&(this.remove(e),t.get("realtime").acceptToTeam(t.get("player").get("teamID"),[e]))})},deny:function(e){return this.remove(e),$.post("/api/team-requests/"+e+"/deny")},approveAll:function(){return this.trigger("request"),$.post("/api/team-requests/accept-all").done(function(e){e.success&&(t.get("realtime").acceptToTeam(t.get("player").get("teamID"),e.data),this.reset())}.bind(this))},denyAll:function(){var e=this;return this.trigger("request"),$.post("/api/team-requests/deny-all").done(function(t){t.success&&e.reset()})}})}),define("team/view",["require","team/views/view_profile","team/views/view_pending","team/views/view_stats","team/views/view_members","team/views/view_motd","team/models/team","team/collections/motds","team/collections/members","team/collections/stats","team/collections/pending","registry"],function(e){"use strict";var t=e("team/views/view_profile"),i=e("team/views/view_pending"),s=e("team/views/view_stats"),a=e("team/views/view_members"),r=e("team/views/view_motd"),n=e("team/models/team"),o=e("team/collections/motds"),l=e("team/collections/members"),c=e("team/collections/stats"),h=e("team/collections/pending"),d=e("registry");return Backbone.View.extend({el:"#app",initialize:function(e){this.player=d.get("player"),n.getTeamByTag(e.tag).done(function(e){e.success?(NTGLOBALS("LOGGED_IN")&&e.data.info.teamID!=this.player.get("teamID")&&d.get("realtime").teamCheckin(e.data.info.teamID),this.setUpViews(e.data),this.render()):location.href="/garage"}.bind(this))},setUpViews:function(e){var d=new n(e.info);this.model=d;var u=new l(e.members),p=new c(e.stats),m=new l(e.season);if(d.id==this.player.get("teamID")||this.player.get("moderator")||this.player.get("admin")){var g=new o(e.motd);this.motd=new r({model:g,team:d})}if(this.profile=new t({model:d}),this.stats=new s({model:p,team:d}),this.members=new a({model:u,seasonModel:m,team:d}),this.model.id==this.player.get("teamID")&&"officer"==this.player.get("teamRole")){var f=new h;this.pending=new i({model:f,team:d})}},render:function(){this.$("#teamProfile").html(this.profile.el),this.motd&&this.$(".team-motd").html(this.motd.el),this.$(".team-stats").html(this.stats.el),this.$(".team-members").html(this.members.el),this.pending&&(this.$(".team-pending").html(this.pending.el),this.$(".applications").show()),this.model.id==this.player.get("teamID")&&this.player.set({teamApplications:0})}})}),define("store/models/purchase_form",["require","shared/classes/form_model","registry"],function(e){"use strict";var t=e("shared/classes/form_model");e("registry");return t.extend({initialize:function(){},url:"/api/purchase",defaults:{product:"",purchaseFor:"",purchaseForUsername:""},validationRules:{purchaseForUsername:{required:!0}},validationMessages:{},purchase:function(e){return this.set(e),$.post("/api/purchase/cash",this.toJSON())}})}),define("store/index",["require","registry","analytics","shared/classes/form_validation","store/models/purchase_form","templates"],function(e){"use strict";var t=e("registry"),i=e("analytics"),s=e("shared/classes/form_validation"),a=e("store/models/purchase_form"),r=e("templates");return Backbone.View.extend({el:"#app",events:{"click .item":"changeProduct","click input[name=purchaseFor]":"changePurchaseFor"},initialize:function(){this.templateComplete=r("store","complete"),this.templateWaiting=r("store","waiting"),this.player=t.get("player"),this.products=NTGLOBALS("PRODUCTS"),this.model=new a,"object"==typeof StripeCheckout?(this.stripeHandler=StripeCheckout.configure({key:NTGLOBALS("STRIPE_KEY"),token:this.confirmOrder.bind(this),closed:this.stripeClosed.bind(this),bitcoin:!0}),$(window).on("popstate",this.stripeHandler.close.bind(this.stripeHandler)),this.render()):alert('Uh oh! It looks like your network is blocking our payment gateway. To upgrade, please allow "stripe.com" in your firewall, or upgrade using a different internet connection.')},render:function(){if(this.$(".username").html(this.player.get("username")),location.hash){this.$("input[name=purchaseForUsername]").val(location.hash.replace("#",""));var e=location.hash.replace("#","");this.$(".username").text(e||this.player.get("username")),this.$("#purchaseForOther").prop("checked",!0),this.$(".purchase-other").show()}this.formValidator=new s(this.$("form[name=payment-form]"),this.$(".purchase-button"),this.model,this.checkCallback,this),"object"==typeof grecaptcha&&grecaptcha.execute()},renderWaiting:function(){this.$("#payment-start").velocity("slideUp",function(){this.$("#payment-waiting").html(this.templateWaiting()).velocity("slideDown")}.bind(this))},renderComplete:function(e){this.$("#payment-waiting").velocity("slideUp",function(){this.$("#payment-confirmation").html(this.templateComplete({data:e})).velocity("slideDown")}.bind(this))},checkCallback:function(e,t){var i=_.extend(e,t.toJSON());this.stripeHandler.open({image:"dist/site/images/icons/stripe.jpg",name:this.products[this.model.get("product")].name,description:"$"+this.products[this.model.get("product")].cashReward.addCommas()+" for "+("other"==i.purchaseFor?i.purchaseForUsername:this.player.get("username")),amount:Math.round(100*this.products[i.product].price),zipCode:!0,email:this.player.get("email")||null,billingAddress:!0,allowRememberMe:!0})},stripeClosed:function(){this.formValidator.enableForm()},confirmOrder:function(e){this.renderWaiting(),"object"==typeof grecaptcha?e.captchaKey=grecaptcha.getResponse():e.captchaKey="ignore",this.model.purchase(e).done(function(e){if(e.success){var t=_.extend(this.model.toJSON(),e.data);"self"==t.purchaseFor&&this.player.inc({money:this.products[t.product].cashReward,totalPurchases:1}),t.buyCash&&this.player.set({buyCash:t.buyCash}),this.googleEcommerce(t),this.renderComplete(t)}else e.data&&e.data.message?(alert(e.data.message),e.data.captchaFail&&location.reload()):alert("There was an error upgrading your account! Please try again, or contact support.")}.bind(this))},changeProduct:function(e){var t=$(e.currentTarget).data("id"),s=this.products[t],a=$(e.currentTarget).data("index"),r=this.$(".selected-item");return r.removeClass("item-1 item-2 item-3 item-4 item-5 item-6").addClass("item-"+a),r.find(".name").html(s.name),r.find(".price").html("$"+s.cashReward.addCommas()),r.find(".image").css({backgroundImage:"url('/dist/site/images/store/cash-"+a+".png')"}),r.find(".description").html(s.description),r.find(".purchase-button").html("Purchase for $"+s.price),r.is(":visible")||r.velocity("slideDown"),i.trackPage("/store/details"),this.model.set({product:t}),!1},changePurchaseFor:function(e){"self"==$(e.currentTarget).val()?this.$(".purchase-other").velocity("slideUp"):this.$(".purchase-other").velocity("slideDown")},googleEcommerce:function(e){e.transaction_id=e.invoiceNum,e.total=this.products[e.product].price,e.store="Nitro Type";var t=[{sku:e.product,product:this.products[e.product].name,price:this.products[e.product].price,quantity:1,category:this.products[e.product].type}];i.trackSale(e,t),i.trackPage("/store/complete")}})}),define("upgrade/index",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.View.extend({el:"#app",events:{"click .button-race":"clickButton"},initialize:function(){this.player=t.get("player")},clickButton:function(){return NTGLOBALS("LOGGED_IN")?t.get("player").get("level")<20?(alert("You must be at least level 20 to purchase Gold Membership."),!1):void 0:(alert("You must be logged to continue."),!1)}})}),define("upgrade/models/purchase_form",["require","shared/classes/form_model","registry"],function(e){"use strict";var t=e("shared/classes/form_model");e("registry");return t.extend({initialize:function(){},url:"/api/purchase",defaults:{product:"",purchaseFor:"",purchaseForUsername:""},validationRules:{purchaseForUsername:{required:!0}},validationMessages:{},purchase:function(e){return this.set(e),$.post("/api/purchase/upgrade",this.toJSON())}})}),define("upgrade/payment",["require","registry","analytics","shared/classes/form_validation","upgrade/models/purchase_form","templates"],function(e){"use strict";var t=e("registry"),i=e("analytics"),s=e("shared/classes/form_validation"),a=e("upgrade/models/purchase_form"),r=e("templates");return Backbone.View.extend({el:"#app",events:{"click input[name=product]":"changeProduct","click input[name=purchaseFor]":"changePurchaseFor"},initialize:function(){void 0===this.template&&(this.template=r("upgrade","complete"),this.templateWaiting=r("upgrade","waiting")),this.player=t.get("player"),this.products=NTGLOBALS("PRODUCTS"),this.model=new a,"object"==typeof StripeCheckout?(this.stripeHandler=StripeCheckout.configure({key:NTGLOBALS("STRIPE_KEY"),image:"dist/site/images/icons/stripe.jpg",token:this.confirmOrder.bind(this),closed:this.stripeClosed.bind(this),bitcoin:!0}),$(window).on("popstate",this.stripeHandler.close.bind(this.stripeHandler)),this.render()):alert('Uh oh! It looks like your network is blocking our payment gateway. To upgrade, please allow "stripe.com" in your firewall, or upgrade using a different internet connection.')},render:function(){if(this.$(".username").html(this.player.get("username")),location.hash||"gold"==this.player.get("membership")){this.$("input[name=purchaseForUsername]").val(location.hash.replace("#",""));var e=location.hash.replace("#","");this.$(".username").text(e||this.player.get("username")),this.$("#purchaseForOther").prop("checked",!0),this.$(".purchase-other").show(),"gold"==this.player.get("membership")&&this.$(".upgrade-self-row").hide()}this.formValidator=new s(this.$("form[name=payment-form]"),this.$("form[name=payment-form] .button"),this.model,this.checkCallback,this),"object"==typeof grecaptcha&&grecaptcha.execute()},renderWaiting:function(){this.$("#payment-start").velocity("slideUp",function(){this.$("#payment-waiting").html(this.templateWaiting()).velocity("slideDown")}.bind(this))},renderComplete:function(e){this.$("#payment-waiting").velocity("slideUp",function(){this.$("#payment-confirmation").html(this.template({data:e})).velocity("slideDown")}.bind(this))},checkCallback:function(e,t){var i=_.extend(e,t.toJSON());this.stripeHandler.open({name:"Nitro Type Gold",description:"Upgrade for "+("other"==i.purchaseFor?i.purchaseForUsername:this.player.get("username")),amount:Math.round(100*this.products[i.product].price),zipCode:!0,email:this.player.get("email")||null,billingAddress:!0,allowRememberMe:!0})},stripeClosed:function(){this.formValidator.enableForm()},confirmOrder:function(e){this.renderWaiting(),"object"==typeof grecaptcha?e.captchaKey=grecaptcha.getResponse():e.captchaKey="ignore",this.model.purchase(e).done(function(e){if(e.success){var t=_.extend(this.model.toJSON(),e.data);"self"==t.purchaseFor&&(this.player.set({membership:"gold",buyCash:t.buyCash}),this.player.inc({money:this.products[t.product].cashReward,totalPurchases:1}),this.player.setCachingCookie("gold")),this.googleEcommerce(t),this.renderComplete(t)}else e.data&&e.data.message?alert(e.data.message):alert("There was an error upgrading your account! Please try again, or contact support."),location.reload()}.bind(this))},changeProduct:function(e){this.$(".price-options p").removeClass("selected"),$(e.currentTarget).parent("p").addClass("selected"),this.$(".price span").html("$"+this.products[$(e.currentTarget).val()].price)},changePurchaseFor:function(e){"self"==$(e.currentTarget).val()?this.$(".purchase-other").velocity("slideUp"):this.$(".purchase-other").velocity("slideDown")},googleEcommerce:function(e){e.transaction_id=e.invoiceNum,e.total=this.products[e.product].price,e.store="Nitro Type";var t=[{sku:e.product,product:this.products[e.product].name,price:this.products[e.product].price,quantity:1,category:this.products[e.product].type}];i.trackSale(e,t),i.trackPage("/upgrade/complete")}})}),define("achievements/models/group",["require"],function(e){"use strict";return Backbone.Model.extend({defaults:{name:"",order:""}})}),define("achievements/collections/groups",["require","achievements/models/group"],function(e){"use strict";var t=e("achievements/models/group");return Backbone.Collection.extend({model:t,comparator:"order",getCounts:function(e){return _.map(this.toJSON(),function(t){var i=e.filterByGroupId(t.id);return t.total=i.length,t.completed=i.filter(function(e){return e.get("completedStamp")>0}).length,t})}})}),define("achievements/views/list",["require","templates","global/models/car","global/views/invites"],function(e){"use strict";var t=e("templates"),i=e("global/models/car"),s=e("global/views/invites");return Backbone.View.extend({title:"",events:{"mouseenter .reward":"scaleRewardUp","mouseleave .reward":"scaleRewardDown","click .invite-link":"handleInviteClick"},initialize:function(e){void 0===this.template&&(this.template=t("achievements","list")),this.options=e,this.title=e.title,this.listenTo(this.model,"reset",this.render),this.render()},setTitle:function(e){this.title=e},render:function(){this.$el.html(this.template({data:this.model,total:this.model.length,completed:this.model.filter(function(e){return e.get("completedStamp")}).length,title:this.title,hideProgress:this.options.hideProgress,carTag:i.imageTag}))},handleInviteClick:function(){return this.invites||(this.invites=new s),this.invites.show(),!1},scaleRewardUp:function(e){var t=$(e.currentTarget).find(".car");t.length&&(t.find(".small").fastHide(),t.find(".large").fastShow(),t.find(".large img").velocity("finish").velocity({maxHeight:136,top:-54},{duration:200,easing:"linear",queue:!1}))},scaleRewardDown:function(e){var t=$(e.currentTarget).find(".car");t.length&&t.find(".large img").velocity({maxHeight:40,top:0},{duration:200,easing:"linear",queue:!1,complete:function(){t.find(".large").fastHide(),t.find(".small").fastShow()}.bind(this)})}})}),define("achievements/views/summary",["require","templates","registry","achievements/views/list"],function(e){"use strict";var t=e("templates"),i=(e("registry"),e("achievements/views/list"));return Backbone.View.extend({initialize:function(e){void 0===this.template&&(this.template=t("achievements","summary")),this.options=e,this.list=new i({model:e.achievements.getRecentlyCompleted(3),title:"Recent Achievements",hideProgress:!0}),this.render()},render:function(){var e=this.options.groups.getCounts(this.options.achievements),t=_.reduce(e,function(e,t){return e+t.total},0),i=_.reduce(e,function(e,t){return e+t.completed},0);this.$el.html(this.template({total:t,completed:i,groups:e,loggedIn:NTGLOBALS("LOGGED_IN")})),this.$(".recent-list").html(this.list.el)}})}),define("achievements/index",["require","templates","achievements/collections/groups","achievements/collections/achievements","achievements/views/summary","achievements/views/list","registry"],function(e){"use strict";var t=e("templates"),i=e("achievements/collections/groups"),s=e("achievements/collections/achievements"),a=e("achievements/views/summary"),r=e("achievements/views/list"),n=e("registry");return Backbone.View.extend({el:".achievements-box",events:{"click .groups a":"handleGroupClick","click .progress-bars .progress":"handleGroupClick"},initialize:function(){void 0===this.template&&(this.template=t("achievements","index")),this.player=n.get("player"),this.groups=new i(JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").GROUPS))),this.achievements=n.get("achievements"),this.texts=JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT)),this.achievements.setCompleted(n.get("playerAchievements")),this.selectedGroup=this.player.get("_achGroup")||"summary";var e=location.hash;e&&(this.selectedGroup=e.replace("#","")),this.groups.get(this.selectedGroup)||(this.selectedGroup="summary"),this.summary=new a({player:this.player,achievements:this.achievements,groups:this.groups,texts:this.texts}),"summary"!==this.selectedGroup&&this.summary.$el.hide(),this.list=new r({model:new s}),"summary"===this.selectedGroup?this.list.$el.hide():this.showList(this.selectedGroup),this.render()},render:function(){this.$el.html(this.template({data:this.groups.getCounts(this.achievements),player:this.player.toJSON(),selected:this.selectedGroup})),this.$(".list").append(this.summary.el).append(this.list.el)},handleGroupClick:function(e){var t=$(e.currentTarget).data("id");return this.$(".groups a").removeClass("active"),this.$(".groups a[data-id="+t+"]").addClass("active"),this.player.set({_achGroup:t}),"summary"==t?(this.list.$el.fastHide(),this.summary.$el.fastShow()):(this.showList(t),this.summary.$el.fastHide(),this.list.$el.fastShow()),!1},showList:function(e){this.list.setTitle(this.groups.get(e).get("name")),this.list.model.reset(this.achievements.filterByGroupId(e))}})}),define("router",["require","registry","index/index","relogin/index","join/index","garage/index","dealership/index","friends/index","bugs/index","scoreboard/index","news/index","news/read","garage/index","stats/index","racelog/index","race/index","race/index","race/performance_test","race/index","support/index","refund/index","profile/index","newpass/index","validate/index","team/index","team/search","team/edit","team/create","team/view","store/index","upgrade/index","upgrade/payment","achievements/index"],function(e){"use strict";var t=e("registry"),i=Backbone.Router.extend({initialize:function(){this.pubSub=t.get("pubSub")},routes:{"":function(){new(e("index/index"))},"relogin(/*)":function(){new(e("relogin/index")),this.pubSub.trigger("app:navigate","relogin")},"join/:username":function(t){new(e("join/index"))({username:t}),this.pubSub.trigger("app:navigate","join")},"garage(/*)":function(){new(e("garage/index")),this.pubSub.trigger("app:navigate","garage")},"dealership(/*)":function(){new(e("dealership/index")),this.pubSub.trigger("app:navigate","dealership")},"friends(/*)":function(){new(e("friends/index")),this.pubSub.trigger("app:navigate","friends")},"bugs(/*)":function(){new(e("bugs/index")),this.pubSub.trigger("app:navigate","bugs")},"leaderboards(/*)":function(){new(e("scoreboard/index")),this.pubSub.trigger("app:navigate","scoreboard")},"news(/*)":function(){new(e("news/index")),this.pubSub.trigger("app:navigate","news")},"news/read/:id/*name(/*)":function(t){new(e("news/read"))({newsId:t}),this.pubSub.trigger("app:navigate","news")},"racer/:username(/*)":function(t){new(e("garage/index"))({username:t}),this.pubSub.trigger("app:navigate","racer")},"stats(/*)":function(){new(e("stats/index")),this.pubSub.trigger("app:navigate","stats")},"racelog/:type(/*)":function(t){new(e("racelog/index"))({type:t}),this.pubSub.trigger("app:navigate","stats")},"race/:useranme(/*)":function(t){new(e("race/index"))({trackLeader:t}),this.pubSub.trigger("app:navigate","race")},"race(/*)":function(){new(e("race/index"))({}),this.pubSub.trigger("app:navigate","race")},"test(/*)":function(){new(e("race/performance_test"))({}),this.pubSub.trigger("app:navigate","test")},"practice(/*)":function(){new(e("race/index"))({practice:!0}),this.pubSub.trigger("app:navigate","race")},"support(/*)":function(){new(e("support/index")),this.pubSub.trigger("app:navigate","support")},"refund(/*)":function(){new(e("refund/index")),this.pubSub.trigger("app:navigate","refund")},"profile(/*)":function(){new(e("profile/index"))},"newpass(/*)":function(){new(e("newpass/index"))},"validate(/*)":function(){new(e("validate/index"))},"team(/*)":function(){t.get("player").get("teamID")?location.href="/team/"+t.get("player").get("tag"):(new(e("team/index")),this.pubSub.trigger("app:navigate","team"))},"team/search(/*)":function(){new(e("team/search")),this.pubSub.trigger("app:navigate","team")},"team/edit(/*)":function(){new(e("team/edit")),this.pubSub.trigger("app:navigate","team")},"team/create(/*)":function(){t.get("player").get("teamID")?location.href="/team/"+t.get("player").get("tag"):(new(e("team/create")),this.pubSub.trigger("app:navigate","team"))},"team/:tag(/*)":function(t){new(e("team/view"))({tag:t}),this.pubSub.trigger("app:navigate","team")},"store(/*)":function(){new(e("store/index"))},"upgrade(/*)":function(){new(e("upgrade/index"))},"upgrade/payment(/*)":function(){new(e("upgrade/payment"))},"achievements(/*)":function(){new(e("achievements/index")),this.pubSub.trigger("app:navigate","achievements")}}});return{initialize:function(){new i,Backbone.history.start({pushState:!0})}}}),define("global/collections/messages",["require","registry"],function(e){"use strict";var t=e("registry");return Backbone.Collection.extend({receiveMessage:function(e){var i=t.get("player");if(e=_.extend(e,e.data),e.stamp=Date.now(),e.id=e.type+e.from,delete e.data,"race-invite"==e.type||"friend-accept"==e.type||"team-accept"==e.type||"sent-cash"==e.type){if("race-invite"==e.type&&(i.get("offline")||location.href.match("/race/"+e.username)))return;"team-accept"==e.type&&i.set({tag:e.tag,teamID:e.teamID,tagColor:e.tagColor}),"sent-cash"==e.type&&i.set({cashgift:1}),this.add(e)}else"friend-requests"==e.type?i.set({requests:e.requests}):"team-application"==e.type?i.set({teamApplications:e.applications}):"team-invite"!=e.type||i.get("teamID")?"team-motd"==e.type&&i.inc({teamApplications:1}):i.inc({teamApplications:1})},clearOld:function(){this.filter(function(e){if(Date.now()-e.get("stamp")>9e5)return!0}).forEach(function(e){this.remove(e)}.bind(this))},model:Backbone.Model.extend({defaults:{userID:0,teamID:0,username:"",displayName:"",speed:0,type:"",tag:"",tagColor:""}})})}),define("global/collections/top3_players",["require"],function(e){"use strict";return Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"userID"}),comparator:"rank"})}),define("global/models/login_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/login",defaults:{username:null,password:null},validationRules:{username:{required:!0},password:{required:!0}},validationMessages:{username:{required:"Please enter a username"},password:{required:"Please enter a password"}}})}),define("global/views/login_form",["require","templates","registry","global/models/login_form","shared/classes/form_validation"],function(e){"use strict";var t=e("templates"),i=e("registry"),s=e("global/models/login_form"),a=e("shared/classes/form_validation");return Backbone.View.extend({events:{'keypress input[name="password"]':"submitOnEnter",'keypress input[name="remember"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=t("global","login_form")),this.model=new s},render:function(){this.$el.html(this.template({}));var e=this.$("form"),t=this.$("form .submit");return window.detectAdb&&this.$("input[name=adb]").val(window.detectAdb()),this.$("input[name=tz]").val(jstz.determine().name()),new a(e,t,this.model,this.successCallback,this),this},successCallback:function(e){i.get("player").loginWithData(e),"/"==window.location.pathname||window.location.pathname.match(/^\/join/)||window.location.pathname.match(/^\/newpass/)?window.location.href="/garage":window.location.reload()},submitOnEnter:function(e){13===e.keyCode&&(e.preventDefault(),$(e.currentTarget).blur(),this.$("form").submit())}})}),define("global/models/forgot_password_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/lostpass-send",defaults:{email:null},validationRules:{email:{required:!0,email:!0}},validationMessages:{email:{required:"Please enter an email",email:"Please enter a valid email"}}})}),define("global/views/forgot_password",["require","templates","shared/classes/form_validation","global/models/forgot_password_form"],function(e){"use strict";var t=e("templates"),i=e("shared/classes/form_validation"),s=e("global/models/forgot_password_form");return Backbone.View.extend({events:{"click .forgot-password":"toggleForgotPassword",'keypress input[name="email"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=t("global","forgot_password")),this.model=new s},render:function(){this.$el.html(this.template());var e=this.$("form"),t=this.$("form .submit");return new i(e,t,this.model,this.successCallback.bind(this)),this},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".reset-instructions").velocity("slideDown")},toggleForgotPassword:function(e){e.preventDefault();var t=this.$(".forgot-password-form");t.is(":visible")?t.velocity("slideUp",150):(t.velocity("slideDown",150),t.find("input").focus())},hide:function(){this.$(".forgot-password-form").hide()},submitOnEnter:function(e){13===e.keyCode&&(e.preventDefault(),$(e.currentTarget).blur(),this.$("form").submit())}})}),define("global/views/login",["require","templates","global/views/login_form","global/views/forgot_password","registry"],function(e){"use strict";var t=e("templates"),i=e("global/views/login_form"),s=e("global/views/forgot_password");e("registry");return Backbone.View.extend({className:"login-box",events:{"click .close":"hide","click .login-with-facebook":"facebookLogin","click .login-with-google":"googleLogin","click .login-with-clever":"cleverLogin"},_initialize:function(){void 0===this.template&&(this.template=t("global","login")),this.loginForm=new i,this.forgotPassword=new s,this.render(),this.inited=!0},render:function(){this.$el.html(this.template()),this.$("#loginFormContainer").html(this.loginForm.render().el),this.$("#forgotPasswordContainer").html(this.forgotPassword.render().el),$("body").append(this.el)},show:function(e){this.inited||this._initialize(),e=$(e),this.$el.css({left:e.offset().left+e.width()-this.$el.width(),top:e.offset().top+15}).velocity("fadeIn",function(){this.$el.find('input[name="username"]').focus()}.bind(this))},hide:function(){return this.$el.hide(),this.forgotPassword&&this.forgotPassword.hide(),!1},getState:function(){var e=_.random(1e4,99999);return $.cookie("state",e,{path:"/"}),e},facebookLogin:function(){return $.get("/api/auth/facebook").done(function(e){e.success?location.href=e.data.url:alert("Unable to log into facebook: "+e.data.message)}.bind(this)),!1},googleLogin:function(){return location.href="https://accounts.google.com/o/oauth2/auth?client_id="+NTGLOBALS("GOOGLE_CLIENTID")+"&redirect_uri="+encodeURIComponent(NTGLOBALS("GOOGLE_REDIRECTURI"))+"&response_type=code&scope=openid&state="+this.getState(),!1},cleverLogin:function(){return location.href="https://clever.com/oauth/authorize?client_id="+NTGLOBALS("CLEVER_CLIENTID")+"&redirect_uri="+encodeURIComponent(NTGLOBALS("CLEVER_REDIRECTURI"))+"&response_type=code&scope=openid&state="+this.getState(),!1}})}),define("global/models/register_form",["require","shared/classes/form_model"],function(e){"use strict";return e("shared/classes/form_model").extend({url:"/api/register",defaults:{username:null,password:null,email:null},validationRules:{username:{required:!0},password:{required:!0},email:{email:!0}},validationMessages:{username:{required:"Please enter a username"},password:{required:"Please enter a password"},email:{email:"Please enter a valid email, or none at all"}}})}),define("global/views/register_form",["require","templates","analytics","registry","global/models/register_form","shared/classes/form_validation"],function(e){"use strict";var t=e("templates"),i=e("analytics"),s=e("registry"),a=e("global/models/register_form"),r=e("shared/classes/form_validation");return Backbone.View.extend({events:{'keypress input[name="password"],input[name="email"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=t("global","register_form")),this.model=new a},render:function(){this.$el.html(this.template());var e=this.$("form"),t=this.$("form .submit");return window.detectAdb&&this.$("input[name=adb]").val(window.detectAdb()),this.$("input[name=tz]").val(jstz.determine().name()),new r(e,t,this.model,this.successCallback,this),"object"==typeof grecaptcha?(window.registerRecaptchaCallback(this.setCaptchaKey.bind(this)),grecaptcha.execute()):this.setCaptchaKey("ignore"),this},setCaptchaKey:function(e){this.$("input[name=captchaKey]").val(e)},successCallback:function(e){i.trackPage("/signup/complete"),s.get("player").loginWithData(e),window.location.href="/race"},submitOnEnter:function(e){13===e.keyCode&&(e.preventDefault(),$(e.currentTarget).blur(),this.$("form").submit())}})}),define("global/views/register",["require","global/views/login","templates","global/views/register_form"],function(e){"use strict";var t=e("global/views/login"),i=e("templates"),s=e("global/views/register_form");return t.extend({className:"register-box",_initialize:function(){void 0===this.template&&(this.template=i("global","register")),this.render(),this.inited=!0},show:function(e){this.inited||this._initialize(),t.prototype.show.apply(this,arguments)},render:function(){this.$el.html(this.template());var e=new s;this.$("#registerFormContainer").html(e.render().el),setTimeout(function(){this.$el.find('input[name="username"]').focus()}.bind(this),0),$("body").append(this.el)}})}),define("global/views/level_up",["require","global/views/modal","templates"],function(e){"use strict";var t=e("global/views/modal"),i=e("templates");return t.extend({initialize:function(){t.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=i("global","level_up")),this.listenTo(this.model,"change:level",this.render)},render:function(){return this.$el.append(this.template({level:this.model.get("level")})),this.$el.show(),this}})}),define("global/views/messages",["require","templates","registry","shared/classes/drags"],function(e){"use strict";var t=e("templates"),i=e("registry");return e("shared/classes/drags"),Backbone.View.extend({className:"message-center",events:{"click .close":"hide","click .button-red":"decline","click .button-green":"accept"},initialize:function(){if(NTGLOBALS("LOGGED_IN")){void 0===this.template&&(this.template=t("global","messages")),this.player=i.get("player"),this.model=i.get("playerMessages"),this.model.clearOld(),this.listenTo(this.model,"add",this.addRow);var e=this.player.get("_messagesPos");e&&this.$el.css(e),this.render()}},messageText:function(e){switch(e.type){case"race-invite":return"has invited you to race";case"friend-accept":return"just accepted your friend request";case"sent-cash":return"just sent you $"+Number(e.amount).addCommas()+"!"}},addRow:function(){this.renderMessages(),this.show()},render:function(){this.$el.html(this.template({data:!1})),this.model.length&&this.renderMessages(),this.model.length>0?this.$el.show():this.$el.hide(),$("body").append(this.el),this.$el.drags({handle:".drag-bar",stop:function(e){this.player.set({_messagesPos:e})}.bind(this)})},renderMessages:function(){this.$(".messages").html(this.template({data:this.model.toJSON(),messageText:this.messageText}))},show:function(){this.$el.velocity("fadeIn")},hide:function(){return this.model.reset(),this.$el.velocity("fadeOut"),!1},decline:function(e){var t=$(e.target).parents(".message"),i=t.data("id");return this.model.remove(i),t.velocity("slideUp"),0===this.model.length&&this.hide(),!1},accept:function(e){var t=$(e.target).parents(".message").data("id"),i=this.model.get(t);if(!i)return!1;var s=i.toJSON();switch(this.model.remove(i),s.type){case"race-invite":location.href="/race/"+s.username;break;case"friend-accept":location.href="/racer/"+s.username;break;case"team-accept":location.href="/team/"+s.tag;break;case"sent-cash":location.href="/garage"}return!1}})}),define("global/views/achievement_alert",["require","templates","global/models/car","registry"],function(e){"use strict";var t=e("templates"),i=e("global/models/car"),s=e("registry");return Backbone.View.extend({className:"achievement-alert-container hide scale",events:{"click .achievement-alert":"clickAlert","mouseover .achievement-alert":"clearTimeout"},initialize:function(){void 0===this.template&&(this.template=t("global","achievement_alert")),this.player=s.get("player"),this.model=s.get("playerAchievements"),this.achievements=s.get("achievements"),this.listenTo(this.model,"add",this.addRow),this.render(),this.inited=!0},addRow:function(e){var t=this.achievements.get(e.id);t&&(this.$el.append(this.template({data:t.toJSON(),carImg:i.imageTag})),this.show())},render:function(){$("body").append(this.el)},show:function(){this.$el.removeClass("animate"),setTimeout(function(){this.$el.addClass("animate").removeClass("hide scale")}.bind(this),50),this.clearTimeout(),this.timeout=setTimeout(this.hide.bind(this),7e3)},hide:function(){this.$el.addClass("hide"),this.clearTimeout()},clearTimeout:function(){clearTimeout(this.timeout)},clickAlert:function(e){var t=$(e.currentTarget),i=t.data("id"),s=this.achievements.get(i);return $(e.target).hasClass("close")?(t.velocity("fadeOut",function(){$(this).remove()}),!1):!!$(e.target).is("a")||(location.href="/achievements#"+s.get("gid"),!1)}})}),define("global/views/session_expiring",["require","global/views/modal","templates","registry"],function(e){"use strict";var t=e("global/views/modal"),i=e("templates"),s=e("registry");return t.extend({expired:!1,startTime:0,initialize:function(e){e=e||{},t.prototype.initialize.apply(this,arguments),this.options=_.extend(this.options,e),this.delegateEvents(_.extend(this.events,{"click .stay-button":"stayLoggedIn","click .logout-button":"logOut"})),void 0===this.template&&(this.template=i("global","session_expiring")),this.player=s.get("player"),this.startTime=Date.getUnixTime(),this.render(),this.updateTime()},render:function(){return this.$(".popup-overlay").html(this.template({expired:this.expired})),this},updateTime:function(){var e=60*this.options.minutesRemaining-(Date.getUnixTime()-this.startTime),t=Math.floor(e/60),i=e-60*t;if(i="00".substring(0,"00".length-String(i).length)+i,this.$(".remaining-time").html(t+":"+i),e<=0)return this.expired=!0,s.get("player").logout(),void this.render();setTimeout(this.updateTime.bind(this),1e3)},stayLoggedIn:function(e){return $(e.target).addClass("pending"),location.reload(),!1},logOut:function(){return s.get("player").logout(),location.href="/",!1}})}),define("global/views/login_alert_modal",["require","global/views/modal","templates","registry"],function(e){"use strict";var t=e("global/views/modal"),i=e("templates"),s=e("registry");return t.extend({initialize:function(e){e=e||{},t.prototype.initialize.apply(this,arguments),this.options=_.extend(this.options,e),void 0===this.template&&(this.template=i("global","login_alert_modal")),this.player=s.get("player"),this.render(),this.$(".js-toggle-button").click(this.toggleButtons.bind(this))},render:function(){return this.$(".popup-overlay").html(this.template(this.options)),this},toggleButtons:function(e){var t=$(e.currentTarget),i=t.parent(),s=t.data("toggle"),a=this.$(".js-toggle-section"),r=this.$("."+s);a.fastHide(),r.fastShow(),i.children().removeClass("is-active"),t.addClass("is-active")}})}),define("shared/classes/helpers",["require"],function(e){"use strict";window.PIXI&&(window.PIXI.dontSayHello=!0);var t=function(e,t){var i,s,a,r=new String,n=t.length;for(i=0;i<e.length;i++)a=e.charAt(i),(s=t.indexOf(a))>=0&&(a=t.charAt((s+n/2)%n)),r+=a;return r};if(window.rot47=function(e){try{return t(e=e||"","!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~")}catch(e){return""}},$.objectArray=function(e,t){return t.map(function(t){return _.object(e,t)})},window.supportsWebGL=function(){return!!function(){try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}()},$.getQueryParam=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))},"object"!=typeof window.performance&&(window.performance={}),"function"!=typeof window.performance.now){var i=Date.now();"object"==typeof window.performance.timing&&window.performance.timing.navigationStart&&(i=window.performance.timing.navigationStart),window.performance.now=function(){return Date.now()-i}}$.fn.fastHide=function(){return this.each(function(e,t){t.style.display="none"}),this},$.fn.fastShow=function(e){return this.each(function(t,i){i.style.display=e?"inline-block":"block"}),this},Math.radians=function(e){return e*Math.PI/180},Number.addCommas=function(e,t){void 0!==t&&(e=Number(e).toFixed(t)||0);var i=e.toString().split(".");return i[0]=i[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),i.join(".")},Number.prototype.addCommas=function(e){return Number.addCommas(this,e)},Number.prototype.pluralize=function(){return 1==this?"":"s"},String.prototype.ucFirst=function(){return this.substr(0,1).toUpperCase()+this.substr(1)},Number.prototype.prettySeconds=function(){var e,t="",i=this;return i=Math.round((parseInt(i,10)+0)/60),(e=Math.floor(i/60))>0&&(t+=e+" hour"+(1==e?"":"s")+", ",i-=60*e),t+=i+" min"+(1==i?"":"s")},Number.prototype.countdownSeconds=function(){var e=Math.floor(this/60/60),t=Math.floor((this-60*e*60)/60),i=this-60*e*60-60*t;return String(e).pad(2,"0","STR_PAD_LEFT")+":"+String(t).pad(2,"0","STR_PAD_LEFT")+":"+String(i).pad(2,"0","STR_PAD_LEFT")},String.prototype.pad=function(e,t,i){var s,a=this,r="",n=function(e,t){for(var i="";i.length<t;)i+=e;return i=i.substr(0,t)};return a+="",t=void 0!==t?t:" ","STR_PAD_LEFT"!==i&&"STR_PAD_RIGHT"!==i&&"STR_PAD_BOTH"!==i&&(i="STR_PAD_RIGHT"),(s=e-a.length)>0&&("STR_PAD_LEFT"===i?a=n(t,s)+a:"STR_PAD_RIGHT"===i?a+=n(t,s):"STR_PAD_BOTH"===i&&(a=(a=(r=n(t,Math.ceil(s/2)))+a+r).substr(0,e))),a},String.prototype.wordwrap=function(e,t,i){var s,a,r,n,o,l=this,c=arguments.length>=1?arguments[0]:75,h=arguments.length>=2?arguments[0]:"\n",d=arguments.length>=3&&arguments[0];if(l+="",c<1)return l;for(s=-1,r=(o=l.split(/\r\n|\n|\r/)).length;++s<r;o[s]+=n)for(n=o[s],o[s]="";n.length>c;o[s]+=n.slice(0,a)+((n=n.slice(a)).length?h:""))a=2==d||(a=n.slice(0,c+1).match(/\S*(\s)?$/))[1]?c:a.input.length-a[0].length||1==d&&c||a.input.length+(a=n.slice(c).match(/^\S*/))[0].length;return o.join("\n")},Number.prototype.ordinal=function(){var e=["th","st","nd","rd"],t=this%100;return e[(t-20)%10]||e[t]||e[0]},Date.getUnixTime=function(){return Math.floor((new Date).getTime()/1e3)}}),define("shared/classes/model",["require"],function(e){"use strict";Backbone.Model.prototype.parse=function(e){return _.isObject(e.data)&&_.isBoolean(e.success)?e.data:e},Backbone.Model.prototype.setBackend=function(e,t){return this.backend&&this.off("change",this.backend.change),e.setModel(this),this.on("change",e.change,e),"backend"==t?this.set(e.getData()):"model"==t&&e.setData(this.toJSON()),this.backend=e,this},Backbone.Model.prototype.inc=function(){if("object"==typeof arguments[0]){var e=null,t={};_.each(arguments[0],function(i,s){i=Number(i),e=this.get(s)||0,t[s]=e+i},this),this.set(t,arguments[1])}else if("string"==typeof arguments[0]&&arguments[1]){e=this.get(arguments[0])||0;return(t={})[arguments[0]]=e+arguments[1],this.set(t,arguments[3])}}}),define("shared/classes/collection",["require"],function(e){"use strict";Backbone.Collection.prototype.parse=function(e){return _.isObject(e.data)&&_.isBoolean(e.success)?e.data:e},Backbone.Collection.prototype.setBackend=function(e,t){return e.setModel(this),this.on("change",e.change,e),this.on("add",e.add,e),this.on("remove",e.remove,e),this.on("reset",e.reset,e),this.on("sort",e.sort,e),"backend"==t?this.reset(e.getData()):"model"==t&&e.setData(this.toJSON()),this}}),"#nows"==location.hash&&(WebSocket=!1),define("app",["require","global/views/navigation","router","registry","analytics","global/collections/cars","friends/collections/friends","global/models/player","global/collections/messages","garage/collections/garage","achievements/collections/achievements","global/collections/top3_players","global/views/login","global/views/register","global/views/level_up","global/views/tooltip","global/views/messages","global/views/achievement_alert","global/views/session_expiring","global/views/login_alert_modal","shared/classes/model_backends/localstorage","shared/classes/helpers","shared/classes/model","shared/classes/collection"],function(e){"use strict";var t=e("global/views/navigation"),i=e("router"),s=e("registry"),a=e("analytics"),r=e("global/collections/cars"),n=e("friends/collections/friends"),o=e("global/models/player"),l=e("global/collections/messages"),c=e("garage/collections/garage"),h=e("achievements/collections/achievements"),d=e("global/collections/top3_players"),u=e("global/views/login"),p=e("global/views/register"),m=e("global/views/level_up"),g=e("global/views/tooltip"),f=e("global/views/messages"),v=e("global/views/achievement_alert"),y=e("global/views/session_expiring"),w=e("global/views/login_alert_modal"),b=e("shared/classes/model_backends/localstorage");return e("shared/classes/helpers"),e("shared/classes/model"),e("shared/classes/collection"),window.Moment=window.moment,{initialize:function(){this.browserCheck()&&(this.plugins(),this.globals(),"production"==NTGLOBALS("ENV")&&this.analytics(),this.authentication()&&(this.realtime(),this.views(),this.achievements(),this.router(),this.alertModal()))},browserCheck:function(){try{window.localStorage.setItem("test","test")}catch(e){return navigator.userAgent.match(/safari/i)?alert("Nitro Type can not be used in Safari while in Private Browsing Mode due to a bug in Safari. Please switch to normal browsing mode to use Nitro Type."):alert("Error: Your browser does not support Local Storage, or your Local Storage is full.  You will not be able to use Nitro Type until this is resolved."),!1}return!0},plugins:function(){$.extend($.timeago.settings.strings,{suffixFromNow:"from now",seconds:"< a min",minute:"~ a minute",minutes:"%d mins",hour:"~ an hour",hours:"~ %d hours",day:"a day",days:"%d days",month:"~ a month",months:"%d months",year:"~ a year",years:"%d years"}),$.fn.highlight=function(e,t){e=e||2,t=t||"fast";for(var i=0;i<e;i++)this.velocity("fadeOut",t).velocity("fadeIn",t)};var e=function(e){e&&"object"==typeof e&&e.data&&e.data.relogin&&(s.get("player").logout(),location.href="/")},t=function(e){return(e=_.toArray(e))[1]&&"object"==typeof e[1]&&e[1].ignoreCSRF?(delete e[1].ignoreCSRF,e):(1==e.length&&e.push({}),_.isArray(e[1])?e[1][e[1].length]={uhash:$.cookie("ntuserrem")}:_.isObject(e[1])&&(e[1].uhash=$.cookie("ntuserrem")),e)};jQuery.oldPost=jQuery.post,$.post=function(){return jQuery.oldPost.apply(jQuery,t(arguments)).done(e)},jQuery.oldGet=jQuery.get,$.get=function(){return jQuery.oldGet.apply(jQuery,t(arguments)).done(e)},$.getQueryParams=function(){for(var e,t=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(t," "))},a=window.location.search.substring(1),r={};;){if(!(e=i.exec(a)))break;r[s(e[1])]=s(e[2])}return r}},authentication:function(){var e=NTGLOBALS("LOGGED_IN"),t=s.get("player"),i=($.cookie("ntuserrem")||"").split("<")[1],a=$.cookie("PHPNTSESSION")&&$.cookie($.cookie("PHPNTSESSION"));if(location.pathname.match(/^\/relogin/))return!0;if(e){if(!t.id||!i||i!=t.id||paid()&&"gold"!=t.get("membership")||!a)return t.logout(),this.playerGlobals(),location.reload(),!1;t.setCachingCookie(),setTimeout(function(){new y({minutesRemaining:5}).show()},69e5)}else!a&&t.isGuest()||(t.logout(),this.playerGlobals());return!e&&t.get("experience")>0&&$.post("/api/settings/sessionbug",{player:t.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN"),paid:paid()}),!0},realtime:function(){if("function"==typeof Primus){var e,t,i=location.pathname.match(/^\/race\//)||"/race"==location.pathname,a=location.pathname.match(/^\/race\//),r=NTGLOBALS("REALTIME_SERVERS"),n=s.get("player");if(NTGLOBALS("LOGGED_IN")||a||i&&n.get("avgSpeed")>0){t=i&&a?r[location.pathname.substr(-1).charCodeAt(0)%r.length]:r[parseInt(String(n.id).substr(-3),10)%r.length],location.hostname.match(/^192\.168/)&&(t=location.hostname+":28001");var o={pathname:"/realtime"};i&&(o.reconnect={retries:2}),"#polling"==location.hash&&(o.websockets=!1),n.get("websocketSupport")&&(o.transports=["websocket"]),o.manual=!0,e=Primus.connect(location.protocol+"//"+t,o),setTimeout(function(){e.open()},0),$(window).unload(function(){e.pageUnloaded=!0,e.end()}),e.on("open",function(){setTimeout(function(){e.socket.transport.ws&&e.socket.transport.ws.readyState==WebSocket.OPEN?n.set({websocketSupport:!0}):n.set({websocketSupport:!1})},1e3)}),e.on("error",function(e){console.error("Primus Error"),console.dir(e)});var l,c=function(){clearTimeout(l),l=setTimeout(function(){e.end()},9e5)};c(),e.on("data",function(t){if("error"!=t.stream)c();else{switch(t.type){case"invalid session":s.get("player").logout(),location.href="/";break;case"no cookie":s.get("player").logout(),alert("Your browser must have cookies enabled to play Nitro Type")}e.end()}}),s.set("realtime",e)}if(NTGLOBALS("LOGGED_IN")){s.get("player").get("offline")||e.checkin();var h=s.get("playerMessages");e.getNotifications().on("data",h.receiveMessage.bind(h))}}},globals:function(){s.set("isMobile",navigator.userAgent.match(/iPad|iPhone|Android/));var e=_.extend({},Backbone.Events);s.set("pubSub",e),this.playerGlobals();var t=[];_.flatten(_.map(_.values(NTGLOBALS("SCOREBOARD_TOP3")),_.values)).forEach(function(e){var i=JSON.parse(e.userID);_.isArray(i)?i.forEach(function(e){t.push({userID:e})}):t.push({userID:i})});var i=new d(t);s.set("top3Players",i),s.set("cars",new r(NTGLOBALS("CARS"))),s.set("achievements",new h(JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").LIST))))},playerGlobals:function(){var e=new o,t=new r,i=new n,a=new h,d=new c,u=new l;e.setBackend(new b("player"),"backend"),NTGLOBALS("LOGGED_IN")?(t.setBackend(new b("playerCars"),"backend"),i.setBackend(new b("playerFriends"),"backend"),a.setBackend(new b("playerAchievements"),"backend"),d.setBackend(new b("playerGarage"),"backend"),u.setBackend(new b("playerMessages"),"backend")):(e.setupGuest(),t.add({})),s.set("player",e),s.set("playerCars",t),s.set("playerFriends",i),s.set("playerAchievements",a),s.set("playerGarage",d),s.set("playerMessages",u),e.on("change",_.debounce(h.check.bind(h),300)),setTimeout(h.check.bind(h),1e3)},achievements:function(){var e=s.get("player"),t=function(){var t=0;t+=e.get("gender")?1:0,e.get("gender")&&e.set({hasGender:Math.round(Date.now()/1e3)}),t+=e.get("country")?1:0,e.get("country")&&e.set({hasCountry:Math.round(Date.now()/1e3)}),e.set({profileFields:t})};t(),e.on("change:gender change:country",t)},views:function(){this.loginView=new u,this.registerView=new p,$(document).on("click",".login-link",function(e){return this.loginView.show($(e.target)),this.registerView.hide(),!1}.bind(this)),$(document).on("click",".register-link",function(e){return this.registerView.show($(e.target)),this.loginView.hide(),!1}.bind(this)),NTGLOBALS("LOGGED_IN")&&new m({model:s.get("player")}),this.tooltip=new g,$(document).on("mouseover",".tooltip,.tooltip-nostyle",this.tooltip.show.bind(this.tooltip)),$(document).on("mouseout",".tooltip,.tooltip-nostyle",this.tooltip.hide.bind(this.tooltip)),$(document).on("click",".tooltip,.tooltip-nostyle",function(e){return!1}),new f,new v,new t({model:s.get("player")})},analytics:function(){var e=s.get("player");if(a.customDimension(1,NTGLOBALS("LOGGED_IN")?"yes":"no"),NTGLOBALS("LOGGED_IN")){a.customDimension(2,e.get("accountType")),a.customDimension(3,e.get("membership")),a.customDimension(4,e.get("gender")?e.get("gender"):"unknown");var t=10*Math.floor(e.get("level")/10);t<10?a.customDimension(5,"1-9"):a.customDimension(5,t+"-"+(t+9)),e.get("totalComments")?e.get("totalComments")<10?a.customDimension(6,"1-9"):(i=10*Math.floor(e.get("totalComments")/10),a.customDimension(6,i+"-"+(i+9))):a.customDimension(6,0),a.customDimension(7,Math.floor((Date.getUnixTime()-e.get("createdStamp"))/60/60/24)),a.customDimension(10,e.get("teamID")?"yes":"no"),a.customDimension(12,NTGLOBALS("SPECIAL_EVENT")&&-1!=NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(e.get("carID"))?"yes":"no");var i=0;s.get("playerFriends").length||a.customDimension(13,0),s.get("playerFriends").length<50?(i=10*Math.floor(s.get("playerFriends").length/10),a.customDimension(13,(i||1)+"-"+(i+9))):(i=50*Math.floor(s.get("playerFriends").length/50),a.customDimension(13,i+"-"+(i+49))),a.customDimension(14,e.get("totalPurchases"))}var r=10*Math.floor(e.get("avgSpeed")/10);r>0&&a.customDimension(8,r+"-"+(r+9)),location.pathname.match(/\/race(\/*)$/)?e.get("avgSpeed")?a.customDimension(9,"public"):a.customDimension(9,"qualifying"):location.pathname.match(/\/race\/.+/)&&a.customDimension(9,"friend"),a.customDimension(11,NTGLOBALS("SPECIAL_EVENT")?"yes":"no"),"/race"==location.pathname&&0===e.get("avgSpeed")&&ga("set","page","/qualifying"),ga("send","pageview")},router:function(){i.initialize();var e=$("#app-loader"),t=$("#app");e.fastHide(),t.fastShow()},alertModal:function(){var e=NTGLOBALS("LOGGED_IN"),t=NTGLOBALS("GLOBAL_ALERT"),i=s.get("player");e&&t&&moment(1e3*i.get("lastLogin")).format("YYYY-MM-DD")<t.startStamp&&!i.get("_sawGlobalAlert")&&(i.set({_sawGlobalAlert:!0}),new w(NTGLOBALS("GLOBAL_ALERT")).show())}}}),require.config({urlArgs:"bust="+(new Date).getTime(),baseUrl:"/src/site/js",paths:{shared:"../../shared",analytics:"../../shared/classes/analytics",registry:"../../shared/classes/registry",templates:"../../shared/classes/templates"},shim:{}});var oldRequire=require;(require=function(e,t,i,s,a){oldRequire(e,t,i,!0,a)})(["app"],function(e){$(function(){e.initialize()})}),define("main",function(){}),require(["app"]);