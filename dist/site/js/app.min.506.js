var requirejs,require,define;!function(a){function b(a,b){return s.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=b&&b.split("/"),p=q.map,r=p&&p["*"]||{};if(a){for(a=a.split("/"),g=a.length-1,q.nodeIdCompat&&u.test(a[g])&&(a[g]=a[g].replace(u,"")),"."===a[0].charAt(0)&&o&&(n=o.slice(0,o.length-1),a=n.concat(a)),k=0;k<a.length;k++)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(0===k||1===k&&".."===a[2]||".."===a[k-1])continue;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}if((o||r)&&p){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),o)for(l=o.length;l>0;l-=1)if(e=p[o.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&r&&r[d]&&(i=r[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function d(b,c){return function(){var d=t.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),l.apply(a,d.concat([b,c]))}}function e(a){return function(b){return c(b,a)}}function f(a){return function(b){o[a]=b}}function g(c){if(b(p,c)){var d=p[c];delete p[c],r[c]=!0,k.apply(a,d)}if(!b(o,c)&&!b(r,c))throw new Error("No "+c);return o[c]}function h(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function i(a){return a?h(a):[]}function j(a){return function(){return q&&q.config&&q.config[a]||{}}}var k,l,m,n,o={},p={},q={},r={},s=Object.prototype.hasOwnProperty,t=[].slice,u=/\.js$/;m=function(a,b){var d,f=h(a),i=f[0],j=b[1];return a=f[1],i&&(i=c(i,j),d=g(i)),i?a=d&&d.normalize?d.normalize(a,e(j)):c(a,j):(a=c(a,j),f=h(a),i=f[0],a=f[1],i&&(d=g(i))),{f:i?i+"!"+a:a,n:a,pr:i,p:d}},n={require:function(a){return d(a)},exports:function(a){var b=o[a];return"undefined"!=typeof b?b:o[a]={}},module:function(a){return{id:a,uri:"",exports:o[a],config:j(a)}}},k=function(c,e,h,j){var k,l,q,s,t,u,v,w=[],x=typeof h;if(j=j||c,u=i(j),"undefined"===x||"function"===x){for(e=!e.length&&h.length?["require","exports","module"]:e,t=0;t<e.length;t+=1)if(s=m(e[t],u),l=s.f,"require"===l)w[t]=n.require(c);else if("exports"===l)w[t]=n.exports(c),v=!0;else if("module"===l)k=w[t]=n.module(c);else if(b(o,l)||b(p,l)||b(r,l))w[t]=g(l);else{if(!s.p)throw new Error(c+" missing "+l);s.p.load(s.n,d(j,!0),f(l),{}),w[t]=o[l]}q=h?h.apply(o[c],w):void 0,c&&(k&&k.exports!==a&&k.exports!==o[c]?o[c]=k.exports:q===a&&v||(o[c]=q))}else c&&(o[c]=h)},requirejs=require=l=function(b,c,d,e,f){if("string"==typeof b)return n[b]?n[b](c):g(m(b,i(c)).f);if(!b.splice){if(q=b,q.deps&&l(q.deps,q.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?k(a,b,c,d):setTimeout(function(){k(a,b,c,d)},4),l},l.config=function(a){return l(a)},requirejs._defined=o,define=function(a,c,d){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");c.splice||(d=c,c=[]),b(o,a)||b(p,a)||(p[a]=[a,c,d])},define.amd={jQuery:!0}}(),define("../../../bower_components/almond/almond",function(){}),define("registry",["require"],function(a){"use strict";var b=[];return{get:function(a){return b[a]||void 0},set:function(a,c){b[a]=c}}}),define("global/views/navigation",["require","registry"],function(a){"use strict";var b=a("registry"),c=Backbone.View.extend({el:"#nav",events:{"click .log-out":"logOut"},initialize:function(){var a=b.get("pubSub");this.listenTo(a,"app:navigate",this.setActiveTab),this.listenTo(this.model,"change:requests",this.showFriendRequests),this.listenTo(this.model,"change:teamApplications",this.showTeamApplications),this.model.get("tag")&&this.$("#navTeam a").attr("href","/team/"+this.model.get("tag")),this.showFriendRequests(),this.showNewNews(),this.showTeamApplications()},setActiveTab:function(a){var b="nav"+a.charAt(0).toUpperCase()+a.slice(1);"navNews"==b&&this.model.set({_visitedBlog:!0})},logOut:function(a){a.preventDefault(),b.get("player").logout(),document.location.href="/"},showFriendRequests:function(){this.model.get("requests")>0?this.$("#navFriends .navigation-jewel").html(this.model.get("requests")).show():this.$("#navFriends .navigation-jewel").hide()},showNewNews:function(){NTGLOBALS("LOGGED_IN")&&this.model.get("lastLogin")<NTGLOBALS("RECENT_NEWS")&&!this.model.get("_visitedBlog")?this.$("#navNews .navigation-jewel").show():this.$("#navNews .navigation-jewel").hide()},showTeamApplications:function(){this.model.get("teamApplications")>0?this.$("#navTeam .navigation-jewel").html(this.model.get("teamApplications")).show():this.$("#navTeam .navigation-jewel").hide()}});return c}),define("templates",["require"],function(a){"use strict";var b="NTJST";return function(a,c){return window[b][a+"_"+c]?window[b][a+"_"+c]:(console.error("Unable to find template: "+a+"_"+c),function(){return"Unable to find template: "+a+"_"+c})}}),define("shared/classes/typing",["require"],function(a){"use strict";return{speed:function(a,b){return a=a||0,b=b||0,0==b?0:Math.round(a/5/(b/60))},accuracy:function(a,b,c){if(a=a||0,b=b||0,c=parseInt(c,10)||0,0==a)return 0;var d=parseFloat((100-b/a*100).toFixed(c));return d>=100?100:d}}}),define("global/models/car",["require"],function(a){"use strict";var b=Backbone.Model.extend({idAttribute:"carID",defaults:{carID:9,name:"Rental Car",price:0,unlockLevel:999,status:"owned"},imageSrc:function(a,c){return b.imageSrc(a,this.id,c)}},{imageSrc:function(a,b,c){return c=10*Math.floor(c/10),c&&c>0&&c<356?"/cars/painted/"+b+"_"+a+"_1_"+c+".png":"/cars/"+b+"_"+a+"_1.png"},imageTag:function(a,c,d){var e,f="";return e=b.imageSrc(a,c,d),'<img src="'+e+'" '+f+" />"},imageBackgroundCSS:function(a,c,d){var e,f="";return e="background-image: url('"+b.imageSrc(a,c,d)+"'); ",e+f}});return b}),define("global/views/scoreboard_table",["require","templates","shared/classes/typing","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("shared/classes/typing"),d=a("global/models/car"),e=a("registry"),f=[{field:"played",title:"Most Active",header:"Races"},{field:"speed",title:"Fastest Racer (500+ races)",header:"Avg Speed"},{field:"longestSession",title:"Longest Session",header:"Session Races"},{field:"money",title:"Most Money",header:"Dollars Saved"},{field:"moneySpent",title:"Biggest Spender",header:"Dollars Spent"},{field:"nitrosUsed",title:"Nitros Used",header:"Nitros"},{field:"oldest",title:"Oldest Active Player",header:"Member Since"}],g=Backbone.View.extend({hoverOffset:354,hover:null,tagName:"table",className:"scoreboard-table",events:{"click .row":"handleRowClick","mouseenter .row":"showPlayerPopup","mouseleave .row":"hidePlayerPopup"},initialize:function(a){void 0===this.template&&(this.template=b("global","scoreboard_table"),this.hofTemplate=b("global","scoreboard_hof")),this.headers=a.headers||!1,this.hover=a.hover,this.noTop3=a.noTop3,this.listenTo(this.model,"reset",this.render)},render:function(){var a="hof"==this.model.board?this.hofTemplate:this.template;return this.$el.html(a({hofData:f,board:this.model.board,time:this.model.time,Typing:c,noTop3:this.noTop3,grouping:this.model.grouping,countries:NTGLOBALS("COUNTRIES"),rows:this.model.toJSON(),headers:this.headers,player:e.get("player").toJSON(),formatHof:this.formatHof,carSrc:d.imageSrc})),this},handleRowClick:function(a){var b=$(a.currentTarget).data("id");return!!b&&void("teams"==this.model.grouping?location.href="/team/"+this.model.findWhere({teamID:b}).get("tag"):"racer"==this.model.grouping&&(location.href="/racer/"+this.model.findWhere({userID:b}).get("username")))},showPlayerPopup:function(a){if(a.preventDefault(),"teams"!=this.model.grouping){var b,c=$(a.currentTarget).data("id");c&&(b=this.model.findWhere({userID:c}),this.hover&&this.hover.show(a.currentTarget,b,this.hoverOffset))}},hidePlayerPopup:function(a){return this.hover&&this.hover.hide(a),!1},formatHof:function(a){switch(a.valueType){case"number":return a.value.addCommas();case"dollars":return"$"+a.value.addCommas();case"percentage":return a.value+"%";case"date":return moment(1e3*a.value).format("MMM D, YYYY");case"speed":return a.value+" wpm";default:return a.value}}});return g}),define("scoreboard/collections/data",["require","registry"],function(a){"use strict";var b=a("registry");return Backbone.Collection.extend({board:"points",grouping:"racer",time:"season",seasonID:0,rankingsModel:null,cache:{},rankingsCache:{},initialize:function(){this.player=b.get("player"),this.rankingsModel=new Backbone.Model,this.time=this.player.get("_scoreboardTime")||this.time,this.board=this.player.get("_scoreboardBoard")||this.board,this.grouping=this.player.get("_scoreboardGrouping")||this.grouping,this.updateRankings({})},updateRankings:function(a){if(a.scores){var b;b="racer"==this.grouping?_.find(a.scores,function(a){return a.userID==this.player.id},this):_.find(a.scores,function(a){return a.teamID==this.player.get("teamID")},this),this.rankingsCache[a.board+a.time+a.grouping+a.seasonID]={board:a.board,time:a.time,grouping:a.grouping,seasonID:a.seasonID,yourRank:b?"points"==this.board?b.rank:a.scores.indexOf(b)+1:0,yourScore:b?b[this.board]:0,totalRanks:a.totalRanks},this.rankingsModel.set(this.rankingsCache[this.board+this.time+this.grouping+this.seasonID])}},parse:function(a){return a.success?(this.updateRankings(a.data),this.cache[this.board+this.time+this.grouping+this.seasonID]=a.data.scores,a.data.scores):void this.rankingsModel.set({error:a.data.message})},setOptions:function(a,b,c,d){return this.board=a||this.board,this.time=b||this.time,this.grouping=c||this.grouping,this.seasonID=d||0,this.player.set({_scoreboardBoard:a,_scoreboardTime:b,_scoreboardGrouping:c}),this},fetch:function(){if(this.cache[this.board+this.time+this.grouping+this.seasonID])this.rankingsModel.set(this.rankingsCache[this.board+this.time+this.grouping+this.seasonID]),this.reset(this.cache[this.board+this.time+this.grouping+this.seasonID]);else{this.trigger("request");var a=this.board,b=this.time,c=this.grouping,d=this.seasonID,e={board:this.board,time:this.time,grouping:this.grouping,seasonID:this.seasonID};$.ajax({url:"/api/scoreboard",data:e,success:function(e){e.data.board=a,e.data.time=b,e.data.grouping=c,e.data.seasonID=d,this.reset(this.parse(e))}.bind(this),error:function(){this.reset([])}.bind(this)})}}})}),define("shared/classes/model_backends/localstorage",["require"],function(a){"use strict";var b=[],c=function(a){this.table=a};return c.prototype.setModel=function(a){b.push(a),this.model=a},c.prototype.getData=function(){return"undefined"==typeof window.localStorage[rot47(this.table)]?null:JSON.parse(rot47(window.localStorage[rot47(this.table)]))},c.prototype.setData=function(a){window.localStorage[rot47(this.table)]=rot47(JSON.stringify(a))},c.prototype.change=function(){this.setData(this.model.toJSON())},c.prototype.add=c.prototype.change,c.prototype.remove=c.prototype.change,c.prototype.reset=c.prototype.change,c.prototype.sort=c.prototype.change,c.clear=function(){b.forEach(function(a){a.off()}),b=[],localStorage.clear()},c}),define("global/models/player",["require","shared/classes/model_backends/localstorage","shared/classes/typing","registry"],function(a){"use strict";var b=a("shared/classes/model_backends/localstorage"),c=(a("shared/classes/typing"),a("registry"));return Backbone.Model.extend({idAttribute:"userID",defaults:{username:"",gender:"",displayName:"Guest Racer",title:"Accountless One",money:0,blogComments:0,totalComments:0,moneySpent:0,level:0,playTime:0,highestSpeed:0,avgSpeed:0,placed1:0,placed2:0,placed3:0,racesPlayed:0,experience:0,carID:9,carHueAngle:0,nitros:0,nitrosUsed:0,nitrosPurchased:0,achievementPoints:0,country:"",sessionPages:0,visits:"",sessionRaces:0,shares:0,speed:0,practices:0,referrals:0,profileFields:0,consecWins:0,consecDaysRaced:0,seasonField1:0,seasonField2:0,seasonField3:0,membership:"basic",lastLogin:0,wampusWins:0,requests:0,totalCars:0,soldCars:0,friendLimit:200,teamID:0,tag:"",tagColor:"",raceSounds:"none",lookingForTeam:0,paintJobs:0,profileViews:0,allowFriendRequests:1,teamApplications:0,longestSession:0,mysteryBoxes:0,memberDays:0,rewardCountdown:0,teamRole:"member"},initialize:function(){this.on("change:avgSpeed",function(){$.cookie(rot47("avgspeed"),this.get("avgSpeed"),{path:"/",domain:this.getCookieDomain()})}.bind(this))},setupGuest:function(){var a=$.cookie("ntuserguest");a||(a="g"+Math.random(),$.cookie("ntuserguest",a,{path:"/",domain:this.getCookieDomain()})),this.defaults.userID=a,this.defaults.avgSpeed=this.get("avgSpeed"),this.set(this.defaults)},isGuest:function(){return String(this.id).match(/^g/)},loginWithData:function(a){a.cars.length>0&&_.isArray(a.cars[0])&&(a.cars=a.cars.map(function(a){return{carID:a[0],status:a[1],hueAngle:a[2]}})),a.achievements.length>0&&_.isArray(a.achievements[0])&&(a.achievements=a.achievements.map(function(a){return{achievementID:a[0],completedStamp:a[1]}})),a.friends.length>0&&_.isNumber(a.friends[0])&&(a.friends=a.friends.map(function(a){return{userID:a}}));var d=c.get("playerCars");d.reset(a.cars,{silent:!0}),d.setBackend(new b("playerCars"),"model"),delete a.cars;var e=c.get("playerGarage");e.reset(_.map(a.garage,function(a){return{carID:a}}),{silent:!0}),e.setBackend(new b("playerGarage"),"model"),delete a.garage;var f=c.get("playerFriends");f.reset(a.friends,{silent:!0}),f.setBackend(new b("playerFriends"),"model"),delete a.friends;var g=c.get("playerAchievements");g.reset(a.achievements,{silent:!0}),g.setBackend(new b("playerAchievements"),"model"),delete a.achievements,a.rewardCountdown=Date.getUnixTime()+a.rewardCountdown,this.clear({silent:!0}),this.set(a,{silent:!0}),this.setBackend(new b("player"),"model"),this.setCachingCookie(a.membership)},setCachingCookie:function(a){var b=$.cookie("ntuserrem");if("gold"==a){var c=b.split("<");c[2]=2,b=c.join("<")}var d=1/24*2;$.cookie("ntuserrem",b,{expires:d,path:"/",domain:this.getCookieDomain()}),$.cookie("PHPNTSESSION",$.cookie("PHPNTSESSION"),{expires:d,path:"/",domain:this.getCookieDomain()}),$.cookie($.cookie("PHPNTSESSION"),$.cookie($.cookie("PHPNTSESSION")),{expires:d,path:"/",domain:this.getCookieDomain()}),$.removeCookie("ntuserguest",{path:"/",domain:this.getCookieDomain()})},logout:function(a){a=a||{};var d=c.get("realtime");d&&d.end();var e=this.getCookieDomain();$.removeCookie("ntuserguest",{path:"/",domain:e}),$.removeCookie(rot47("avgspeed"),{path:"/",domain:e}),this.removeSessionCookies(),b.clear()},removeSessionCookies:function(){var a=this.getCookieDomain();$.removeCookie("ntuserrem",{path:"/",domain:a}),$.removeCookie($.cookie("PHPNTSESSION"),{path:"/",domain:a}),$.removeCookie("PHPNTSESSION",{path:"/",domain:a})},applyToTeam:function(a){return $.post("/api/teams/"+a+"/apply").done(function(){c.get("realtime").applyToTeam(a)}.bind(this))},inviteToTeam:function(a){return this.get("teamID")&&"officer"==this.get("teamRole")?$.post("/api/players/"+a+"/team-invite").done(function(b){b.success&&c.get("realtime").inviteToTeam(a,this.get("teamID"))}.bind(this)):$.Deferred().resolve()},addCar:function(a){var b={},d=c.get("playerCars"),e=d.get(a);b.carID=a,b.carHueAngle=0,this.set(b),e?e.set({status:"owned",hueAngle:0}):d.add({carID:a})},useCar:function(a,b){if(this.set({carID:a,carHueAngle:b}),!this.get("profileView"))return $.post("/api/cars/"+a+"/use")},requestFriend:function(a){return $.post("/api/friends/"+a+"/request").done(function(){c.get("realtime").requestFriend(a)})},report:function(a){return $.post("/api/players/"+a+"/report")},setSoundPrefs:function(a){if(this.set({raceSounds:a}),NTGLOBALS("LOGGED_IN"))return $.post("/api/settings/sounds/",{value:a})},getReward:function(){return $.get("/api/rewards/daily")},getPendingCashGifts:function(){return $.get("/api/items/cash-gifts")},getCookieDomain:function(){var a,b=location.hostname.split(".");return a=location.hostname.match(/nitrotype/)?"."+b[b.length-2]+"."+b[b.length-1]:location.hostname}})}),define("global/views/player_hover",["require","global/models/player","global/models/car","templates","registry"],function(a){"use strict";var b=a("global/models/player"),c=a("global/models/car"),d=a("templates"),e=a("registry");return Backbone.View.extend({className:"racer-hover",events:{mouseleave:"hide"},_initialize:function(){void 0===this.template&&(this.template=d("global","player_hover")),this.player=e.get("player"),this.model=new b,this.top3=e.get("top3Players"),this.listenTo(this.model,"change",this.render),$("body").append(this.el),this.inited=!0},render:function(){var a=this.model;this.model.id==this.player.id&&(a=this.player),this.$el.html(this.template({data:a.toJSON(),carImage:c.imageTag,formatDate:this.formatDate,cars:e.get("cars"),top3:this.top3,countries:NTGLOBALS("COUNTRIES")}))},show:function(a,b,c,d){this.inited||this._initialize(),a=$(a),this.model.clear({silent:!0}),this.model.set(b.toJSON());var e=237;d&&(this.model.set({robot:!0}),e=135),this.$el.css({top:a.offset().top+a.height()/2-e,left:a.offset().left+c}).show()},hide:function(a){$(a.relatedTarget).closest(this.el).length||this.$el.hide()},formatDate:function(a){if(!a)return"N/A";var b=moment(new Date(1e3*a));return b.format("MMM D, YYYY")}})}),define("index/views/mini_scoreboard",["require","registry","global/views/scoreboard_table","scoreboard/collections/data","global/views/player_hover","templates"],function(a){"use strict";var b=a("registry"),c=a("global/views/scoreboard_table"),d=a("scoreboard/collections/data"),e=a("global/views/player_hover"),f=a("templates");return Backbone.View.extend({boards:{},text:{season:"Top Racers This Season",weekly:"Top Racers in the Last 7 Days",monthly:"Top Racers in the Last 30 Days",daily:"Top Racers in the Last 24 Hours"},times:["weekly"],timeIndex:-1,initialize:function(){void 0===this.template&&(this.template=f("index","mini_scoreboard")),this.playerHover=new e,this.player=b.get("player");var a;_.each(this.times,function(b){NTGLOBALS("SCOREBOARD_TOP3")[b]&&(a=new d(NTGLOBALS("SCOREBOARD_TOP3")[b]),a.time=b,a.board="points",a.grouping="racer",this.boards[b]=new c({model:a,hover:this.playerHover,headers:!0,noTop3:!0}))}.bind(this)),this.render()},render:function(){this.$el.html(this.template({times:this.times,text:this.text})),_.each(this.times,function(a){NTGLOBALS("SCOREBOARD_TOP3")[a]&&this.$(".time-"+a+" .scoreboard-table").append(this.boards[a].render().el)}.bind(this))},changeBoard:function(){this.$(".boards").velocity({bottom:-332},1e3,"easeIn",function(){}),setTimeout(this.changeBoard.bind(this),6e3)}})}),define("index/index",["require","index/views/mini_scoreboard"],function(a){"use strict";var b=a("index/views/mini_scoreboard");return Backbone.View.extend({el:"#app",initialize:function(){this.miniScoreboard=new b,this.render()},render:function(){this.$(".scoreboard-scroll-container").html(this.miniScoreboard.el)}})}),define("relogin/index",["require","registry"],function(a){"use strict";var b=a("registry");return Backbone.View.extend({el:"#app",initialize:function(){var a,c=b.get("player");if(a=location.hash?JSON.parse(decodeURIComponent(location.hash.replace("#",""))):$.getQueryParams(),window.detectAdb&&(a.adb=window.detectAdb()),a.tz=jstz.determine().name(),a.type)$.get("/api/login/"+a.type,a).done(function(a){a.success?(c.loginWithData(a.data),a.data.new?window.location.href="/race":window.location.href="/garage"):(this.showMessage("Unable to log in","There was an error: "+a.data?a.data.message:"Unable to log in"),console.log(a))}.bind(this));else{if(!a.autologin)return void(location.href="/");$.post("/api/auth/autologin",{id:a.id}).done(function(a){a.success?(c.loginWithData(a.data),location.href="/garage"):alert("Failed to log in !")})}},loginMessage:function(){this.showMessage("Your session has expired",'Please <a href="#" class="login-link" style="text-decoration: underline">log back in</a>.')},showMessage:function(a,b){this.$(".section-header").velocity("fadeOut",function(){$(this).html(a).velocity("fadeIn")}),this.$(".content-box p").velocity("fadeOut",function(){$(this).html(b).velocity("fadeIn")})}})}),define("join/index",["require","templates","registry"],function(a){"use strict";var b=a("templates"),c=(a("registry"),Backbone.View.extend({el:".lookup",initialize:function(a){return void 0===this.template&&(this.template=b("join","index")),NTGLOBALS("LOGGED_IN")?void this.showMessage("You are already logged in.  This link is for creating new accounts."):void $.post("/api/referrals/"+a.username).done(function(a){a.success?this.render(a.data.displayName):this.showMessage("Invalid referral link.  Unable to find a player with that username.")}.bind(this))},render:function(a){this.$el.velocity("fadeOut",function(){this.$el.html(this.template({displayName:a})).velocity("fadeIn")}.bind(this))},showMessage:function(a){this.$el.html("<p>"+a+"</p>")}}));return c}),define("global/collections/invites",["require","global/models/player"],function(a){"use strict";var b=a("global/models/player");return Backbone.Collection.extend({model:b,comparator:function(a,b){return a.get("reward")&&!b.get("reward")?-1:b.get("reward")&&!a.get("reward")?1:a.get("createdStamp")>b.get("createdStamp")?-1:1},fetch:function(){this.trigger("request");var a=this;this.request=$.get("/api/referrals").done(function(b){a.request=null,b.success?a.reset(b.data):a.reset()})}})}),define("global/views/modal",["require"],function(a){"use strict";return Backbone.View.extend({options:{},className:"popup-base",events:{"click .close-button":"hide"},initialize:function(a){a=a||{},this.options=a,$("body div.wrap").append(this.el),this.$el.html('<div class="popup-overlay"></div>')},show:function(a){return this.showOptions=a||{},this.$el.velocity("fadeIn"),setTimeout(function(){this.$("input:eq(0)").focus()}.bind(this),0),!1},hide:function(){return this.$el.velocity("fadeOut",function(){this.showOptions&&this.showOptions.destroy&&this.remove()}.bind(this)),this.trigger("close"),!1},showError:function(a){this.$(".message").html(a)},isPending:function(){return this.pendingButton&&this.pendingButton.hasClass("pending")},startPendingMode:function(a){this.pendingButton=$(a),this.pendingButton.addClass("pending").prop("disabled",!0)},endPendingMode:function(){this.pendingButton&&this.pendingButton.removeClass("pending").prop("disabled",!1)}})}),define("global/views/invites",["require","templates","global/collections/invites","global/views/modal","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("global/collections/invites"),d=a("global/views/modal"),e=a("global/models/car"),f=a("registry");return d.extend({_initialize:function(){void 0===this.template&&(this.template=b("global","invites")),this.player=f.get("player"),this.model=new c,this.listenTo(this.model,"reset",this.render),this.inited=!0},render:function(){return this.$el.append(this.template({invites:this.model.toJSON(),username:this.player.get("username"),carPath:e.imageSrc})),this},show:function(){return this.inited||this._initialize(),0===this.model.length&&this.model.fetch(),d.prototype.show.apply(this,arguments)}})}),define("shared/classes/form_model",["require"],function(a){"use strict";var b=Backbone.Model.extend({url:"",initialize:function(){$.validator.addMethod("alphanum",function(a){return/^[a-zA-Z0-9]+$/.test(a)},"Can only contain letters and numbers")},validationRules:{},validationMessages:{},save:function(){var a="function"==typeof this.url?this.url():this.url;if(!a)throw new Error("You must specify a url for your FormModels");var b=$.post(a,this.toJSON());return b}});return b}),define("garage/models/survey_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/settings/survey",defaults:{field:"",value:""},validationRules:{value:{required:!0}},validationMessages:{}})}),define("shared/classes/form_validation",["require"],function(a){"use strict";var b=function(a,b,c,d,e,f){this.form=a,this.button=b,this.model=c,e&&(d=d.bind(e),f&&(f=f.bind(e))),this.successCallback=d||$.noop,this.errorCallback=f,this.setup()};return b.prototype.setup=function(){this.form.validate({submitHandler:_.bind(this.submitHandler,this),rules:this.model.validationRules||{},messages:this.model.validationMessages||{}});var a=this;this.button.click(function(b){b.preventDefault(),a.form.submit()})},b.prototype.submitHandler=function(){var a=this;if(!this.submitted){this.disableForm();var b={};_.each(this.form.serializeArray(),function(a){b[a.name]=a.value}),this.model.set(b),setTimeout(function(){a.model.save().done(function(b){if(b.success)a.successCallback(b.data,a.model,a.form);else{if(b.data){try{a.form.validate().showErrors(b.data)}catch(c){a.errorCallback?a.errorCallback(b.data,a.model,a.form):b.data&&b.data.message?alert("An error occurred!\n\nMessage: "+b.data.message+"\n\nIf this continues, please try logging out and back in, and if that does not fix it please contact support!"):window.onerror("validation.showErrors",location.href,0,0,{stack:JSON.stringify(b)})}var c=Object.keys(b.data)[0];a.form.find("[name="+c+"]").focus()}else alert("There was an error communicating with the server");a.enableForm()}})},300)}},b.prototype.disableForm=function(){this.submitted=!0,this.button.addClass("pending")},b.prototype.enableForm=function(){this.button.removeClass("pending"),this.submitted=!1},b}),define("garage/views/under_ad",["require","templates","global/views/invites","garage/models/survey_form","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("global/views/invites"),d=a("garage/models/survey_form"),e=a("shared/classes/form_validation");a("registry");return Backbone.View.extend({events:{"click .invite-link":"handleInviteClick"},initialize:function(a){void 0===this.template&&(this.template=b("garage","under_ad"))},render:function(){var a=!1;return this.model.get("profileView")||!NTGLOBALS("LOGGED_IN")||this.model.get("gender")&&this.model.get("country")||1!=Math.floor(3*Math.random())||(a=this.model.get("country")?"gender":"country"),this.$el.html(this.template({player:this.model.toJSON(),countries:NTGLOBALS("COUNTRIES"),showSurvey:a})),a&&new e(this.$("form[name=survey]"),this.$("form[name=survey] .button"),new d,this.surveyCallback,this),this},handleInviteClick:function(){return this.invites||(this.invites=new c),this.invites.show(),!1},surveyCallback:function(a,b){var c={};c[b.get("field")]=b.get("value"),this.model.set(c),this.$("form[name=survey]").velocity("fadeOut",function(){$(this).replaceWith("<p>Your profile has been updated!</p>").show()})}})}),define("analytics",["require"],function(a){"use strict";return{trackEvent:function(a,b,c,d){ga("send","event",a,b,c,d)},trackPage:function(a){ga("send","pageview",a)},customDimension:function(a,b){ga("set","dimension"+a,b)},customMetric:function(a,b){ga("set","metric"+a,b)},trackSale:function(a,b){ga("require","ecommerce"),ga("ecommerce:addTransaction",{id:a.transaction_id,affiliation:a.store,revenue:a.total,shipping:0,tax:0}),b&&b.forEach(function(b){ga("ecommerce:addItem",{id:a.transaction_id,name:b.product,sku:b.sku,category:b.category,price:b.price,quantity:b.quantity||1})}),ga("ecommerce:send")}}}),define("garage/models/sell_nitros",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/sell-nitros"},defaults:{password:"",quantity:10},validationRules:{password:{required:!0}}})}),define("garage/views/sell_nitros",["require","templates","analytics","global/views/modal","garage/models/sell_nitros","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/views/modal"),e=a("garage/models/sell_nitros"),f=a("shared/classes/form_validation"),g=a("registry");return d.extend({initialize:function(a){d.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .arrows a":"updateQuantity"})),this.formModel=new e,"standard"!=g.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),void 0===this.template&&(this.template=b("garage","sell_nitros")),this.player=a.player,this.render()},render:function(){return this.$el.append(this.template({player:this.player.toJSON(),quantity:this.formModel.get("quantity"),unitPrice:NTGLOBALS("NITRO_SALES_PRICE"),price:NTGLOBALS("NITRO_SALES_PRICE")*this.formModel.get("quantity")})),new f(this.$("form"),this.$(".sell-button"),this.formModel,this.sell,this,this.sellError),this},sellError:function(a){this.showError(a.message)},sell:function(a){g.get("player").set(a),c.trackEvent("Dealership","Sell Nitro",null,this.formModel.get("quantity")),this.hide()},updateQuantity:function(a){var b=10*Math.round((this.formModel.get("quantity")+($(a.currentTarget).is(".up")?10:-10))/10);return this.formModel.set({quantity:Math.max(10,Math.min(this.player.get("nitros"),b))}),this.$(".quantity-value").html("-"+this.formModel.get("quantity").addCommas()),this.$(".price-value").html("$"+(NTGLOBALS("NITRO_SALES_PRICE")*this.formModel.get("quantity")).addCommas()),!1}})}),define("garage/models/send_cash",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({initialize:function(){$.validator.addMethod("notEnoughCash",function(a){return a<=this.get("playersCash")*(1+this.get("feePercent"))}.bind(this),"You do not have enough cash!")},url:function(){return"/api/friends/"+this.get("recipient")+"/sendcash"},defaults:{amount:0,password:""},validationRules:{amount:{required:!0,number:!0,min:1e5,notEnoughCash:!0},password:{required:!0}},validationMessages:{amount:{min:"You can not send less than $100,000",notEnoughCash:"You do not have enough money!"}}})}),define("shared/classes/sound",["require","registry"],function(a){"use strict";var b,c=0,d=0,e="/dist/site/misc/sounds/",f=a("registry"),g=function(){if(!b){var a=new Audio,c=a.canPlayType("audio/ogg")?"ogg":null,d=a.canPlayType("audio/mp4")?"mp4":null;b=c||d||"mp3"}},h={sounds:{},play:function(a){"string"==typeof a&&(a={id:a}),a.loop=a.loop||!1,a.volume=a.volume||1,a.delay=a.delay||0,this.sounds[a.id]&&(this.sounds[a.id].volume=a.volume,this.sounds[a.id].loop=a.loop,a.muted&&this.mute(a.id),setTimeout(function(){this.sounds[a.id].play()}.bind(this),a.delay))},stop:function(a,b){b=b||!1;var c=this.sounds[a];c&&(b?createjs.Tween.get(c).to({volume:0},b).call(function(){this.stop(a)}.bind(this)):c.pause&&c.pause())},mute:function(a){this.sounds[a]&&(this.sounds[a].muted=!0)},unmute:function(a){this.sounds[a]&&(this.sounds[a].muted=!1)},preload:function(a,f,h){g(),b="mp3","blank"!=a&&c++,h=h||a;var i=function(){d++,d==c&&this.trigger("complete")}.bind(this);$.ajax(e+f+"/"+b+"/"+h+"."+b).done(function(){this.sounds[a]=new Audio(e+f+"/"+b+"/"+h+"."+b),"blank"!=h&&(d++,this.trigger("progress"),i())}.bind(this)).fail(function(a){"blank"!=h&&(this.trigger("error",a,h),i())}.bind(this))}},i={sounds:{},sources:{},gameSounds:null,inited:!1,initialize:function(){g();try{this.gameSounds=new WebAudiox.GameSounds}catch(a){return void(this.disabled=!0)}this.inited=!0,f.get("isMobile")&&(this.preload("blank","global"),$("body").one("touchstart",function(){this.play("blank")}.bind(this)))},play:function(a){if("string"==typeof a&&(a={id:a}),a.loop=a.loop||!1,a.volume=a.volume||1,a.delay=a.delay||0,this.sounds[a.id]){var b=function(){try{var b=this.sounds[a.id].play({loop:a.loop,volume:a.volume});b.defaultVolume=a.volume,this.sources[a.id]||(this.sources[a.id]=[]),this.sources[a.id].push(b),a.muted&&this.mute(a.id)}catch(a){console.error(a)}}.bind(this);a.delay?setTimeout(b,a.delay):b()}},stop:function(a,b){b=b||!1;var c=this.sources[a];if(c)try{c.forEach(function(a){b?createjs.Tween.get(a.gainNode.gain).to({value:0},b).call(function(){a.stop()}.bind(this)):a.stop()})}catch(a){console.error(a)}},mute:function(a){if(this.sources[a])try{this.sources[a].forEach(function(a){a.gainNode.gain.value=0})}catch(a){console.error(a)}},unmute:function(a){if(this.sources[a])try{this.sources[a].forEach(function(a){a.gainNode.gain.value=a.defaultVolume})}catch(a){console.error(a)}},preload:function(a,f,g){
if(this.inited||this.initialize(),!this.disabled){"blank"!=a&&c++,g=g||a;var h=function(){d++,d==c&&this.trigger("complete")}.bind(this);try{this.gameSounds.createClip().load(e+f+"/"+b+"/"+g+"."+b,function(b){this.sounds[a]=b,"blank"!=g&&(d++,this.trigger("progress"),h())}.bind(this),function(a){"blank"!=g&&(this.trigger("error",a,g),h())}.bind(this))}catch(a){console.error(a)}}}};return window.AudioContext?_.extend(i,Backbone.Events):_.extend(h,Backbone.Events)}),define("garage/views/send_cash",["require","templates","analytics","global/views/modal","garage/models/send_cash","shared/classes/form_validation","shared/classes/sound","registry"],function(a){"use strict";var b=a("templates"),c=(a("analytics"),a("global/views/modal")),d=a("garage/models/send_cash"),e=a("shared/classes/form_validation"),f=a("shared/classes/sound"),g=a("registry");return c.extend({initialize:function(a){c.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=b("garage","send_cash")),this.events["change input[name=amount]"]="updateTransactionFee",this.delegateEvents(this.events),this.player=g.get("player"),this.recipient=a.recipient,this.model=new d,this.model.validationRules.amount.min=NTGLOBALS("CASH_SENDING").minimum,this.model.validationMessages.amount.min="You can not send less than $"+NTGLOBALS("CASH_SENDING").minimum.addCommas(),"standard"!=g.get("player").get("accountType")&&(this.model.validationRules.password.required=!1),this.model.set({playersCash:this.player.get("money"),recipient:this.recipient.id,feePercent:"basic"==this.player.get("membership")?NTGLOBALS("CASH_SENDING").feePercent:0}),this.render()},render:function(){return this.$el.append(this.template({recipient:this.recipient.toJSON(),player:this.player.toJSON(),minAmount:NTGLOBALS("CASH_SENDING").minimum,feePercent:NTGLOBALS("CASH_SENDING").feePercent})),new e(this.$("form"),this.$(".purchase-button"),this.model,this.send,this),this.updateTransactionFee(),this},send:function(a){f.play({id:"purchase",volume:.5}),g.get("realtime").sendCash(this.recipient.id,this.model.get("amount")),g.get("player").set(a),this.hide()},updateTransactionFee:function(){var a=parseInt(this.$("input[name=amount]").val(),10);!isNaN(a)&&a>0&&this.$(".transaction-fee").html(Math.round(a+a*this.model.get("feePercent")).addCommas())}})}),define("shared/classes/levels",["require"],function(a){"use strict";return{experienceForLevel:function(a){var b=NTGLOBALS("LEVEL_BASE_POINTS"),c=NTGLOBALS("LEVEL_MULTIPLE");return a=parseInt(a,10)-1,Math.floor(b*c*Math.pow(a,2)+b*a)},levelForExperience:function(a){var b=NTGLOBALS("LEVEL_BASE_POINTS"),c=NTGLOBALS("LEVEL_MULTIPLE");return a=parseInt(a,10),Math.floor((Math.sqrt(4*b*c*a+Math.pow(b,2))-b)/(2*b*c))+1}}}),define("global/views/experience_bar",["require","shared/classes/levels"],function(a){"use strict";var b=a("shared/classes/levels");return Backbone.View.extend({width:280,level:1,experience:0,initialize:function(a){this.options=a,this.width=parseInt(this.options.width,10)||this.width,this.level=parseInt(this.options.level,10),this.experience=parseInt(this.options.experience,10),this.render()},render:function(){if(this.options.loggedOut)$(this.el).css("background-size","0% 100%").html('You must <a class="login login-link" href="#">log in</a> or <a class="register register-link" href="#">sign up</a> to level up');else{var a=b.experienceForLevel(this.level),c=b.experienceForLevel(this.level+1),d=c-a,e=Math.round((this.experience-a)/d*100),f=c-this.experience;$(this.el).html('<span class="numbers">'+f.addCommas()+"</span> more exp to next level").css("background-size",e+"% 100%")}},animateTo:function(a,c){var d,e,f,g,h,i,j,k=b.levelForExperience(a),l=k-this.level,m=0,n=[],o="linear",p=this.$(".numbers");if(c=c||2e3,!(a<=this.experience)){if(l>0)for(;m<l;)this.level+m<k&&n.push(b.experienceForLevel(this.level+m+1)),m++;n.push(a),d=parseInt(c/n.length,10),m=0,e=function(){0!==n.length&&(f=n.shift(),m>0?(this.$el.css("background-size","0% auto"),j=0):(p.countdown(b.experienceForLevel(k+1)-a,{formatter:Number.addCommas}),j=this.$el.css("background-size").split(" ")[0].replace("%","")),n.length>0?(o="linear",h=100):(o="swing",g=b.experienceForLevel(this.level+m+1)-1-b.experienceForLevel(this.level+m),i=a-b.experienceForLevel(this.level+m),h=Math.round(i/g*100)),$({exp:j}).animate({exp:h},{step:function(a){this.$el.css({"background-size":a+"% 100%"})}.bind(this),easing:o,duration:d,complete:e.bind(this)}),m++)}.bind(this),e()}}})}),define("global/views/tooltip",["require"],function(a){"use strict";return Backbone.View.extend({className:"tooltip-hover",initialize:function(){this.$el.hide(),$("body").append(this.el)},show:function(a){var b=$(a.currentTarget);this.$el.html(b.data("tip")).css({left:b.offset().left-this.$el.outerWidth()/2+b.width()/2,top:b.offset().top-this.$el.outerHeight()-15}).velocity("fadeIn",200)},hide:function(){return this.$el.hide(),!1}})}),define("global/views/report_user",["require","global/views/tooltip","templates"],function(a){"use strict";var b=a("global/views/tooltip"),c=a("templates");return b.extend({className:"tooltip-hover tooltip-report",events:{"click .report":"report","click .cancel":"hide"},initialize:function(a){void 0===this.template&&(this.template=c("global","report_user")),this.player=a.player,b.prototype.initialize.apply(this),this.render()},render:function(){this.$el.html(this.template({}))},show:function(a,c){return!$(a.currentTarget).hasClass("done")&&(this.userID=c,this.target=a.target,b.prototype.show.apply(this,arguments))},report:function(){return this.hide(),this.player.report(this.userID),$(this.target).velocity("fadeOut",function(){$(this).html("Reported. Thanks!").addClass("done").velocity("fadeIn")}),!1}})}),define("garage/views/rewards",["require","global/views/modal","registry","global/models/car","shared/classes/levels","templates"],function(a){"use strict";var b=a("global/views/modal"),c=a("registry"),d=a("global/models/car"),e=a("shared/classes/levels"),f=a("templates");return b.extend({events:{"click .close-button":"close"},initialize:function(a){void 0===this.template&&(this.template=f("garage","rewards")),b.prototype.initialize.apply(this,arguments),this.render()},show:function(){b.prototype.show.apply(this,arguments);var a=c.get("player");a.getReward().done(function(b){b.success?(this.showCloseButtons(),b.data.reward?(this.showReward(b.data.type,b.data.value),this.reward=b.data):(a.set({rewardCountdown:Date.getUnixTime()+b.data.next}),this.showNotReady(b.data.next))):(alert("There was an error fetching your reward.  Please refresh the page and try again"),this.hide())}.bind(this))},render:function(){this.$el.append(this.template({}))},showCloseButtons:function(){this.$(".close-button").velocity("fadeIn",{display:"block"})},close:function(){if(this.reward){var a=c.get("player");a.set({mysteryBoxes:a.get("mysteryBoxes")+1,rewardCountdown:Date.getUnixTime()+this.reward.next}),this.reward.reward&&("money"==this.reward.type?a.inc({money:this.reward.value}):"nitros"==this.reward.type?a.inc({nitros:this.reward.value}):"experience"==this.reward.type?(a.inc({experience:this.reward.value}),a.set({level:e.levelForExperience(a.get("experience"))})):"car"==this.reward.type&&a.addCar(this.reward.value))}return this.hide(),!1},showReward:function(a,b){var c="";"money"==a?c="$"+Number(b).addCommas():"nitros"==a?c=b+" nitros":"experience"==a?c=Number(b).addCommas()+" XP":"car"==a&&(c="a new car");var e=this.$(".reward-image").addClass(a).css({transform:"scale(0.0)"});"car"==a&&e.css({backgroundImage:"url("+d.imageSrc("large",b)+")"}),this.$(".reward-value").html(c),this.$(".wait").hide(),this.$(".reward-info").velocity("fadeIn",function(){e.velocity({scale:[1,0],rotateZ:[1080,0]},{duration:1e3}).velocity({top:"-=10"},{duration:1500,easing:"easeInOutQuad",loop:5})})},showNotReady:function(a){this.$(".countdown-timer").html(Number(a).countdownSeconds()),this.$(".wait").hide(),this.$(".not-ready").velocity("fadeIn",{display:"block"})}})}),define("garage/views/player_info",["require","templates","analytics","global/models/car","garage/views/sell_nitros","garage/views/send_cash","global/views/experience_bar","global/views/report_user","garage/views/rewards","registry","shared/classes/sound"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/models/car"),e=a("garage/views/sell_nitros"),f=a("garage/views/send_cash"),g=a("global/views/experience_bar"),h=a("global/views/report_user"),i=a("garage/views/rewards"),j=a("registry"),k=a("shared/classes/sound");return Backbone.View.extend({events:{"click .sell-nitros-button":"showSellNitros","click .add-friend":"addFriend","click .invite-to-team":"inviteToTeam","click .report-player a":"showReportPlayer","click .claim-button":"claimReward","click .send-cash":"sendCash"},initialize:function(a){void 0===this.template&&(this.template=b("garage","player_info")),this.friends=a.friends,this.reportUser=new h({player:this.model}),this.listenTo(this.model,"change:carID",this.changeCar),this.listenTo(this.model,"change:money",this.changeMoney),this.listenTo(this.model,"change:nitros",this.changeNitros),this.listenTo(this.model,"change:experience",this.changeExperience),this.listenTo(this.model,"change:level",this.changeLevel),k.preload("swoosh","global"),k.preload("purchase","global")},render:function(){var a=this.model.toJSON(),b=j.get("cars");return this.$el.html(this.template({player:a,friends:this.friends,car:b.get(parseInt(this.model.get("carID"),10)).toJSON(),carImage:d.imageTag,top3:j.get("top3Players"),viewer:j.get("player").toJSON(),self:j.get("player").get("userID")==a.userID,maxFriends:j.get("player").get("friendLimit")<=j.get("playerFriends").totalFriends(),loggedIn:NTGLOBALS("LOGGED_IN"),countries:NTGLOBALS("COUNTRIES"),rewardCountdown:this.rewardCountdown()})),!a.profileView&&NTGLOBALS("LOGGED_IN")&&this.updateRewardCountdown(),this.model.get("profileView")||(this.experienceBar=new g({width:280,el:this.$(".experience-bar"),level:this.model.get("level"),experience:this.model.get("experience"),loggedOut:!this.model.get("profileView")&&!NTGLOBALS("LOGGED_IN")})),this},claimReward:function(){this.$(".countdown-claim").velocity("fadeOut");var a=new i;return a.show(),!1},updateRewardCountdown:function(){this.rewardCountdownEle||(this.rewardCountdownEle=this.$(".reward-countdown"));var a=this.rewardCountdown();a<=0?(this.$(".countdown-timer").fastHide(),this.$(".countdown-claim").fastShow()):(this.rewardCountdownEle.html(a.countdownSeconds()),setTimeout(this.updateRewardCountdown.bind(this),1e3))},rewardCountdown:function(){return this.model.get("rewardCountdown")-Date.getUnixTime()},changeMoney:function(){this.$(".player-money .numbers").countdown(this.model.get("money"),{formatter:Number.addCommas}),k.play({id:"purchase",volume:.5})},changeNitros:function(){this.$(".player-nitros").countdown(this.model.get("nitros"),{formatter:Number.addCommas})},changeExperience:function(){this.$(".player-experience").countdown(this.model.get("experience"),{formatter:Number.addCommas}),this.experienceBar.animateTo(this.model.get("experience"))},changeLevel:function(){this.$(".player-level").countdown(this.model.get("level"))},changeCar:function(){var a=$(window).width();this.$(".player-car-name").html(j.get("cars").get(this.model.get("carID")).get("name"));var b=this;this.$(".player-car").finish().css({left:280}).velocity({left:-1*a/2},250,"easeInExpo",function(){$(this).html(d.imageTag("large",b.model.get("carID"),b.model.get("carHueAngle"))).css("left",a/2+135).velocity({left:280},250,"easeOutExpo")}),k.play({id:"swoosh",volume:.5})},showSellNitros:function(a){return new e({player:this.model}).show({destroy:!0}),!1},sendCash:function(){return j.get("player").get("level")<NTGLOBALS("CASH_SENDING").minLevel?(alert("You must be at least level "+NTGLOBALS("CASH_SENDING").minLevel+" to send cash to friends."),!1):(new f({recipient:this.model}).show({destroy:!0}),!1)},addFriend:function(){var a=this.$(".add-friend");return!(a.hasClass("button-pending")||!a.hasClass("button-green"))&&(c.trackEvent("Friends","Request","racer profile"),j.get("player").requestFriend(this.model.id),a.addClass("button-pending").removeClass("button-green").text("Sent").attr("disabled","disabled"),!1)},inviteToTeam:function(){var a=this.$(".invite-to-team");return!a.hasClass("button-pending")&&(a.addClass("button-pending"),c.trackEvent("Team","Invite","racer profile"),j.get("player").inviteToTeam(this.model.id).always(function(){a.removeClass("button-green").text("Sent").attr("disabled","disabled")}.bind(this)),!1)},showReportPlayer:function(a){return this.reportUser.show(a,this.model.id),!1}})}),define("global/collections/cars",["require","global/models/car"],function(a){"use strict";var b=a("global/models/car");return Backbone.Collection.extend({model:b,comparator:function(a){return("00000"+a.get("level")).slice(-5)+"-"+a.get("name")}})}),define("garage/collections/garage",["require"],function(a){"use strict";return Backbone.Collection.extend({})}),define("stats/collections/stats",["require"],function(a){"use strict";return Backbone.Collection.extend({url:"/api/stats/summary",model:Backbone.Model.extend({idAttribute:"board"})})}),define("global/views/chart",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({options:{scaleGridLineColor:"rgba(110,115,121,0.3)",scaleShowLabels:!1,pointDotRadius:5,pointDotStrokeWidth:2,pointHitDetectionRadius:0,datasetStrokeWidth:7,bezierCurve:!1,showTooltips:!0,tooltipFillColor:"#2d8acd",tooltipFontColor:"#ffffff",showLabels:!1},dataset:{labels:[],data:[]},initialize:function(a){void 0===this.template&&(this.template=b("global","chart")),a.width=a.width||this.width||548,a.height=a.height||this.height||100,a.type=(a.type||this.type||"line").ucFirst(),this.setOptions(a)},setData:function(a,b){b=b||{},b.data=a,this.dataset=b},setOptions:function(a){_.extend(this.options,a)},render:function(){if(this.$el.html(this.template({options:this.options,data:this.dataset.data})),this.dataset.data.length>0){var a=this.$("canvas")[0],b=a.getContext("2d"),c=_.pluck(this.dataset.data,"label");2==window.devicePixelRatio&&(a.width=this.options.width,a.height=this.options.height,a.style.width=this.options.width/2+"px",a.style.height=this.options.height/2+"px",b.scale(2,2)),new Chart(b)[this.options.type]({labels:c,datasets:[this.dataset]},this.options)}}})}),define("stats/views/racelog_graph",["require","global/views/chart","shared/classes/typing"],function(a){"use strict";var b=a("global/views/chart"),c=a("shared/classes/typing");return b.extend({placeColors:["fee78b","cecece","9b671c","2d8acd"],getPointColor:function(a){return"#"+(this.placeColors[a-1]||this.placeColors[this.placeColors.length-1])},getPlaceText:function(a){return a+a.ordinal()},initialize:function(a){a=a||{},a.tooltipTemplate=function(a){var b=this.dataset.data[a.index];return b.value+" WPM   "+this.getPlaceText(b.place)+" Place   "+c.accuracy(b.typed,b.errs,2)+"% Acc"}.bind(this),b.prototype.initialize.call(this,a)},setData:function(a){var c={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};a=_.map(a,function(a){return a.label="",a.pointColor=this.getPointColor(a.place),a},this),b.prototype.setData.call(this,a,c)}})}),define("stats/views/daily_graph",["require","global/views/chart"],function(a){"use strict";var b=a("global/views/chart");return b.extend({initialize:function(a){a=a||{},a.tooltipTemplate=function(a){var b=this.dataset.data[a.index];return b.date+"   "+b.races+" Race"+(1==b.races?"":"s")+"   Avg "+b.value+" WPM"}.bind(this),b.prototype.initialize.call(this,a)},setData:function(a){var c={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};a=_.map(a,function(a){var b=moment(new Date(1e3*a.stamp));return a.date=b.format("MMM D, YYYY"),a.pointColor="#2d8acd",a.label="",a},this),b.prototype.setData.call(this,a,c)}})}),define("stats/views/monthly_graph",["require","global/views/chart"],function(a){"use strict";var b=a("global/views/chart");return b.extend({initialize:function(a){a=a||{},a.tooltipTemplate=function(a){var b=this.dataset.data[a.index];return b.date+"   "+b.races+" Race"+(1==b.races?"":"s")+"   Avg "+b.value+" WPM"}.bind(this),b.prototype.initialize.call(this,a)},setData:function(a){var c={fillColor:"transparent",strokeColor:"#2d8acd",pointStrokeColor:"#3b3b3b"};a=_.map(a,function(a){var b=moment(new Date(a.year,a.month-1,1));return a.date=b.format("MMM, YYYY"),a.pointColor="#2d8acd",a.label="",a},this),b.prototype.setData.call(this,a,c)}})}),define("stats/views/problemkeys_graph",["require","global/views/chart"],function(a){"use strict";var b=a("global/views/chart");return b.extend({initialize:function(a){a=a||{},a.type="bar",a.tooltipTemplate="<%=label%> was typed incorrectly <%=value%>% of the time",b.prototype.initialize.call(this,a)},setData:function(a){var c={fillColor:"rgba(45,138,205,0.5)",strokeColor:"#2d8acd"};b.prototype.setData.call(this,a,c)}})}),define("global/views/stats",["require","registry","templates","stats/collections/stats","stats/views/racelog_graph","stats/views/daily_graph","stats/views/monthly_graph","stats/views/problemkeys_graph","shared/classes/typing"],function(a){"use strict";var b=a("registry"),c=a("templates"),d=a("stats/collections/stats"),e=a("stats/views/racelog_graph"),f=a("stats/views/daily_graph"),g=a("stats/views/monthly_graph"),h=a("stats/views/problemkeys_graph"),i=a("shared/classes/typing");return Backbone.View.extend({events:{"click .graph-options a":"handleSwitchGraph"},graphType:"racelog",cachedData:{},initialize:function(a){void 0===this.template&&(this.template=c("global","stats"),this.statsTemplate=c("global","stats_summary")),this.player=b.get("player"),this.username=a.username,this.racingStats=new d(this.model.get("racingStats")),this.model.get("raceLogs")&&(this.cachedData.racelog=this.model.get("raceLogs")),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),dateFormat:this.dateFormat,typing:i,username:this.username,loggedIn:NTGLOBALS("LOGGED_IN")})),this.showStats(),this.showGraph()},dateFormat:function(a){if(!a)return"Not a Member";var b=moment(new Date(1e3*a));return b.format("MMM D, YYYY")},handleSwitchGraph:function(a){return!$(a.target).hasClass("active")&&(this.graphType=$(a.target).data("id"),this.$(".graph-options a").removeClass("active"),$(a.target).addClass("active"),"problemkeys"==this.graphType?this.$(".racer-logs-link").velocity("fadeOut"):this.$(".racer-logs-link").html($(a.target).html()+" History &raquo;").attr("href","/racelog/"+this.graphType).velocity("fadeIn"),this.showGraph(),!1)},renderStats:function(){this.$("#stats-summary").html(this.statsTemplate({stats:_.indexBy(this.racingStats.toJSON(),function(a){return a.board}),typing:i}))},showStats:function(){!NTGLOBALS("LOGGED_IN")||this.model.get("profileView")||Date.now()-this.player.get("_racingStatsStamp")<6e5?this.renderStats():this.racingStats.fetch().done(function(){this.player.set({racingStats:this.racingStats.toJSON(),_racingStatsStamp:Date.now()}),this.renderStats()}.bind(this))},showGraph:function(){if(NTGLOBALS("LOGGED_IN")||this.model.get("profileView")){var a,b=110;this.graph&&this.graph.remove(),"problemkeys"==this.graphType?(a=h,b=90):a="racelog"==this.graphType?e:"lastdays"==this.graphType?f:g,this.graph=new a({width:548,height:b}),this.$(".race-chart").append(this.graph.el),this.cachedData[this.graphType]?(this.graph.setData(this.cachedData[this.graphType]),this.graph.render()):$.get("/api/stats/graphs/"+this.graphType).done(function(a){a.success?(this.cachedData[this.graphType]=a.data,"racelog"==this.graphType&&this.model.set({raceLogs:a.data}),this.graph.setData(a.data),this.graph.render()):alert("Unable to access graph data: "+a.data.message)}.bind(this))}}})}),define("achievements/models/achievement",["require","registry"],function(a){"use strict";var b=a("registry"),c=Backbone.Model.extend({idAttribute:"achievementID",defaults:{active:0,desc:"",gid:0,hidden:0,name:"",points:0,reward:"",newCarThumbs:null,rewardDesc:"",ruleGroup:"",rules:"",completedStamp:0},prettyCompletedStamp:function(){return $.timeago(1e3*this.get("completedStamp"))},icon:function(){var a=JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT)),b=this.get("rules");return a[b[0].field].icon},progress:function(){var a,c,d,e,f,g=[],h=this.get("rules"),i=JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT)),j=b.get("player");return _.each(h,function(b,h){if(i[b.field]&&"carID"!=b.field){switch(e=j.get(b.field),f=b.value,h>0&&("gt"==b.comparison||"gte"==b.comparison)&&e>=f&&(e=Math.min(e,f)),a=i[b.field].prefix||"",c=i[b.field].suffix||"",d=i[b.field].format||null){case"minutes":e=Math.round(e/60),f=Math.round(f/60);break;case"speed":c="wpm"}i=i[b.field].text,e="eq"==b.comparison?e:Number(e).addCommas(),g.push(a+e+c+("gt"==b.comparison||"gte"==b.comparison?" / "+a+Number(f).addCommas()+c:"")+" "+i)}}),g.length>0?g[0]:""},progressPercent:function(){var a=this.get("rules"),c=b.get("player");if("gt"!=a[0].comparison&&"gte"!=a[0].comparison)return 0;var d=c.get(a[0].field),e=a[0].value;return Math.round(d/e*100)},checkIfComplete:function(a){var b,c,d,e,f=this.get("rules"),g=0;if(!this.get("active"))return!1;for(c=0,b=f.length,e=0;c<b;c++)switch(d=parseInt(a[f[c].field]||0,10),f[c].comparison){case"eq":g+=d==parseInt(f[c].value,10)||a[f[c].field]===f[c].value?1:0;break;case"ne":g+=d!=parseInt(f[c].value,10)?1:0;break;case"gt":g+=d>parseInt(f[c].value,10)?1:0;break;case"gte":g+=d>=parseInt(f[c].value,10)?1:0;break;case"lt":g+=d<parseInt(f[c].value,10)?1:0;break;case"lte":g+=d<=parseInt(f[c].value,10)?1:0;break;default:"undefined"!=typeof console&&console.log("Unknown comparison in achievement: "+this.id+", comp: "+f[c].comparison);continue}return g==b}});return c}),define("achievements/collections/achievements",["require","achievements/models/achievement","analytics","registry"],function(a){"use strict";var b=a("achievements/models/achievement"),c=a("analytics"),d=a("registry"),e=Backbone.Collection.extend({model:b,comparator:function(a){return this.sortOrder?a.get(this.sortOrder):a.get("ruleGroup")+"-"+("00000"+a.get("points")).slice(-5)+"-"+a.get("name")},filterByGroupId:function(a){return this.filter(function(b){return b.get("gid")==a&&(1==b.get("active")||b.get("completedStamp")>0)&&(0===b.get("hidden")||b.get("completedStamp")>0)})},setCompleted:function(a){a.each(function(a){this.get(a.id).set({completedStamp:a.get("completedStamp")})},this)},getRecentlyCompleted:function(a){a=a||3;var b=new e;return b.sortOrder="createdStamp",b.add(_.chain(this.toJSON()).filter(function(a){return a.completedStamp>0}).sortBy(function(a){return-1*a.completedStamp}).first(a).value()),b}},{check:function(){if(NTGLOBALS("LOGGED_IN")&&!this.paused){var a,b,e=d.get("player").toJSON(),f=d.get("playerAchievements"),g=d.get("achievements"),h=[],i=d.get("player");g.each(function(a){f.get(a.id)||a.checkIfComplete(e)&&h.push(a.id)},this),h.length&&$.post("/api/achievements/check/",{ids:h}).done(function(e){e.success&&(e=e.data,_.size(e.achieved)>0&&_.each(e.achieved,function(e,h){a=g.get(h),b=a.get("reward"),f.add({achievementID:a.id,completedStamp:e}),"car"==b.type&&d.get("playerCars").add({carID:b.value}),"title"==b.type&&i.set({title:b.value}),c.trackEvent("Achievements","Achieved",a.get("name"))}.bind(this)),i.set(e.user))})}},pause:function(a){this.paused=a,this.paused||this.check()}});return e}),define("garage/views/gold_gift",["require","templates","global/views/modal","registry"],function(a){"use strict";var b=a("templates"),c=a("global/views/modal"),d=a("registry");return c.extend({_initialize:function(){void 0===this.template&&(this.template=b("garage","gold_gift")),this.player=d.get("player"),this.inited=!0},render:function(){return this.$el.append(this.template({from:this.player.get("goldgift")})),this.player.unset("goldgift"),this},show:function(){return this.inited||this._initialize(),this.render(),c.prototype.show.apply(this,arguments)}})}),define("garage/views/cash_gift",["require","templates","global/views/modal","registry"],function(a){"use strict";var b=a("templates"),c=a("global/views/modal"),d=a("registry");return c.extend({_initialize:function(a){void 0===this.template&&(this.template=b("garage","cash_gift")),this.player=d.get("player"),this.inited=!0},render:function(){return this.$el.append(this.template({data:this.options.data})),this},show:function(){return this.inited||this._initialize(),this.render(),c.prototype.show.apply(this,arguments)},hide:function(){return this.player.inc({money:this.options.data.amount}),c.prototype.hide.apply(this,arguments)}})}),define("garage/models/garage_spot",["require"],function(a){"use strict";var b=Backbone.Model.extend({defaults:{spot_id:null,car_id:null},idAttribute:"spot_id"});return b}),define("garage/collections/garage_spots",["require","garage/models/garage_spot","global/collections/cars","registry"],function(a){"use strict";var b=a("garage/models/garage_spot"),c=a("global/collections/cars"),d=a("registry"),e=Backbone.Collection.extend({model:b,comparator:"spot_id",setPlayer:function(a,b,c){var e=_.where(c.toJSON(),{status:"owned"});this.playerGarage=b,b=b.pluck("carID"),this.allCars=d.get("cars"),this.setCars(b,e,a)},setCars:function(a,b,d){b=new c(b);var e,f=a.length-1;for(e=f;e>=0&&(null===a[e]||""===a[e]);e--)a.pop();a=_.map(a,function(a){return Number(a)||null});var g;_.each(a,function(c,d){c&&(g=parseInt(c,10),b.get(g)||(a[d]=null))}),b.each(function(b){var c=b.toJSON();if(a.indexOf(parseInt(c.carID,10))==-1){var d=a.indexOf(null);d==-1?a.push(c.carID):a[d]=c.carID}});var h={};_.each(a,function(b,c){h[b]?a[c]=null:h[b]=!0});var i=a.length%30,j=a.length+(30-i);e=a.length;var k=!1;if(0===i?_.each(a,function(a){null!==a&&""!==a||(k=!1)}):k=!0,k)for(e;e<j;e++)a.push(null);this.playerGarage.reset(_.map(a,function(a){return{carID:a}}));var l,m=[],n=null;_.each(a,function(a,c){l=null,n=null,a&&(l=this.allCars.get(a).get("name"),n=b.get(a).get("hueAngle")),m[c]={spot_id:c,car_id:a,name:l,hue_angle:n,active:a==d.get("carID")}}.bind(this)),this.reset(m,{silent:!0})},saveCars:function(){var a=this.toJSON(),b=[];return _.each(a,function(a){b.push(a.car_id)}),$.post("/api/cars-arrange",{garage:b}),b},swapCars:function(a,b,c,d){var e=this.findWhere({spot_id:parseInt(a,10)}),f=this.findWhere({spot_id:parseInt(c,10)});b=b?parseInt(b,10):null,d=d?parseInt(d,10):null;var g=e.toJSON(),h=f.toJSON();e.set({car_id:d,name:h.name,hue_angle:h.hue_angle,active:h.active},{silent:!0}),f.set({car_id:b,name:g.name,hue_angle:g.hue_angle,active:g.active},{silent:!0}),this.trigger("change")},setActiveCar:function(a){a=parseInt(a,10);var b=this.findWhere({active:!0});b&&b.set({active:!1},{silent:!0});var c=this.get(a);c&&c.set({active:!0},{silent:!0})}});return e}),define("garage/views/spots",["require","templates","global/models/car"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=b("garage","spots")),this.listenTo(this.collection,"change",this.render)},render:function(){var a={spots:this.collection.toJSON(),carStyle:c.imageBackgroundCSS};return this.$el.html(this.template(a)),this}});return d}),define("garage/models/sell_car",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/cars/"+this.get("carID")+"/sell"},defaults:{password:""},validationRules:{password:{required:!0}}})}),define("garage/views/sell_car",["require","templates","analytics","registry","global/views/modal","garage/models/sell_car","shared/classes/form_validation","global/models/car"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("registry"),e=a("global/views/modal"),f=a("garage/models/sell_car"),g=a("shared/classes/form_validation"),h=a("global/models/car");return e.extend({initialize:function(a){e.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=b("garage","sell_car")),this.formModel=new f,"standard"!=d.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.formModel.set({carID:this.model.id}),this.hueAngle=a.hueAngle,this.player=a.player,this.render()},render:function(){var a=this.player.toJSON(),b=this.model.toJSON(),c="";return this.$el.append(this.template({data:b,hueAngle:this.hueAngle,player:a,sellPrice:Math.round(.6*b.price),discountText:c,carSrc:h.imageSrc})),new g(this.$("form"),this.$(".sell-button"),this.formModel,this.sell,this,this.sellError),this},sellError:function(a){this.showError(a.message)},sell:function(a){var b=d.get("playerCars"),e=b.get(this.model.id);e.set({status:"sold",hueAngle:0}),d.get("player").set(a),c.trackEvent("Dealership","Sell Car",this.model.get("name"),.6*this.model.get("price")),this.hide()}})}),define("garage/views/car_picker",["require","templates","garage/collections/garage_spots","garage/views/spots","garage/views/sell_car","registry"],function(a){"use strict";var b=a("templates"),c=a("garage/collections/garage_spots"),d=a("garage/views/spots"),e=a("garage/views/sell_car"),f=a("registry"),g=Backbone.View.extend({$activeCar:null,$draggingCar:null,draggingCarOffset:null,hoveredCarId:null,editMode:!1,canChangeEditMode:!0,events:{"click #editMode":"toggleEditMode","mouseover .spot":"mouseOver","mouseout .spot":"mouseOut","mousedown .spot":"mouseDown",mouseup:"mouseUp","click .spot":"selectCar","click .sell-button":"showSellCar"},initialize:function(a){void 0===this.template&&(this.template=b("garage","car_picker")),this.playerGarage=a.playerGarage,this.playerCars=a.playerCars,this.listenTo(this.playerCars,"change",this.playerCarsChanged),this.listenTo(this.playerCars,"add",this.playerCarsChanged),this.collection=new c,this.collection.setPlayer(this.model,this.playerGarage,this.playerCars);var d=this;$(document).mousemove(function(a){d.$draggingCar&&d.$draggingCar.css({left:Math.round(a.pageX-d.draggingCarOffset.left),top:Math.round(a.pageY-d.draggingCarOffset.top)})})},render:function(){this.$el.html(this.template({player:this.model.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN")}));var a=new d({collection:this.collection});return this.$(".car-picker").html(a.render().el),this},playerCarsChanged:function(){this.collection.setPlayer(this.model,this.playerGarage,this.playerCars),this.render()},mouseOver:function(a){this.editMode&&(this.activeSpotId=$(a.currentTarget).data("id"))},mouseOut:function(a){this.editMode&&(this.activeSpotId=null)},mouseDown:function(a){a.preventDefault(),this.editMode&&$(a.currentTarget).find(".car").data("id")&&(this.$activeCar=$(a.currentTarget),this.$draggingCar=this.$activeCar.find(".car").clone(!1),this.$draggingCar.addClass("dragging"),this.$draggingCar.appendTo(this.$el.find(".car-picker")),this.draggingCarOffset=this.$draggingCar.offset(),this.draggingCarOffset.left+=Math.round(this.$draggingCar.find(".image").height()/2),this.draggingCarOffset.top+=Math.round(this.$draggingCar.find(".image").width()/2),this.$draggingCar.css({left:this.$activeCar.offset().left-this.$el.find(".car-picker").offset().left,top:this.$activeCar.offset().top-this.$el.find(".car-picker").offset().top}),this.$activeCar.addClass("moving"),this.$el.find(".car-picker").addClass("drag"))},mouseUp:function(a){if(this.editMode&&this.$activeCar){if(null!==this.activeSpotId){var b=this.activeSpotId,c=this.$activeCar.data("id"),d=this.$el.find('.spot[data-id="'+c+'"]').find(".car").data("id")||null,e=this.$el.find('.spot[data-id="'+b+'"]').find(".car").data("id")||null;this.collection.swapCars(c,d,b,e)}this.$activeCar.removeClass("moving"),this.$activeCar=null,this.$draggingCar&&(this.$draggingCar.remove(),this.$draggingCar=null,this.draggingCarOffset=null),this.$el.find(".car-picker").removeClass("drag")}},toggleEditMode:function(a){if(a.preventDefault(),this.canChangeEditMode)if(this.editMode=!this.editMode,this.editMode)$(a.currentTarget).text("Save Cars"),
this.$(".owned-cars").addClass("edit-mode"),this.$("#editFade").velocity("fadeIn",500);else{$(a.currentTarget).text("Re-arrange Cars"),this.$(".owned-cars").removeClass("edit-mode"),this.$("#editFade").velocity("fadeOut",500);var b=this.collection.saveCars();this.playerGarage.reset(_.map(b,function(a){return{carID:a}}))}},selectCar:function(a){if(!this.editMode){var b=parseInt($(a.currentTarget).find(".car").data("id"),10),c=parseInt($(a.currentTarget).find(".car").data("angle"),10)||0;if($(a.currentTarget).hasClass("empty")||this.model.get("carID")==b)return;this.$el.find(".spot.active").removeClass("active"),$(a.currentTarget).addClass("active"),this.model.useCar(b,c);var d=parseInt($(a.currentTarget).data("id"),10);this.collection.setActiveCar(d)}},showSellCar:function(a){var b=this.model,c=f.get("cars").get($(a.target).parents(".car").data("id")),d=f.get("playerCars").get(c.id).get("hueAngle");return new e({player:b,model:c,hueAngle:d}).show({destroy:!0}),!1}});return g}),define("garage/index",["require","garage/views/under_ad","garage/views/player_info","registry","global/models/player","global/collections/cars","garage/collections/garage","global/views/stats","achievements/collections/achievements","garage/views/gold_gift","garage/views/cash_gift","garage/views/car_picker"],function(a){"use strict";var b=a("garage/views/under_ad"),c=a("garage/views/player_info"),d=a("registry"),e=a("global/models/player"),f=a("global/collections/cars"),g=a("garage/collections/garage"),h=a("global/views/stats"),i=a("achievements/collections/achievements"),j=a("garage/views/gold_gift"),k=a("garage/views/cash_gift"),l=a("garage/views/car_picker");return Backbone.View.extend({el:"#app",initialize:function(a){a=a||{},a.username?(this.model=new e(NTGLOBALS("RACER_INFO")),this.playerCars=new f(NTGLOBALS("RACER_INFO").cars.map(function(a){return{carID:a[0],status:a[1],hueAngle:a[2]}})),this.playerGarage=new g(_.map(NTGLOBALS("RACER_INFO").garage,function(a){return{carID:a}}))):(this.model=d.get("player"),this.playerCars=d.get("playerCars"),this.playerGarage=d.get("playerGarage"),this.model.get("goldgift")&&(this.goldGift=new j),this.model.get("cashgift")?this.model.getPendingCashGifts().done(function(a){a.data.length&&(this.model.set({pendingCashGifts:a.data}),this.showCashGifts()),this.model.set({cashgift:null})}.bind(this)):this.model.get("pendingCashGifts")&&this.showCashGifts()),this.playerFriends=d.get("playerFriends"),this.playerInfo=new c({model:this.model,friends:this.playerFriends}),this.playerCars.length>0&&(this.carPicker=new l({model:this.model,playerCars:this.playerCars,playerGarage:this.playerGarage})),a.username?this.statsView=new h({model:this.model,username:a.username}):this.underAd=new b({model:this.model}),this.render()},render:function(){this.$el.find("#profileView").append(this.playerInfo.render().el),this.carPicker&&this.$(".owned-cars").append(this.carPicker.render().el),this.underAd&&this.$(".under-ad").append(this.underAd.render().el),this.statsView&&this.$(".stats-view").append(this.statsView.el),this.goldGift&&this.goldGift.show(),"#die"==location.hash&&this.monkey()},showCashGifts:function(){var a=this.model.get("pendingCashGifts");if(!a||0===a.length)return this.model.set({pendingCashGifts:null}),void i.pause(!1);i.pause(!0);var b=a.pop();this.model.set({pendingCashGifts:a});var c=new k({data:b});c.show(),c.on("close",this.showCashGifts.bind(this))}})}),define("dealership/models/paint_car",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/cars/"+this.get("carID")+"/paint"},defaults:{angle:0,password:""},validationRules:{password:{required:!0}}})});var Pixastic=function(){function a(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)}function b(b){var c=!1,d=function(){c||(c=!0,b())};document.write('<script defer src="//:" id="__onload_ie_pixastic__"></script>');var e=document.getElementById("__onload_ie_pixastic__");e.onreadystatechange=function(){"complete"==e.readyState&&(e.parentNode.removeChild(e),d())},document.addEventListener&&document.addEventListener("DOMContentLoaded",d,!1),a(window,"load",d)}function c(){for(var a=d("pixastic",null,"img"),b=d("pixastic",null,"canvas"),c=a.concat(b),e=0;e<c.length;e++)!function(){for(var a=c[e],b=[],d=a.className.split(" "),f=0;f<d.length;f++){var g=d[f];if("pixastic-"==g.substring(0,9)){var h=g.substring(9);""!=h&&b.push(h)}}if(b.length)if("img"==a.tagName.toLowerCase()){var i=new Image;if(i.src=a.src,i.complete)for(var j=0;j<b.length;j++){var k=Pixastic.applyAction(a,a,b[j],null);k&&(a=k)}else i.onload=function(){for(var c=0;c<b.length;c++){var d=Pixastic.applyAction(a,a,b[c],null);d&&(a=d)}}}else setTimeout(function(){for(var c=0;c<b.length;c++){var d=Pixastic.applyAction(a,a,b[c],null);d&&(a=d)}},1)}()}function d(a,b,c){var d=new Array;null==b&&(b=document),null==c&&(c="*");var e=b.getElementsByTagName(c),f=e.length,g=new RegExp("(^|\\s)"+a+"(\\s|$)");for(i=0,j=0;i<f;i++)g.test(e[i].className)&&(d[j]=e[i],j++);return d}function e(a,b){if(Pixastic.debug)try{switch(b){case"warn":console.warn("Pixastic:",a);break;case"error":console.error("Pixastic:",a);break;default:console.log("Pixastic:",a)}}catch(a){}}"undefined"!=typeof pixastic_parseonload&&pixastic_parseonload&&b(c);var f=function(){var a=document.createElement("canvas"),b=!1;try{b=!("function"!=typeof a.getContext||!a.getContext("2d"))}catch(a){}return function(){return b}}(),g=function(){var a,b=document.createElement("canvas"),c=!1;try{"function"==typeof b.getContext&&(a=b.getContext("2d"))&&(c="function"==typeof a.getImageData)}catch(a){}return function(){return c}}(),h=function(){var a=!1,b=document.createElement("canvas");if(f()&&g()){b.width=b.height=1;var c=b.getContext("2d");c.fillStyle="rgb(255,0,0)",c.fillRect(0,0,1,1);var d=document.createElement("canvas");d.width=d.height=1;var e=d.getContext("2d");e.fillStyle="rgb(0,0,255)",e.fillRect(0,0,1,1),c.globalAlpha=.5,c.drawImage(d,0,0);var h=c.getImageData(0,0,1,1).data;a=255!=h[2]}return function(){return a}}();return{parseOnLoad:!1,debug:!1,applyAction:function(a,b,c,d){d=d||{};var f="canvas"==a.tagName.toLowerCase();if(f&&Pixastic.Client.isIE())return Pixastic.debug&&e("Tried to process a canvas element but browser is IE."),!1;var g,h,i=!1;Pixastic.Client.hasCanvas()&&(i=!!d.resultCanvas,g=d.resultCanvas||document.createElement("canvas"),h=g.getContext("2d"));var j=a.offsetWidth,k=a.offsetHeight;if(f&&(j=a.width,k=a.height),0==j||0==k){if(null!=a.parentNode)return void(Pixastic.debug&&e("Image has 0 width and/or height."));var l=a.style.position,m=a.style.left;a.style.position="absolute",a.style.left="-9999px",document.body.appendChild(a),j=a.offsetWidth,k=a.offsetHeight,document.body.removeChild(a),a.style.position=l,a.style.left=m}if(c.indexOf("(")>-1){var n=c;c=n.substr(0,n.indexOf("("));var o=n.match(/\((.*?)\)/);if(o[1]){o=o[1].split(";");for(var p=0;p<o.length;p++)if(thisArg=o[p].split("="),2==thisArg.length)if("rect"==thisArg[0]){var q=thisArg[1].split(",");d[thisArg[0]]={left:parseInt(q[0],10)||0,top:parseInt(q[1],10)||0,width:parseInt(q[2],10)||0,height:parseInt(q[3],10)||0}}else d[thisArg[0]]=thisArg[1]}}d.rect?(d.rect.left=Math.round(d.rect.left),d.rect.top=Math.round(d.rect.top),d.rect.width=Math.round(d.rect.width),d.rect.height=Math.round(d.rect.height)):d.rect={left:0,top:0,width:j,height:k};var r=!1;if(Pixastic.Actions[c]&&"function"==typeof Pixastic.Actions[c].process&&(r=!0),!r)return Pixastic.debug&&e('Invalid action "'+c+'". Maybe file not included?'),!1;if(!Pixastic.Actions[c].checkSupport())return Pixastic.debug&&e('Action "'+c+'" not supported by this browser.'),!1;Pixastic.Client.hasCanvas()?(g!==a&&(g.width=j,g.height=k),i||(g.style.width=j+"px",g.style.height=k+"px"),h.drawImage(b,0,0,j,k),a.__pixastic_org_image?(g.__pixastic_org_image=a.__pixastic_org_image,g.__pixastic_org_width=a.__pixastic_org_width,g.__pixastic_org_height=a.__pixastic_org_height):(g.__pixastic_org_image=a,g.__pixastic_org_width=j,g.__pixastic_org_height=k)):Pixastic.Client.isIE()&&"undefined"==typeof a.__pixastic_org_style&&(a.__pixastic_org_style=a.style.cssText);var s={image:a,canvas:g,width:j,height:k,useData:!0,options:d},t=Pixastic.Actions[c].process(s);return!!t&&(Pixastic.Client.hasCanvas()?(s.useData&&Pixastic.Client.hasCanvasImageData()&&(g.getContext("2d").putImageData(s.canvasData,d.rect.left,d.rect.top),g.getContext("2d").fillRect(0,0,0,0)),d.leaveDOM||(g.title=a.title,g.imgsrc=a.imgsrc,f||(g.alt=a.alt),f||(g.imgsrc=a.src),g.className=a.className,g.style.cssText=a.style.cssText,g.name=a.name,g.tabIndex=a.tabIndex,g.id=a.id,a.parentNode&&a.parentNode.replaceChild&&a.parentNode.replaceChild(g,a)),d.resultCanvas=g,g):a)},prepareData:function(a,b){var c=a.canvas.getContext("2d"),d=a.options.rect,e=c.getImageData(d.left,d.top,d.width,d.height),f=e.data;return b||(a.canvasData=e),f},process:function(a,b,c,d){if("img"==a.tagName.toLowerCase()){var e=new Image;if(e.src=a.src,e.complete){var f=Pixastic.applyAction(a,e,b,c);return d&&d(f),f}e.onload=function(){var f=Pixastic.applyAction(a,e,b,c);d&&d(f)}}if("canvas"==a.tagName.toLowerCase()){var f=Pixastic.applyAction(a,a,b,c);return d&&d(f),f}},revert:function(a){if(Pixastic.Client.hasCanvas()){if("canvas"==a.tagName.toLowerCase()&&a.__pixastic_org_image)return a.width=a.__pixastic_org_width,a.height=a.__pixastic_org_height,a.getContext("2d").drawImage(a.__pixastic_org_image,0,0),a.parentNode&&a.parentNode.replaceChild&&a.parentNode.replaceChild(a.__pixastic_org_image,a),a}else Pixastic.Client.isIE()&&"undefined"!=typeof a.__pixastic_org_style&&(a.style.cssText=a.__pixastic_org_style)},Client:{hasCanvas:f,hasCanvasImageData:g,hasGlobalAlpha:h,isIE:function(){return!!document.all&&!!window.attachEvent&&!window.opera}},Actions:{}}}();"undefined"!=typeof jQuery&&jQuery&&jQuery.fn&&(jQuery.fn.pixastic=function(a,b){var c=[];return this.each(function(){if("img"!=this.tagName.toLowerCase()||this.complete){var d=Pixastic.process(this,a,b);d&&c.push(d)}}),c.length>0?jQuery(c):this}),Pixastic.Actions.hsl={process:function(a){var b=parseInt(a.options.hue,10)||0,c=(parseInt(a.options.saturation,10)||0)/100,d=(parseInt(a.options.lightness,10)||0)/100;if(c<0)var e=1+c;else var e=1+2*c;b=b%360/360;var f=6*b,g=255*d,h=1+d,i=1-d;if(Pixastic.Client.hasCanvasImageData()){for(var j=Pixastic.prepareData(a),k=a.options.rect,l=k.width*k.height,m=4*l,n=m+1,o=m+2;l--;){var p=j[m-=4],q=j[n=m+1],r=j[o=m+2];if(0!=b||0!=c){var s=p;q>s&&(s=q),r>s&&(s=r);var t=p;q<t&&(t=q),r<t&&(t=r);var u=s-t,v=(t+s)/510;if(v>0&&u>0){if(v<=.5){var w=u/(s+t)*e;w>1&&(w=1);var x=v*(1+w)}else{var w=u/(510-s-t)*e;w>1&&(w=1);var x=v+w-v*w}if(p==s)if(q==t)var y=5+(s-r)/u+f;else var y=1-(s-q)/u+f;else if(q==s)if(r==t)var y=1+(s-p)/u+f;else var y=3-(s-r)/u+f;else if(p==t)var y=3+(s-q)/u+f;else var y=5-(s-p)/u+f;y<0&&(y+=6),y>=6&&(y-=6);var z=v+v-x,A=y>>0;0==A?(p=255*x,q=255*(z+(x-z)*(y-A)),r=255*z):1==A?(p=255*(x-(x-z)*(y-A)),q=255*x,r=255*z):2==A?(p=255*z,q=255*x,r=255*(z+(x-z)*(y-A))):3==A?(p=255*z,q=255*(x-(x-z)*(y-A)),r=255*x):4==A?(p=255*(z+(x-z)*(y-A)),q=255*z,r=255*x):5==A&&(p=255*x,q=255*z,r=255*(x-(x-z)*(y-A)))}}d<0?(p*=h,q*=h,r*=h):d>0&&(p=p*i+g,q=q*i+g,r=r*i+g),p<0?j[m]=0:p>255?j[m]=255:j[m]=p,q<0?j[n]=0:q>255?j[n]=255:j[n]=q,r<0?j[o]=0:r>255?j[o]=255:j[o]=r}return!0}},checkSupport:function(){return Pixastic.Client.hasCanvasImageData()}},define("shared/classes/pixastic",function(){}),define("dealership/views/paint_car",["require","templates","analytics","global/views/modal","registry","dealership/models/paint_car","shared/classes/form_validation","global/models/car","shared/classes/pixastic"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/views/modal"),e=a("registry"),f=a("dealership/models/paint_car"),g=a("shared/classes/form_validation"),h=a("global/models/car");return a("shared/classes/pixastic"),d.extend({initialize:function(a){d.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{})),void 0===this.template&&(this.template=b("dealership","paint_car")),this.player=a.player,this.model=e.get("cars").get(this.player.get("carID")),this.formModel=new f,this.formModel.set({carID:this.model.id}),"standard"!=e.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.render(),this.$("input[type=range]").on("input change",this.sliderUpdate.bind(this)),this.car=this.$(".carImage"),this.carSourceImage=new Image,this.carSourceImage.src=h.imageSrc("large",this.player.get("carID")),this.updateHue(this.player.get("carHueAngle"))},render:function(){var a=this.model.toJSON();return a.price=Math.round(a.price*NTGLOBALS("PAINT_PRICE")),this.$el.append(this.template({data:a,player:this.player.toJSON(),carSrc:h.imageSrc})),new g(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},sliderUpdate:function(a){var b=$(a.target).val();return this.updateHue(b),!1},updateHue:function(a){Pixastic.process(this.carSourceImage,"hsl",{hue:a},function(a){this.car.html(a)}.bind(this)),this.formModel.set({angle:a})},purchaseError:function(a){this.showError(a.message)},purchase:function(a){var b=e.get("playerCars");a.carHueAngle=this.formModel.get("angle"),e.get("player").set(a),b.get(this.model.id).set({hueAngle:a.carHueAngle}),c.trackEvent("Dealership","Paint Car",this.model.get("name")),c.trackEvent("Dealership","Spend Money",null,this.model.get("price")*NTGLOBALS("PAINT_PRICE")),this.hide()}})}),define("dealership/models/buy_nitros",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/buy-nitros"},defaults:{password:"",quantity:10},validationRules:{password:{required:!0}}})}),define("dealership/views/buy_nitros",["require","templates","analytics","global/views/modal","dealership/models/buy_nitros","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/views/modal"),e=a("dealership/models/buy_nitros"),f=a("shared/classes/form_validation"),g=a("registry");return d.extend({initialize:function(a){d.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .arrows a":"updateQuantity"})),this.formModel=new e,"standard"!=g.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),void 0===this.template&&(this.template=b("dealership","buy_nitros")),this.player=a.player,this.render()},render:function(){return this.$el.append(this.template({player:this.player.toJSON(),quantity:this.formModel.get("quantity"),unitPrice:NTGLOBALS("NITRO_PRICE"),price:NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity")})),new f(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},purchaseError:function(a){this.showError(a.message)},purchase:function(a){c.trackEvent("Dealership","Purchase Nitro",null,this.formModel.get("quantity")),c.trackEvent("Dealership","Spend Money",null,parseInt(NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity"),10)),this.hide(),g.get("player").set(a)},updateQuantity:function(a){return this.formModel.set({quantity:Math.max(10,this.formModel.get("quantity")+($(a.currentTarget).is(".up")?10:-10))}),this.$(".quantity-value").html("+"+this.formModel.get("quantity").addCommas()),this.$(".price-value").html("$"+(NTGLOBALS("NITRO_PRICE")*this.formModel.get("quantity")).addCommas()),!1}})}),define("dealership/views/player_info",["require","templates","registry","dealership/views/paint_car","dealership/views/buy_nitros","global/models/car","shared/classes/sound"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("dealership/views/paint_car"),e=a("dealership/views/buy_nitros"),f=a("global/models/car"),g=a("shared/classes/sound");return Backbone.View.extend({events:{"click .paint-car":"showPaintCarView","click .buy-nitros":"showBuyNitrosView"},initialize:function(a){void 0===this.template&&(this.template=b("dealership","player_info")),this.player=a.player,this.listenTo(this.player,"change:carID change:carHueAngle",this.changeCar),this.listenTo(this.player,"change:money",this.changeMoney),this.listenTo(this.player,"change:nitros",this.changeNitros),g.preload("swoosh","global"),g.preload("purchase","global"),this.render()},render:function(){var a=c.get("playerCars");this.$el.html(this.template({player:this.player.toJSON(),carImage:f.imageTag,cars:c.get("cars"),loggedIn:NTGLOBALS("LOGGED_IN"),allowPaint:a.length>0}))},changeCar:function(){this.$(".player-car-name").html(c.get("cars").get(this.player.get("carID")).get("name"));var a=this;this.$(".player-car").finish().css({left:0}).velocity({left:-1*$(window).width()/2},250,function(){$(this).html(f.imageTag("large",a.player.get("carID"),a.player.get("carHueAngle"))).css("left",$(window).width()/2+135).velocity({left:0},250,"easeOutExpo")}),g.play({id:"swoosh",volume:.5})},changeMoney:function(){this.$(".player-money .numbers").countdown(this.player.get("money"),{formatter:Number.addCommas}),g.play({id:"purchase",volume:.5})},changeNitros:function(){this.$(".player-nitros").countdown(this.player.get("nitros").addCommas(),{formatter:Number.addCommas})},showPaintCarView:function(){return new d({player:this.player}).show({destroy:!0}),!1},showBuyNitrosView:function(){return new e({player:this.player}).show({destroy:!0}),!1}})}),define("dealership/collections/groups",["require"],function(a){"use strict";return Backbone.Collection.extend({comparator:"minLevel"})}),define("dealership/models/buy_car",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/cars/"+this.get("carID")+"/buy"},defaults:{password:""},validationRules:{password:{required:!0}}})}),define("dealership/views/buy_car",["require","templates","analytics","global/views/modal","dealership/models/buy_car","shared/classes/form_validation","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/views/modal"),e=a("dealership/models/buy_car"),f=a("shared/classes/form_validation"),g=a("global/models/car"),h=a("registry");return d.extend({initialize:function(a){d.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{})),void 0===this.template&&(this.template=b("dealership","buy_car")),this.player=a.player,this.formModel=new e,this.formModel.set({carID:this.model.id}),"standard"!=h.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.render()},render:function(){var a=this.player.toJSON(),b=this.model.toJSON();return this.$el.append(this.template({data:b,player:a,carSrc:g.imageSrc})),new f(this.$("form"),this.$(".purchase-button"),this.formModel,this.purchase,this,this.purchaseError),this},purchaseError:function(a){this.showError(a.message)},purchase:function(a){var b=h.get("player");b.set(a),b.addCar(this.formModel.get("carID")),c.trackEvent("Dealership","Purchase Car",this.model.get("name")),c.trackEvent("Dealership","Spend Money",null,this.model.get("price")),this.hide()}})}),define("dealership/views/catalog",["require","templates","dealership/collections/groups","registry","dealership/views/buy_car"],function(a){"use strict";var b=a("templates"),c=a("dealership/collections/groups"),d=a("registry"),e=a("dealership/views/buy_car");return Backbone.View.extend({events:{"click .buy-car":"showBuyCarView"},initialize:function(a){void 0===this.template&&(this.template=b("dealership","catalog")),this.player=a.player,this.model=d.get("cars"),this.groups=new c(NTGLOBALS("CAR_GROUPS")),NTGLOBALS("SPECIAL_EVENT")&&(this.groups.forEach(function(a){a.set({excludeCars:NTGLOBALS("SPECIAL_EVENT_CARS")})}),this.groups.unshift({minLevel:0,filterCars:NTGLOBALS("SPECIAL_EVENT_CARS"),subText:"Use "+NTGLOBALS("SPECIAL_EVENT").ucFirst()+" event cars to earn extra cash, experience, and achievements!",name:NTGLOBALS("SPECIAL_EVENT").ucFirst()+" Event Cars"})),this.owned=d.get("playerCars"),this.listenTo(this.owned,"add change",this.buyCar),this.render()},render:function(){var a=this.owned,b=_.chain(this.model.toJSON()).filter(function(b){return!(a.get(b.id)&&"owned"==a.get(b.id).get("status")||!a.get(b.id)&&!b.purchasable)}).sortBy("price").groupBy(function(a){return a.unlockLevel}).value();this.$el.html(this.template({allCars:_.flatten(_.values(b)),cars:b,player:this.player.toJSON(),groups:this.groups.toJSON(),carPath:this.model.model.imageSrc}))},buyCar:function(a){this.$("div[data-id="+a.id+"]").velocity("fadeOut",function(){$(this).remove()})},showBuyCarView:function(a){if($(a.currentTarget).hasClass("button-locked"))return!1;var b=this.model.get($(a.target).parents(".car").data("id"));return new e({player:this.player,model:b}).show({destroy:!0}),!1}})}),define("dealership/index",["require","registry","dealership/views/player_info","dealership/views/catalog"],function(a){"use strict";var b=a("registry"),c=a("dealership/views/player_info"),d=a("dealership/views/catalog");return Backbone.View.extend({el:"#app",initialize:function(){this.player=b.get("player"),this.playerInfo=new c({player:this.player}),this.catalogView=new d({player:this.player}),this.render()},render:function(){this.$(".player-info").append(this.playerInfo.el),this.$(".car-list").append(this.catalogView.el)}})}),define("friends/views/friends",["require","templates","analytics","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/models/car"),e=a("registry");return Backbone.View.extend({events:{"click tr":"handleRowClick"},initialize:function(a){this.statusMap=NTGLOBALS("PAGE_LABELS"),this.parent=a.parent,this.player=e.get("player"),void 0===this.template&&(this.template=b("friends","friends")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,data:this.model.toJSON(),carImage:d.imageTag,friends:e.get("playerFriends"),loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friendLimit:this.player.get("friendLimit"),totalFriends:e.get("playerFriends").totalFriends(),totalTeammates:e.get("playerFriends").totalTeammates(),countries:NTGLOBALS("COUNTRIES"),status:this.formatOnlineStatus.bind(this)})),this.hideSpinner()},formatOnlineStatus:function(a){var b=this.statusMap[a];return b?b:"Browsing"},removeRow:function(a){var b=this;this.$("#row-"+a.id).velocity("fadeOut",function(){b.render()})},show:function(a){this.model.fetch(a),this.$el.show()},hide:function(){this.model.cancel(),this.$el.hide()},showSpinner:function(){this.$(".my-friends").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".my-friends").fastShow(),this.$(".spinner").fastHide()},handleRowClick:function(a){a.preventDefault();var b=$(a.target);return b.is(".remove-friend")?this.confirmDelete(a):b.is(".cancel")?this.cancelDelete(a):b.is(".delete")?this.deleteFriend(a):!b.is(".remove-popup")&&void(location.href="/racer/"+this.model.get($(a.currentTarget).data("id")).get("username"))},confirmDelete:function(a){c.trackEvent("Friends","Delete"),$(a.currentTarget).find(".remove-popup").fastShow()},cancelDelete:function(a){$(a.currentTarget).find(".remove-popup").fastHide()},deleteFriend:function(a){var b=$(a.currentTarget).data("id");this.model.get(b)&&this.model.delete(b)}})}),define("friends/views/requests",["require","templates","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=a("registry");return Backbone.View.extend({events:{"click .refresh":"refresh","click .approve-all":"handleApproveAll","click .deny-all":"handleDenyAll","click tr":"handleRowClick"},initialize:function(a){this.parent=a.parent,this.player=d.get("player"),void 0===this.template&&(this.template=b("friends","requests")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,totalRecords:this.model.totalRecords,data:this.model.toJSON(),carImage:c.imageTag,loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friendLimit:this.player.get("friendLimit"),totalFriends:d.get("playerFriends").totalFriends(),countries:NTGLOBALS("COUNTRIES")})),this.hideSpinner()},removeRow:function(a){var b=this;this.$("#row-"+a.id).velocity("fadeOut",function(){b.render()})},refresh:function(){return this.model.fetch(1e3),!1},show:function(a){this.model.fetch(a),this.$el.fastShow()},hide:function(){this.model.cancel(),this.$el.hide()},showSpinner:function(){this.$(".friend-requests").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friend-requests").fastShow(),this.$(".spinner").fastHide()},handleApproveAll:function(){var a=this;return this.model.approveAll().done(function(b){b.success?a.parent.switchTabs("friends"):alert("There was an error: "+b.message)}),!1},handleDenyAll:function(){var a=this;return this.model.denyAll().done(function(b){b.success?a.parent.switchTabs("friends"):alert("There was an error: "+b.message)}),!1},getRowId:function(a){return $(a.currentTarget).data("id")},handleRowClick:function(a){if($(a.target).is(".approve")){if($(a.currentTarget).data("clicked"))return!1;$(a.currentTarget).data("clicked",!0),this.model.approve(this.getRowId(a))}else if($(a.target).is(".deny")){if($(a.currentTarget).data("clicked"))return!1;$(a.currentTarget).data("clicked",!0),this.model.deny(this.getRowId(a))}else $(a.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(a.currentTarget).data("id")).get("username"));return!1}})}),define("friends/views/search_results",["require","templates","analytics","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("global/models/car"),e=a("registry");return Backbone.View.extend({searchTerm:"",events:{"click tr":"handleRowClick"},initialize:function(){this.player=e.get("player"),void 0===this.template&&(this.template=b("friends","search_results")),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"reset",this.render),this.render()},render:function(){this.$el.html(this.template({searchTerm:this.searchTerm,data:this.model.toJSON(),carImage:d.imageTag,loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),friends:e.get("playerFriends"),friendLimit:this.player.get("friendLimit"),totalFriends:e.get("playerFriends").totalFriends(),countries:NTGLOBALS("COUNTRIES")})),this.hideSpinner()},handleRowClick:function(a){if($(a.target).is(".add-friend")){var b=$(a.currentTarget).data("id");this.model.requestFriend(b),c.trackEvent("Friends","Request","friends page"),$(a.target).removeClass("button-green add-friend").addClass("button-pending").html("Request Sent")}else{if($(a.target).is(".button-friends"))return!1;$(a.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(a.currentTarget).data("id")).get("username"))}return!1},search:function(a,b){this.searchTerm=a,a.length<3?this.model.reset():(c.trackEvent("Friends","Search"),this.model.search(a,b))},show:function(){this.$el.fastShow()},hide:function(){this.model.cancel(),this.$el.fastHide()},showSpinner:function(){this.$(".friend-search").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friend-search").fastShow(),this.$(".spinner").fastHide()}})}),define("friends/collections/friends",["require","global/models/player","registry"],function(a){"use strict";var b=a("global/models/player"),c=a("registry");return Backbone.Collection.extend({prevTotalFriends:0,model:b,initialize:function(){},comparator:function(a){var b="";return b=a.get("lastActivity")?"1-":"2-"+a.get("friendType"),b+a.get("displayName")+a.get("username")},delete:function(a){this.remove(a),$.post("/api/friends/"+a+"/delete").done(function(a){a.success||alert("There was an error: "+a.message)})},cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},fetch:function(a){if(!NTGLOBALS("LOGGED_IN"))return this.reset();if(this.trigger("request"),this.cancel(),a)return void(this.request=setTimeout(_.bind(this.fetch,this),a));var b="/api/friends";this.onlineOnly&&(b+="?online=1"),this.request=$.get(b).done(function(a){if(this.request=null,a.success){var b=[];a.data.fields&&a.data.values?b=$.objectArray(a.data.fields,a.data.values):_.isArray(a.data)&&(b=a.data),c.get("playerFriends").reset(b),this.reset(b)}else this.reset()}.bind(this))},totalFriends:function(){return this.where({friendType:"friend"}).length},totalTeammates:function(){return this.where({friendType:"teammate"}).length}})}),define("friends/collections/requests",["require","global/models/player","registry"],function(a){"use strict";var b=a("global/models/player"),c=a("registry");return Backbone.Collection.extend({model:b,totalRecords:0,initialize:function(){this.on("reset",this.updatePlayer,this),this.on("remove",this.updatePlayer,this)},updatePlayer:function(){var a=c.get("player");a.set({requests:this.totalRecords})},approve:function(a){this.totalRecords--,this.remove(a);c.get("player");return $.post("/api/friend-requests/"+a+"/accept").done(function(){c.get("realtime").acceptFriends([a])})},deny:function(a){return this.totalRecords--,this.remove(a),$.post("/api/friend-requests/"+a+"/deny")},approveAll:function(){return this.trigger("request"),$.post("/api/friend-requests/accept-all").done(function(a){a.success&&(c.get("realtime").acceptFriends(this.pluck("id")),this.totalRecords-=a.data.count,this.reset())}.bind(this))},denyAll:function(){return this.trigger("request"),$.post("/api/friend-requests/deny-all").done(function(a){a.success&&(this.totalRecords=0,this.reset())}.bind(this))},cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},fetch:function(a){if(!NTGLOBALS("LOGGED_IN"))return this.reset();if(this.cancel(),this.trigger("request"),a)return void(this.request=setTimeout(_.bind(this.fetch,this),a));var b=this;this.request=$.get("/api/friend-requests").done(function(a){b.request=null,a.success?a.data.ignore?b.reset():(b.totalRecords=a.data.totalRecords,b.reset(a.data.requests)):b.reset()})}})}),define("friends/collections/search_results",["require","global/models/player","registry"],function(a){"use strict";var b=a("global/models/player"),c=a("registry");return Backbone.Collection.extend({prevTerm:"",model:b,cancel:function(){return this.request&&(clearTimeout(this.request),"object"==typeof this.request&&this.request.abort(),this.request=null),this},search:function(a,b){if(a!=this.prevTerm){if(this.cancel(),this.trigger("request"),b)return void(this.request=setTimeout(_.bind(this.search,this,a),b));this.prevTerm=a;var c=this;this.request=$.post("/api/players-search",{term:a}).done(function(a){c.request=null,a.success?c.reset(a.data):c.reset()})}},requestFriend:function(a){return c.get("player").requestFriend(a)}})}),define("friends/index",["require","friends/views/friends","friends/views/requests","friends/views/search_results","global/views/invites","friends/collections/friends","friends/collections/requests","friends/collections/search_results","registry"],function(a){"use strict";var b=a("friends/views/friends"),c=a("friends/views/requests"),d=a("friends/views/search_results"),e=a("global/views/invites"),f=a("friends/collections/friends"),g=a("friends/collections/requests"),h=a("friends/collections/search_results"),i=a("registry");return Backbone.View.extend({el:"#app",contentEl:null,activeTab:"friends",events:{"click .tabs li":"handleTabClick","click .search-button":"handleSearchClick","click .invite-link":"handleInviteClick",
"submit form":"handleSearchSubmit"},initialize:function(){this.player=i.get("player"),this.playerFriends=i.get("playerFriends"),this.listenTo(this.playerFriends,"add",this.updateTabs),this.listenTo(this.playerFriends,"remove",this.updateTabs),this.listenTo(this.player,"change:requests",this.updateTabs),this.player.get("requests")>0&&(this.activeTab="requests");var a=new f,j=new g,k=new h;this.friendsView=new b({model:a,parent:this}),this.requestsView=new c({model:j,parent:this}),this.searchResultsView=new d({model:k,parent:this}),this.invites=new e,this.render(),this.updateTabs(),this.switchTabs(this.activeTab,0)},render:function(){this.contentEl=this.$(".friends-content"),this.contentEl.append([this.friendsView.el,this.requestsView.el,this.searchResultsView.el])},updateTabs:function(){this.$("#tab-friends a").html("My Friends ("+this.playerFriends.length+")"),this.$("#tab-requests a").html("Requests ("+this.player.get("requests")+")")},switchTabs:function(a,b){this.activeTab=a,this.$(".tabs li").removeClass("active"),this.$("#tab-"+a).addClass("active"),this.friendsView.hide(),this.requestsView.hide(),this.searchResultsView.hide(),this[this.activeTab+"View"].show(b)},handleTabClick:function(a){return this.switchTabs(a.currentTarget.id.split("-")[1],1e3),!1},handleSearchClick:function(a){a.preventDefault(),this.$("form").submit()},handleSearchSubmit:function(a){a.preventDefault(),this.switchTabs("searchResults"),this.searchResultsView.search(this.$("form input").val(),1e3)},handleInviteClick:function(){return this.invites.show(),!1}})}),define("bugs/models/form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/settings/bugs",defaults:{},validationRules:{description:{required:!0},page:{required:!0},action:{required:!0}},validationMessages:{}})}),define("bugs/index",["require","registry","shared/classes/form_validation","bugs/models/form"],function(a){"use strict";var b=(a("registry"),a("shared/classes/form_validation")),c=a("bugs/models/form"),d=Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){new b(this.$("form[name=bugs-form]"),this.$("form[name=bugs-form] .button"),new c,this.callback,this)},callback:function(a,b,c){c.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Thanks for helping to improve Nitro Type!</p>").velocity("fadeIn")})}});return d}),define("scoreboard/views/navigation",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({grouping:null,board:null,time:null,events:{"click .tabs a":"handleTabClick","click .tab-filters a":"handleTimeClick"},initialize:function(){void 0===this.template&&(this.template=b("scoreboard","navigation")),this.grouping=this.model.grouping,this.board=this.model.board,this.time=this.model.time,this.render()},render:function(){this.$el.html(this.template(this)),this.switchTabs()},handleTabClick:function(a){a.preventDefault();var b=a.currentTarget.id.split("-");this.grouping=b[1],this.board=b[2],"speed"==this.board&&"season"==this.time&&(this.time="monthly"),this.model.setOptions(this.board,this.time,this.grouping).fetch(),this.switchTabs()},handleTimeClick:function(a){a.preventDefault(),this.time=a.currentTarget.id.split("-")[1],"speed"==this.board&&"season"==this.time&&(this.time="monthly"),this.model.setOptions(this.board,this.time,this.grouping).fetch(),this.switchTabs()},switchTabs:function(){"speed"==this.board?(this.$(".tab-filters li").fastShow(!0),this.$("#time-season").parent().fastHide()):"hof"==this.board?this.$(".tab-filters li").fastHide():(this.$("#time-season").parent().fastShow(!0),this.$(".tab-filters li").fastShow(!0)),this.$(".tabs li,.tab-filters li").removeClass("active"),this.$("#tab-"+this.grouping+"-"+this.board).parent().addClass("active"),this.$("#time-"+this.time).parent().addClass("active")}})}),define("scoreboard/views/ranking",["require","templates"],function(a){"use strict";var b=a("templates"),c=Backbone.View.extend({events:{"click .js-see-rewards":"seeRewards","change select[name=seasonID]":"changeSeason"},minRequirements:{racer:{daily:6,weekly:15,monthly:30,season:20},teams:{daily:50,weekly:150,monthly:300,season:200}},initialize:function(a){this.seasons=a.seasons,this.currentSeason=a.currentSeason,void 0===this.template&&(this.template=b("scoreboard","ranking")),this.listenTo(this.model,"reset",this.render)},render:function(){var a=this.model.rankingsModel.toJSON();switch(a.board){case"speed":a.scoreDesc="WPM";break;case"played":a.scoreDesc="races";break;case"points":a.scoreDesc="points"}a.grouping&&(a.minReqs=this.minRequirements[a.grouping][a.time]),this.$el.html(this.template({data:a,seasons:this.seasons.toJSON(),season:this.currentSeason?this.currentSeason.toJSON():{}}))},changeSeason:function(a){this.trigger("change-season",$(a.currentTarget).val())},seeRewards:function(a){$(a.currentTarget).addClass("is-open"),$(".seasons-rewardsLink").fastHide()}});return c}),define("global/models/season",["require"],function(a){"use strict";return Backbone.Model.extend({idAttribute:"seasonID",defaults:{name:""}})}),define("global/collections/seasons",["require","global/models/season"],function(a){"use strict";var b=a("global/models/season");return Backbone.Collection.extend({model:b,comparator:"startStamp"})}),define("scoreboard/index",["require","scoreboard/views/navigation","scoreboard/views/ranking","global/views/player_hover","global/views/scoreboard_table","scoreboard/collections/data","global/collections/seasons","global/models/season","registry"],function(a){"use strict";var b=a("scoreboard/views/navigation"),c=a("scoreboard/views/ranking"),d=a("global/views/player_hover"),e=a("global/views/scoreboard_table"),f=a("scoreboard/collections/data"),g=a("global/collections/seasons"),h=a("global/models/season"),i=a("registry");return Backbone.View.extend({el:"#app",initialize:function(){this.player=i.get("player"),this.dataColl=new f,this.listenTo(this.dataColl,"request",this.showLoader),this.listenTo(this.dataColl,"reset",this.hideLoader),this.seasons=new g(NTGLOBALS("SEASONS").map(function(a){return a.rewards=JSON.parse(a.rewards),a})),this.currentSeason=new h(this.getCurrentSeason().toJSON()),this.playerHover=new d,this.navigation=new b({model:this.dataColl}),this.ranking=new c({model:this.dataColl,seasons:this.seasons,currentSeason:this.currentSeason}),this.listenTo(this.ranking,"change-season",this.changeSeason),this.table=new e({model:this.dataColl,hover:this.playerHover,headers:!0}),this.render(),this.dataColl.fetch()},render:function(){this.$(".navigation").append(this.navigation.el),this.showLoader(),this.$(".scoreboard-content").append(this.ranking.el).append(this.table.el)},getCurrentSeason:function(a){if(a>0)return this.seasons.get(a);var b=NTGLOBALS("CURRENT_SEASON");return b?this.seasons.get(NTGLOBALS("CURRENT_SEASON").seasonID):this.seasons.find({started:0})},changeSeason:function(a){this.currentSeason.set(this.getCurrentSeason(a).toJSON()),this.dataColl.setOptions(null,null,null,a),this.dataColl.fetch()},showLoader:function(){this.$(".scoreboard-content").hide(),this.$(".loading-box").show()},hideLoader:function(){this.$(".loading-box").hide(),this.$(".scoreboard-content").show()}})}),define("news/index",["require"],function(a){"use strict";var b=Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){}});return b}),define("news/models/comment",["require"],function(a){"use strict";return Backbone.Model.extend({idAttribute:"blogCommentID",delete:function(){return $.post("/api/news-comments/"+this.id+"/delete")},approve:function(){return $.post("/api/news-comments/"+this.id+"/approve")},deleteAndModerate:function(a){var b={};return a&&(b.ban=1),$.post("/api/news-comments/"+this.id+"/delete-and-moderate",b)},edit:function(){}})}),define("news/collections/comments",["require","news/models/comment","registry"],function(a){"use strict";var b=a("news/models/comment"),c=a("registry");return Backbone.Collection.extend({model:b,initialize:function(){this.isModerator=c.get("player").get("moderator")},comparator:function(a,b){if(this.isModerator){if(!a.get("approved")&&b.get("approved"))return 1;if(a.get("approved")&&!b.get("approved"))return-1}return a.get("createdStamp")>b.get("createdStamp")?1:-1},getOffset:function(a){return a==this.length?0:a-this.length},fetchUnapproved:function(a){$.get("/api/news/"+a+"/unapproved").done(function(a){a.success&&a.data&&a.data.length&&this.add(a.data)}.bind(this))}})}),define("news/models/comment_edit_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/news-comments/"+this.get("blogCommentID")+"/edit"},defaults:{comment:null},validationRules:{comment:{maxlength:2e3}},validationMessages:{}})}),define("news/views/comment_edit_box",["require","templates","analytics","news/models/comment_edit_form","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("news/models/comment_edit_form"),e=a("shared/classes/form_validation"),f=a("registry");return Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=b("news","comment_edit_box")),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),allowComments:NTGLOBALS("ALLOW_COMMENTS"),player:f.get("player").toJSON()})),new e(this.$("form"),this.$(".button"),new d,this.postComment,this)},postComment:function(){c.trackEvent("Blog","CommentEdit"),this.$el.velocity("slideUp",function(){this.$el.html("Your comment edit has been submitted for moderation and will appear shortly.").velocity("fadeIn")}.bind(this))}})}),define("news/views/comments",["require","templates","global/views/report_user","registry","global/models/car","news/views/comment_edit_box","shared/classes/pixastic"],function(a){"use strict";var b=a("templates"),c=a("global/views/report_user"),d=a("registry"),e=a("global/models/car"),f=a("news/views/comment_edit_box");a("shared/classes/pixastic");var g=Backbone.View.extend({events:{"click .delete-post":"deletePost","click .moderate-post":"moderatePost","click .approve-post":"approvePost","click .reply-to":"replyToPost","click .report-user a":"reportPost","click .edit-post":"editPost"},initialize:function(a){this.commentCount=a.commentCount,this.player=d.get("player"),void 0===this.template&&(this.template=b("news","comments")),this.model.isModerator&&this.model.fetchUnapproved(a.id),this.listenTo(this.model,"add",this.render),this.reportUser=new c({player:this.player}),this.listenTo(this.reportUser,"reported",this.playerReported),this.render()},render:function(){this.$el.html(this.template({loggedIn:NTGLOBALS("LOGGED_IN"),countries:NTGLOBALS("COUNTRIES"),CarModel:e,friends:d.get("playerFriends"),allowComments:NTGLOBALS("ALLOW_COMMENTS"),comments:this.model.toJSON(),offset:this.model.getOffset(NTGLOBALS("COMMENT_COUNT")),player:d.get("player"),view:this,top3:d.get("top3Players")}))},formatComment:function(a){return a.replace(/(@\S+)\s+|(@\S+)$/gm,function(a){return'<span class="reply">'+a+"</span>"}).replace(/\n/gm,"<br />\n")},formatDate:function(a){var b=moment(new Date(1e3*a));return b.format("YYYY-MM-DD")==b.format("YYYY-MM-DD")?b.format("h:mma"):b.format("M/D/YY h:mma")},getModelByEvent:function(a){return this.model.get(this.getCommentByEvent(a).data("id"))},getCommentByEvent:function(a){return this.$(a.currentTarget).parents("div.comment")},deletePost:function(a){var b=this.getModelByEvent(a);return b.delete().done(function(b){b.success?this.getCommentByEvent(a).velocity("fadeOut"):alert("ERROR: "+b.data.message)}.bind(this)),!1},moderatePost:function(a){var b=this.getModelByEvent(a),c=!1;return $(a.currentTarget).hasClass("ban")&&(c=!0),b.deleteAndModerate(c).done(function(b){b.success?this.getCommentByEvent(a).velocity("fadeOut"):alert("ERROR: "+b.data.message)}.bind(this)),!1},approvePost:function(a){var b=this.getModelByEvent(a);return b.approve().done(function(b){b.success?this.getCommentByEvent(a).velocity("fadeOut"):alert("ERROR: "+b.data.message)}.bind(this)),!1},replyToPost:function(a){var b=this.getModelByEvent(a),c="";this.player.get("lastComment")>(new Date).getTime()/1e3-900&&$("#comment-message").highlight(),b.get("teamID")&&(c="["+b.get("tag")+"]"),c+=b.get("displayName")?b.get("displayName"):b.get("username"),$("textarea[name=comment]").focus().val($("textarea[name=comment]").val()+"@"+c)},reportPost:function(a){return this.reportUser.show(a,this.getModelByEvent(a).id),!1},playerReported:function(){this.$(".report-player").velocity("fadeOut",function(){$(this).html("Reported. Thanks!").velocity("fadeIn")})},editPost:function(a){var b=this.getModelByEvent(a);return new f({model:b,el:this.getCommentByEvent(a).find(".comment-text")}),$(a.target).hide(),!1}});return g}),define("news/models/comment_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return"/api/news/"+this.get("newsId")+"/comment"},defaults:{comment:null},validationRules:{comment:{required:!0,maxlength:2e3}},validationMessages:{}})}),define("news/views/comment_box",["require","templates","analytics","news/models/comment_form","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("news/models/comment_form"),e=a("shared/classes/form_validation"),f=a("registry");return Backbone.View.extend({initialize:function(a){this.newsId=a.id,void 0===this.template&&(this.template=b("news","comment_box")),this.render()},render:function(){this.$el.html(this.template({newsId:this.newsId,allowComments:NTGLOBALS("ALLOW_COMMENTS"),player:f.get("player").toJSON(),loggedIn:NTGLOBALS("LOGGED_IN")})),new e(this.$("form"),this.$(".button"),new d,this.postComment,this)},postComment:function(){c.trackEvent("Blog","Comment"),this.$el.velocity("slideUp",function(){this.$el.html("Thanks for joining the conversation!  Your post will display shortly.").velocity("fadeIn"),f.get("player").set({lastComment:(new Date).getTime()/1e3}),f.get("player").inc({totalComments:1})}.bind(this))}})}),define("news/read",["require","news/collections/comments","news/views/comments","news/views/comment_box","registry"],function(a){"use strict";var b=a("news/collections/comments"),c=a("news/views/comments"),d=a("news/views/comment_box"),e=a("registry");return Backbone.View.extend({el:"#app",initialize:function(a){this.player=e.get("player");var f=a.newsId,g=new b(NTGLOBALS("COMMENTS"));this.comments=new c({model:g,id:f}),this.commentBox=new d({id:f}),this.render()},render:function(){this.$(".num-comments .num").html(NTGLOBALS("COMMENT_COUNT")),this.player.get("level")<20&&this.$(".add-comment").hide(),this.$(".comments").append(this.comments.el),this.$(".leave-comment").append(this.commentBox.el)}})}),define("stats/index",["require","registry","global/views/stats"],function(a){"use strict";var b=a("registry"),c=a("global/views/stats");return Backbone.View.extend({el:"#app",initialize:function(){this.stats=new c({model:b.get("player")}),this.render()},render:function(){this.$el.prepend(this.stats.el);var a=$("#midAd");a.length&&this.$("#midAdPosition").append(a)}})}),define("racelog/collections/data",["require"],function(a){"use strict";return Backbone.Collection.extend({currentPage:0,pageSize:30,totalRecords:0,fetch:function(a,b,c){return b=b||0,c=c||30,this.currentPage=b,this.pageSize=c,$.get("/api/stats/data/"+a+"?page="+b+"&limit="+c).done(function(a){a.success&&(this.totalRecords=a.data.totalRecords,this.reset(a.data.logs))}.bind(this))}})}),define("race/models/racer",["require","registry","shared/classes/typing","shared/classes/levels"],function(a){"use strict";var b=a("registry"),c=a("shared/classes/typing"),d=a("shared/classes/levels");return Backbone.Model.extend({idAttribute:"userID",defaults:{completeStamp:0,joinStamp:0,disqualified:!1,guest:!1,robot:!1,position:0,typed:0,errors:0,seconds:0,skipped:0,nitrosAvailable:0,nitros:0,nitrosUsed:0,profile:null,rewards:null},save:function(a){if(this.race=a,!NTGLOBALS("LOGGED_IN"))return this.saveGuest();var e=this.toJSON(),f=b.get("player"),g=a.racers.getPlace(this.id),h=(e.completeStamp-e.startStamp)/1e3;this.logProblemKeys();var i={money:e.rewards.money,experience:e.rewards.experience,level:d.levelForExperience(f.get("experience")+e.rewards.experience)>f.get("level")?1:0,nitros:e.rewards.nitros-e.nitrosUsed,placed1:1===g?1:0,placed2:2===g?1:0,placed3:3===g?1:0,racesPlayed:1,playTime:Math.ceil(h),nitrosUsed:e.nitrosUsed,wampusWins:e.rewards.bonuses.wampus?1:0};e.rewards.session?i.sessionRaces=1:f.set({sessionRaces:1}),"holiday"==NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(b.get("player").get("carID"))!=-1?(i.seasonField1=1,i.seasonField2=1,i.seasonField3=e.nitrosUsed):"summer"==NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(b.get("player").get("carID"))!=-1?(i.seasonField1=1,i.seasonField2=1,i.seasonField3=e.nitrosUsed):"halloween"==NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(b.get("player").get("carID"))!=-1&&(i.seasonField1=1),1===g?i.consecWins=1:i.consecWins=-1*f.get("consecWins"),f.inc(i);var j=[];f.get("lastRaces")&&(j=f.get("lastRaces").split("|").map(function(a){var b=a.split(",");return{typed:parseInt(b[0],10),seconds:parseInt(b[1],10),errors:parseInt(b[2],10)}})),j.push({typed:e.typed-e.skipped,seconds:Math.round(h),errors:e.errors}),j=j.slice(-10);var k=j.reduce(function(a,b){return{typed:a.typed+b.typed,seconds:a.seconds+b.seconds,errors:a.errors+b.errors}},{typed:0,seconds:0,errors:0}),l=c.speed(k.typed,k.seconds),m=c.accuracy(k.typed,k.errors,2),n=j.map(function(a){return a.typed+","+a.seconds+","+a.errors}).join("|"),o=Math.ceil(Date.now()/1e3),p=parseInt(f.get("tzOffset")||0,10),q=parseInt(f.get("lastConsecRace"),10),r=parseInt(f.get("consecDaysRaced"),10),s=o-o%86400-p,t=q-q%86400-p;s-t==86400?r++:s-t>86400&&(r=1),f.set({avgSpeed:l,avgAccuracy:m,lastRaces:n,newHighSpeed:c.speed(e.typed-e.skipped,h)>f.get("highestSpeed")?1:0,highestSpeed:Math.max(f.get("highestSpeed"),c.speed(e.typed-e.skipped,h)),longestSession:Math.max(f.get("sessionRaces"),f.get("longestSession")),lastConsecRace:o,consecDaysRaced:r,raceLogs:null})},saveQualifying:function(a,d){var e=b.get("player"),f=c.speed(this.get("typed"),(this.get("completeStamp")-this.get("startStamp"))/1e3);return NTGLOBALS("LOGGED_IN")?$.post("/api/race/save-qualifying",{speed:f,carID:d.carID}).done(function(a){a.success&&(e.addCar(d.carID),e.set({carID:d.carID,avgSpeed:f}),e.inc({money:1e4}))}):(e.set({avgSpeed:f}),$.Deferred().resolve({success:!0}))},saveGuest:function(){var a=b.get("player"),d=this.toJSON(),e=c.speed(d.typed-d.skipped,(d.completeStamp-d.startStamp)/1e3);a.set({avgSpeed:e})},logProblemKeys:function(){var a=this.toJSON(),b={ak:JSON.stringify(this.get("allKeys")),ek:JSON.stringify(this.get("errorKeys"))};$("#"+rot47("3@EA")+rot47("2?6=")).length>0&&(b.hx="3@EA2?6="),b.std=this.race.std,b.speed=c.speed(a.typed,(a.completeStamp-a.startStamp)/1e3),b.acc=c.accuracy(a.typed,a.errors,2),b.co=document.co,b.std<=50&&$.post("/api/race/problem-keys",b)},savePractice:function(){if(NTGLOBALS("LOGGED_IN")){var a=b.get("player"),c=this.toJSON();$.post("/api/race/log-practice",{secs:Math.ceil((c.completeStamp-c.startStamp)/1e3),errors:c.errors,typed:c.typed}).done(function(){a.inc({practices:1})})}},getAccuracy:function(){return c.accuracy(this.get("typed"),this.get("errors"),2)}})}),define("race/collections/racers",["require","race/models/racer"],function(a){"use strict";var b=a("race/models/racer");return Backbone.Collection.extend({comparator:function(a,b){return a.attributes.disqualified&&!b.attributes.disqualified?1:b.attributes.disqualified&&!a.attributes.disqualified?-1:a.attributes.completeStamp&&!b.attributes.completeStamp?-1:b.attributes.completeStamp&&!a.attributes.completeStamp?1:a.attributes.completeStamp&&b.attributes.completeStamp?a.attributes.completeStamp<b.attributes.completeStamp?-1:1:a.attributes.position==b.attributes.position?0:a.attributes.position>b.attributes.position?-1:1},model:b,getPlace:function(a){return this.sort(),this.indexOf(this.get(a))+1}})}),define("race/models/race",["require","race/collections/racers","registry"],function(a){"use strict";var b=a("race/collections/racers"),c=a("registry"),d=Backbone.Model.extend({idAttribute:"raceID",defaults:{track:"",music:"",completeStamp:0,startStamp:0,status:"",countdown:0,lessonID:0,lesson:"",nitros:0,lastCallStamp:0,callSpeed:250},self:null,racers:null,logs:[],log:function(a,b){var c;try{c=this.realtime.transport.transports.indexOf("websocket")==-1?"polling":"websocket"}catch(a){}this.logs.push({event:a,stamp:Date.now(),transport:c,data:b})},initialize:function(){this.racers=new b,this.realtime=c.get("realtime"),this.realtime.on("end",this.connectionEnd.bind(this)),this.realtime.on("reconnect failed",this.connectionEnd.bind(this)),this.realtime.on("reconnect",function(){this.reconnect()}.bind(this))},join:function(a,b){b=b||{},this.raceJoinOptions=b,this.self=a,b.fake?this.fakeRace():(this.listenTo(this.self,"change",this.trackChanges),this.sendUpdates(),this.log("send:join",b),this.realtime.raceJoin(b).on("data",this.receiveUpdates.bind(this)))},beginFriendRace:function(){this.set({startFriendRace:!0}),this.log("send:beginFriendRace"),this.realtime.raceBeginFriendRace()},raceChanges:{},trackChanges:function(a){this.self.changed.nitrosUsed&&(this.raceChanges.n=a.changed.nitrosUsed),this.self.changed.typed&&(this.raceChanges.t=a.changed.typed),this.self.changed.errors&&(this.raceChanges.e=a.changed.errors),this.self.changed.skipped&&(this.raceChanges.s=a.changed.skipped),this.raceChanges.n>0&&this.sendUpdates()},sendUpdates:function(){if(Object.keys(this.raceChanges).length>0&&(this.log("send:update",this.raceChanges),this.realtime.raceUpdate(this.raceChanges),this.raceChanges={}),this.get("startStamp")>0&&(Date.now()-this.get("startStamp"))/1e3>20&&this.self.getAccuracy()>0&&this.self.getAccuracy()<50)return void this.trigger("error",{type:"accuracy",accuracy:this.self.getAccuracy()});if(!this.self.get("completeStamp")){var a=500;setTimeout(this.sendUpdates.bind(this),a)}},receiveUpdates:function(a){if("race"==a.stream){this.log("receive:"+a.msg,a.payload);var b=performance.now();switch(this.set({callSpeed:b-this.get("lastCallStamp"),lastCallStamp:b}),a.msg){case"error":this.error(a.payload);break;case"setup":this.setUp(a.payload);break;case"joined":this.addRacer(a.payload);break;case"left":a.payload==this.self.id?this.disqualifyRacer():this.removeRacer(a.payload);break;case"disqualified":this.disqualifyRacer();break;case"status":this.changeStatus(a.payload);break;case"update":this.racerUpdates(a.payload)}}},setUp:function(a){this.set(a),a.racers&&a.racers.forEach(function(a){this.addRacer(a)}.bind(this))},changeStatus:function(a){var b=["l","lesson","","join","reverse","split"];a[b[0]]&&(a[b[1]]=rot47(a[b[0]])[b[5]](b[2])[b[4]]()[b[3]](b[2]),delete a[b[0]]),"racing"==a.status?this.racers.each(function(b){b.set({startStamp:a.startStamp})}):"countdown"==a.status&&this.beginCountdown(),this.set(a)},beginCountdown:function(){this.countdownStart=performance.now(),this.countdownTimer()},countdownTimer:function(){if(0!==this.get("countdown")){if("racing"==this.get("status"))return void this.set({countdown:0});var a=performance.now();return a-this.countdownStart>=1e3&&(this.countdownStart+=a-this.countdownStart,this.inc({countdown:-1})),requestAnimFrame(this.countdownTimer.bind(this))}},addRacer:function(a){a.nitros=a.nitrosAvailable,this.racers.add(a)},removeRacer:function(a){this.racers.remove(a)},disqualifyRacer:function(){this.self.set({disqualified:!0}),console.warn("You have been disqualified")},error:function(a){this.trigger("error",a)},racerUpdates:function(a){a.racers.forEach(this.updateRacer.bind(this)),this.set({lastUpdate:this.get("startStamp")+a.secs,racerChanges:a.racers,seconds:a.secs/1e3}),this.racers.sort()},updateRacer:function(a){a.id=a.u,a.t&&(a.typed=a.t,a.position=a.t/this.attributes.lesson.length),a.n&&(a.nitrosUsed=a.n),a.d&&(a.disqualified=a.d),a.c&&(a.completeStamp=a.c),a.e&&(a.errors=a.e),a.s&&(a.skipped=a.s),a.r&&(a.rewards=a.r);var b=this.racers.get(a.u);b&&(b.set(a),a.u==this.self.id&&(a.c||a.r)&&this.self.set(this.racers.get(a.u).toJSON()))},reconnect:function(){!this.get("id")||this.self.get("disqualified")||this.self.get("completeStamp")||this.self.get("rewards")||this.self.get("error")||(console.log("Reconnect occurred"),this.realtime.raceReJoin(this.raceJoinOptions))},connectionEnd:function(a){this.trigger("error",{type:"closed",message:a&&a.message||null,stack:a&&a.stack||null})},disconnectError:function(){}});return d}),define("global/views/race_results",["require","templates","shared/classes/typing","global/models/car","registry","global/views/experience_bar","global/models/player","shared/classes/levels"],function(a){"use strict";var b=a("templates"),c=a("shared/classes/typing"),d=a("global/models/car"),e=a("registry"),f=a("global/views/experience_bar"),g=a("global/models/player"),h=a("shared/classes/levels");return Backbone.View.extend({events:{"click .close-button":"hide","click .racer":"clickRow","click .button-race":"raceAgain","mouseenter .racer":"showPlayerPopup","mouseleave .racer":"hidePlayerPopup"},initialize:function(a){void 0===this.template&&(this.template=b("global","race_results"),this.templateRacers=b("global","race_results_racers")),this.replay=a.replay,this.practice=a.practice,this.player=e.get("player"),this.racers=a.model.racers,this.hover=a.hover,this.replay||$(document).bind("keypress.rerace",this.handleEnterKey.bind(this)),this.render(),this.listenTo(this.model,"change",this.renderRacers)},render:function(){var a=this.racers.get(this.player.id).toJSON();a.place=this.racers.getPlace(this.player.id),a.rewards||(a.rewards={bonuses:{}}),2!=this.model.get("version")&&(a.rewards={},a.rewards.bonuses={place:a.money},a.rewards.experience=a.exp,a.rewards.nitros=a.nitros,a.rewards.money=a.money,this.racers.where({robot:"wampus"}).length&&a.place<this.racers.getPlace(this.racers.where({robot:"wampus"})[0].id)&&(a.rewards.bonuses.wampus=5e4,a.rewards.bonuses.place-=a.rewards.bonuses.wampus));var b=4;a.rewards.bonuses.wampus&&b++,a.rewards.bonuses.goldWords&&b++,a.rewards.bonuses.test&&b++,(NTGLOBALS("SPECIAL_EVENT")&&!this.replay||a.rewards.bonuses.event)&&b++,this.$el.hide().html(this.template({replay:this.replay,practice:this.practice,race:this.model.toJSON(),racer:a,racers:this.racers.toJSON(),player:this.player.toJSON(),speed:c.speed,accuracy:c.accuracy,rewardRows:b})),this.replay||(this.experienceBar=new f({width:445,el:this.$(".experience-bar"),level:h.levelForExperience(this.player.get("experience")-a.rewards.experience),experience:this.player.get("experience")-a.rewards.experience,loggedOut:!NTGLOBALS("LOGGED_IN")})),this.racersEle=this.$(".racers"),this.renderRacers(),$("body").append(this.el)},renderRacers:function(){this.racersEle.html(this.templateRacers({racers:this.racers.toJSON(),player:this.player.toJSON(),seconds:this.model.get("seconds"),top3:e.get("top3Players"),friends:e.get("playerFriends"),speed:c.speed,accuracy:c.accuracy,carTag:d.imageTag,countries:NTGLOBALS("COUNTRIES")}))},animateRewards:function(){this.replay||this.practice||(this.$(".current-cash .amount").countdown(this.player.get("money"),{formatter:function(a){return"$"+a.addCommas()}}),this.experienceBar.animateTo(this.player.get("experience")))},show:function(a,b){a&&this.$(".popup").css({top:Math.max(20,a-575)}),b?this.$el.velocity("fadeIn",this.animateRewards.bind(this)):(this.$el.show(),this.animateRewards())},hide:function(){return this.$el.hide(),this.trigger("hide"),!1},clickRow:function(a){var b=$(a.currentTarget);return b.hasClass("wampus")?(location.href="/racer/wampus",!1):!b.hasClass("guest")&&!b.hasClass("robot")&&(location.href="/racer/"+this.racers.get(b.data("id")).get("profile").username,!1)},showPlayerPopup:function(a){if(!this.hover)return!1;var b,c=$(a.currentTarget).data("id"),d=this.racers.findWhere({userID:c});if(!d)return!1;var e=d.get("profile");return e.userID=d.id,b=new g(e),this.hover.show(a.currentTarget,b,300,d.get("robot")),!1},hidePlayerPopup:function(a){return this.hover&&this.hover.hide(a),!1},handleEnterKey:function(a){if(!$(a.target).is("input"))return 13==a.which?($(document).unbind("keypress.rerace"),this.raceAgain()):void 0},raceAgain:function(){return location.reload(),!1}})}),define("racelog/views/table",["require","shared/classes/typing","race/models/race","global/models/player","global/views/race_results","templates"],function(a){"use strict";var b=a("shared/classes/typing"),c=a("race/models/race"),d=a("global/models/player"),e=a("global/views/race_results"),f=a("templates");return Backbone.View.extend({type:"racelog",events:{"click tbody tr":"clickRow"},initialize:function(a){void 0===this.template&&(this.template=f("racelog","table")),this.type=a.type||this.type,this.listenTo(this.model,"reset",this.render),this.render()},dateFormat:function(a,b){var c=moment(new Date(1e3*a));return"racelog"==b?c.format("MM/DD/YY hh:mma"):"lastdays"==b?c.format("MM/DD/YY"):"bymonth"==b?c.format("MMM/YY"):void 0},placeFormat:function(a,b,c){return"racelog"==c?a+a.ordinal():(a/b*10/10).toFixed(2)+" / 5"},monthFormat:function(a,b){var c=moment(new Date(b,a-1,1));return c.format("MMM, YYYY")},secondsFormat:function(a){var b,c;return a>60?(b=Math.floor(a/60),c=b+" min"+(1==b?"":"s")):c=a+" secs",c},render:function(){this.$el.html(this.template({data:this.model.toJSON(),type:this.type,pageSize:this.model.pageSize,totalRecords:this.model.totalRecords,currentPage:this.model.currentPage,dateFormat:this.dateFormat,placeFormat:this.placeFormat,secondsFormat:this.secondsFormat,monthFormat:this.monthFormat,speed:b.speed,accuracy:b.accuracy}))},clickRow:function(a){if("racelog"!=this.type)return!1;var b=$(a.currentTarget).data("id");return b!=this.lastRace&&(this.lastRace=b,this.fetchSavedRace(b).done(function(b){this.resultsView&&this.resultsView.remove(),this.resultsView=new e({destroy:!0,replay:!0,model:b}),this.resultsView.on("hide",function(){this.resultsView.remove(),this.lastRace=null},this),this.resultsView.show(a.pageY)}.bind(this)).fail(function(a){alert(a)}),!1)},fetchSavedRace:function(a){var b=$.Deferred();return $.get("/api/race/"+a).done(function(a){if(a.success){var e=new c(_.pick(a.data,["status","completeStamp","startStamp","lessonID","version"]));e.racers.reset(_.map(a.data.racers,function(a){return a.guest||a.robot||(a.userID=Number(a.userID)),a.seconds=(a.completeStamp-a.startStamp)/1e3,a.profile.wampus&&(a.robot="wampus"),a.profile=new d(a.profile).toJSON(),a})),a.data.rewards&&_.each(a.data.rewards,function(a){e.racers.get(a.userID).set(_.omit(a,["userID"]))}),b.resolve(e)}else b.reject("Unable to fetch race "+a.data.message)}),b}})}),define("racelog/views/pager",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({pages:1,pageSize:30,currentPage:0,events:{"click a":"handleClick"},initialize:function(a){void 0===this.template&&(this.template=b("racelog","pager")),this.pageSize=a.pageSize||this.pageSize,this.listenTo(this.model,"reset",this.setPages),this.render()},render:function(){this.$el.html(this.template({pages:this.pages}))},setPages:function(){var a=Math.ceil(this.model.totalRecords/this.pageSize);a!=this.pages&&(this.pages=a,this.render())},handleClick:function(a){var b=$(a.target).data("index");return b!=this.currentPage&&("next"==b&&(b=this.currentPage+1),!(b+1>this.pages)&&(this.currentPage=b,this.$("a").removeClass("active"),this.$("a[data-index="+this.currentPage+"]").addClass("active"),this.trigger("change",this.currentPage),!1))}})}),define("racelog/index",["require","registry","racelog/collections/data","racelog/views/table","racelog/views/pager","stats/views/racelog_graph","shared/classes/typing","stats/views/daily_graph","stats/views/monthly_graph"],function(a){
"use strict";var b=a("registry"),c=a("racelog/collections/data"),d=a("racelog/views/table"),e=a("racelog/views/pager"),f=a("stats/views/racelog_graph"),g=a("shared/classes/typing"),h=a("stats/views/daily_graph"),i=a("stats/views/monthly_graph");return Backbone.View.extend({el:"#app",daysBack:30,pageSize:30,type:"racelog",initialize:function(a){this.type=a.type||this.type,this.player=b.get("player"),"gold"==this.player.get("membership")&&(this.daysBack=90),this.model=new c,this.listenTo(this.model,"reset",this.changePage),this.pagerView=new e({model:this.model,pageSize:this.pageSize}),this.listenTo(this.pagerView,"change",this.fetchPage),"racelog"==this.type?this.graphView=new f({width:735,height:198}):"lastdays"==this.type?this.graphView=new h({width:735,height:198}):this.graphView=new i({width:735,height:198}),this.tableView=new d({model:this.model,type:this.type}),this.render(),this.fetchPage(0)},render:function(){var a="";switch(this.type){case"bymonth":a="Monthly Stats";break;case"lastdays":a="Daily Stats (Last "+this.daysBack+" Days)";break;case"racelog":a="Race Logs (Last "+this.daysBack+" Days)"}this.$(".section-header").html(a),this.$(".export").attr("href","/api/stats/data/"+this.type+"?export=1"),this.$(".pages").append(this.pagerView.el),this.$(".graph").append(this.graphView.el),this.$(".table").append(this.tableView.el)},changePage:function(){var a=_.map(this.model.toJSON(),function(a){var b;return"bymonth"==this.type?(b=moment(new Date(a.year,a.month-1,1)),a.label=b.format("MMM, YYYY"),a.place=(a.placed/a.races*10/10).toFixed(2)+"/5"):"racelog"==this.type?(b=moment(new Date(1e3*a.stamp)),a.label=b.format("MMM D, YYYY"),a.place=a.placed):"lastdays"==this.type&&(b=moment(new Date(1e3*a.stamp)),a.label=b.format("MM/DD/YY"),a.place=(a.placed/a.races*10/10).toFixed(2)+"/5"),a.money=a.reward.money,a.value=g.speed(a.typed,a.secs),a}.bind(this)).reverse();this.graphView.setData(a),this.graphView.render()},fetchPage:function(a){this.model.fetch(this.type,a,this.pageSize).done(function(a){a.success||alert("There was an error fetching your data: "+a.data.message)})}})}),define("race/models/practice_race",["require","race/collections/racers","registry"],function(a){"use strict";var b=a("race/collections/racers"),c=a("registry");return Backbone.Model.extend({idAttribute:"raceID",defaults:{track:"",music:"",completeStamp:0,startStamp:0,status:"",countdown:0,lessonID:0,nitros:0,practice:!0},self:null,racers:null,initialize:function(){this.racers=new b},join:function(a){this.self=a,this.listenTo(this.self,"change:typed",this.racerUpdates),this.listenTo(this.self,"change:errors",this.racerUpdates),this.sendUpdates(),$.get("/api/race/practice-lesson").done(function(a){a.success?(this.begin(),this.countdown(a.data.lesson,3)):alert("There was an error fetching a practice lesson")}.bind(this))},begin:function(){var a=c.get("player");this.setUp({status:"open",racers:[{userID:a.id,profile:a.toJSON()}]})},countdown:function(a,b){this.changeStatus({status:"countdown",lesson:a}),this.updateCountdown(b);var c=setInterval(function(){var a=this.get("countdown");this.updateCountdown(a-1),0===this.get("countdown")&&(clearInterval(c),this.changeStatus({status:"racing"}))}.bind(this),1e3)},setUp:function(a){this.set(a),a.racers&&a.racers.forEach(function(a){this.addRacer(a)}.bind(this))},changeStatus:function(a){if("racing"==a.status){var b=Date.now();a.startStamp=b,this.racers.each(function(a){a.set({startStamp:b})}),this.raceUpdate()}this.set(a)},updateCountdown:function(a){this.set({countdown:a})},addRacer:function(a){this.racers.add(a)},raceUpdate:function(){this.racers.at(0).set({update:Date.now()}),this.racers.at(0).get("completeStamp")||setTimeout(this.raceUpdate.bind(this),500)},raceChanges:{},racerUpdates:function(a){var b=a.changed;b.typed&&(this.raceChanges.typed=b.typed),b.errors&&(this.raceChanges.errors=b.errors)},sendUpdates:function(){this.get("lesson")&&(this.raceChanges.typed||this.raceChanges.errors)&&(this.raceChanges.typed&&(this.raceChanges.position=this.raceChanges.typed/this.get("lesson").length),1==this.raceChanges.position&&(this.raceChanges.completeStamp=Date.now(),this.raceChanges.rewards=!0,this.set({completeStamp:this.raceChanges.completeStamp})),this.raceChanges.id=this.self.id);var a=Date.now(),b=(a-this.get("startStamp"))/1e3,c=a-this.get("lastCallStamp"),d={lastUpdate:a,seconds:b,lastCallStamp:a,callSpeed:c};this.get("startStamp")||(d.seconds=0),Object.keys(this.raceChanges).length>0&&(this.racers.at(0).set(this.raceChanges),this.self.set(this.racers.at(0).toJSON()),d.racerChanges=[this.raceChanges]),this.set(d),this.raceChanges={},this.get("completeStamp")||setTimeout(this.sendUpdates.bind(this),1e3)}})}),define("race/models/qualifying_race",["require","race/models/practice_race","registry"],function(a){"use strict";var b=a("race/models/practice_race");a("registry");return b.extend({lesson:"By typing this text you are setting your qualifying typing speed.",join:function(a){this.self=a,this.listenTo(this.self,"change:typed",this.racerUpdates),this.listenTo(this.self,"change:errors",this.racerUpdates),this.sendUpdates(),this.begin()},beginCountdown:function(){this.countdown(this.lesson,4)}})}),define("race/views/invite",["require","global/views/modal","analytics","registry","global/models/car","friends/collections/friends","templates"],function(a){"use strict";var b=a("global/views/modal"),c=(a("analytics"),a("registry")),d=a("global/models/car"),e=a("friends/collections/friends"),f=a("templates");return b.extend({_initialize:function(){void 0===this.template&&(this.template=f("race","invite")),this.player=c.get("player"),this.delegateEvents(_.extend(this.events,{"click .tabs li":"clickTab","click .friend":"clickFriend","click .send-invites":"sendInvites"})),this.model=new e,this.model.onlineOnly=!0,this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"request",this.showSpinner),this.render(),this.model.fetch(0),this.inited=!0},render:function(){this.$el.append(this.template({data:this.model.toJSON(),player:this.player.toJSON(),carTag:d.imageTag})),this.hideSpinner()},showSpinner:function(){this.$(".friends").fastHide(),this.$(".spinner").fastShow()},hideSpinner:function(){this.$(".friends").fastShow(),this.$(".spinner").fastHide()},show:function(){return this.inited||this._initialize(),b.prototype.show.apply(this,arguments)},clickFriend:function(a){return $(a.currentTarget).toggleClass("active"),!1},clickTab:function(a){var b=$(a.currentTarget);if(b.hasClass("active"))return!1;var c=$(a.currentTarget).hasClass("others")?"others":"online";return this.$(".tabs li").removeClass("active"),b.addClass("active"),"others"==c?(this.$(".online-friends").fastHide(),this.$(".invite-others").velocity("fadeIn")):(this.$(".invite-others").fastHide(),this.$(".online-friends").velocity("fadeIn")),!1},sendInvites:function(a){var b=this.$(".friend.active"),d=_.map(b,function(a){return $(a).data("id")});return!!d.length&&(c.get("realtime").raceInvites(d),b.addClass("sending"),$(a.currentTarget).fastHide(),this.$(".invites-sent").fastShow(),setTimeout(function(){this.hide(),b.removeClass("sending active"),$(a.currentTarget).fastShow(),this.$(".invites-sent").fastHide()}.bind(this),3e3),!1)}})}),define("global/views/filtered_select",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({className:"response-container",selectOptions:{},filter:"",text:"",events:{"click .selected-response":"toggleOptions","keyup .search-input":"keyInput","click li":"clickOption"},initialize:function(a){this.options=a,this.template=b("global","filtered_select"),this.selectOptions=a.selectOptions,this.select=$(a.select),this.render()},render:function(){this.$el.append(this.template()),this.selectedEle=this.$(".selected-response"),this.optionsEle=this.$(".response-scroll"),this.filterEle=this.$(".search-input"),this.renderOptions()},renderOptions:function(){var a="",b=this.filter.replace(/[\-\[\]\/\{}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");Object.keys(this.selectOptions).forEach(function(c){a+='<p class="response-group">'+c+"</p><ul>",this.selectOptions[c].forEach(function(c){c.match(new RegExp(b,"i"))&&(a+="<li>"+c+"</li>")}.bind(this)),a+="</ul>"}.bind(this)),this.optionsEle.html(a)},resetFilter:function(){this.filter="",this.clearSelection(),this.renderOptions(),this.filterEle.val(""),this.optionsEle.scrollTop(0)},clearSelection:function(){this.$("li.active").removeClass("active"),this.selectedEle.html("&nbsp;"),this.text=""},clickOption:function(a){this.selectText($(a.currentTarget))},getText:function(){return this.text},selectText:function(a){var b=$(a).html();this.text=b,this.$("li.active").removeClass("active"),a.addClass("active"),this.hideOptions(),this.selectedEle.html(b)},toggleOptions:function(){this.$el.hasClass("open")?this.hideOptions():this.showOptions()},showOptions:function(){this.filters&&this.resetFilter(),this.filterEle.focus(),this.$el.addClass("open")},hideOptions:function(){this.$el.removeClass("open")},keyInput:function(a){if(13==a.which){var b=this.optionsEle.find("li.active");if(0===b.length){var c=this.optionsEle.find("li");1===c.length&&(b=c)}if(b){if(this.text=b.html(),!this.text)return;this.trigger("enter"),this.hideOptions(),this.resetFilter()}return!1}return 27==a.which?(""===this.filter&&this.hideOptions(),this.resetFilter(),this.clearSelection(),!1):38==a.which?(this.moveActive(-1),!1):40==a.which?(this.moveActive(1),!1):(this.filter!=a.currentTarget.value&&(this.filter=a.currentTarget.value,this.renderOptions()),!1)},moveActive:function(a){for(var b,c=this.optionsEle.find("li"),d=0;d<c.length;d++)if(b=c[d],"active"==b.className)return void(c[d+a]&&(c[d+a].className="active",this.selectedEle.html(c[d+a].innerHTML),c[d+a].scrollIntoView(!1),b.className=""));c.length&&(c[0].className="active")}})}),define("shared/classes/drags",["require"],function(a){$.fn.drags=function(a){if(a=$.extend({handle:"",cursor:"move"},a),""===a.handle)var b=this;else var b=this.find(a.handle);if("function"==typeof a.stop)var c=a.stop;else var c=$.noop;return b.css("cursor",a.cursor).on("mousedown",function(b){if(""===a.handle)var c=$(this).addClass("draggable");else var c=$(this).addClass("active-handle").parent().addClass("draggable");var d=c.css("z-index"),e=c.outerHeight(),f=c.outerWidth(),g=c.offset().top+e-b.pageY,h=c.offset().left+f-b.pageX;c.parents().on("mousemove",function(a){$(".draggable").offset({top:a.pageY+g-e,left:a.pageX+h-f}).on("mouseup",function(){$(this).removeClass("draggable").css("z-index",d)})}),b.preventDefault()}).on("mouseup",function(b){""===a.handle?$(this).removeClass("draggable"):$(this).removeClass("active-handle").parent().removeClass("draggable");var d=$(this).offset();c({top:d.top,left:d.left})})}}),define("race/views/chat",["require","registry","templates","global/views/filtered_select","shared/classes/drags"],function(a){"use strict";var b=a("registry"),c=a("templates"),d=a("global/views/filtered_select");return a("shared/classes/drags"),Backbone.View.extend({className:"race-chat",events:{"click .send":"send","click .collapse-toggle":"toggleCollapse"},initialize:function(a){this.options=a,this.template=c("race","chat"),this.chatTemplate=c("race","chat_row"),this.player=b.get("player"),this.realtime=b.get("realtime"),this.realtime.on("data",this.receiveData.bind(this)),this.race=a.race,this.listenTo(this.race,"change:status",this.raceStatusChange),this.chats=new Backbone.Collection,this.listenTo(this.chats,"add",this.renderNewChat),this.racers=a.race.racers,this.listenTo(this.racers,"add",this.updateRacers),this.listenTo(this.racers,"remove",this.updateRacers),this.chatOptions=_.flatten(_.values(NTGLOBALS("CHAT_TEXTS"))),this.select=new d({selectOptions:NTGLOBALS("CHAT_TEXTS")}),this.select.on("enter",this.send.bind(this));var e=this.player.get("_chatPos");e&&this.$el.css(e),this.render()},raceStatusChange:function(a,b){"open"==b?this.joinRoom():"countdown"==b&&this.hide()},render:function(){this.$el.fastHide().html(this.template()),this.$(".chat-texts").replaceWith(this.select.el),this.messagesEle=this.$(".messages"),this.racersSelect=this.$(".racers"),this.updateRacers(),this.$el.drags({handle:".handle",stop:function(a){this.player.set({_chatPos:a})}.bind(this)})},renderNewChat:function(a){a=a.toJSON(),a.userID==this.player.id?a.fromClass="you":a.fromClass="other";var b=$(this.chatTemplate(a));this.messagesEle.append(b),this.messagesEle[0].scrollTop=this.messagesEle[0].scrollHeight},show:function(){this.shown||(this.shown=!0,this.$el.velocity("fadeIn"))},hide:function(){this.$el.fastHide()},updateRacers:function(){var a,b,c,d='<option value="">Everyone</option>';this.racers.forEach(function(e){e.id!=this.player.id&&(a=e.get("profile"),c=a.tag?"["+a.tag+"]":"",b=a.displayName?a.displayName:a.username,d+="<option>"+c+b+"</option>")}.bind(this)),this.racersSelect.html(d),this.racers.length>1&&!this.race.get("startFriendRace")&&this.show()},send:function(){var a=this.select.getText();if(this.select.hideOptions(),this.select.resetFilter(),this.select.clearSelection(),a){var b=this.racersSelect.val();this.racersSelect[0].selectedIndex=0;var c=this.player.get("tag"),d=this.player.get("displayName")||this.player.get("username");c&&(d="["+c+"]"+d),this.realtime.chat({room:this.race.get("id"),userID:this.player.id,to:b,from:d,msg:a})}},joinRoom:function(){this.realtime.chat({room:this.race.get("id"),join:!0})},receiveData:function(a){"chat"==a.stream&&a.chats.forEach(function(a){if(this.chatOptions.indexOf(a.msg)!==-1){if(this.racers.get(a.userID)){var b=this.racers.get(a.userID).get("profile"),c=b.tag,d=b.displayName||b.username;c&&(d="["+c+"]"+d),a.from=d}this.chats.add(a)}}.bind(this))},toggleCollapse:function(){return this.$el.toggleClass("collapsed"),!1}})}),define("race/views/top/background",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=PIXI.Sprite.fromFrame("race_top.png")};return b.prototype={tick:function(a){}},b}),define("race/views/top/sound_buttons",["require","registry"],function(a){"use strict";var b=a("registry"),c=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.player=b.get("player");var c=this.player.get("raceSounds");"none"==c?(this.fx="off",this.music="off"):"only_music"==c?(this.fx="off",this.music="on"):"only_fx"==c?(this.fx="on",this.music="off"):(this.fx="on",this.music="on"),this.textures={music_on:PIXI.Texture.fromFrame("sound_music_on.png"),music_off:PIXI.Texture.fromFrame("sound_music_off.png"),fx_on:PIXI.Texture.fromFrame("sound_fx_on.png"),fx_off:PIXI.Texture.fromFrame("sound_fx_off.png")},this.el=new PIXI.DisplayObjectContainer,this.fxButton=new PIXI.Sprite(this.textures["fx_"+this.fx]),this.fxButton.position.x=8,this.fxButton.position.y=32,$("#sound-fx-toggle").click(this.toggleFx.bind(this)),this.musicButton=new PIXI.Sprite(this.textures["music_"+this.music]),this.musicButton.position.x=8,this.musicButton.position.y=53,$("#sound-music-toggle").click(this.toggleMusic.bind(this)),this.el.addChild(this.fxButton),this.el.addChild(this.musicButton)};return c.prototype={toggleFx:function(){this.fx="on"==this.fx?"off":"on",this.fxButton.setTexture(this.textures["fx_"+this.fx]),this.updateSoundPrefs()},toggleMusic:function(){this.music="on"==this.music?"off":"on",this.musicButton.setTexture(this.textures["music_"+this.music]),this.updateSoundPrefs()},updateSoundPrefs:function(){$("#sound-tooltip").remove();var a;a="on"==this.music&&"on"==this.fx?"all":"on"==this.music&&"off"==this.fx?"only_music":"off"==this.music&&"on"==this.fx?"only_fx":"none",this.player.setSoundPrefs(a)}},c}),define("race/views/top/lead_car",["require","global/models/car"],function(a){"use strict";var b=a("global/models/car"),c=function(a){this.game=a.game,this.model=a.model,this.leader=null,this.model.racers.on("sort",this.update.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=640,this.el.position.y=14;var b=new PIXI.Text("Lead Car",{font:"14px 'Droid Serif'",fill:"#f8ce5e"});b.position.x=14,b.position.y=15,this.el.addChild(b),this.teamNameText=new PIXI.Text(" ",{font:"14px 'Droid Serif'"}),this.teamNameText.position.x=14,this.teamNameText.position.y=33,this.el.addChild(this.teamNameText),this.displayNameText=new PIXI.Text(" ",{font:"14px 'Droid Serif'",fill:"#cecece"}),this.displayNameText.position.x=14,this.displayNameText.position.y=33,this.el.addChild(this.displayNameText),this.leadCar=PIXI.Sprite.fromFrame("car_loading.png"),this.leadCar.position.y=12,this.leadCar.position.x=226,this.leadCar.anchor.x=1,this.el.addChild(this.leadCar)};return c.prototype={tick:function(a){},update:function(){if(!("racing"!=this.model.get("status")||this.model.get("seconds")<1)){var a=this.model.racers.at(0);if(a!==this.leader){var c=a.get("profile");this.updateCar(b.imageSrc("small",c.carID,c.carHueAngle)),c.tag?(this.teamNameText.visible=!0,this.teamNameText.setText("["+c.tag+"]"),this.teamNameText.setStyle({fill:"#"+c.tagColor,font:"14px 'Droid Serif'"}),this.displayNameText.position.x=14+this.teamNameText.width):(this.displayNameText.position.x=14,this.teamNameText.visible=!1),this.displayNameText.setText(c.displayName||c.username),this.leader=a}}},updateCar:function(a){this.leadCar.setTexture(PIXI.Texture.fromImage(a))}},c}),define("race/views/top/mini_track",["require"],function(a){"use strict";var b=446,c=20,d=9,e=2,f=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.el=new PIXI.DisplayObjectContainer,this.el.x=179,this.el.y=17,this.cars={},this.carPositions=[],this.model.racers.on("add",this.addRacer.bind(this)),this.model.racers.on("remove",this.removeRacer.bind(this)),this.model.on("change:racerChanges",this.update.bind(this)),this.model.racers.forEach(function(a){this.addRacer(a)}.bind(this))};return f.prototype={tick:function(a){var b=this;Object.keys(this.cars).forEach(function(a){var c=b.cars[a];c.position.x=Math.round(c.tempX)})},addRacer:function(a){for(var b=a.id==this.racer.id,c=0;c<this.carPositions.length&&this.carPositions[c];c++);this.carPositions[c]=a;var f;f=b?PIXI.Sprite.fromFrame("mini_car_self.png"):PIXI.Sprite.fromFrame("mini_car_other.png"),f.tempX=0,f.position.y=c*(d+e),this.el.addChild(f),this.cars[a.id]=f},removeRacer:function(a){this.el.removeChild(this.cars[a.id]),delete this.cars[a.id],delete this.carPositions[this.carPositions.indexOf(a)]},update:function(){var a;this.model.get("racerChanges").forEach(function(d){d.position&&(a=(b-c)*d.position,createjs.Tween.get(this.cars[d.id],{override:!0}).to({tempX:a},this.model.get("callSpeed")+10))},this)}},f}),define("race/views/top",["require","race/views/top/background","race/views/top/sound_buttons","race/views/top/lead_car","race/views/top/mini_track","registry"],function(a){"use strict";var b=a("race/views/top/background"),c=a("race/views/top/sound_buttons"),d=a("race/views/top/lead_car"),e=a("race/views/top/mini_track");a("registry");return Backbone.View.extend({initialize:function(a){this.options=a,this.loader=a.loader,this.stage=a.stage,this.renderer=a.renderer,this.supportSound=!0,this.started=!1,this.racer=a.racer,this.deltaCounter=0,this.loader.on("complete",function(){this.start(),this.started=!0}.bind(this))},start:function(){this.background=new b({game:this}),this.stage.addChild(this.background.el),this.supportSound&&(this.soundButtons=new c({game:this}),this.stage.addChild(this.soundButtons.el)),this.leadCar=new d({game:this,model:this.model}),this.stage.addChild(this.leadCar.el),this.miniTrack=new e({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.miniTrack.el),this.updateStage()},tick:function(a){this.started&&this.miniTrack.tick(a)},updateStage:function(){this.renderer.render(this.stage)}})}),define("race/views/track/background",["require"],function(a){"use strict";var b=1,c=function(a){this.game=a.game,this.velocity=0,this.allowVelocityChanges=!1,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var b,c=0;c<12;c++)b=PIXI.Sprite.fromFrame("base.png"),b.position.x=c*b.width,this.el.addChild(b);for(c=0;c<2;c++)b=PIXI.Sprite.fromFrame("top.png"),b.position.x=c*b.width,this.el.addChild(b),b=PIXI.Sprite.fromFrame("skids.png"),b.position.x=c*b.width,this.el.addChild(b);this.el.cacheAsBitmap=!0,this.tileW=this.el.getBounds().width/2};return c.prototype={tick:function(a){this.el.position.x=Math.round((this.el.position.x-a.delta*this.velocity)%this.tileW)},begin:function(){createjs.Tween.get(this).to({velocity:b},3e3,createjs.Ease.linear).call(function(){this.allowVelocityChanges=!0}.bind(this))},updateVelocity:function(a){this.allowVelocityChanges&&(a=Math.max(Math.min(a,2),.5),createjs.Tween.get(this).to({velocity:b*a},1e3,createjs.Ease.linear))}},c}),define("race/views/track/animation",["require"],function(a){"use strict";var b={nitro:{frames:10,speed:.4},hearts:{frames:4,speed:.3},smoke:{frames:20,speed:.4},stars:{frames:10,speed:.3},type:{frames:12,speed:.3},lightning:{frames:24,speed:.2},bits:{frames:19,speed:.4},fire:{frames:16,speed:.5}},c=function(a){this.game=a.game;var c,d=b[a.type],e=[];if(d){for(var f=0;f<d.frames;f++)c=PIXI.Texture.fromFrame(""+a.type+"/texture"+String(f+1).pad(4,"0","STR_PAD_LEFT")+".png"),e.push(c);this.el=new PIXI.MovieClip(e),this.el.animationSpeed=d.speed}};return c.prototype={play:function(a){this.el.loop=a,this.el.gotoAndPlay(0)}},c}),define("race/views/track/flag",["require"],function(a){"use strict";var b=function(a){this.game=a.game;try{this.el=PIXI.Sprite.fromFrame("flags/"+a.country.toLowerCase()+".png")}catch(a){this.el=PIXI.Sprite.fromFrame("flags/unknown.png")}};return b.prototype={tick:function(a){}},b}),define("race/views/track/gender",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=PIXI.Sprite.fromFrame(a.gender+".png"),a.gender||(this.el.visible=!1)};return b.prototype={tick:function(a){}},b}),define("race/views/track/car",["require","race/views/track/animation","race/views/track/flag","race/views/track/gender","global/models/car","registry"],function(a){"use strict";var b=a("race/views/track/animation"),c=a("race/views/track/flag"),d=a("race/views/track/gender"),e=a("global/models/car"),f=a("registry"),g=345,h=40,i=980,j=90,k=46,l=function(a){this.options=a,this.game=a.game,this.model=a.model,this.race=a.race,this.practiceMode=this.race.get("practice"),this.animations={},this.progress=0,this.disqualified=!1,this.finished=!1,this.wpm=0,this.initialized=!1,this.x=0,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=j+k*a.position+this.game.topOffset,this.hideOffTrack(),i=this.game.renderer.width+30;var b=this.model.get("profile");this.carSrc=e.imageSrc("small",b.carID);var c=$("<img>").attr("src",this.carSrc).load(function(){try{if(b.carHueAngle>0)return void Pixastic.process(c[0],"hsl",{hue:b.carHueAngle},function(a){this.initialize(new PIXI.Sprite(new PIXI.Texture(new PIXI.BaseTexture(a),new PIXI.Rectangle(0,0,a.width,a.height))))}.bind(this))}catch(a){console.warn("Failed to color car. Falling back to no paint"),console.error(a)}var a=PIXI.Sprite.fromImage(this.carSrc);a.width=c[0].width,a.height=c[0].height,this.initialize(a)}.bind(this)).error(function(){console.error("Car image failed to load: ",this.carSrc),this.carSrc=e.imageSrc("small",9,0),this.initialize(PIXI.Sprite.fromImage(this.carSrc))}.bind(this))};return l.prototype={tick:function(){this.el.position.x=Math.round(this.x)},calculateX:function(a){if(!(this.progress>=1||this.finished||this.disqualified)){var b=0,c=0,d=(i-g)/20+5;this.practiceMode?c=(i-g)*a:a>=.8&&(c=(100*a-80)*d),b=this.options.self?c:100*(this.progress-a)*d+c,b=Math.round(b),createjs.Tween.get(this,{override:!0}).to({x:b},this.race.get("callSpeed")+100)}},initialize:function(a){if(!this.initialized){this.initialized=!0;var b=this.model.get("profile");this.car=a,this.car.position.x=g,this.car.anchor.x=1,this.tag=new PIXI.DisplayObjectContainer,this.tag.position.x=2;var e=PIXI.Sprite.fromImage((this.options.self?"self_tag":"competitor_tag")+".png");e.position.y=2;var h=b.country;"NT"==b.tag&&(h="ftw");var i=new c({game:this.game,country:h});i.el.position.x=8,i.el.position.y=7;var j,k=i.el.width+12;b.gender&&(j=new d({game:this.game,gender:b.gender}),j.el.position.x=k,j.el.position.y=6,k+=j.el.width+4);var l;f.get("playerFriends").get(this.model.id)&&(l=PIXI.Sprite.fromImage("friend.png"),l.position.x=k,l.position.y=6,k+=l.width+3);var m;"gold"==b.membership&&(m=PIXI.Sprite.fromImage("gold_icon.png"),m.position.x=k,m.position.y=6,k+=m.width+2);var n,o=f.get("top3Players");o.get(this.model.id)&&(n=PIXI.Sprite.fromImage("scoreboard_champion.png"),n.position.x=k,n.position.y=4);var p="";b.tag&&(p="["+b.tag+"]");var q=new PIXI.Text(p+(b.displayName||b.username),{font:'10px "Droid Serif"',fill:"#FFFFFF"});if(q.position.x=7,q.position.y=22,q.width>120){var r=new PIXI.Graphics;r.beginFill(16777215).drawRect(0,0,120,40),q.mask=r}this.tag.addChild(e),this.tag.addChild(q),this.tag.addChild(i.el),j&&this.tag.addChild(j.el),l&&this.tag.addChild(l),m&&this.tag.addChild(m),n&&this.tag.addChild(n),this.tag.cacheAsBitmap=!0,this.el.addChild(this.car),this.el.addChild(this.tag),b.animation&&this.addAnimation(b.animation,"behind",!0),this.addAnimation("nitro"),this.enterTrack(this.options.animateIn)}},disqualify:function(){this.disqualified=!0,this.el.x>-g&&createjs.Tween.get(this,{override:!0}).to({x:-g},2*(this.el.x+g),createjs.Ease.linear)},hideOffTrack:function(){createjs.Tween.removeTweens(this),this.x=-g},enterTrack:function(a){a?createjs.Tween.get(this,{override:!0}).to({x:0},1e3,createjs.Ease.sineOut):this.x=0},enterFinish:function(a,b){this.finished=!0;var c=this.game.renderer.width-g;a?(this.hideOffTrack(),createjs.Tween.get(this,{override:!0}).wait(b).to({x:c},1500+b,createjs.Ease.sineOut)):(createjs.Tween.removeTweens(this),this.x=c)},finishRace:function(){this.finished=!0,createjs.Tween.get(this,{override:!0}).to({x:this.game.renderer.width+100},500,createjs.Ease.linear)},addAnimation:function(a,c,d){c=c||"behind";var e=new b({game:this.game,type:a});this.model.get("profile");this.animations[a]=e,"behind"==c&&(e.el.position.x=g-this.car.width-e.el.width,e.el.position.y=Math.round(h/2-e.el.height/2)),this.el.addChild(e.el),d&&e.play(!0)},fireNitro:function(){this.animations.nitro&&this.animations.nitro.play(!1)}},l}),define("race/views/track/tree",["require"],function(a){"use strict";var b=48,c=function(a){this.game=a.game,this.isCanvas=!(this.game.renderer instanceof PIXI.WebGLRenderer),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=412,this.el.position.y=60+this.game.topOffset;var b=PIXI.Sprite.fromFrame("tree_lights.png");this.el.addChild(b),this.lights={},this.lights.green=[PIXI.Sprite.fromFrame("green_light_glow.png"),PIXI.Sprite.fromFrame("green_light_glow.png")],this.lights.yellow=[PIXI.Sprite.fromFrame("yellow_light_glow.png"),PIXI.Sprite.fromFrame("yellow_light_glow.png")],this.lights.red=[PIXI.Sprite.fromFrame("red_light_glow.png"),PIXI.Sprite.fromFrame("red_light_glow.png")],this.lights.green[0].position.x=-5,this.lights.green[1].position.x=92,this.lights.yellow[0].position.x=-5,this.lights.yellow[1].position.x=92,this.lights.red[0].position.x=-5,this.lights.red[1].position.x=92,this.el.addChild(this.lights.green[0]),this.el.addChild(this.lights.green[1]),this.el.addChild(this.lights.yellow[0]),this.el.addChild(this.lights.yellow[1]),this.el.addChild(this.lights.red[0]),this.el.addChild(this.lights.red[1]),this.wait=PIXI.Sprite.fromFrame("tree_wait.png"),this.wait.position.x=155,this.wait.position.y=3,this.wait.visible=!0,this.el.addChild(this.wait),this.ready=PIXI.Sprite.fromFrame("tree_ready.png"),this.ready.position.x=155,this.ready.position.y=52,this.ready.visible=!1,this.el.addChild(this.ready),this.type=PIXI.Sprite.fromFrame("tree_type.png"),this.type.position.x=155,this.type.position.y=200,this.type.visible=!1,this.el.addChild(this.type),this.showFrame(4)};return c.prototype={tick:function(a){},getLightMask:function(a){var c=new PIXI.Graphics;return c.beginFill(0).drawCircle(this.el.position.x+29,this.el.position.y+29+a*b,23),c.beginFill(0).drawCircle(this.el.position.x+125,this.el.position.y+29+a*b,23),c},showFrame:function(a){switch(this.lights.green[0].visible=!1,this.lights.green[1].visible=!1,this.lights.yellow[0].visible=!1,this.lights.yellow[1].visible=!1,this.lights.red[0].visible=!1,this.lights.red[1].visible=!1,this.ready.visible=!1,this.wait.visible=!1,a){case 3:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=-3+(4-a)*b,this.lights.yellow[1].position.y=-3+(4-a)*b,this.ready.visible=!0;break;case 2:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=-3+(4-a)*b,this.lights.yellow[1].position.y=-3+(4-a)*b,this.ready.position.y=103,this.ready.visible=!0;break;case 1:this.lights.yellow[0].visible=!0,this.lights.yellow[1].visible=!0,this.lights.yellow[0].position.y=-3+(4-a)*b,this.lights.yellow[1].position.y=-3+(4-a)*b,this.ready.visible=!0,this.ready.position.y=150;break;case 0:this.lights.green[0].visible=!0,this.lights.green[1].visible=!0,this.lights.green[0].position.y=-2+(4-a)*b,this.lights.green[1].position.y=-2+(4-a)*b,this.type.visible=!0,createjs.Tween.get(this.el).wait(1e3).to({alpha:0},1e3).call(function(){this.el.visible=!1}.bind(this));break;default:this.lights.red[0].position.y=-3,this.lights.red[1].position.y=-3,this.lights.red[0].visible=!0,this.lights.red[1].visible=!0,this.wait.visible=!0}}},c}),define("race/views/track/starting_line",["require"],function(a){"use strict";var b=4,c=function(a){this.game=a.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var c,d=0;d<2*b;d++)c=PIXI.Sprite.fromFrame("base.png"),c.position.x=d*c.width,this.el.addChild(c);for(d=0;d<b;d++)c=PIXI.Sprite.fromFrame("bleachers.png"),c.position.x=d*c.width,this.el.addChild(c);var e=PIXI.Sprite.fromFrame("start.png");e.position.x=240,e.position.y=42,this.el.addChild(e),this.el.cacheAsBitmap=!0};return c.prototype={tick:function(a,b){this.el.visible&&(this.el.position.x=Math.round(this.el.position.x-a.delta*b),this.el.position.x<=-this.el.getBounds().width&&(this.el.visible=!1))}},c}),define("race/views/track/finish_line",["require"],function(a){"use strict";var b=100,c=8,d=function(a){this.game=a.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.y=this.game.topOffset;for(var d,e=new PIXI.DisplayObjectContainer,f=0;f<6;f++)d=PIXI.Sprite.fromFrame("base.png"),d.position.x=f*d.width,e.addChild(d);for(f=0;f<3;f++)d=PIXI.Sprite.fromFrame("bleachers.png"),d.position.x=f*d.width,e.addChild(d);for(d=PIXI.Sprite.fromFrame("skids.png"),e.addChild(d),d=PIXI.Sprite.fromFrame("finish.png"),d.position.x=0,d.position.y=88,e.addChild(d),e.cacheAsBitmap=!0,this.el.addChild(e),this.flashes=[],f=0;f<c;f++)this.flashes.push(PIXI.Sprite.fromFrame("flash.png")),this.flashes[f].shown=Math.round(Math.random()*b),this.flashes[f].y=this.randomFlashY(),this.flashes[f].x=this.randomFlashX(),this.el.addChild(this.flashes[f]);this.el.visible=!1};return d.prototype={tick:function(a){this.flashes.forEach(function(c){c.shown>b&&(c.shown=0,c.y=this.randomFlashY(),c.x=this.randomFlashX(),c.visible=!c.visible),c.shown+=a.delta},this)},show:function(){this.el.visible=!0},randomFlashX:function(){return Math.round(Math.random()*(this.game.renderer.width-60))+20},randomFlashY:function(){return Math.round(35*Math.random())+8}},d}),define("race/views/track/flash",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.Graphics,this.el.beginFill(16777215).drawRect(0,0,this.game.renderer.width,320),this.el.position.y=this.game.topOffset,this.el.visible=!1};return b.prototype={tick:function(a){},show:function(){this.el.visible=!0,createjs.Tween.get(this.el,{override:!0}).wait(100).to({alpha:0},400,createjs.Ease.linear)}},b}),define("race/views/track",["require","race/views/track/background","race/views/track/car","race/views/track/tree","race/views/track/starting_line","race/views/track/finish_line","race/views/track/flash","shared/classes/typing","shared/classes/sound","registry"],function(a){
"use strict";var b=a("race/views/track/background"),c=a("race/views/track/car"),d=a("race/views/track/tree"),e=a("race/views/track/starting_line"),f=a("race/views/track/finish_line"),g=a("race/views/track/flash"),h=a("shared/classes/typing"),i=a("shared/classes/sound"),j=a("registry");return Backbone.View.extend({stage:null,renderer:null,loader:null,sounds:{},cars:{},carPositions:[],focalRacer:null,lastUpdateStamp:null,status:"",disqualified:!1,finished:!1,fps:0,initialize:function(a){this.options=a,this.loader=a.loader,this.carLoader=a.carLoader,this.racer=a.racer,this.stage=a.stage,this.renderer=a.renderer,this.topOffset=a.topOffset||0,this.player=j.get("player"),this.listenTo(this.player,"change:raceSounds",this.stopMultipleSounds),this.listenTo(this.racer,"change:disqualified",this.disqualify),this.listenTo(this.racer,"change:nitrosUsed",this.firePlayerNitro),this.listenTo(this.racer,"change:errors",this.playErrorSound),this.listenTo(this.racer,"change:typingComplete",this.finish),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.model,"change:countdown",this.countdown),this.listenTo(this.model,"change:racerChanges",this.update),this.listenTo(this.model.racers,"add",this.addRacer),this.listenTo(this.model.racers,"remove",this.removeRacer),this.loader.on("complete",function(){this.stage.removeChild(this.loaderText),this.stage.removeChild(this.loaderPercent),this.createElements(),this.updateStage()},this)},render:function(){},createElements:function(){this.background=new b({game:this,track:this.model.get("track")}),this.tree=new d({game:this}),this.startingLine=new e({game:this,track:this.model.get("track")}),this.finishLine=new f({game:this,track:this.model.get("track")}),this.carContainer=new PIXI.DisplayObjectContainer,this.flash=new g({game:this})},start:function(){this.stage.addChild(this.background.el),this.stage.addChild(this.startingLine.el),this.stage.addChild(this.tree.el),this.stage.addChild(this.finishLine.el),this.stage.addChild(this.carContainer),this.stage.addChild(this.flash.el),this.model.racers.forEach(function(a){this.addRacer(a)},this),this.options.showFPS&&(this.fps="~",this.fpsText=new PIXI.Text("FPS: "+this.fps,{font:"24px Arial",fill:"white"}),this.fpsText.position.y=this.topOffset,this.stage.addChild(this.fpsText),setInterval(this.updateFPS.bind(this),1e3)),this.playSound({id:"cheering",loop:!0,volume:.1})},updateFPS:function(){this.fpsText.setText("FPS: "+Math.round(this.fps))},update:function(){!this.finished&&this.focalRacer&&this.focalRacer.get("completeStamp")&&this.finish();var a,b,c=[];if(this.model.get("racerChanges").forEach(function(d){a=this.model.racers.get(d.id),a&&(b=this.cars[a.id],d.disqualified&&b.disqualify(),!d.position||b.finished||b.disqualified||this.finished||(b.progress=d.position),d.nitrosUsed&&this.focalRacer&&a.id!=this.focalRacer.id&&(b.fireNitro(),this.playSound({id:"nitro",volume:.6,oneOff:!0})),d.completeStamp&&(this.finished?c.push(a):b.finishRace()))},this),this.focalRacer&&this.focalRacer.get("profile").avgSpeed>0){var d=h.speed(this.focalRacer.get("typed"),this.model.get("seconds"))/this.focalRacer.get("profile").avgSpeed;this.background.updateVelocity(d)}var e=c.reduce(function(a,b){return Math.min(a,b.get("completeStamp"))},this.model.get("lastUpdate")),f=0;if(c.forEach(function(a){f=a.get("completeStamp")-e,this.cars[a.id].enterFinish(!0,f),this.playSound({id:"car_stopping",volume:.5,oneOff:!0,delay:f})}.bind(this)),!this.finished&&this.focalRacer){var g=this.focalRacer.get("position");this.model.racers.forEach(function(a){this.cars[a.id].calculateX(g)}.bind(this))}},firePlayerNitro:function(){this.focalRacer.get("completeStamp")||(this.cars[this.focalRacer.id].fireNitro(),this.playSound({id:"nitro",oneOff:!0,volume:.6}))},playErrorSound:function(){var a=Math.floor(4*Math.random())+1;this.playSound({id:"error"+a,oneOff:!0,volume:.6})},statusChange:function(){this.status=this.model.get("status"),"open"==this.status?this.start():"racing"==this.status&&(this.playSound({id:"countdown_go",volume:.5}),this.playSound({id:"acceleration",volume:.2}),this.playSound({id:"music",volume:.6,loop:!0,delay:1e3}),this.background.begin())},countdown:function(){var a=this.model.get("countdown");this.tree.showFrame(a),2!=a&&1!=a||this.playSound({id:"countdown_"+a,volume:.5})},finish:function(){this.finished||(this.finished=!0,this.finishLine.show(),this.flash.show(),this.background.el.visible=!1,this.startingLine.el.visible=!1,this.model.racers.forEach(function(a){a.get("completeStamp")?this.cars[a.id].finished&&this.cars[a.id].enterFinish(!1):this.cars[a.id].hideOffTrack()},this),this.stopSound("music"),this.stopSound("cheering"),this.playSound({id:"finish_crowd",volume:.5}))},disqualify:function(){this.playSound({id:"disqualified",volume:.5}),this.stopSound("cheering",2e3),this.stopSound("music",1e3),this.disqualified=!0},addRacer:function(a){var b=a.id==this.racer.id;b&&(this.focalRacer=a);for(var d=0;d<this.carPositions.length&&this.carPositions[d];d++);this.carPositions[d]=a;var e=new c({game:this,model:a,race:this.model,self:b,position:d,animateIn:!!this.focalRacer});this.carContainer.addChild(e.el),this.cars[a.id]=e;var f=j.get("cars").get(a.get("profile").carID).get("enterSound");this.focalRacer&&this.playSound({id:"entry_"+f,oneOff:!0,volume:.2})},removeRacer:function(a){this.carContainer.removeChild(this.cars[a.id].el),delete this.cars[a.id],delete this.carPositions[this.carPositions.indexOf(a)]},tick:function(a){this.fps=a.fps;var b=this;Object.keys(this.cars).forEach(function(a){b.cars[a].tick()}),this.disqualified||(this.finished?this.finishLine.tick(a):"racing"==this.status&&(this.background.tick(a),this.startingLine.tick(a,this.background.velocity)))},playSound:function(a){var b=this.player.get("raceSounds"),c=!0,d=!0;"none"==b?(c=!1,d=!1):"only_music"==b?(c=!1,d=!0):"only_fx"==b&&(c=!0,d=!1),"music"!=a.id||d||(a.muted=!0),"music"==a.id||c||(a.muted=!0),i.play(a)},stopSound:function(a,b){i.stop(a,b)},stopMultipleSounds:function(){var a=this.player.get("raceSounds"),b=!0,c=!0;"none"==a?(b=!1,c=!1):"only_music"==a?(b=!1,c=!0):"only_fx"==a&&(b=!0,c=!1),c?i.unmute("music"):i.mute("music"),Object.keys(i.sounds).forEach(function(a){"music"!=a&&(b?i.unmute(a):i.mute(a))}.bind(this))},updateStage:function(){this.renderer.render(this.stage)}})}),define("race/classes/keyboard_input",["require","registry"],function(a){"use strict";function b(a){var b=c(a),d=a.map(function(a){var c=a-b,d=c*c;return d}),e=c(d),f=Math.sqrt(e);return f}function c(a){var b=a.reduce(function(a,b){return a+b},0),c=b/a.length;return c}var d=a("registry"),e=[],f=0;return Backbone.View.extend({racer:null,typed:0,acceptInput:!1,letters:[],content:"",lastKeyWasError:!1,allKeys:{},errorKeys:{},initialize:function(a){this.options=a,this.racer=a.racer,this.isMobile=d.get("isMobile"),this.isMobile?(this.mobileFocusAlert=$("#mobile-focus-alert").fastShow(),this.raceInput=$("#race-input").focus(this.mobileInputFocused.bind(this)).blur(this.mobileInputBlurred.bind(this))):$("#race-input").remove(),$("body").keypress(this.handleKeyPress.bind(this)).keydown(this.handleKeyDown.bind(this)),this.listenTo(this.model,"change:lesson",this.setLesson),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.racer,"change:disqualified",function(){this.acceptInput=!1},this),this.contentEl=this.$(".lesson-content")},stop:function(){this.mobileFocusAlert&&this.mobileFocusAlert.remove(),this.raceInput&&this.raceInput.unbind().blur().remove()},mobileInputFocused:function(){this.mobileFocusAlert.fastHide()},mobileInputBlurred:function(){this.raceInput.focus()},setLesson:function(a,b){this.content=b,this.letters=b.split("")},statusChange:function(a,b){"racing"==b?this.acceptInput=!0:this.acceptInput=!1},fakeInput:function(){var a=function(){this.handleKeyPress({which:this.letters[this.typed].charCodeAt(0),target:{}}),this.acceptInput&&setTimeout(a,150)}.bind(this);a()},getKeyStd:function(){return b(e)},prevKeyPress:null,handleKeyPress:function(a){if(this.prevKeyPress&&this.prevKeyPress.timeStamp===a.timeStamp)return!1;if(this.prevKeyPress=a,f?(e.push(Date.now()-f),f=Date.now()):f=Date.now(),("INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName)&&"race-input"!=a.target.id)return!0;if(!this.acceptInput)return 32!=a.which;if(13==a.which)return Math.min(this.model.get("nitros"),this.racer.get("nitros"))-this.racer.get("nitrosUsed")>0&&this.skipWord(),!1;var b=String.fromCharCode(a.which),c=this.letters[this.typed];return!a.shiftKey&&b.match(/[a-zA-Z]/)&&(b==b.toUpperCase()?this.showCapsLockWarning():this.hideCapsLockWarning()),b==c?this.typedCorrectLetter(b):this.typedIncorrectLetter(c),!(!this.isMobile||32==a.which)},prevKeyDown:null,handleKeyDown:function(a){return(!this.prevKeyDown||this.prevKeyDown.timeStamp!==a.timeStamp)&&(this.prevKeyDown=a,32==a.which?this.handleKeyPress(a):("INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName)&&"race-input"!=a.target.id||9!=a.which&&(!this.acceptInput||(9===a.which||8===a.which||20===a.which||13==a.which||32==a.which?(20==a.which&&this.showCapsLockWarning(),(8==a.which||13==a.which)&&this.handleKeyPress(a)):void 0)))},skipWord:function(){var a,b,c;a=this.content.indexOf(" ",this.typed+1),a==-1?a=this.content.length:a++,b=this.content.substring(this.typed,a),c=b.length,this.racer.inc({skipped:c,nitrosUsed:1}),this.typedCorrectLetter(null,c)},typedCorrectLetter:function(a,b){b=b||1,this.typed+=b,this.racer.set({typed:this.typed}),a&&" "!=a&&(this.allKeys[a]=this.allKeys[a]?this.allKeys[a]+1:1),this.typed>=this.content.length&&(this.acceptInput=!1,this.racer.set({allKeys:this.allKeys,errorKeys:this.errorKeys,typingComplete:!0})),this.lastKeyWasError=!1},typedIncorrectLetter:function(a){this.trigger("error-typed"),this.lastKeyWasError||(this.errorKeys[a]=this.errorKeys[a]?this.errorKeys[a]+1:1,this.racer.inc({errors:1}),this.lastKeyWasError=!0)},showCapsLockWarning:function(){this.isMobile||this.racer.set({capslock:!0})},hideCapsLockWarning:function(){this.racer.set({capslock:!1})}})}),define("race/classes/asset_loader",["require","registry","shared/classes/sound"],function(a){"use strict";var b=a("registry"),c=a("shared/classes/sound"),d={basePath:"/dist/site/images/track",tracks:["desert","beach","arctic","forest","grass"],music:["8bit","city_nights","desert","dirty_bit","road_warrior","standard"],sounds:["acceleration","car_stopping","cheering","disqualified","error1","error2","error3","error4","finish_crowd","nitro","countdown_1","countdown_2","countdown_go","entry_muscle","entry_sport"]},e=[d.basePath+"/textures.8.png",d.basePath+"/textures.8.json",d.basePath+"/animations.png",d.basePath+"/animations.json",d.basePath+"/fonts/LCD2.fnt"],f=function(a){this.options=a||{};var f=0,g=function(){f++,2==f&&this.trigger("complete")}.bind(this);"holiday"==NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(b.get("player").get("carID"))!=-1?(d.tracks=["holiday"],d.music=["christmas1","christmas2","christmas3","christmas4"]):"summer"==NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(b.get("player").get("carID"))!=-1&&(d.tracks=["beach"],d.music=["summer1","summer2","summer3"]),this.options.track||(this.options.track=d.tracks[Math.floor(Math.random()*d.tracks.length)]),this.options.music||(this.options.music=d.music[Math.floor(Math.random()*d.music.length)]),e.push(d.basePath+"/tracks/"+this.options.track+"/textures.json"),this.loader=new PIXI.AssetLoader(e),this.loader.on("onComplete",g),c.on("complete",g)};return _.extend(f.prototype,Backbone.Events),f.prototype.load=function(){var a=this.loader.assetURLs.length,b=0,e=function(){b++,b==a?this.loader.load():this.trigger("progress",{progress:b/a})}.bind(this);a=a+d.sounds.length+1,c.preload("music","music",this.options.music),d.sounds.forEach(function(a){c.preload(a,"track")}.bind(this)),c.on("progress",e),c.on("error",e),this.loader.assetURLs.forEach(function(a){$.get(a,{ignoreCSRF:!0}).done(e).error(function(b){this.trigger("error",b,a)}.bind(this))}.bind(this))},f}),define("race/views/dashboard/background",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=PIXI.Sprite.fromFrame("dashboard_bg.png"),this.el.position.y=this.game.topOffset};return b.prototype={tick:function(a){}},b}),define("race/views/dashboard/panel",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=PIXI.Sprite.fromFrame("dashboard.png"),this.el.position.x=32,this.el.position.y=2+this.game.topOffset};return b.prototype={tick:function(a){}},b}),define("race/views/dashboard/accuracy",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.x=147,this.el.position.y=53+this.game.topOffset,this.text=new PIXI.BitmapText("100",{font:"24px LCD2"}),this.text.position.x=0,this.text.position.y=0,this.el.addChild(this.text);var b=new PIXI.Text("%",{font:"12px Arial",fill:"#5fbf55",stroke:"#393939",strokeThickness:2});b.position.x=48,b.position.y=14,b.cacheAsBitmap=!0,this.el.addChild(b)};return b.prototype={update:function(a){this.lastAccuracy!=a&&(this.text.setText(String(a).pad(3," ","STR_PAD_LEFT")),this.lastAccuracy=a)}},b}),define("race/views/dashboard/speed",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.BitmapText("  0",{font:"24px LCD2"}),this.el.position.x=128,this.el.position.y=104+this.game.topOffset};return b.prototype={update:function(a){a!=this.lastSpeed&&(this.el.setText(String(a).pad(3," ","STR_PAD_LEFT")),this.lastSpeed=a)}},b}),define("race/views/dashboard/position",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.DisplayObjectContainer,this.el.position.x=762,this.el.position.y=14+this.game.topOffset,this.textYou=new PIXI.BitmapText("0",{font:"24px LCD2"}),this.textYou.position.x=11,this.textYou.position.y=5,this.el.addChild(this.textYou),this.slash=new PIXI.BitmapText("/",{font:"24px LCD2"}),this.slash.position.x=22,this.slash.position.y=16,this.el.addChild(this.slash),this.textTotal=new PIXI.BitmapText("1",{font:"24px LCD2"}),this.textTotal.position.x=33,this.textTotal.position.y=26,this.el.addChild(this.textTotal)};return b.prototype={update:function(a,b){a==this.lastYou&&b==this.lastTotal||(this.textYou.setText(String(a)),this.textTotal.setText(String(b)),this.lastYou=a,this.lastTotal=b)}},b}),define("race/views/dashboard/time",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.BitmapText("0:00",{font:"24px LCD2"}),this.el.position.x=803,this.el.position.y=104+this.game.topOffset};return b.prototype={update:function(a){a=Math.floor(a),isNaN(a)&&(a=0);var b=Math.floor(a/60);a-=60*b,this.el.setText(b+":"+String(a).pad(2,"0","STR_PAD_LEFT"))}},b}),define("race/views/dashboard/nitros",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.el=new PIXI.DisplayObjectContainer,this.lockedNitro=PIXI.Sprite.fromFrame("nitro_locked.png"),this.el.addChild(this.lockedNitro),this.emptyNitro=PIXI.Sprite.fromFrame("nitro_empty.png"),this.el.addChild(this.emptyNitro),this.fullNitro=PIXI.Sprite.fromFrame("nitro_full.png");var b=new PIXI.Graphics;b.beginFill(0).moveTo(0,0).lineTo(this.emptyNitro.width,0).lineTo(this.emptyNitro.width+40,this.emptyNitro.height).lineTo(0,this.emptyNitro.height),this.fullNitro.mask=b,this.el.addChild(b),this.el.addChild(this.fullNitro),a.full||(this.fullNitro.mask.position.x=-this.emptyNitro.width-20)};b.prototype.use=function(){if(!this.used){this.used=!0;var a=this.emptyNitro.width;createjs.Tween.get(this.fullNitro.mask.position,{override:!0}).to({x:-a-20},300)}},b.prototype.lock=function(){this.emptyNitro.visible=!1,this.lockedNitro.visible=!0},b.prototype.unlock=function(){this.emptyNitro.visible=!0,this.lockedNitro.visible=!1},b.prototype.fill=function(){this.used=!1,createjs.Tween.get(this.fullNitro.mask.position,{override:!0}).to({x:0},300)};var c=function(a){this.game=a.game,this.nitrosEles=[],this.nitros=Math.min(3,a.nitros),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=860,this.el.position.y=4+this.game.topOffset;for(var c,d=0;d<3;d++)c=new b({game:this.game}),c.el.position.y=50*d,this.nitrosEles[d]=c,this.el.addChild(c.el)};return c.prototype={tick:function(a){},useNitro:function(){this.nitros&&(this.nitrosEles[this.nitros-1].use(),this.nitros--)},fill:function(a,b){for(var c=Math.min(a,b,3),d=0;d<3;d++)c>d?this.nitrosEles[d].fill():a<=d?this.nitrosEles[d].lock():this.nitrosEles[d].unlock();this.nitros=c}},c}),define("race/views/dashboard/speedo",["require"],function(a){"use strict";var b=-160,c=42,d=function(a){this.game=a.game,this.avgSpeed=a.avgSpeed||50,this.speed=0,this.el=PIXI.Sprite.fromFrame("needle.png"),this.el.position.x=95,this.el.position.y=81+this.game.topOffset,this.el.anchor.x=.5,this.el.anchor.y=1,this.el.rotation=Math.radians(b+20)};return d.prototype={update:function(a){if(a!=this.speed){this.speed=a;var d=Math.max(0,Math.min(a/this.avgSpeed,1)),e=Math.radians(b+(c-b)*d);createjs.Tween.get(this.el,{override:!0}).to({rotation:e},1e3)}}},d}),define("race/views/dashboard/lesson_multi",["require","registry"],function(a){"use strict";var b=a("registry"),c="Please wait. Typing content will appear before the race begins",d=14,e=28,f=4,g=5,h=35,i="#2e2e2e",j="#7b7b7b",k=0,l=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.player=b.get("player"),this.text="",this.model.on("change:lesson",function(){this.updateText(this.model.get("lesson"))}.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=241,this.el.position.y=24+this.game.topOffset;var f=new PIXI.Graphics;f.beginFill(0).drawRect(this.el.position.x,this.el.position.y,d*h+2*g,119),this.el.mask=f,this.innerContainer=new PIXI.DisplayObjectContainer,this.el.addChild(this.innerContainer),this.cursor=new PIXI.Graphics,this.cursor.position.x=g,this.cursor.beginFill(11332256).drawRect(0,0,d,e),this.innerContainer.addChild(this.cursor),this.errorCursor=new PIXI.Graphics,this.errorCursor.position.x=this.cursor.position.x,this.errorCursor.beginFill(15379104).drawRect(0,0,d,e),this.errorCursor.visible=!1,this.innerContainer.addChild(this.errorCursor),this.setVisibility(),this.updateText(c,!0),this.player.on("change:_raceLineType",this.setVisibility,this),this.racer.on("change:typed",this.typed,this),this.racer.on("change:errors",this.error,this)};return l.prototype={setVisibility:function(){"single"==this.player.get("_raceLineType")?this.el.visible=!1:(this.el.visible=!0,this.game.updateStage())},lastPosition:0,typed:function(){var a=this.racer.get("typed");for(this.lastPosition;this.lastPosition<a;this.lastPosition++)this.progress(this.lastPosition+1)},progress:function(a){this.cursor.x+=d,this.cursor.visible=!0,this.errorCursor.visible=!1,"\n"==this.text[a-1]&&(this.cursor.position.y+=e,this.cursor.position.x=g,this.advanceLine()),this.text[a]||(this.cursor.visible=!1),this.errorCursor.position.x=this.cursor.x,this.errorCursor.position.y=this.cursor.y,this.el.visible&&this.game.updateStage()},error:function(){this.cursor.visible=!1,this.errorCursor.visible=!0},advanceLine:function(){createjs.Tween.get(this.innerContainer.position).to({y:this.innerContainer.position.y-e},500)},updateText:function(a,b){function c(a,b){var c=new PIXI.Text(a,{font:'18px "Droid Serif"',fill:b});return c.anchor.x=.5,c}b=b||!1,this.letters&&(this.letters.cacheAsBitmap=!1,this.innerContainer.removeChild(this.letters)),this.letters=new PIXI.DisplayObjectContainer,this.text=a.wordwrap(h-1).split("\n").map(function(a){return a.trim()}).join("\n");var l,m=0,n=0,o=b?j:i;this.text.split("").forEach(function(a){l=c(a,o),l.position.x=m+d/2+g,l.width%2&&(l.position.x+=.5),l.position.y=n+f,this.letters.addChild(l),m+=d,"\n"==a&&(n+=e,m=0,k++)}.bind(this));var p=PIXI.Sprite.fromFrame("finish_flag.png");p.position.x=m+3+g,p.position.y=n+8,this.letters.addChild(p),this.letters.cacheAsBitmap=!0,this.innerContainer.addChild(this.letters)}},l}),define("race/views/dashboard/lesson_single",["require","registry"],function(a){"use strict";var b=a("registry"),c="Please wait. Typing content will appear before the race begins",d=28,e=54,f=8,g=5,h="#2e2e2e",i="#7b7b7b",j=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.player=b.get("player"),this.text="",this.extraLetters=[],this.model.on("change:lesson",function(){this.updateText(this.model.get("lesson"))}.bind(this)),this.el=new PIXI.DisplayObjectContainer,this.el.position.x=241,this.el.position.y=50+this.game.topOffset,this.lettersWindow=new PIXI.DisplayObjectContainer;var f=new PIXI.Graphics;f.beginFill(0).drawRect(this.el.position.x,this.el.position.y,504,50),this.game.stage.addChild(f),this.lettersWindow.mask=f,this.setVisibility(),this.cursor=new PIXI.Graphics,this.cursor.position.x=g,this.cursor.beginFill(11332256).drawRect(0,0,d,e),this.el.addChild(this.cursor),this.errorCursor=new PIXI.Graphics,this.errorCursor.position.x=this.cursor.position.x,this.errorCursor.beginFill(15379104).drawRect(0,0,d,e),this.errorCursor.visible=!1,this.el.addChild(this.errorCursor),this.el.addChild(this.lettersWindow),this.updateText(c,!0),this.player.on("change:_raceLineType",this.setVisibility,this),this.racer.on("change:typed",this.typed,this),this.racer.on("change:errors",this.error,this)};return j.prototype={setVisibility:function(){"single"==this.player.get("_raceLineType")?(this.el.visible=!0,this.game.updateStage()):this.el.visible=!1},lastPosition:0,typed:function(){var a=this.racer.get("typed");for(this.lastPosition;this.lastPosition<a;this.lastPosition++)this.progress(this.lastPosition+1)},progress:function(a){if(this.cursor.visible=!0,this.errorCursor.visible=!1,this.letters.position.x-=d,this.text[a]||(this.cursor.visible=!1),a%40===0){this.letters.cacheAsBitmap=!1;var b=a/40-1;this.lines[b].visible=!1,this.lines[b+2]&&(this.lines[b+2].position.x=this.lines[b+1].position.x,this.lines[b+2].visible=!0),this.lines[b+1]&&(this.lines[b+1].position.x=0),this.letters.position.x=0,this.letters.cacheAsBitmap=!0}this.el.visible&&this.game.updateStage()},error:function(){this.cursor.visible=!1,this.errorCursor.visible=!0},updateText:function(a,b){function c(a,b){var c=new PIXI.Text(a,{font:'32px "Droid Serif"',fill:b});return c.anchor.x=.5,c}b=b||!1,this.letters&&(this.letters.cacheAsBitmap=!1,this.lettersWindow.removeChild(this.letters)),this.lines=[],this.letters=new PIXI.DisplayObjectContainer,this.letters.position.y=5,this.text=a;var e,j,k=0,l=f,m=0,n=!0,o=b?i:h,p=0;this.text.split("").forEach(function(a){p%40===0&&(k=0,p%80===0&&(m=0,p>0&&(n=!1)),e=new PIXI.DisplayObjectContainer,e.visible=n,e.position.x=m,e.position.y=l,this.letters.addChild(e),this.lines.push(e)),p++,j=c(a,o),j.position.x=k+d/2+g,j.width%2&&(j.position.x+=.5),e.addChild(j),k+=d,m+=d}.bind(this));var q=PIXI.Sprite.fromFrame("finish_flag.png");q.position.x=k+3+g,q.position.y=20,e.addChild(q),this.letters.cacheAsBitmap=!0,this.lettersWindow.addChild(this.letters)}},j}),define("race/views/dashboard/lesson_switch",["require","registry"],function(a){"use strict";var b=a("registry"),c=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.player=b.get("player"),this.lineType=this.player.get("_raceLineType")||"multi",this.textures={multi:PIXI.Texture.fromFrame("line_toggle_multi.png"),single:PIXI.Texture.fromFrame("line_toggle_single.png")},this.el=new PIXI.Sprite(this.textures[this.lineType]),this.el.position.x=432,this.el.position.y=144+this.game.topOffset,$("#line-type-toggle").click(this.toggleLineType.bind(this))};return c.prototype={toggleLineType:function(){this.lineType="multi"==this.lineType?"single":"multi",this.player.set({_raceLineType:this.lineType}),this.el.setTexture(this.textures[this.lineType])}},c}),define("race/views/dashboard/capslock_warning",["require"],function(a){"use strict";var b=function(a){this.game=a.game,this.model=a.model,this.racer=a.racer,this.el=PIXI.Sprite.fromFrame("caps_lock.png"),this.el.position.y=77+this.game.topOffset,this.el.position.x=367,this.el.visible=!1,this.racer.on("change:capslock",this.toggle,this)};return b.prototype={toggle:function(){this.racer.get("capslock")?this.el.visible=!0:this.el.visible=!1}},b}),define("race/views/dashboard",["require","race/views/dashboard/background","race/views/dashboard/panel","race/views/dashboard/accuracy","race/views/dashboard/speed","race/views/dashboard/position","race/views/dashboard/time","race/views/dashboard/nitros","race/views/dashboard/speedo","race/views/dashboard/lesson_multi","race/views/dashboard/lesson_single","race/views/dashboard/lesson_switch","race/views/dashboard/capslock_warning","shared/classes/typing"],function(a){"use strict";var b=a("race/views/dashboard/background"),c=a("race/views/dashboard/panel"),d=a("race/views/dashboard/accuracy"),e=a("race/views/dashboard/speed"),f=a("race/views/dashboard/position"),g=a("race/views/dashboard/time"),h=a("race/views/dashboard/nitros"),i=a("race/views/dashboard/speedo"),j=a("race/views/dashboard/lesson_multi"),k=a("race/views/dashboard/lesson_single"),l=a("race/views/dashboard/lesson_switch"),m=a("race/views/dashboard/capslock_warning"),n=a("shared/classes/typing");return Backbone.View.extend({accuracyEle:null,speedEle:null,positionEle:null,timeEle:null,nitrosEle:null,speedoEle:null,lessonEle:null,deltaCounter:0,initialize:function(a){this.options=a,this.loader=a.loader,this.racer=a.racer,this.stage=a.stage,this.renderer=a.renderer,this.topOffset=a.topOffset||0,this.listenTo(this.racer,"change:nitrosUsed",this.useNitro),this.listenTo(this.model.racers,"add",this.update),this.listenTo(this.model.racers,"remove",this.update),this.listenTo(this.racer,"change",this.update),this.listenTo(this.model,"change:nitros",this.fillNitros),this.listenTo(this.racer,"change:nitros",this.fillNitros),this.listenTo(this.model,"change:seconds",this.update),this.loader.on("complete",function(){this.start()}.bind(this)),this.render()},start:function(){this.background=new b({game:this}),this.stage.addChild(this.background.el),this.nitrosEle=new h({game:this,nitros:0}),this.stage.addChild(this.nitrosEle.el),this.panel=new c({game:this}),this.stage.addChild(this.panel.el),this.accuracyEle=new d({game:this}),this.stage.addChild(this.accuracyEle.el),this.speedEle=new e({game:this}),this.stage.addChild(this.speedEle.el),this.positionEle=new f({game:this}),this.stage.addChild(this.positionEle.el),this.timeEle=new g({game:this}),this.stage.addChild(this.timeEle.el),this.speedoEle=new i({game:this,avgSpeed:this.racer.get("profile").avgSpeed}),this.stage.addChild(this.speedoEle.el),this.lessonMultiEle=new j({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.lessonMultiEle.el),this.lessonSingleEle=new k({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.lessonSingleEle.el),this.lessonSwitchEle=new l({game:this,model:this.model}),this.stage.addChild(this.lessonSwitchEle.el),this.capslockWarningEle=new m({game:this,model:this.model,racer:this.racer}),this.stage.addChild(this.capslockWarningEle.el),this.updateStage()},updateStage:function(){this.renderer.render(this.stage)},tick:function(a){},fillNitros:function(){this.nitrosEle.fill(this.model.get("nitros"),this.racer.get("nitros"))},useNitro:function(){this.nitrosEle.useNitro()},update:function(){var a=0,b=this.model.racers.get(this.racer.id);if(b){this.model.get("startStamp")&&(a=b.get("completeStamp")?(b.get("completeStamp")-this.model.get("startStamp"))/1e3:this.model.get("seconds"));var c=n.accuracy(b.get("typed")-b.get("skipped"),b.get("errors"));this.accuracyEle.update(c);var d=n.speed(b.get("typed")-b.get("skipped"),a);this.speedEle.update(d),"racing"==this.model.get("status")?this.positionEle.update(this.model.racers.getPlace(b.id),this.model.racers.length):this.positionEle.update(0,this.model.racers.length),this.timeEle.update(a),this.speedoEle.update(d)}},prettyTime:function(a){a=Math.ceil(a),isNaN(a)&&(a=0);var b=Math.floor(a/60);return a-=60*b,b+":"+String(a).pad(2,"0","STR_PAD_LEFT")}})}),define("race/views/qualifying",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({events:{"click a.button":"clickBegin"},initialize:function(){void 0===this.template&&(this.template=b("race","qualifying")),this.$el.fastHide(),this.render()},render:function(){this.setElement(this.template())},show:function(){this.$el.velocity("fadeIn")},clickBegin:function(){return this.remove(),this.trigger("close"),!1}})}),define("race/views/qualifying_complete",["require","shared/classes/typing","registry","templates"],function(a){"use strict";var b=a("shared/classes/typing"),c=(a("registry"),a("templates"));return Backbone.View.extend({events:{"click .car-choices .choice":"selectCar","click .button":"close"},initialize:function(a){void 0===this.template&&(NTGLOBALS("LOGGED_IN")?this.template=c("race","qualifying_complete"):this.template=c("race","qualifying_complete_guest")),this.speed=b.speed(a.racer.get("typed"),(a.racer.get("completeStamp")-a.racer.get("startStamp"))/1e3),this.render()},render:function(){this.$el.append(this.template({speed:this.speed}))},selectCar:function(a){return this.$(".choice.active").removeClass("active"),$(a.currentTarget).addClass("active"),!1},show:function(){this.$el.velocity("fadeIn")},close:function(a){if(!NTGLOBALS("LOGGED_IN"))return!0;var b=this.$(".choice.active").data("carid"),c=$(a.currentTarget).hasClass("button-race")?"race":"garage";return this.undelegateEvents(),$(a.currentTarget).addClass("pending"),this.trigger("close",{carID:b,goto:c}),!1}})}),define("race/views/settings",["require","templates","registry","global/views/modal"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("global/views/modal");return d.extend({initialize:function(a){d.prototype.initialize.apply(this,arguments),this.delegateEvents(_.extend(this.events,{"click .renderer":"changeRenderer"})),this.player=c.get("player"),void 0===this.template&&(this.template=b("race","settings")),this.render()},render:function(){var a,b=this.player.get("avgFPS");return a=b>=50?"great":b>=35?"good":b>=25?"fair":b>=20?"low":"poor",this.$el.append(this.template({avgFPS:b,fpsGrade:a,renderer:$.cookie("ntTrackRenderer"),hasWebGL:window.supportsWebGL()})),this},changeRenderer:function(a){var b=$(a.currentTarget).val();$.cookie("ntTrackRenderer")!=b&&this.$(".render-change").fastShow(),$.cookie("ntTrackRenderer",b,{path:"/",expires:365})}})}),define("global/views/window",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({className:"popup-base",events:{"click .close":"hide","click .alt-button":"clickAltButton","click .main-button":"clickMainButton"},initialize:function(a){this.$el.html('<div class="popup-overlay"></div>'),this.options=a},_initialize:function(){void 0===this.template&&(this.template=b("global","window")),this.render(),this.inited=!0},render:function(){this.$el.append(this.template({options:this.options})),$("body div.wrap").append(this.el)},show:function(){return this.inited||this._initialize(),this.$el.velocity("fadeIn"),!1},hide:function(){return this.$el.hide(),!1},clickMainButton:function(){return this.handleButtonClick(this.options.mainButtonHandler),!1},clickAltButton:function(){return this.handleButtonClick(this.options.altButtonHandler),!1},handleButtonClick:function(a){"string"==typeof a?"close"==a?this.hide():location.href=a:"function"==typeof a&&a(),this.hide()}})}),define("race/views/loader",["require","templates"],function(a){"use strict";var b=a("templates");return Backbone.View.extend({verbs:["Installing","Loading","Upgrading","Maintaining"],nouns:["Mufflers","Steering Wheels","Nitros","Achievements","Transmissions","Fish Heads","Ergonomic Keyboards","Wireless Mice (and Rats)","Corndogs","Coffee","Alternator","Sunroofs","Belts","Fans","Performance Chips","Struts","Knuckle"],header:"",message:"",initialize:function(a){void 0===this.template&&(this.template=b("race","loader")),
_.extend(this,a),this.render()},render:function(){this.update()},update:function(a,b){this.header=a||this.header,this.message=b||this.message,this.$el.html(this.template({header:this.header,message:this.message}))},randomMessage:function(a){var b="Please wait... "+this.verbs[Math.floor(Math.random()*this.verbs.length)]+" "+this.nouns[Math.floor(Math.random()*this.nouns.length)];a&&(b+=a),this.update(null,b)}})}),define("race/index",["require","registry","analytics","race/models/race","race/models/practice_race","race/models/qualifying_race","race/models/racer","race/views/invite","race/views/chat","race/views/top","race/views/track","race/classes/keyboard_input","race/classes/asset_loader","race/views/dashboard","race/views/qualifying","race/views/qualifying_complete","global/views/race_results","race/views/settings","global/views/window","race/views/loader","global/views/player_hover"],function(a){"use strict";var b=a("registry"),c=a("analytics"),d=a("race/models/race"),e=a("race/models/practice_race"),f=a("race/models/qualifying_race"),g=a("race/models/racer"),h=a("race/views/invite"),i=a("race/views/chat"),j=a("race/views/top"),k=a("race/views/track"),l=a("race/classes/keyboard_input"),m=a("race/classes/asset_loader"),n=a("race/views/dashboard"),o=a("race/views/qualifying"),p=a("race/views/qualifying_complete"),q=a("global/views/race_results"),r=a("race/views/settings"),s=a("global/views/window"),t=a("race/views/loader"),u=a("global/views/player_hover"),v=console,w=function(){return document.body?(document.co=1,void(document.body.__defineGetter__&&(document.body.__defineGetter__("id",function(){document.co=2}),v.log(document.body),v.clear(),2==document.co||setTimeout(w,1e3)))):void setTimeout(w,1e3)};return"production"==NTGLOBALS("ENV")&&w(),Backbone.View.extend({el:"#app",events:{"click .friends-controls .invite":"inviteFriends","click .friends-controls .start-race":"beginFriendRace","click #settings-button":"openSettings"},initialize:function(a){this.options=a,this.options.debugging=!1,window.onbeforeunload=this.leavingRaceError.bind(this),$.cookie("ntTrackRenderer")||$.cookie("ntTrackRenderer","canvas",{path:"/",expires:365}),this.player=b.get("player"),this.racer=new g({profile:this.player.toJSON()}),this.options.avgSpeed=this.player.get("avgSpeed"),this.options.forceEarlyPlace=this.player.get("forceEarlyPlace"),this.listenTo(this.racer,"change:rewards",this.racerComplete),this.listenTo(this.racer,"change:disqualified",this.racerDisqualified),this.options.avgSpeed||(this.options.track="grass",this.options.music="desert"),this.loader=new m(this.options),b.get("isMobile")&&!this.player.get("_raceLineType")&&this.player.set({_raceLineType:"single"}),this.options.practice?(this.race=new e,this.racer.get("profile").nitros=0):this.options.avgSpeed||this.options.trackLeader||0!==this.player.get("racesPlayed")?(this.race=new d({version:2}),this.options.trackLeader):(this.race=new f,this.qualifying=new o({noOverlay:!0}),this.qualifying.on("close",function(){$("body").focus(),this.race.beginCountdown()}.bind(this))),this.listenTo(this.race,"change:status",this.statusChange),this.listenTo(this.race,"error",this.raceError),this.loaderView=new t({header:"Loading Race Files",message:"Please wait..."}),this.options.trackLeader&&(this.chat=new i({race:this.race})),this.race.racers.on("add",function(a){if(a.id==b.get("player").id){var c=a.toJSON();c.joinPosition=this.race.racers.length,this.racer.set(c)}}.bind(this)),this.render(),this.cacheElements(),this.scrollToPosition(),this.loader.once("complete",function(){var a=0;this.player.get("raceRenderDelay")&&(a=1e3*this.player.get("raceRenderDelay")),setTimeout(this.showTrack.bind(this),a)},this),this.loader.once("error",function(a,b){this.raceError({type:"assets",asset:b})},this),setTimeout(function(){this.loader.on("progress",function(a){this.loaderView.update("",Math.floor(100*a.progress)+"% complete")},this)}.bind(this),1e3),this.loader.load()},showTrack:function(){this.loaderView.remove(),this.options.avgSpeed&&0===this.player.get("racesPlayed")&&this.$(".first-race-tip").velocity("fadeIn"),this.input=new l({model:this.race,racer:this.racer}),b.get("isMobile")?$("#race-input").one("touchstart",this.joinRace.bind(this)):this.joinRace()},joinRace:function(){this.qualifying&&this.qualifying.show(),this.race.join(this.racer,this.options)},cachedEles:{},cacheElements:function(){this.cachedEles["settings-tooltip"]=this.$("#settings-tooltip"),this.cachedEles["sound-tooltip"]=this.$("#sound-tooltip"),this.cachedEles["race-tip"]=this.$(".race-tip"),this.cachedEles["friends-race"]=this.$(".friends-race"),this.cachedEles["friends-controls"]=this.$(".friends-controls")},statusChange:function(a,b){"countdown"==b&&(this.cachedEles["settings-tooltip"].fastHide(),this.cachedEles["sound-tooltip"].fastHide(),this.cachedEles["race-tip"].fastHide(),this.cachedEles["friends-race"].fastHide(),this.cachedEles["friends-controls"].fastHide()),"expired"==b&&(c.trackEvent("Race","Expired"),this.expireRace())},inviteFriends:function(){if("open"==this.race.get("status"))return this.invite||(this.invite=new h),this.invite.show(),!1},beginFriendRace:function(a){if("open"==this.race.get("status"))return this.cachedEles["friends-controls"].fastHide(),this.race.beginFriendRace(),!1},render:function(){var a=$("#race-track")[0];if(this.stage=new PIXI.Stage(0,!1),this.stage.interactive=!1,"webgl"==$.cookie("ntTrackRenderer")?this.renderer=PIXI.autoDetectRenderer(a.width,a.height,{view:a,transparent:!1}):this.renderer=new PIXI.CanvasRenderer(a.width,a.height,{view:a,transparent:!1}),this.$("#track-loader").append(this.loaderView.el),this.top=new j({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer}),this.track=new k({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:80}),this.dashboard=new n({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:400}),createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",this.tick.bind(this)),this.updateFPS(),this.qualifying&&this.$(".page-race").append(this.qualifying.el),!this.options.fake&&this.options.trackLeader)this.chat&&this.$el.append(this.chat.el),this.options.trackLeader==b.get("player").get("username")?this.$(".friends-controls").fastShow():this.$(".friends-race").fastShow();else if(!this.options.practice){var c=NTGLOBALS("TIPS"),d=this.$(".race-tip"),e=d.html();d.html(e+c[Math.floor(Math.random()*c.length)]).fastShow()}},frames:0,lastStamp:0,incTime:0,tick:function(a){var b=performance.now();this.lastStamp||(this.lastStamp=b);var c={delta:b-this.lastStamp,fps:this.fps};this.lastStamp=b,this.incTime+=c.delta,this.frames++,this.top.tick(c),this.track.tick(c);try{this.renderer.render(this.stage)}catch(a){window.onerror("Render Loop: "+a.message,a.fileName,a.lineNumber,a.columnNumber,a)}},lastFPSStamp:0,fpsCache:[],fps:0,zeroFpsCount:0,updateFPS:function(){var a=performance.now();this.lastFPSStamp&&(this.fps=this.frames/(a-this.lastFPSStamp)*1e3,this.fpsCache.push(this.fps),0===Math.round(this.fps)&&this.zeroFpsCount++,this.frames=0),this.lastFPSStamp=a,setTimeout(this.updateFPS.bind(this),1e3)},saveFPS:function(){if(this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(this.racer.get("disqualified")||this.racer.get("error"))&&$.post("/api/settings/fpscache",{raceID:this.race.get("id"),fps:this.fpsCache,position:this.racer.get("joinPosition"),renderer:$.cookie("ntTrackRenderer"),perfTestFps:"WebGL: "+this.player.get("_webglFPS")+", Canvas: "+this.player.get("_canvasFPS"),dq:this.racer.get("disqualified")?1:0,error:this.racer.get("error"),errorStack:this.racer.get("errorStack"),webglSupport:window.supportsWebGL()?1:0,errorMessage:this.racer.get("errorMessage"),socket:b.get("realtime").socket.transport.ws?"websocket":"polling",forceEarlyPlace:this.player.get("forceEarlyPlace")?1:0,racerRenderDelay:this.player.get("raceRenderDelay")}),this.fpsCache.length>10){var a=this.fpsCache.slice(4,-1),c=a.reduce(function(a,b){return a+b},0)/a.length;if((this.zeroFpsCount>3||this.player.get("avgFPS")>40&&c<20)&&(this.zeroFpsCount>3&&this.cachedEles["settings-tooltip"].html("Performance Issues Detected<br />View Performance Settings"),this.cachedEles["settings-tooltip"].velocity("fadeIn")),this.player.set({avgFPS:c}),"basic"==this.player.get("membership")){a=this.fpsCache.slice(1,9).sort(),a.pop();var d=a.reduce(function(a,b){return a+b},0)/a.length,e=Math.floor(this.fpsCache.length/2);a=this.fpsCache.slice(e,e+5);var f=a.reduce(function(a,b){return a+b},0)/a.length;d<=15&&f>=2*d&&this.player.set({forceEarlyPlace:!0}),this.player.get("raceRenderDelay")?this.player.inc({raceRenderDelay:-1}):d<=15&&f>=4*d&&this.player.set({raceRenderDelay:10})}}},scrollToPosition:function(){var a="gold"==this.player.get("membership")?780:880,b=$(window).height(),c=a-b;if(!(c<0)){"gold"!=this.player.get("membership")&&c<200&&(c+=200-c),window.pageTopPadding&&(c+=window.pageTopPadding);try{$(window).scrollTop(c)}catch(a){}}},racerComplete:function(){this.saveFPS(),this.options.fake||(this.input.stop(),this.options.practice?(this.racer.savePractice(),this.showRaceResults()):this.player.get("avgSpeed")||this.options.trackLeader||0!==this.player.get("racesPlayed")?this.racer.get("rewards")&&(this.race.std=this.input.getKeyStd(),this.racer.save(this.race),this.showRaceResults()):this.showQualifyingComplete())},showRaceResults:function(){var a=new u,b=("gold"==this.player.get("membership")?780:880)+(window.pageTopPadding||0);setTimeout(function(){new q({model:this.race,practice:this.options.practice,hover:a}).show(b,!0)}.bind(this),this.options.practice?0:2e3)},showQualifyingComplete:function(){var a=new p({racer:this.racer});NTGLOBALS("LOGGED_IN")?a.on("close",function(a){this.racer.saveQualifying(this.race,a).done(function(b){b.success?location.href="/"+a.goto:alert("Uh oh.. There was a problem saving your qualifying score.  Please try again or contact support! "+b.error)})}.bind(this)):this.racer.saveQualifying(this.race),setTimeout(function(){this.$(".page-race").append(a.el),a.show()}.bind(this),2e3)},racerDisqualified:function(){c.trackEvent("Race","Disqualification"),this.input.stop(),this.race.logs.push({event:"disqualified window",stamp:Date.now()}),this.saveFPS();var a="Uh oh! You have been disqualified due to inactivity.";this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(a+='</p><div class="dq-error" id="dq-error"><p>Was this disqualification an error? If so, please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">');var b=new s({hideCloseButton:!1,title:"Disqualified",body:a,mainButtonText:"Race Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}});b.show(),this.options.debugging&&NTGLOBALS("LOGGED_IN")&&$("#dq-error-send").click(function(a){a.target.disabled=!0,$.post("/api/race/log-dq",{id:this.race.get("id"),type:"disqualification",logs:this.race.logs,msg:$("#dq-report").val()}),$("#dq-error").velocity("slideUp",function(){$("#dq-after-error").html("<p>Thanks for helping us improve Nitro Type!</p>")})}.bind(this))},expireRace:function(){this.input.stop(),this.race.logs.push({event:"expired window",stamp:Date.now()}),this.saveFPS();var a="Uh oh! The race has expired due to inactivity. Please start another race to continue.",b=new s({hideCloseButton:!1,title:"Race Expired",body:a,mainButtonText:"Race Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}});b.show()},openSettings:function(){var a=new r({racer:this.racer});return a.show(),!1},leavingRaceError:function(a){if(!(this.racer.get("completeStamp")||this.racer.get("error")||this.racer.get("disqualified")||this.options.practice)){var b=null;return"racing"==this.race.get("status")||"countdown"==this.race.get("status")?(b="The race is currently active! Are you sure you want to leave?",a.returnValue=b,b):void 0}},raceError:function(a){if(!("expired"==this.race.get("status")||this.racer.get("completeStamp")||this.racer.get("disqualified")||this.racer.get("error"))){c.trackEvent("Race","Error",a.type),this.racer.set({error:a.type,errorMessage:a.message,errorStack:a.stack}),"connection"!=a.type&&"closed"!=a.type||this.saveFPS(),this.input&&this.input.stop(),a=a||{};var b="Communications Error",d="There was an error communicating with the race server.<br /><br />Most common reasons:<ul><li>Your Internet connection is slow, unreliable, or unexpectedly stopped.</li><li>Your Internet connection is behind a firewall or proxy that is causing problems.</li></ul>";if("in race"==a.type)b="Currently in a Race",d="You are currently engaged in an active race. You must wait a moment until you are disqualified from that race before you can continue.";else if("cannot rejoin"==a.type)b="Connection Lost";else if("accuracy"==a.type)b="Accuracy Too Low",d="Oops, your accuracy is only "+a.accuracy+"%, which is too low to qualify in a race!";else if("no userid"==a.type)b="Invalid Session",d="It is possible you have been logged out of your session.  Please log out and back in to continue.";else if("cookies required"==a.type)b="Cookies Required",d='It appears that your browser has "cookies" disabled. You must enable cookie support to play Nitro Type.';else if("invalid session"==a.type)b="Invalid Session",d="Something appears to be wrong with your session. Please log out and back in.";else if("race is full"==a.type)b="Race Is Full",d="The race you are attempting to join is already full. Most likely you were invited to a race with a friend, but unfortunately there are already 5 racers playing.";else if("assets"==a.type)b="Problem Loading Game Files",d="A required game file failed to load.<br /><br />File that could not load: "+a.asset+"  <br /><br />Please try again.<br /><br />If this continues, please contact Nitro Type support!";else{if("banned"==a.type)return this.player.logout(),void(location.href="/");"connection"==a.type?(d='There was an error communicating with the race server.<br /><br />Message: "'+a.message+'"',this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(d+='</p><div class="dq-error" id="dq-error"><p>Uh oh, we don\'t like this! Please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">')):"closed"==a.type&&(d="There was an error communicating with the race server.<br /><br />Message: Connection Closed",this.options.debugging&&NTGLOBALS("LOGGED_IN")&&(d+='</p><div class="dq-error" id="dq-error"><p>Uh oh, we don\'t like this! Please describe what happened in as much detail as possible.</p><textarea placeholder="Error Report" id="dq-report"></textarea> <button id="dq-error-send">Send Error Report</button></div><p id="dq-after-error">'))}var e=new s({hideCloseButton:!0,title:b,body:d,mainButtonText:"Try Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}});e.show(),this.options.debugging&&NTGLOBALS("LOGGED_IN")&&("connection"==a.type||"closed"==a.type)&&(this.race.logs.push({event:"error window",stamp:Date.now(),data:{type:a.type,message:a.message}}),$("#dq-error-send").click(function(b){b.target.disabled=!0,$.post("/api/race/log-dq",{id:this.race.get("id"),type:a.message,logs:this.race.logs,msg:$("#dq-report").val()}),$("#dq-error").velocity("slideUp",function(){$("#dq-after-error").html("<p>Thanks for helping us improve Nitro Type!</p>")})}.bind(this)))}}})}),define("race/models/performance_test_race",["require","race/models/practice_race"],function(a){"use strict";var b=a("race/models/practice_race");return b.extend({join:function(){this.begin(),this.countdown("some text",1),this.set({status:"racing"})}})}),define("race/performance_test",["require","registry","race/models/performance_test_race","race/models/racer","race/views/top","race/views/track","race/classes/asset_loader","race/views/dashboard","race/views/loader","global/views/window"],function(a){"use strict";var b=a("registry"),c=a("race/models/performance_test_race"),d=a("race/models/racer"),e=a("race/views/top"),f=a("race/views/track"),g=a("race/classes/asset_loader"),h=a("race/views/dashboard"),i=a("race/views/loader"),j=a("global/views/window");return Backbone.View.extend({el:"#app",initialize:function(a){return this.options=a||{},window.supportsWebGL()?(this.player=b.get("player"),this.racer=new d({profile:this.player.toJSON()}),this.player.get("_webglFPS")?this.options.renderer="webgl":this.options.renderer="canvas",this.options.track="grass",this.options.music="desert",this.loader=new g(this.options),this.loaderView=new i({header:"Loading Race Files",message:"Please wait..."}),this.race=new c,this.listenTo(this.race,"change:status",this.statusChange),this.render(),this.scrollToPosition(),this.loader.once("complete",function(){this.joinRace()}.bind(this)),this.loader.once("error",function(a,b){this.raceError({type:"assets",asset:b})},this),setTimeout(function(){this.loader.on("progress",function(a){this.loaderView.update("",Math.floor(100*a.progress)+"% complete")},this)}.bind(this),1e3),void this.loader.load()):void(location.href="/")},joinRace:function(){this.qualifying&&this.qualifying.show(),this.race.join(this.racer,this.options),this.testSeconds=0,this.loaderView.$el.addClass("test-loader"),this.loaderView.verbs=["Polishing","Wrenching","Bolting","Soldering","Welding"],this.loaderView.update("Testing "+("canvas"==this.options.renderer?"Canvas":"WebGL")+" Performance"),this.updateFeedback()},updateFeedback:function(){return this.loaderView.randomMessage(" ("+Math.round(this.testSeconds/5*100)+"%)"),this.testSeconds>=5?void this.testComplete():(this.testSeconds++,void setTimeout(this.updateFeedback.bind(this),1e3))},testComplete:function(){var a,b=this.fpsCache.slice(1,-1),c=_.reduce(b,function(a,b){return a+b},0)/(0===b.length?1:b.length),d={};if(d["_"+this.options.renderer+"FPS"]=c,this.player.set(d),this.player.get("_canvasFPS")>55||this.player.get("_canvasFPS")&&this.player.get("_webglFPS")){this.loaderView.update("Test Complete","Prepare To Race!");var e=this.player.get("_canvasFPS")||0,f=this.player.get("_webglFPS")||0;f-=5,a=f>e?"webgl":"canvas",$.cookie("ntTrackRenderer",a,{path:"/",expires:365}),setTimeout(function(){location.href="/race"+(location.hash?"/"+location.hash.replace("#",""):"")},1e3)}else location.reload()},render:function(){var a=$("#race-track")[0];a.style.position="absolute",a.style.top="-1000px",this.stage=new PIXI.Stage(0),"webgl"==this.options.renderer?this.renderer=new PIXI.WebGLRenderer(a.width,a.height,{view:a,transparent:!1}):this.renderer=new PIXI.CanvasRenderer(a.width,a.height,{view:a,transparent:!1}),this.$("#track-loader").append(this.loaderView.el),this.top=new e({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer}),this.track=new f({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:80}),this.track.playSound=function(){},this.dashboard=new h({model:this.race,racer:this.racer,loader:this.loader,stage:this.stage,renderer:this.renderer,topOffset:400}),this.tick(),this.updateFPS()},frames:0,lastStamp:0,incTime:0,tick:function(){var a=performance.now();this.lastStamp||(this.lastStamp=a);var b={delta:a-this.lastStamp,fps:this.fps};this.lastStamp=a,this.incTime+=b.delta,this.frames++,createjs.Tween.tick(b.delta),this.top.tick(b),this.track.tick(b),this.renderer.render(this.stage),requestAnimFrame(this.tick.bind(this))},lastFPSStamp:0,fpsCache:[],fps:0,updateFPS:function(){var a=performance.now();this.lastFPSStamp&&(this.fps=this.frames/(a-this.lastFPSStamp)*1e3,this.fpsCache.push(this.fps),this.frames=0),this.lastFPSStamp=a,setTimeout(this.updateFPS.bind(this),1e3)},scrollToPosition:function(){var a="gold"==this.player.get("membership")?780:880,b=$(window).height(),c=a-b;if(!(c<0)){"gold"!=this.player.get("membership")&&c<200&&(c+=200-c),window.pageTopPadding&&(c+=window.pageTopPadding);try{$(window).scrollTop(c)}catch(a){}}},raceError:function(a){a=a||{};var b,c;b="Problem Loading Game Files",c="A required game file failed to load.<br /><br />File that could not load: "+a.asset+"  <br /><br />Please try again.<br /><br />If this continues, please contact Nitro Type support!";var d=new j({hideCloseButton:!0,title:b,body:c,mainButtonText:"Try Again",mainButtonHandler:function(){location.reload()},altButtonText:"Garage",altButtonHandler:function(){location.href="/garage"}});d.show()}})}),define("support/models/contact_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/contact",defaults:{name:null,email:null,body:null},validationRules:{name:{required:!0},email:{required:!0,email:!0},body:{required:!0,minlength:75}},validationMessages:{name:{required:"Please enter your name"},email:{required:"Please enter your email",email:"Please enter a valid email"},body:{required:"Please enter a descriptive message",minlength:"Your message looks a little short. Please provide more information."}}})}),define("support/index",["require","support/models/contact_form","shared/classes/form_validation"],function(a){"use strict";var b=a("support/models/contact_form"),c=a("shared/classes/form_validation"),d=Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){var a=new b;new c(this.$("form"),this.$("form .button"),a,this.successCallback,this)},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".success").velocity("slideDown")}});return d}),define("refund/models/contact_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/contact/refund",defaults:{name:null,email:null,body:null},validationRules:{name:{required:!0},ccLast4:{required:!0,number:!0},postalCode:{number:!0},amount:{number:!0,required:!0},email:{required:!0,email:!0},date:{required:!0},body:{required:!1}},validationMessages:{name:{required:"Please enter your name"},email:{required:"Please enter your email",email:"Please enter a valid email"}}})}),define("refund/index",["require","refund/models/contact_form","shared/classes/form_validation"],function(a){"use strict";var b=a("refund/models/contact_form"),c=a("shared/classes/form_validation"),d=Backbone.View.extend({el:"#app",initialize:function(){this.render()},render:function(){var a=new b;new c(this.$("form"),this.$("form .button"),a,this.successCallback,this)},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".success").velocity("slideDown")}});return d}),define("profile/models/profile",["require"],function(a){"use strict";return Backbone.Model.extend({initialize:function(){$.get("/api/settings").done(function(a){a.success?this.set(a.data):alert("There was an error fetching your profile data")}.bind(this))}})}),define("profile/models/profile_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({initialize:function(){$.validator.addMethod("displayName",function(a,b){return!a.match(/<|\>|\"|\'|@|\s+/i)},"Can not contain @, &lt;, &gt;, or quote symbols, or spaces")},url:"/api/settings/profile",defaults:{displayName:"",title:1,gender:"",country:""},validationRules:{displayName:{maxlength:20,minlength:4,displayName:!0}},validationMessages:{}})}),define("profile/models/account_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/settings/account",defaults:{firstname:"",lastname:"",email:"",birthYear:"",contact:0,password:""},validationRules:{password:{required:!0}},validationMessages:{}})}),define("profile/models/social_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/settings/social",defaults:{offlineMode:0,allowFriendRequests:1,lookingForTeam:"no"},validationRules:{},validationMessages:{}})}),define("profile/models/password_form",["require","shared/classes/form_model","registry"],function(a){"use strict";var b=a("shared/classes/form_model"),c=a("registry");return b.extend({initialize:function(){$.validator.addMethod("notMatchUsername",function(a){return a!=c.get("player").get("username")},"Can not match username"),$.validator.addMethod("notMatchPassword",function(a){return a!=this.findByName("password").val()},"Same as password")},url:"/api/settings/password",defaults:{password:"",newPassword:"",newPassword2:""},validationRules:{password:{required:!0},newPassword:{minlength:4,notMatchUsername:!0,notMatchPassword:!0},newPassword2:{minlength:4,equalTo:"input[name=newPassword]"}},validationMessages:{newPassword:{notMatchUsername:"Password can not be the same as your username",notMatchPassword:"That is the same as your Current Password"},newPassword2:{equalTo:"Passwords do not match"}}})}),define("profile/index",["require","templates","registry","profile/models/profile","shared/classes/form_validation","profile/models/profile_form","profile/models/account_form","profile/models/social_form","profile/models/password_form"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("profile/models/profile"),e=a("shared/classes/form_validation"),f=a("profile/models/profile_form"),g=a("profile/models/account_form"),h=a("profile/models/social_form"),i=a("profile/models/password_form"),j=Backbone.View.extend({el:".profile-sections",initialize:function(){return void 0===this.template&&(this.template=b("profile","index")),NTGLOBALS("LOGGED_IN")?(this.player=c.get("player"),this.model=new d,void this.listenTo(this.model,"change",this.render)):void(location.href="/")},render:function(){this.$el.html(this.template({player:this.player.toJSON(),data:this.model.toJSON(),countries:NTGLOBALS("COUNTRIES")})),new e(this.$("form[name=profile]"),this.$("form[name=profile] .button"),new f,this.profileCallback,this),new e(this.$("form[name=account]"),this.$("form[name=account] .button"),new g,this.accountCallback,this),new e(this.$("form[name=social]"),this.$("form[name=social] .button"),new h,this.socialCallback,this),"standard"==this.player.get("accountType")&&new e(this.$("form[name=password]"),this.$("form[name=password] .button"),new i,this.passwordCallback,this)},profileCallback:function(a,b,c){a=b.toJSON(),a.title=this.model.get("titles")[a.title],this.player.set(a),c.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your racer profile has been updated</p>").velocity("fadeIn")})},accountCallback:function(a,b,c){c.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your account info has been updated</p>").velocity("fadeIn")})},socialCallback:function(a,b,c){this.player.set({offline:parseInt(b.get("offlineMode"),10),allowFriendRequests:parseInt(b.get("allowFriendRequests"),10),lookingForTeam:"yes"==b.get("lookingForTeam")?1:0}),c.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your social settings have been updated</p>").velocity("fadeIn")})},passwordCallback:function(a,b,c){c.velocity("slideUp",800,"easeOut",function(){$(this).html("<p>Your password has been updated</p>").velocity("fadeIn")})}});return j}),define("newpass/models/form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/lostpass-change",defaults:{password:"",password2:""},validationRules:{password:{required:!0,minlength:4},password2:{required:!0,minlength:4,equalTo:"input[name=password]"}},validationMessages:{password2:{equalTo:"Passwords do not match"}}})}),define("newpass/index",["require","shared/classes/form_validation","newpass/models/form"],function(a){"use strict";var b=a("shared/classes/form_validation"),c=a("newpass/models/form"),d=Backbone.View.extend({el:"#app",events:{"keypress input":"submitOnEnter"},initialize:function(){var a=location.hash.replace("#","").split(":");a[0]&&a[1]||(location.href="/"),this.$("form input[name=hash]").val(a[1]),this.$("form input[name=userID]").val(a[0]),new b(this.$("form"),this.$("form .button"),new c,this.callback,this)},callback:function(a,b,c){c.velocity("slideUp",function(){this.$(".content-box").append('<p>Your password has been updated.  You can <a href="#" class="login-link">Log In</a> now</p>').velocity("fadeIn")}.bind(this))},submitOnEnter:function(a){if(13===a.keyCode)return $(a.currentTarget).blur(),this.$("form").submit(),!1}});return d}),define("team/models/team",["require"],function(a){"use strict";return Backbone.Model.extend({idAttribute:"teamID",defaults:{name:"",tag:"",tagColor:"",members:0,createdStamp:0,username:"",displayName:"",userID:"",enrollment:"open",lastModified:0,minSpeed:0,minLevel:0,otherRequirements:""},leave:function(a){return $.post("/api/teams/leave").done(function(b){b.success&&a.set({teamID:0,tag:"",tagColor:"",totalTeammates:0})})}},{getTeamByTag:function(a){return $.get("/api/teams/"+a)}})}),define("team/collections/teams",["require","team/models/team"],function(a){"use strict";var b=a("team/models/team");return Backbone.Collection.extend({model:b,searchAndInvites:function(a){a.page||this.trigger("request");var b=this;return $.post("/api/teams/search",a).done(function(c){c.success&&(a.page>0?b.add(c.data.teams):b.reset(c.data.teams),c.data.teams.length<a.pageSize&&b.trigger("end"))})},ignoreInvitation:function(a){return $.post("/api/teams/"+a+"/ignore-invite")},acceptInvitation:function(a){return $.post("/api/teams/"+a+"/accept-invite")}})}),define("team/views/index_invites",["require","templates","registry"],function(a){"use strict";var b=a("templates"),c=a("registry");return Backbone.View.extend({events:{"click tbody tr":"handleRowClick"},initialize:function(){this.template=b("team","index_invites"),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=c.get("player"),this.render()},render:function(){this._rendered?this.$el.html(this.template({data:this.model.toJSON(),waiting:!1})):(this.$el.html(this.template({waiting:!0})),this._rendered=!0)},removeRow:function(a){this.$("#row-"+a.id).velocity("fadeOut",function(){this.render()}.bind(this))},getRowId:function(a){return $(a.currentTarget).data("id")},handleRowClick:function(a){var b=this.model.get(this.getRowId(a));return $(a.target).is(".join")?this.model.acceptInvitation(b.id).done(function(a){a.success?(this.player.set({tag:b.get("tag"),tagColor:b.get("tagColor"),teamID:b.get("teamID")}),alert("You are now a member of "+b.get("tag")+"!"),location.href="/team/"+b.get("tag")):alert(a.data.message)}.bind(this)):$(a.target).is(".ignore")?(this.model.ignoreInvitation(b.id),this.model.remove(b)):$(a.currentTarget).is("tr")&&(location.href="/team/"+this.model.get(this.getRowId(a)).get("tag")),!1}})}),define("team/index",["require","team/collections/teams","profile/models/social_form","team/views/index_invites","templates","registry"],function(a){"use strict";var b=a("team/collections/teams"),c=a("profile/models/social_form"),d=a("team/views/index_invites"),e=a("templates"),f=a("registry");return Backbone.View.extend({el:"#app",events:{"click .team-preview":"handleTeamClick","change .lft-select":"changeLookingForTeam"},initialize:function(){void 0===this.template&&(this.template=e("team","index")),this.player=f.get("player"),this.model=new b,this.listenTo(this.model,"reset",this.render),this.player.get("lookingForTeam")&&(this.invites=new b,this.invitesView=new d({model:this.invites})),this.render(),this.model.searchAndInvites({minLevel:this.player.get("level"),minSpeed:this.player.get("avgSpeed"),invites:this.player.get("lookingForTeam")}).done(function(a){
this.player.get("lookingForTeam")&&this.invites.reset(a.data.invites)}.bind(this)),this.player.set({teamApplications:0})},render:function(){var a=$(this.template({waiting:!this.rendered,player:this.player.toJSON(),teams:this.model.toJSON(),info:NTGLOBALS("TEAM_INFO"),loggedIn:NTGLOBALS("LOGGED_IN")}));this.invitesView&&this.rendered&&a.find("#teamInvites").html(this.invitesView.el),this.$el.html(a),this.rendered=!0},handleTeamClick:function(a){location.href="/team/"+this.model.get($(a.currentTarget).data("id")).get("tag")},changeLookingForTeam:function(a){var b=$(a.target).val(),d=new c;d.clear(),d.set({lookingForTeam:b}),this.player.set({lookingForTeam:"yes"==b?1:0}),d.save()}})}),define("team/search",["require","team/collections/teams","templates","analytics","registry"],function(a){"use strict";var b=a("team/collections/teams"),c=a("templates"),d=a("analytics"),e=a("registry"),f=Backbone.View.extend({page:0,pageSize:8,order:"level",minLevel:0,minSpeed:0,el:"#app",events:{"click .search":"newSearch","click .team-preview":"handleTeamClick","click .show-more a":"showMore"},initialize:function(){void 0===this.template&&(this.template=c("team","search"),this.resultsTemplate=c("team","search_results")),this.player=e.get("player"),this.model=new b,this.listenTo(this.model,"reset",this.renderResults),this.listenTo(this.model,"add",this.addResults),this.listenTo(this.model,"request",this.showSpinner),this.listenTo(this.model,"end",this.removeShowMore),this.render(),this.newSearch()},render:function(){this.$el.html(this.template({level:Math.min(10*Math.floor(this.player.get("level")/10),200),speed:Math.min(10*Math.floor(this.player.get("avgSpeed")/10),200)}))},newSearch:function(){return this.page=0,this.minSpeed=this.$("select[name=minSpeed]").val(),this.minLevel=this.$("select[name=minLevel]").val(),this.order=this.$("select[name=order]").val(),this.search(),!1},search:function(){d.trackEvent("Team","Search"),this.model.searchAndInvites({minLevel:this.minLevel,minSpeed:this.minSpeed,page:this.page,pageSize:this.pageSize,order:this.order})},renderResults:function(){this.hideSpinner(),this.$(".show-more").show(),this.$(".results").html(this.resultsTemplate({teams:this.model.toJSON()}))},addResults:function(a){var b=$(this.resultsTemplate({teams:[a.toJSON()]})).hide();this.$(".results").append(b),b.velocity("fadeIn")},showSpinner:function(){this.$(".spinner").show(),this.$(".team-list").hide()},hideSpinner:function(){this.$(".spinner").hide(),this.$(".team-list").show()},removeShowMore:function(){this.$(".show-more").hide()},handleTeamClick:function(a){location.href="/team/"+this.model.get($(a.currentTarget).data("id")).get("tag")},showMore:function(){return this.page+=1,this.search(),!1}});return f}),define("team/models/create_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:function(){return this.get("teamID")?"/api/teams/update":"/api/teams/create"},defaults:{tag:null,name:null,tagColor:null,minLevel:0,minSpeed:0,otherRequirements:null,password:""},validationRules:{tag:{required:!0,maxlength:4,minlength:2,alphanum:!0},name:{required:!0,maxlength:20},minLevel:{maxlength:3,number:!0},minSpeed:{maxlength:3,number:!0},otherRequirements:{maxlength:150},password:{required:!0}},validationMessages:{}})}),define("team/edit",["require","templates","registry","team/models/team","team/models/create_form","shared/classes/form_validation"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("team/models/team"),e=a("team/models/create_form"),f=a("shared/classes/form_validation"),g=Backbone.View.extend({el:"#app",events:{"click .tag-colors a":"changeColor","keyup input[name=tag]":"updatePreview","keyup input[name=name]":"updatePreview"},initialize:function(){void 0===this.template&&(this.template=b("team","create")),this.player=c.get("player"),d.getTeamByTag(this.player.get("tag")).done(function(a){if(a.success){if(a.data.info.userID!=this.player.id)return void(location.href="/team/"+a.data.info.tag);this.model=new d(a.data.info),this.render(),this.$(".spinner").hide(),this.$(".create-contents").show()}else alert("There was an error fetching your team information."),location.href="/team"}.bind(this))},render:function(){this.$el.html(this.template({team:this.model.toJSON(),player:this.player.toJSON(),teamInfo:NTGLOBALS("TEAM_INFO"),colors:NTGLOBALS("TEAM_COLORS")})),this.$(".spinner").show(),this.$(".create-contents").hide(),new f(this.$("form"),this.$(".create"),new e,this.editTeam,this)},updatePreview:function(){var a=this.$("input[name=tag]").val()||"TAG",b=this.$("input[name=name]").val()||"Your Team Name";this.$(".tag-preview").html("["+a.toUpperCase()+"]"),this.$(".name-preview").html(b)},changeColor:function(a){var b=$(a.currentTarget),c=b.data("color");return this.$("input[name=tagColor]").val(c),this.$(".tag-colors a").removeClass("active"),b.addClass("active"),this.$(".tag-color").css("color","#"+c),!1},editTeam:function(a,b){this.player.set({tag:b.get("tag").toUpperCase(),teamName:b.get("name"),tagColor:b.get("tagColor")}),location.href="/team/"+b.get("tag").toUpperCase()}});return g}),define("team/create",["require","templates","analytics","registry","team/models/create_form","shared/classes/form_validation"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("registry"),e=a("team/models/create_form"),f=a("shared/classes/form_validation");return Backbone.View.extend({el:"#app",events:{"click .tag-colors a":"changeColor","keyup input[name=tag]":"updatePreview","keyup input[name=name]":"updatePreview"},initialize:function(){void 0===this.template&&(this.template=b("team","create")),this.formModel=new e,"standard"!=d.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.player=d.get("player"),this.render()},render:function(){this.$el.html(this.template({team:{},player:this.player.toJSON(),teamInfo:NTGLOBALS("TEAM_INFO"),colors:NTGLOBALS("TEAM_COLORS")})),new f(this.$("form"),this.$(".create"),this.formModel,this.createTeam,this)},updatePreview:function(){var a=this.$("input[name=tag]").val()||"TAG",b=this.$("input[name=name]").val()||"Your Team Name";this.$(".tag-preview").html("["+a.toUpperCase()+"]"),this.$(".name-preview").html(b)},changeColor:function(a){var b=$(a.currentTarget),c=b.data("color");return this.$("input[name=tagColor]").val(c),this.$(".tag-colors a").removeClass("active"),b.addClass("active"),this.$(".tag-color").css("color","#"+c),!1},createTeam:function(a,b){c.trackEvent("Team","Create"),this.player.set({teamID:a.teamID,tag:b.get("tag").toUpperCase(),teamName:b.get("name"),tagColor:b.get("tagColor")}),location.href="/team/"+b.get("tag").toUpperCase()}})}),define("team/models/disband_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({url:"/api/teams/delete",defaults:{password:null},validationRules:{password:{required:!0}},validationMessages:{}})}),define("team/views/view_profile",["require","templates","analytics","team/models/disband_form","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("team/models/disband_form"),e=a("shared/classes/form_validation"),f=a("registry");return Backbone.View.extend({events:{"click .actions a":"handleClick"},initialize:function(){void 0===this.template&&(this.template=b("team","view_profile")),this.formModel=new d,"standard"!=f.get("player").get("accountType")&&(this.formModel.validationRules.password.required=!1),this.player=f.get("player"),this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN"),player:this.player.toJSON(),playerUserID:this.player.id,playerLevel:this.player.get("level"),playerSpeed:this.player.get("avgSpeed"),playerTeamID:this.player.get("teamID"),teamInfo:NTGLOBALS("TEAM_INFO"),dateFormat:this.dateFormat})),new e(this.$(".disband-confirm form"),this.$(".disband"),this.formModel,this.disbandTeam,this)},dateFormat:function(a){var b=moment(new Date(1e3*a));return b.format("MMM D, YYYY")},handleClick:function(a){var b=$(a.target);if(b.is(".leave-team"))this.showConfirm(a);else if(b.is(".cancel"))this.cancelConfirm(a);else if(b.is(".leave"))this.model.leave(this.player).done(function(a){a.success?location.href="/team":alert("There was an error: "+a.message)});else if(b.is(".disband-team"))this.showConfirm(a);else{if(!b.is(".join-button"))return!0;this.joinTeam(a)}return!1},disbandTeam:function(){c.trackEvent("Team","Disband"),this.player.set({teamID:0,tag:"",tagColor:"",totalTeammates:0}),location.href="/team"},showConfirm:function(a){$(a.currentTarget).parent().find(".confirm").velocity("fadeIn")},cancelConfirm:function(a){$(a.currentTarget).parents(".confirm").velocity("fadeOut")},joinTeam:function(a){var b=$(a.currentTarget),d=b.parent();b.addClass("pending").prop("disabled",!0),this.player.applyToTeam(this.model.id).done(function(a){b.hide(),a.success?(c.trackEvent("Team","Join"),d.html("You will be notified if you are accepted, and will be joined to the first team that accepts you."),this.$(".num-views").fastHide()):d.html(a.data.message)}.bind(this))}})}),define("team/views/view_pending",["require","templates","global/models/car","registry","shared/classes/typing"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=a("registry"),e=a("shared/classes/typing");return Backbone.View.extend({events:{"click .approve-all":"handleApproveAll","click .deny-all":"handleDenyAll","click tbody tr":"handleRowClick"},initialize:function(a){void 0===this.template&&(this.template=b("team","view_pending")),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=d.get("player"),this.team=a.team,this.model.fetch()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),team:this.team.toJSON(),carImage:c.imageTag,countries:NTGLOBALS("COUNTRIES"),typing:e,dateFormat:this.dateFormat,playerUserID:this.player.id}));var a=this.$(".social-table")[0];a&&Sortable.initTable(a)},removeRow:function(a){var b=this;this.$("#row-"+a.id).velocity("fadeOut",function(){b.render()})},dateFormat:function(a){var b=moment(new Date(1e3*a));return b.format("MMM D, YYYY")},handleApproveAll:function(){return this.model.approveAll().done(function(a){a.success||alert("There was an error: "+a.message)}),!1},handleDenyAll:function(){return this.model.denyAll().done(function(a){a.success||alert("There was an error: "+a.message)}),!1},getRowId:function(a){return $(a.currentTarget).data("id")},handleRowClick:function(a){return $(a.target).is(".approve")?this.model.approve(this.getRowId(a)).done(function(a){!a.success&&a.data&&a.data.message&&alert(a.data.message)}):$(a.target).is(".deny")?this.model.deny(this.getRowId(a)):$(a.currentTarget).is("tr")&&(location.href="/racer/"+this.model.get($(a.currentTarget).data("id")).get("username")),!1}})}),define("team/views/view_stats",["require","templates","shared/classes/typing"],function(a){"use strict";var b=a("templates"),c=a("shared/classes/typing");return Backbone.View.extend({initialize:function(){void 0===this.template&&(this.template=b("team","view_stats")),this.render()},render:function(){this.$el.html(this.template({data:_.indexBy(this.model.toJSON(),function(a){return a.board}),typing:c}))}})}),define("team/views/view_members",["require","templates","global/models/car","registry","shared/classes/typing"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=a("registry"),e=a("shared/classes/typing");return Backbone.View.extend({events:{"click tbody tr":"handleRowClick","click .js-member-toggle":"toggleMemberTables"},initialize:function(a){void 0===this.template&&(this.template=b("team","view_members")),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"remove",this.removeRow),this.player=d.get("player"),this.team=a.team,this.seasonModel=a.seasonModel,this.render()},render:function(){this.$el.html(this.template({data:this.model.toJSON(),season:this.seasonModel.toJSON(),team:this.team.toJSON(),carImage:c.imageTag,countries:NTGLOBALS("COUNTRIES"),typing:e,canPromote:this.model.where({role:"officer"}).length<NTGLOBALS("TEAM_INFO").maxOfficers,dateFormat:this.dateFormat,player:this.player.toJSON()})),Sortable.initTable(this.$(".js-member-table")[0]),Sortable.initTable(this.$(".js-season-table")[0])},removeRow:function(a){this.$("#row-"+a.id).velocity("fadeOut",function(){$(this).remove()})},dateFormat:function(a){var b=moment(new Date(1e3*a));return b.format("MMM D, YYYY")},handleRowClick:function(a){a.preventDefault();var b=$(a.target);return b.is(".remove-friend")||b.parent().is(".remove-friend")?this.toggleOptions(a):b.is(".delete")?this.deleteMember(a):b.is(".promote")?this.promoteMember(a):b.is(".demote")?this.demoteMember(a):!b.is(".remove-popup")&&void(location.href="/racer/"+this.model.get($(a.currentTarget).data("id")).get("username"))},toggleOptions:function(a){$(a.currentTarget).find(".remove-popup").toggle()},deleteMember:function(a){return confirm("Remove Member from Team\n\nAre you sure?")&&this.model.delete($(a.currentTarget).data("id")),!1},promoteMember:function(a){return this.model.promote($(a.currentTarget).data("id")),!1},demoteMember:function(a){return this.model.demote($(a.currentTarget).data("id")),!1},toggleMemberTables:function(a){var b=$(a.currentTarget).data("id");return this.$(".js-member-toggle").removeClass("is-active"),$(a.currentTarget).addClass("is-active"),this.$(".js-members").fastHide(),this.$(".js-"+b).fastShow(),!1}})}),define("team/models/motd",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model");return b.extend({idAttribute:"teamMotdID",url:"/api/teams/motd",defaults:{message:""},validationRules:{message:{required:!0,maxlength:400}}})}),define("team/views/new_motd",["require","templates","analytics","global/views/modal","team/models/motd","shared/classes/form_validation","registry"],function(a){"use strict";var b=a("templates"),c=(a("analytics"),a("global/views/modal")),d=a("team/models/motd"),e=a("shared/classes/form_validation"),f=a("registry");return c.extend({initialize:function(a){c.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=b("team","new_motd")),this.model=new d,this.render()},render:function(){return this.$el.append(this.template({})),new e(this.$("form"),this.$(".button-update"),this.model,this.update,this),this},update:function(){f.get("realtime").teamMotd(f.get("player").get("teamID")),setTimeout(function(){location.reload()},0)}})}),define("team/views/view_motd",["require","templates","registry","team/views/new_motd"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("team/views/new_motd");return Backbone.View.extend({events:{"click .view-older":"viewAll","click .new-motd":"newMotd"},initialize:function(a){void 0===this.template&&(this.template=b("team","view_motd")),this.player=c.get("player"),this.team=a.team,this.render()},render:function(){this.$el.append(this.template({data:this.model.toJSON(),team:this.team.toJSON(),player:this.player.toJSON(),formatText:this.formatText}))},formatText:function(a){return a.replace(/(@\S+)\s+/gm,function(a){return'<span class="racer">'+a+"</span>"})},viewAll:function(){return this.$(".messages").addClass("view-all"),!1},newMotd:function(){return(new d).show({destroy:!0}),!1}})}),define("team/collections/motds",["require","team/models/motd"],function(a){"use strict";var b=a("team/models/motd");return Backbone.Collection.extend({model:b})}),define("team/collections/members",["require","global/models/player"],function(a){"use strict";var b=a("global/models/player");return Backbone.Collection.extend({model:b,delete:function(a){$.post("/api/team-members/"+a+"/remove").done(function(b){b.success?this.remove(a):alert("There was an error: "+b.message)}.bind(this))},demote:function(a){$.post("/api/team-members/"+a+"/demote").done(function(a){a.success?location.reload():alert("There was an error: "+a.message)})},promote:function(a){$.post("/api/team-members/"+a+"/promote").done(function(a){a.success?location.reload():alert("There was an error: "+a.message)})}})}),define("team/collections/stats",["require"],function(a){"use strict";return Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"board"})})}),define("team/collections/pending",["require","registry","global/models/player"],function(a){"use strict";var b=a("registry"),c=a("global/models/player");return Backbone.Collection.extend({model:c,initialize:function(){this.on("reset",this.updatePlayer,this),this.on("remove",this.updatePlayer,this)},updatePlayer:function(){var a=b.get("player");a.set({teamApplications:this.length})},fetch:function(){var a=this;return $.get("/api/teams/applications").done(function(b){b.success&&a.reset(b.data)})},approve:function(a){return $.post("/api/team-requests/"+a+"/accept").done(function(c){c.success&&(this.remove(a),b.get("realtime").acceptToTeam(b.get("player").get("teamID"),[a]))})},deny:function(a){return this.remove(a),$.post("/api/team-requests/"+a+"/deny")},approveAll:function(){return this.trigger("request"),$.post("/api/team-requests/accept-all").done(function(a){a.success&&(b.get("realtime").acceptToTeam(b.get("player").get("teamID"),a.data),this.reset())}.bind(this))},denyAll:function(){var a=this;return this.trigger("request"),$.post("/api/team-requests/deny-all").done(function(b){b.success&&a.reset()})}})}),define("team/view",["require","team/views/view_profile","team/views/view_pending","team/views/view_stats","team/views/view_members","team/views/view_motd","team/models/team","team/collections/motds","team/collections/members","team/collections/stats","team/collections/pending","registry"],function(a){"use strict";var b=a("team/views/view_profile"),c=a("team/views/view_pending"),d=a("team/views/view_stats"),e=a("team/views/view_members"),f=a("team/views/view_motd"),g=a("team/models/team"),h=a("team/collections/motds"),i=a("team/collections/members"),j=a("team/collections/stats"),k=a("team/collections/pending"),l=a("registry");return Backbone.View.extend({el:"#app",initialize:function(a){this.player=l.get("player"),g.getTeamByTag(a.tag).done(function(a){a.success?(NTGLOBALS("LOGGED_IN")&&a.data.info.teamID!=this.player.get("teamID")&&l.get("realtime").teamCheckin(a.data.info.teamID),this.setUpViews(a.data),this.render()):location.href="/garage"}.bind(this))},setUpViews:function(a){var l=new g(a.info);this.model=l;var m=new i(a.members),n=new j(a.stats),o=new i(a.season);if(l.id==this.player.get("teamID")||this.player.get("moderator")||this.player.get("admin")){var p=new h(a.motd);this.motd=new f({model:p,team:l})}if(this.profile=new b({model:l}),this.stats=new d({model:n,team:l}),this.members=new e({model:m,seasonModel:o,team:l}),this.model.id==this.player.get("teamID")&&"officer"==this.player.get("teamRole")){var q=new k;this.pending=new c({model:q,team:l})}},render:function(){this.$("#teamProfile").html(this.profile.el),this.motd&&this.$(".team-motd").html(this.motd.el),this.$(".team-stats").html(this.stats.el),this.$(".team-members").html(this.members.el),this.pending&&(this.$(".team-pending").html(this.pending.el),this.$(".applications").show()),this.model.id==this.player.get("teamID")&&this.player.set({teamApplications:0})}})}),define("store/models/purchase_form",["require","shared/classes/form_model","registry"],function(a){"use strict";var b=a("shared/classes/form_model");a("registry");return b.extend({initialize:function(){},url:"/api/purchase",defaults:{product:"",purchaseFor:"",purchaseForUsername:""},validationRules:{purchaseForUsername:{required:!0}},validationMessages:{},purchase:function(a){return this.set(a),$.post("/api/purchase/cash",this.toJSON())}})}),define("store/index",["require","registry","analytics","shared/classes/form_validation","store/models/purchase_form","templates"],function(a){"use strict";var b=a("registry"),c=a("analytics"),d=a("shared/classes/form_validation"),e=a("store/models/purchase_form"),f=a("templates");return Backbone.View.extend({el:"#app",events:{"click .item":"changeProduct","click input[name=purchaseFor]":"changePurchaseFor"},initialize:function(){return this.templateComplete=f("store","complete"),this.templateWaiting=f("store","waiting"),this.player=b.get("player"),this.products=NTGLOBALS("PRODUCTS"),this.model=new e,"object"!=typeof StripeCheckout?void alert('Uh oh! It looks like your network is blocking our payment gateway. To upgrade, please allow "stripe.com" in your firewall, or upgrade using a different internet connection.'):(this.stripeHandler=StripeCheckout.configure({key:NTGLOBALS("STRIPE_KEY"),token:this.confirmOrder.bind(this),closed:this.stripeClosed.bind(this),bitcoin:!0}),$(window).on("popstate",this.stripeHandler.close.bind(this.stripeHandler)),void this.render())},render:function(){if(this.$(".username").html(this.player.get("username")),location.hash){this.$("input[name=purchaseForUsername]").val(location.hash.replace("#",""));var a=location.hash.replace("#","");this.$(".username").text(a?a:this.player.get("username")),this.$("#purchaseForOther").prop("checked",!0),this.$(".purchase-other").show()}this.formValidator=new d(this.$("form[name=payment-form]"),this.$(".purchase-button"),this.model,this.checkCallback,this)},renderWaiting:function(){this.$("#payment-start").velocity("slideUp",function(){this.$("#payment-waiting").html(this.templateWaiting()).velocity("slideDown")}.bind(this))},renderComplete:function(a){this.$("#payment-waiting").velocity("slideUp",function(){this.$("#payment-confirmation").html(this.templateComplete({data:a})).velocity("slideDown")}.bind(this))},checkCallback:function(a,b){var c=_.extend(a,b.toJSON());this.stripeHandler.open({name:this.products[this.model.get("product")].name,description:"$"+this.products[this.model.get("product")].cashReward.addCommas()+" for "+("other"==c.purchaseFor?c.purchaseForUsername:this.player.get("username")),amount:Math.round(100*this.products[c.product].price),zipCode:!0,email:this.player.get("email")||null,billingAddress:!0,allowRememberMe:!0})},stripeClosed:function(){this.formValidator.enableForm()},confirmOrder:function(a){this.renderWaiting(),this.model.purchase(a).done(function(a){if(a.success){var b=_.extend(this.model.toJSON(),a.data);"self"==b.purchaseFor&&this.player.inc({money:this.products[b.product].cashReward,totalPurchases:1}),b.buyCash&&this.player.set({buyCash:b.buyCash}),this.googleEcommerce(b),this.renderComplete(b)}else a.data&&a.data.message?alert(a.data.message):alert("There was an error upgrading your account! Please try again, or contact support.")}.bind(this))},changeProduct:function(a){var b=$(a.currentTarget).data("id"),d=this.products[b],e=$(a.currentTarget).data("index"),f=this.$(".selected-item");return f.removeClass("item-1 item-2 item-3 item-4 item-5 item-6").addClass("item-"+e),f.find(".name").html(d.name),f.find(".price").html("$"+d.cashReward.addCommas()),f.find(".image").css({backgroundImage:"url('/dist/site/images/store/cash-"+e+".png')"}),f.find(".description").html(d.description),f.find(".purchase-button").html("Purchase for $"+d.price),f.is(":visible")||f.velocity("slideDown"),c.trackPage("/store/details"),this.model.set({product:b}),!1},changePurchaseFor:function(a){"self"==$(a.currentTarget).val()?this.$(".purchase-other").velocity("slideUp"):this.$(".purchase-other").velocity("slideDown")},googleEcommerce:function(a){a.transaction_id=a.invoiceNum,a.total=this.products[a.product].price,a.store="Nitro Type";var b=[{sku:a.product,product:this.products[a.product].name,price:this.products[a.product].price,quantity:1,category:this.products[a.product].type}];c.trackSale(a,b),c.trackPage("/store/complete")}})}),define("upgrade/index",["require","registry"],function(a){"use strict";var b=a("registry");return Backbone.View.extend({el:"#app",events:{"click .button-race":"clickButton"},initialize:function(){this.player=b.get("player")},clickButton:function(){return NTGLOBALS("LOGGED_IN")?b.get("player").get("level")<20?(alert("You must be at least level 20 to purchase Gold Membership."),!1):void 0:(alert("You must be logged to continue."),!1)}})}),define("upgrade/models/purchase_form",["require","shared/classes/form_model","registry"],function(a){"use strict";var b=a("shared/classes/form_model");a("registry");return b.extend({initialize:function(){},url:"/api/purchase",defaults:{product:"",purchaseFor:"",purchaseForUsername:""},validationRules:{purchaseForUsername:{required:!0}},validationMessages:{},purchase:function(a){return this.set(a),$.post("/api/purchase/upgrade",this.toJSON())}})}),define("upgrade/payment",["require","registry","analytics","shared/classes/form_validation","upgrade/models/purchase_form","templates"],function(a){"use strict";var b=a("registry"),c=a("analytics"),d=a("shared/classes/form_validation"),e=a("upgrade/models/purchase_form"),f=a("templates");return Backbone.View.extend({el:"#app",events:{"click input[name=product]":"changeProduct","click input[name=purchaseFor]":"changePurchaseFor"},initialize:function(){return void 0===this.template&&(this.template=f("upgrade","complete"),this.templateWaiting=f("upgrade","waiting")),this.player=b.get("player"),this.products=NTGLOBALS("PRODUCTS"),this.model=new e,"object"!=typeof StripeCheckout?void alert('Uh oh! It looks like your network is blocking our payment gateway. To upgrade, please allow "stripe.com" in your firewall, or upgrade using a different internet connection.'):(this.stripeHandler=StripeCheckout.configure({key:NTGLOBALS("STRIPE_KEY"),token:this.confirmOrder.bind(this),closed:this.stripeClosed.bind(this),bitcoin:!0}),$(window).on("popstate",this.stripeHandler.close.bind(this.stripeHandler)),void this.render())},render:function(){if(this.$(".username").html(this.player.get("username")),location.hash||"gold"==this.player.get("membership")){this.$("input[name=purchaseForUsername]").val(location.hash.replace("#",""));var a=location.hash.replace("#","");this.$(".username").text(a?a:this.player.get("username")),this.$("#purchaseForOther").prop("checked",!0),this.$(".purchase-other").show(),"gold"==this.player.get("membership")&&this.$(".upgrade-self-row").hide()}this.formValidator=new d(this.$("form[name=payment-form]"),this.$("form[name=payment-form] .button"),this.model,this.checkCallback,this)},renderWaiting:function(){this.$("#payment-start").velocity("slideUp",function(){this.$("#payment-waiting").html(this.templateWaiting()).velocity("slideDown")}.bind(this))},renderComplete:function(a){this.$("#payment-waiting").velocity("slideUp",function(){this.$("#payment-confirmation").html(this.template({data:a})).velocity("slideDown")}.bind(this))},checkCallback:function(a,b){var c=_.extend(a,b.toJSON());this.stripeHandler.open({name:"Nitro Type Gold",description:"Upgrade for "+("other"==c.purchaseFor?c.purchaseForUsername:this.player.get("username")),amount:Math.round(100*this.products[c.product].price),zipCode:!0,email:this.player.get("email")||null,billingAddress:!0,allowRememberMe:!0})},stripeClosed:function(){this.formValidator.enableForm()},confirmOrder:function(a){this.renderWaiting(),this.model.purchase(a).done(function(a){if(a.success){var b=_.extend(this.model.toJSON(),a.data);"self"==b.purchaseFor&&(this.player.set({membership:"gold",buyCash:b.buyCash}),this.player.inc({money:this.products[b.product].cashReward,totalPurchases:1}),this.player.setCachingCookie("gold")),this.googleEcommerce(b),this.renderComplete(b)}else a.data&&a.data.message?alert(a.data.message):alert("There was an error upgrading your account! Please try again, or contact support."),location.reload()}.bind(this))},changeProduct:function(a){this.$(".price-options p").removeClass("selected"),$(a.currentTarget).parent("p").addClass("selected"),this.$(".price span").html("$"+this.products[$(a.currentTarget).val()].price)},changePurchaseFor:function(a){"self"==$(a.currentTarget).val()?this.$(".purchase-other").velocity("slideUp"):this.$(".purchase-other").velocity("slideDown")},googleEcommerce:function(a){a.transaction_id=a.invoiceNum,a.total=this.products[a.product].price,a.store="Nitro Type";var b=[{sku:a.product,product:this.products[a.product].name,price:this.products[a.product].price,quantity:1,category:this.products[a.product].type}];c.trackSale(a,b),c.trackPage("/upgrade/complete")}})}),define("achievements/models/group",["require"],function(a){"use strict";return Backbone.Model.extend({defaults:{name:"",order:""}})}),define("achievements/collections/groups",["require","achievements/models/group"],function(a){"use strict";var b=a("achievements/models/group");return Backbone.Collection.extend({model:b,comparator:"order",getCounts:function(a){var b=_.map(this.toJSON(),function(b){var c=a.filterByGroupId(b.id);return b.total=c.length,b.completed=c.filter(function(a){return a.get("completedStamp")>0}).length,b});return b}})}),define("achievements/views/list",["require","templates","global/models/car","global/views/invites"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=a("global/views/invites"),e=Backbone.View.extend({title:"",events:{"mouseenter .reward":"scaleRewardUp","mouseleave .reward":"scaleRewardDown","click .invite-link":"handleInviteClick"},initialize:function(a){void 0===this.template&&(this.template=b("achievements","list")),this.options=a,this.title=a.title,this.listenTo(this.model,"reset",this.render),this.render()},setTitle:function(a){this.title=a},render:function(){this.$el.html(this.template({data:this.model,total:this.model.length,completed:this.model.filter(function(a){return a.get("completedStamp")}).length,title:this.title,hideProgress:this.options.hideProgress,carTag:c.imageTag}))},handleInviteClick:function(){return this.invites||(this.invites=new d),this.invites.show(),!1},scaleRewardUp:function(a){var b=$(a.currentTarget).find(".car");b.length&&(b.find(".small").fastHide(),b.find(".large").fastShow(),b.find(".large img").velocity("finish").velocity({maxHeight:136,top:-54},{duration:200,easing:"linear",queue:!1}))},scaleRewardDown:function(a){var b=$(a.currentTarget).find(".car");b.length&&b.find(".large img").velocity({maxHeight:40,top:0},{duration:200,easing:"linear",queue:!1,complete:function(){b.find(".large").fastHide(),b.find(".small").fastShow()}.bind(this)})}});return e}),define("achievements/views/summary",["require","templates","registry","achievements/views/list"],function(a){"use strict";var b=a("templates"),c=(a("registry"),a("achievements/views/list")),d=Backbone.View.extend({initialize:function(a){void 0===this.template&&(this.template=b("achievements","summary")),this.options=a,this.list=new c({model:a.achievements.getRecentlyCompleted(3),title:"Recent Achievements",hideProgress:!0}),this.render()},render:function(){var a=this.options.groups.getCounts(this.options.achievements),b=_.reduce(a,function(a,b){return a+b.total},0),c=_.reduce(a,function(a,b){return a+b.completed},0);this.$el.html(this.template({total:b,completed:c,groups:a,loggedIn:NTGLOBALS("LOGGED_IN")})),this.$(".recent-list").html(this.list.el)}});return d}),define("achievements/index",["require","templates","achievements/collections/groups","achievements/collections/achievements","achievements/views/summary","achievements/views/list","registry"],function(a){"use strict";var b=a("templates"),c=a("achievements/collections/groups"),d=a("achievements/collections/achievements"),e=a("achievements/views/summary"),f=a("achievements/views/list"),g=a("registry"),h=Backbone.View.extend({el:".achievements-box",events:{"click .groups a":"handleGroupClick","click .progress-bars .progress":"handleGroupClick"},initialize:function(){void 0===this.template&&(this.template=b("achievements","index")),this.player=g.get("player"),this.groups=new c(JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").GROUPS))),this.achievements=g.get("achievements"),this.texts=JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").TEXT)),
this.achievements.setCompleted(g.get("playerAchievements")),this.selectedGroup=this.player.get("_achGroup")||"summary";var a=location.hash;a&&(this.selectedGroup=a.replace("#","")),this.groups.get(this.selectedGroup)||(this.selectedGroup="summary"),this.summary=new e({player:this.player,achievements:this.achievements,groups:this.groups,texts:this.texts}),"summary"!==this.selectedGroup&&this.summary.$el.hide(),this.list=new f({model:new d}),"summary"===this.selectedGroup?this.list.$el.hide():this.showList(this.selectedGroup),this.render()},render:function(){this.$el.html(this.template({data:this.groups.getCounts(this.achievements),player:this.player.toJSON(),selected:this.selectedGroup})),this.$(".list").append(this.summary.el).append(this.list.el)},handleGroupClick:function(a){var b=$(a.currentTarget).data("id");return this.$(".groups a").removeClass("active"),this.$(".groups a[data-id="+b+"]").addClass("active"),this.player.set({_achGroup:b}),"summary"==b?(this.list.$el.fastHide(),this.summary.$el.fastShow()):(this.showList(b),this.summary.$el.fastHide(),this.list.$el.fastShow()),!1},showList:function(a){this.list.setTitle(this.groups.get(a).get("name")),this.list.model.reset(this.achievements.filterByGroupId(a))}});return h}),define("router",["require","registry","index/index","relogin/index","join/index","garage/index","dealership/index","friends/index","bugs/index","scoreboard/index","news/index","news/read","garage/index","stats/index","racelog/index","race/index","race/index","race/performance_test","race/index","support/index","refund/index","profile/index","newpass/index","team/index","team/search","team/edit","team/create","team/view","store/index","upgrade/index","upgrade/payment","achievements/index"],function(a){"use strict";var b=a("registry"),c=Backbone.Router.extend({initialize:function(){this.pubSub=b.get("pubSub")},routes:{"":function(){new(a("index/index"))},"relogin(/*)":function(){new(a("relogin/index")),this.pubSub.trigger("app:navigate","relogin")},"join/:username":function(b){new(a("join/index"))({username:b}),this.pubSub.trigger("app:navigate","join")},"garage(/*)":function(){new(a("garage/index")),this.pubSub.trigger("app:navigate","garage")},"dealership(/*)":function(){new(a("dealership/index")),this.pubSub.trigger("app:navigate","dealership")},"friends(/*)":function(){new(a("friends/index")),this.pubSub.trigger("app:navigate","friends")},"bugs(/*)":function(){new(a("bugs/index")),this.pubSub.trigger("app:navigate","bugs")},"leaderboards(/*)":function(){new(a("scoreboard/index")),this.pubSub.trigger("app:navigate","scoreboard")},"news(/*)":function(){new(a("news/index")),this.pubSub.trigger("app:navigate","news")},"news/read/:id/*name(/*)":function(b){new(a("news/read"))({newsId:b}),this.pubSub.trigger("app:navigate","news")},"racer/:username(/*)":function(b){new(a("garage/index"))({username:b}),this.pubSub.trigger("app:navigate","racer")},"stats(/*)":function(){new(a("stats/index")),this.pubSub.trigger("app:navigate","stats")},"racelog/:type(/*)":function(b){new(a("racelog/index"))({type:b}),this.pubSub.trigger("app:navigate","stats")},"race/:useranme(/*)":function(b){new(a("race/index"))({trackLeader:b}),this.pubSub.trigger("app:navigate","race")},"race(/*)":function(){new(a("race/index"))({}),this.pubSub.trigger("app:navigate","race")},"test(/*)":function(){new(a("race/performance_test"))({}),this.pubSub.trigger("app:navigate","test")},"practice(/*)":function(){new(a("race/index"))({practice:!0}),this.pubSub.trigger("app:navigate","race")},"support(/*)":function(){new(a("support/index")),this.pubSub.trigger("app:navigate","support")},"refund(/*)":function(){new(a("refund/index")),this.pubSub.trigger("app:navigate","refund")},"profile(/*)":function(){new(a("profile/index"))},"newpass(/*)":function(){new(a("newpass/index"))},"team(/*)":function(){return b.get("player").get("teamID")?void(location.href="/team/"+b.get("player").get("tag")):(new(a("team/index")),void this.pubSub.trigger("app:navigate","team"))},"team/search(/*)":function(){new(a("team/search")),this.pubSub.trigger("app:navigate","team")},"team/edit(/*)":function(){new(a("team/edit")),this.pubSub.trigger("app:navigate","team")},"team/create(/*)":function(){return b.get("player").get("teamID")?void(location.href="/team/"+b.get("player").get("tag")):(new(a("team/create")),void this.pubSub.trigger("app:navigate","team"))},"team/:tag(/*)":function(b){new(a("team/view"))({tag:b}),this.pubSub.trigger("app:navigate","team")},"store(/*)":function(){new(a("store/index"))},"upgrade(/*)":function(){new(a("upgrade/index"))},"upgrade/payment(/*)":function(){new(a("upgrade/payment"))},"achievements(/*)":function(){new(a("achievements/index")),this.pubSub.trigger("app:navigate","achievements")}}});return{initialize:function(){new c,Backbone.history.start({pushState:!0})}}}),define("global/collections/messages",["require","registry"],function(a){"use strict";var b=a("registry");return Backbone.Collection.extend({receiveMessage:function(a){var c=b.get("player");if(a=_.extend(a,a.data),a.stamp=Date.now(),a.id=a.type+a.from,delete a.data,"race-invite"==a.type||"friend-accept"==a.type||"team-accept"==a.type||"sent-cash"==a.type){if("race-invite"==a.type&&(c.get("offline")||location.href.match("/race/"+a.username)))return;"team-accept"==a.type&&c.set({tag:a.tag,teamID:a.teamID,tagColor:a.tagColor}),"sent-cash"==a.type&&c.set({cashgift:1}),this.add(a)}else"friend-requests"==a.type?c.set({requests:a.requests}):"team-application"==a.type?c.set({teamApplications:a.applications}):"team-invite"!=a.type||c.get("teamID")?"team-motd"==a.type&&c.inc({teamApplications:1}):c.inc({teamApplications:1})},clearOld:function(){var a=this.filter(function(a){if(Date.now()-a.get("stamp")>9e5)return!0});a.forEach(function(a){this.remove(a)}.bind(this))},model:Backbone.Model.extend({defaults:{userID:0,teamID:0,username:"",displayName:"",speed:0,type:"",tag:"",tagColor:""}})})}),define("global/collections/top3_players",["require"],function(a){"use strict";return Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"userID"}),comparator:"rank"})}),define("global/models/login_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model"),c=b.extend({url:"/api/login",defaults:{username:null,password:null},validationRules:{username:{required:!0},password:{required:!0}},validationMessages:{username:{required:"Please enter a username"},password:{required:"Please enter a password"}}});return c}),define("global/views/login_form",["require","templates","registry","global/models/login_form","shared/classes/form_validation"],function(a){"use strict";var b=a("templates"),c=a("registry"),d=a("global/models/login_form"),e=a("shared/classes/form_validation"),f=Backbone.View.extend({events:{'keypress input[name="password"]':"submitOnEnter",'keypress input[name="remember"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=b("global","login_form")),this.model=new d},render:function(){this.$el.html(this.template({}));var a=this.$("form"),b=this.$("form .submit");return window.detectAdb&&this.$("input[name=adb]").val(window.detectAdb()),this.$("input[name=tz]").val(jstz.determine().name()),new e(a,b,this.model,this.successCallback,this),this},successCallback:function(a){c.get("player").loginWithData(a),"/"==window.location.pathname||window.location.pathname.match(/^\/join/)||window.location.pathname.match(/^\/newpass/)?window.location.href="/garage":window.location.reload()},submitOnEnter:function(a){13===a.keyCode&&(a.preventDefault(),$(a.currentTarget).blur(),this.$("form").submit())}});return f}),define("global/models/forgot_password_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model"),c=b.extend({url:"/api/lostpass-send",defaults:{email:null},validationRules:{email:{required:!0,email:!0}},validationMessages:{email:{required:"Please enter an email",email:"Please enter a valid email"}}});return c}),define("global/views/forgot_password",["require","templates","shared/classes/form_validation","global/models/forgot_password_form"],function(a){"use strict";var b=a("templates"),c=a("shared/classes/form_validation"),d=a("global/models/forgot_password_form"),e=Backbone.View.extend({events:{"click .forgot-password":"toggleForgotPassword",'keypress input[name="email"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=b("global","forgot_password")),this.model=new d},render:function(){this.$el.html(this.template());var a=this.$("form"),b=this.$("form .submit");return new c(a,b,this.model,this.successCallback.bind(this)),this},successCallback:function(){this.$("form").velocity("slideUp"),this.$(".reset-instructions").velocity("slideDown")},toggleForgotPassword:function(a){a.preventDefault();var b=this.$(".forgot-password-form");b.is(":visible")?b.velocity("slideUp",150):(b.velocity("slideDown",150),b.find("input").focus())},hide:function(){this.$(".forgot-password-form").hide()},submitOnEnter:function(a){13===a.keyCode&&(a.preventDefault(),$(a.currentTarget).blur(),this.$("form").submit())}});return e}),define("global/views/login",["require","templates","global/views/login_form","global/views/forgot_password","registry"],function(a){"use strict";var b=a("templates"),c=a("global/views/login_form"),d=a("global/views/forgot_password");a("registry");return Backbone.View.extend({className:"login-box",events:{"click .close":"hide","click .login-with-facebook":"facebookLogin","click .login-with-google":"googleLogin","click .login-with-clever":"cleverLogin"},_initialize:function(){void 0===this.template&&(this.template=b("global","login")),this.loginForm=new c,this.forgotPassword=new d,this.render(),this.inited=!0},render:function(){this.$el.html(this.template()),this.$("#loginFormContainer").html(this.loginForm.render().el),this.$("#forgotPasswordContainer").html(this.forgotPassword.render().el),$("body").append(this.el)},show:function(a){this.inited||this._initialize(),a=$(a),this.$el.css({left:a.offset().left+a.width()-this.$el.width(),top:a.offset().top+15}).velocity("fadeIn",function(){this.$el.find('input[name="username"]').focus()}.bind(this))},hide:function(){return this.$el.hide(),this.forgotPassword&&this.forgotPassword.hide(),!1},getState:function(){var a=_.random(1e4,99999);return $.cookie("state",a,{path:"/"}),a},facebookLogin:function(){return $.get("/api/auth/facebook").done(function(a){a.success?location.href=a.data.url:alert("Unable to log into facebook: "+a.data.message)}.bind(this)),!1},googleLogin:function(){return location.href="https://accounts.google.com/o/oauth2/auth?client_id="+NTGLOBALS("GOOGLE_CLIENTID")+"&redirect_uri="+encodeURIComponent(NTGLOBALS("GOOGLE_REDIRECTURI"))+"&response_type=code&scope=openid&state="+this.getState(),!1},cleverLogin:function(){return location.href="https://clever.com/oauth/authorize?client_id="+NTGLOBALS("CLEVER_CLIENTID")+"&redirect_uri="+encodeURIComponent(NTGLOBALS("CLEVER_REDIRECTURI"))+"&response_type=code&scope=openid&state="+this.getState(),!1}})}),define("global/models/register_form",["require","shared/classes/form_model"],function(a){"use strict";var b=a("shared/classes/form_model"),c=b.extend({url:"/api/register",defaults:{username:null,password:null,email:null},validationRules:{username:{required:!0},password:{required:!0},email:{email:!0}},validationMessages:{username:{required:"Please enter a username"},password:{required:"Please enter a password"},email:{email:"Please enter a valid email, or none at all"}}});return c}),define("global/views/register_form",["require","templates","analytics","registry","global/models/register_form","shared/classes/form_validation"],function(a){"use strict";var b=a("templates"),c=a("analytics"),d=a("registry"),e=a("global/models/register_form"),f=a("shared/classes/form_validation"),g=Backbone.View.extend({events:{'keypress input[name="password"],input[name="email"]':"submitOnEnter"},initialize:function(){void 0===this.template&&(this.template=b("global","register_form")),this.model=new e},render:function(){this.$el.html(this.template());var a=this.$("form"),b=this.$("form .submit");return window.detectAdb&&this.$("input[name=adb]").val(window.detectAdb()),this.$("input[name=tz]").val(jstz.determine().name()),new f(a,b,this.model,this.successCallback,this),this},successCallback:function(a){c.trackPage("/signup/complete"),d.get("player").loginWithData(a),window.location.href="/race"},submitOnEnter:function(a){13===a.keyCode&&(a.preventDefault(),$(a.currentTarget).blur(),this.$("form").submit())}});return g}),define("global/views/register",["require","global/views/login","templates","global/views/register_form"],function(a){"use strict";var b=a("global/views/login"),c=a("templates"),d=a("global/views/register_form");return b.extend({className:"register-box",_initialize:function(){void 0===this.template&&(this.template=c("global","register")),this.render(),this.inited=!0},show:function(a){this.inited||this._initialize(),b.prototype.show.apply(this,arguments)},render:function(){this.$el.html(this.template());var a=new d;this.$("#registerFormContainer").html(a.render().el),this.$el.find('input[name="username"]').focus(),$("body").append(this.el)}})}),define("global/views/level_up",["require","global/views/modal","templates"],function(a){"use strict";var b=a("global/views/modal"),c=a("templates");return b.extend({initialize:function(){b.prototype.initialize.apply(this,arguments),void 0===this.template&&(this.template=c("global","level_up")),this.listenTo(this.model,"change:level",this.render)},render:function(){return this.$el.append(this.template({level:this.model.get("level")})),this.$el.show(),this}})}),define("global/views/messages",["require","templates","registry","shared/classes/drags"],function(a){"use strict";var b=a("templates"),c=a("registry");return a("shared/classes/drags"),Backbone.View.extend({className:"message-center",events:{"click .close":"hide","click .button-red":"decline","click .button-green":"accept"},initialize:function(){if(NTGLOBALS("LOGGED_IN")){void 0===this.template&&(this.template=b("global","messages")),this.player=c.get("player"),this.model=c.get("playerMessages"),this.model.clearOld(),this.listenTo(this.model,"add",this.addRow);var a=this.player.get("_messagesPos");a&&this.$el.css(a),this.render()}},messageText:function(a){switch(a.type){case"race-invite":return"has invited you to race";case"friend-accept":return"just accepted your friend request";case"sent-cash":return"just sent you $"+Number(a.amount).addCommas()+"!"}},addRow:function(){this.renderMessages(),this.show()},render:function(){this.$el.html(this.template({data:!1})),this.model.length&&this.renderMessages(),this.model.length>0?this.$el.show():this.$el.hide(),$("body").append(this.el),this.$el.drags({handle:".drag-bar",stop:function(a){this.player.set({_messagesPos:a})}.bind(this)})},renderMessages:function(){this.$(".messages").html(this.template({data:this.model.toJSON(),messageText:this.messageText}))},show:function(){this.$el.velocity("fadeIn")},hide:function(){return this.model.reset(),this.$el.velocity("fadeOut"),!1},decline:function(a){var b=$(a.target).parents(".message"),c=b.data("id");return this.model.remove(c),b.velocity("slideUp"),0===this.model.length&&this.hide(),!1},accept:function(a){var b=$(a.target).parents(".message"),c=b.data("id"),d=this.model.get(c);if(!d)return!1;var e=d.toJSON();switch(this.model.remove(d),e.type){case"race-invite":location.href="/race/"+e.username;break;case"friend-accept":location.href="/racer/"+e.username;break;case"team-accept":location.href="/team/"+e.tag;break;case"sent-cash":location.href="/garage"}return!1}})}),define("global/views/achievement_alert",["require","templates","global/models/car","registry"],function(a){"use strict";var b=a("templates"),c=a("global/models/car"),d=a("registry");return Backbone.View.extend({className:"achievement-alert-container hide scale",events:{"click .achievement-alert":"clickAlert","mouseover .achievement-alert":"clearTimeout"},initialize:function(){void 0===this.template&&(this.template=b("global","achievement_alert")),this.player=d.get("player"),this.model=d.get("playerAchievements"),this.achievements=d.get("achievements"),this.listenTo(this.model,"add",this.addRow),this.render(),this.inited=!0},addRow:function(a){var b=this.achievements.get(a.id);b&&(this.$el.append(this.template({data:b.toJSON(),carImg:c.imageTag})),this.show())},render:function(){$("body").append(this.el)},show:function(){this.$el.removeClass("animate"),setTimeout(function(){this.$el.addClass("animate").removeClass("hide scale")}.bind(this),50),this.clearTimeout(),this.timeout=setTimeout(this.hide.bind(this),7e3)},hide:function(){this.$el.addClass("hide"),this.clearTimeout()},clearTimeout:function(){clearTimeout(this.timeout)},clickAlert:function(a){var b=$(a.currentTarget),c=b.data("id"),d=this.achievements.get(c);return $(a.target).hasClass("close")?(b.velocity("fadeOut",function(){$(this).remove()}),!1):!!$(a.target).is("a")||(location.href="/achievements#"+d.get("gid"),!1)}})}),define("global/views/session_expiring",["require","global/views/modal","templates","registry"],function(a){"use strict";var b=a("global/views/modal"),c=a("templates"),d=a("registry");return b.extend({expired:!1,startTime:0,initialize:function(a){a=a||{},b.prototype.initialize.apply(this,arguments),this.options=_.extend(this.options,a),this.delegateEvents(_.extend(this.events,{"click .stay-button":"stayLoggedIn","click .logout-button":"logOut"})),void 0===this.template&&(this.template=c("global","session_expiring")),this.player=d.get("player"),this.startTime=Date.getUnixTime(),this.render(),this.updateTime()},render:function(){return this.$(".popup-overlay").html(this.template({expired:this.expired})),this},updateTime:function(){var a=60*this.options.minutesRemaining-(Date.getUnixTime()-this.startTime),b=Math.floor(a/60),c=a-60*b;return c="00".substring(0,"00".length-String(c).length)+c,this.$(".remaining-time").html(b+":"+c),a<=0?(this.expired=!0,d.get("player").logout(),void this.render()):void setTimeout(this.updateTime.bind(this),1e3)},stayLoggedIn:function(a){return $(a.target).addClass("pending"),location.reload(),!1},logOut:function(){return d.get("player").logout(),location.href="/",!1}})}),define("global/views/login_alert_modal",["require","global/views/modal","templates","registry"],function(a){"use strict";var b=a("global/views/modal"),c=a("templates"),d=a("registry");return b.extend({initialize:function(a){a=a||{},b.prototype.initialize.apply(this,arguments),this.options=_.extend(this.options,a),void 0===this.template&&(this.template=c("global","login_alert_modal")),this.player=d.get("player"),this.render(),this.$(".js-toggle-button").click(this.toggleButtons.bind(this))},render:function(){return this.$(".popup-overlay").html(this.template(this.options)),this},toggleButtons:function(a){var b=$(a.currentTarget),c=b.parent(),d=b.data("toggle"),e=this.$(".js-toggle-section"),f=this.$("."+d);e.fastHide(),f.fastShow(),c.children().removeClass("is-active"),b.addClass("is-active")}})}),define("shared/classes/helpers",["require"],function(a){"use strict";window.PIXI&&(window.PIXI.dontSayHello=!0);var b=function(a,b){var c,d,e,f=new String,g=b.length;for(c=0;c<a.length;c++)e=a.charAt(c),d=b.indexOf(e),d>=0&&(e=b.charAt((d+g/2)%g)),f+=e;return f};if(window.rot47=function(a){try{a=a||"";var c=b(a,"!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~");return c}catch(a){return""}},$.objectArray=function(a,b){return b.map(function(b){return _.object(a,b)})},window.supportsWebGL=function(){return!!function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(a){return!1}}()},$.getQueryParam=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))},"object"!=typeof window.performance&&(window.performance={}),"function"!=typeof window.performance.now){var c=Date.now();"object"==typeof window.performance.timing&&window.performance.timing.navigationStart&&(c=window.performance.timing.navigationStart),window.performance.now=function(){return Date.now()-c}}$.fn.fastHide=function(){return this.each(function(a,b){b.style.display="none"}),this},$.fn.fastShow=function(a){return this.each(function(b,c){c.style.display=a?"inline-block":"block"}),this},Math.radians=function(a){return a*Math.PI/180},Number.addCommas=function(a,b){void 0!==b&&(a=Number(a).toFixed(b)||0);var c=a.toString().split(".");c[0]=c[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");var d=c.join(".");return d},Number.prototype.addCommas=function(a){return Number.addCommas(this,a)},Number.prototype.pluralize=function(){return 1==this?"":"s"},String.prototype.ucFirst=function(){return this.substr(0,1).toUpperCase()+this.substr(1)},Number.prototype.prettySeconds=function(){var a,b="",c=this;return c=Math.round((parseInt(c,10)+0)/60),a=Math.floor(c/60),a>0&&(b+=a+" hour"+(1==a?"":"s")+", ",c-=60*a),b+=c+" min"+(1==c?"":"s")},Number.prototype.countdownSeconds=function(){var a=Math.floor(this/60/60),b=Math.floor((this-60*a*60)/60),c=this-60*a*60-60*b;return String(a).pad(2,"0","STR_PAD_LEFT")+":"+String(b).pad(2,"0","STR_PAD_LEFT")+":"+String(c).pad(2,"0","STR_PAD_LEFT")},String.prototype.pad=function(a,b,c){var d,e=this,f="",g=function(a,b){for(var c="";c.length<b;)c+=a;return c=c.substr(0,b)};return e+="",b=void 0!==b?b:" ","STR_PAD_LEFT"!==c&&"STR_PAD_RIGHT"!==c&&"STR_PAD_BOTH"!==c&&(c="STR_PAD_RIGHT"),(d=a-e.length)>0&&("STR_PAD_LEFT"===c?e=g(b,d)+e:"STR_PAD_RIGHT"===c?e+=g(b,d):"STR_PAD_BOTH"===c&&(f=g(b,Math.ceil(d/2)),e=f+e+f,e=e.substr(0,a))),e},String.prototype.wordwrap=function(a,b,c){var d,e,f,g,h,i=this,j=arguments.length>=1?arguments[0]:75,k=arguments.length>=2?arguments[0]:"\n",l=arguments.length>=3&&arguments[0];if(i+="",j<1)return i;for(d=-1,f=(h=i.split(/\r\n|\n|\r/)).length;++d<f;h[d]+=g)for(g=h[d],h[d]="";g.length>j;h[d]+=g.slice(0,e)+((g=g.slice(e)).length?k:""))e=2==l||(e=g.slice(0,j+1).match(/\S*(\s)?$/))[1]?j:e.input.length-e[0].length||1==l&&j||e.input.length+(e=g.slice(j).match(/^\S*/))[0].length;return h.join("\n")},Number.prototype.ordinal=function(){var a=["th","st","nd","rd"],b=this%100;return a[(b-20)%10]||a[b]||a[0]},Date.getUnixTime=function(){return Math.floor((new Date).getTime()/1e3)}}),define("shared/classes/model",["require"],function(a){"use strict";Backbone.Model.prototype.parse=function(a){return _.isObject(a.data)&&_.isBoolean(a.success)?a.data:a},Backbone.Model.prototype.setBackend=function(a,b){return this.backend&&this.off("change",this.backend.change),a.setModel(this),this.on("change",a.change,a),"backend"==b?this.set(a.getData()):"model"==b&&a.setData(this.toJSON()),this.backend=a,this},Backbone.Model.prototype.inc=function(){if("object"==typeof arguments[0]){var a=null,b={};_.each(arguments[0],function(c,d){c=Number(c),a=this.get(d)||0,b[d]=a+c},this),this.set(b,arguments[1])}else if("string"==typeof arguments[0]&&arguments[1]){var a=this.get(arguments[0])||0,b={};return b[arguments[0]]=a+arguments[1],this.set(b,arguments[3])}}}),define("shared/classes/collection",["require"],function(a){"use strict";Backbone.Collection.prototype.parse=function(a){return _.isObject(a.data)&&_.isBoolean(a.success)?a.data:a},Backbone.Collection.prototype.setBackend=function(a,b){return a.setModel(this),this.on("change",a.change,a),this.on("add",a.add,a),this.on("remove",a.remove,a),this.on("reset",a.reset,a),this.on("sort",a.sort,a),"backend"==b?this.reset(a.getData()):"model"==b&&a.setData(this.toJSON()),this}}),"#nows"==location.hash&&(WebSocket=!1),define("app",["require","global/views/navigation","router","registry","analytics","global/collections/cars","friends/collections/friends","global/models/player","global/collections/messages","garage/collections/garage","achievements/collections/achievements","global/collections/top3_players","global/views/login","global/views/register","global/views/level_up","global/views/tooltip","global/views/messages","global/views/achievement_alert","global/views/session_expiring","global/views/login_alert_modal","shared/classes/model_backends/localstorage","shared/classes/helpers","shared/classes/model","shared/classes/collection"],function(a){"use strict";var b=a("global/views/navigation"),c=a("router"),d=a("registry"),e=a("analytics"),f=a("global/collections/cars"),g=a("friends/collections/friends"),h=a("global/models/player"),i=a("global/collections/messages"),j=a("garage/collections/garage"),k=a("achievements/collections/achievements"),l=a("global/collections/top3_players"),m=a("global/views/login"),n=a("global/views/register"),o=a("global/views/level_up"),p=a("global/views/tooltip"),q=a("global/views/messages"),r=a("global/views/achievement_alert"),s=a("global/views/session_expiring"),t=a("global/views/login_alert_modal"),u=a("shared/classes/model_backends/localstorage");return a("shared/classes/helpers"),a("shared/classes/model"),a("shared/classes/collection"),window.Moment=window.moment,{initialize:function(){this.browserCheck()&&(this.plugins(),this.globals(),"production"==NTGLOBALS("ENV")&&this.analytics(),this.authentication()&&(this.realtime(),this.views(),this.achievements(),this.router(),this.alertModal()))},browserCheck:function(){try{window.localStorage.setItem("test","test")}catch(a){return navigator.userAgent.match(/safari/i)?alert("Nitro Type can not be used in Safari while in Private Browsing Mode due to a bug in Safari. Please switch to normal browsing mode to use Nitro Type."):alert("Error: Your browser does not support Local Storage, or your Local Storage is full.  You will not be able to use Nitro Type until this is resolved."),!1}return!0},plugins:function(){$.extend($.timeago.settings.strings,{suffixFromNow:"from now",seconds:"< a min",minute:"~ a minute",minutes:"%d mins",hour:"~ an hour",hours:"~ %d hours",day:"a day",days:"%d days",month:"~ a month",months:"%d months",year:"~ a year",years:"%d years"}),$.fn.highlight=function(a,b){a=a||2,b=b||"fast";for(var c=0;c<a;c++)this.velocity("fadeOut",b).velocity("fadeIn",b)};var a=function(a){a&&"object"==typeof a&&a.data&&a.data.relogin&&(d.get("player").logout(),location.href="/")},b=function(a){return a=_.toArray(a),a[1]&&"object"==typeof a[1]&&a[1].ignoreCSRF?(delete a[1].ignoreCSRF,a):(1==a.length&&a.push({}),_.isArray(a[1])?a[1][a[1].length]={uhash:$.cookie("ntuserrem")}:_.isObject(a[1])&&(a[1].uhash=$.cookie("ntuserrem")),a)};jQuery.oldPost=jQuery.post,$.post=function(){return jQuery.oldPost.apply(jQuery,b(arguments)).done(a)},jQuery.oldGet=jQuery.get,$.get=function(){return jQuery.oldGet.apply(jQuery,b(arguments)).done(a)},$.getQueryParams=function(){for(var a,b=/\+/g,c=/([^&=]+)=?([^&]*)/g,d=function(a){return decodeURIComponent(a.replace(b," "))},e=window.location.search.substring(1),f={};;){if(a=c.exec(e),!a)break;f[d(a[1])]=d(a[2])}return f}},authentication:function(){var a=NTGLOBALS("LOGGED_IN"),b=d.get("player"),c=$.cookie("ntuserrem")||"",e=c.split("<"),f=e[1],g=$.cookie("PHPNTSESSION")&&$.cookie($.cookie("PHPNTSESSION"));if(location.pathname.match(/^\/relogin/))return!0;if(a){if(!b.id||!f||f!=b.id||paid()&&"gold"!=b.get("membership")||!g)return b.logout(),this.playerGlobals(),location.reload(),!1;var h=2,i=5;b.setCachingCookie(),setTimeout(function(){new s({minutesRemaining:i}).show()},3600*h*1e3-60*i*1e3)}else!g&&b.isGuest()||(b.logout(),this.playerGlobals());return!a&&b.get("experience")>0&&$.post("/api/settings/sessionbug",{player:b.toJSON(),loggedIn:NTGLOBALS("LOGGED_IN"),paid:paid()}),!0},realtime:function(){if("function"==typeof Primus){var a,b,c=location.pathname.match(/^\/race\//)||"/race"==location.pathname,e=location.pathname.match(/^\/race\//),f=NTGLOBALS("REALTIME_SERVERS"),g=d.get("player");if(NTGLOBALS("LOGGED_IN")||e||c&&g.get("avgSpeed")>0){b=c&&e?f[location.pathname.substr(-1).charCodeAt(0)%f.length]:f[parseInt(String(g.id).substr(-3),10)%f.length],location.hostname.match(/^192\.168/)&&(b=location.hostname+":28001");var h={pathname:"/realtime"};c&&(h.reconnect={retries:2}),"#polling"==location.hash&&(h.websockets=!1),g.get("websocketSupport")&&(h.transports=["websocket"]),h.manual=!0,a=Primus.connect(location.protocol+"//"+b,h),setTimeout(function(){a.open()},0),$(window).unload(function(){a.pageUnloaded=!0,a.end()}),a.on("open",function(){setTimeout(function(){a.socket.transport.ws&&a.socket.transport.ws.readyState==WebSocket.OPEN?g.set({websocketSupport:!0}):g.set({websocketSupport:!1})},1e3)}),a.on("error",function(a){console.error("Primus Error"),console.dir(a)});var i,j=function(){clearTimeout(i),i=setTimeout(function(){a.end()},9e5)};j(),a.on("data",function(b){if("error"==b.stream){switch(b.type){case"invalid session":d.get("player").logout(),location.href="/";break;case"no cookie":d.get("player").logout(),alert("Your browser must have cookies enabled to play Nitro Type")}return void a.end()}j()}),d.set("realtime",a)}if(NTGLOBALS("LOGGED_IN")){d.get("player").get("offline")||a.checkin();var k=d.get("playerMessages");a.getNotifications().on("data",k.receiveMessage.bind(k))}}},globals:function(){d.set("isMobile",navigator.userAgent.match(/iPad|iPhone|Android/));var a=_.extend({},Backbone.Events);d.set("pubSub",a),this.playerGlobals();var b=[];_.flatten(_.map(_.values(NTGLOBALS("SCOREBOARD_TOP3")),_.values)).forEach(function(a){var c=JSON.parse(a.userID);_.isArray(c)?c.forEach(function(a){b.push({userID:a})}):b.push({userID:c})});var c=new l(b);d.set("top3Players",c),d.set("cars",new f(NTGLOBALS("CARS"))),d.set("achievements",new k(JSON.parse(rot47(NTGLOBALS("ACHIEVEMENTS").LIST))))},playerGlobals:function(){var a=new h,b=new f,c=new g,e=new k,l=new j,m=new i;a.setBackend(new u("player"),"backend"),NTGLOBALS("LOGGED_IN")?(b.setBackend(new u("playerCars"),"backend"),c.setBackend(new u("playerFriends"),"backend"),e.setBackend(new u("playerAchievements"),"backend"),l.setBackend(new u("playerGarage"),"backend"),m.setBackend(new u("playerMessages"),"backend")):(a.setupGuest(),b.add({})),d.set("player",a),d.set("playerCars",b),d.set("playerFriends",c),d.set("playerAchievements",e),d.set("playerGarage",l),d.set("playerMessages",m),a.on("change",_.debounce(k.check.bind(k),300)),setTimeout(k.check.bind(k),1e3)},achievements:function(){var a=d.get("player"),b=function(){var b=0;b+=a.get("gender")?1:0,a.get("gender")&&a.set({hasGender:Math.round(Date.now()/1e3)}),b+=a.get("country")?1:0,a.get("country")&&a.set({hasCountry:Math.round(Date.now()/1e3)}),a.set({profileFields:b})};b(),a.on("change:gender change:country",b)},views:function(){this.loginView=new m,this.registerView=new n,$(document).on("click",".login-link",function(a){return this.loginView.show($(a.target)),this.registerView.hide(),!1}.bind(this)),$(document).on("click",".register-link",function(a){return this.registerView.show($(a.target)),this.loginView.hide(),!1}.bind(this)),NTGLOBALS("LOGGED_IN")&&new o({model:d.get("player")}),this.tooltip=new p,$(document).on("mouseover",".tooltip,.tooltip-nostyle",this.tooltip.show.bind(this.tooltip)),$(document).on("mouseout",".tooltip,.tooltip-nostyle",this.tooltip.hide.bind(this.tooltip)),$(document).on("click",".tooltip,.tooltip-nostyle",function(a){return!1}),new q,new r,new b({model:d.get("player")})},analytics:function(){var a=d.get("player");if(e.customDimension(1,NTGLOBALS("LOGGED_IN")?"yes":"no"),NTGLOBALS("LOGGED_IN")){e.customDimension(2,a.get("accountType")),e.customDimension(3,a.get("membership")),e.customDimension(4,a.get("gender")?a.get("gender"):"unknown");var b=10*Math.floor(a.get("level")/10);b<10?e.customDimension(5,"1-9"):e.customDimension(5,b+"-"+(b+9)),a.get("totalComments")?a.get("totalComments")<10?e.customDimension(6,"1-9"):(c=10*Math.floor(a.get("totalComments")/10),e.customDimension(6,c+"-"+(c+9))):e.customDimension(6,0),
e.customDimension(7,Math.floor((Date.getUnixTime()-a.get("createdStamp"))/60/60/24)),e.customDimension(10,a.get("teamID")?"yes":"no"),e.customDimension(12,NTGLOBALS("SPECIAL_EVENT")&&NTGLOBALS("SPECIAL_EVENT_CARS").indexOf(a.get("carID"))!=-1?"yes":"no");var c=0;d.get("playerFriends").length||e.customDimension(13,0),d.get("playerFriends").length<50?(c=10*Math.floor(d.get("playerFriends").length/10),e.customDimension(13,(c||1)+"-"+(c+9))):(c=50*Math.floor(d.get("playerFriends").length/50),e.customDimension(13,c+"-"+(c+49))),e.customDimension(14,a.get("totalPurchases"))}var f=10*Math.floor(a.get("avgSpeed")/10);f>0&&e.customDimension(8,f+"-"+(f+9)),location.pathname.match(/\/race(\/*)$/)?a.get("avgSpeed")?e.customDimension(9,"public"):e.customDimension(9,"qualifying"):location.pathname.match(/\/race\/.+/)&&e.customDimension(9,"friend"),e.customDimension(11,NTGLOBALS("SPECIAL_EVENT")?"yes":"no"),"/race"==location.pathname&&0===a.get("avgSpeed")&&ga("set","page","/qualifying"),ga("send","pageview")},router:function(){c.initialize();var a=$("#app-loader"),b=$("#app");a.fastHide(),b.fastShow()},alertModal:function(){var a=NTGLOBALS("LOGGED_IN"),b=NTGLOBALS("GLOBAL_ALERT"),c=d.get("player");a&&b&&moment(1e3*c.get("lastLogin")).format("YYYY-MM-DD")<b.startStamp&&!c.get("_sawGlobalAlert")&&(c.set({_sawGlobalAlert:!0}),new t(NTGLOBALS("GLOBAL_ALERT")).show())}}}),require.config({urlArgs:"bust="+(new Date).getTime(),baseUrl:"/src/site/js",paths:{shared:"../../shared",analytics:"../../shared/classes/analytics",registry:"../../shared/classes/registry",templates:"../../shared/classes/templates"},shim:{}});var oldRequire=require;require=function(a,b,c,d,e){oldRequire(a,b,c,!0,e)},require(["app"],function(a){$(function(){a.initialize()})}),define("main",function(){}),require(["app"]);